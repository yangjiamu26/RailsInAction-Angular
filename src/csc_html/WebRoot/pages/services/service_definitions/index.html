<link href="assets/lib/zTree/css/ibos/ibos.css" rel="stylesheet"
	type="text/css" />

<div class="app-content-full">
	<div class="bg-light lter b-b wrapper-sm">
		<ol class="breadcrumb">
			<li>当前位置：</li>
			<li>服务</li>
			<li class="active">服务管理</li>
		</ol>
	</div>
	<!-- hbox layout -->
	<div class="hbox hbox-auto-xs bg-light ">
		<!-- column -->
		<div class="col w lter b-r">
			<div class="vbox">
				<div class="wrapper b-b">
					<div class="left-title clearfix">
						<span style="font-size: 16px;">服务目录</span> 
						<span data-bind="click: editDir"
							class="glyphicon glyphicon-pencil pull-right service-edit-btn"
							style="color: #9c9c9c; top: 3px;"></span> 
						<span data-bind="click: delDir"
							class="glyphicon glyphicon-minus pull-right service-delete-btn"
							style="color: #9c9c9c; top: 3px;"></span>
						<span data-bind="click: add"
							class="glyphicon glyphicon-plus pull-right service-add-btn"
							style="color: #2aabd2; top: 3px; margin-right: 10px;"></span>
					</div>
				</div>
				<div class="row-row">
					<div class="cell scrollable hover">
						<div class="cell-inner">
							<div id="serverDefinitionsTree" class="ztree"
								style="margin-left: 8px;"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- /column -->

		<!-- column -->
		<div class="col">
			<div class="vbox">
				<div class="row-row">
					<div class="cell">
						<div class="cell-inner">
							<div class="wrapper-md">
								<div class="panel panel-default">
									<div class="row wrapper">
										<div class="col-xs-1">
											<a class="btn btn-sm btn-primary"
												onclick="showModal('pages/services/service_definitions/addService.html')">创建服务</a>
										</div>
										<div class="col-xs-3">
											<div class="input-group">
												<span class="input-group-addon">服务状态</span> 
												<select class="form-control input-sm" data-bind="value: searchParam().state">
													<option value="">全部</option>
													<option value="0">未发布</option>
													<option value="1">已发布</option>
													<option value="2">已下线</option>
													<option value="3">已销毁</option>
													<option value="4">无效</option>
												</select>
											</div>
										</div>
										<div class="col-xs-3">
											<div class="input-group">
												<span class="input-group-addon">所属产品</span> 
												<select class="form-control input-sm"
													data-bind="value: searchParam().product, options: $root.types, optionsText: 'name', optionsValue: 'uuid'">
													<option value="">全部</option>
												</select>
											</div>
										</div>
										<div class="col-xs-3">
											<div class="input-group">
												<span class="input-group-addon">服务名称</span> <input
													type="text" class="input-sm form-control"
													placeholder="请输入服务名称"
													data-bind="value: searchParam().serviceName">
											</div>
										</div>
										<div class="col-xs-2">
											<button class="btn btn-sm" type="button">重置</button>
											<button class="btn btn-sm btn-default" type="button" data-bind="click: search">搜索</button>
										</div>
									</div>

									<div class="table-responsive" data-bind="with : table">
										<table class="table table-striped">
											<thead>
												<th>服务名称</th>
												<th>所属产品</th>
												<th>服务状态</th>
												<th>服务目录</th>
												<th>创建人</th>
												<th>生效时间</th>
												<th>操作</th>
											</thead>
											<tbody>
												<tr data-bind="visible: showNoData">
													<td colspan="6" class="aligncenter">This table has no data.</td>
												</tr>
												<!-- ko foreach: {data: pagedRows, as: '$row'} -->
												<tr class="b-l b-l-3x b-l-info">
													<td data-bind="text: $row.name"></td>
													<td data-bind="text: $row.productName"></td>
													<td><span class="label label-danger" data-bind="text: $row.stateDesc"></span></td>
													<td data-bind="text: $row.dirName"></td>
													<td data-bind="text: $row.createUserName"></td>
													<td data-bind="text: $row.effectTime"></td>
													<td><a data-bind="if: $row.state == 0 || $row.state == 2" onclick="alert('发布成功！')">发布&nbsp;&nbsp;</a> 
													 <a data-bind="if: $row.state == 0 || $row.state == 2" onclick="showModal('pages/services/service_definitions/addService.html')">修改&nbsp;&nbsp;</a>
													 <a data-bind="if: $row.state == 0" onclick="alert('确定删除吗？')">删除 &nbsp;&nbsp;</a>
													 <a data-bind="if: $row.state == 1" onclick="alert('确定删除吗？')">下线&nbsp;&nbsp;</a>
													 <a data-bind="if: $row.state == 2" onclick="alert('确定删除吗？')">销毁 </a>													
													</td>													
												</tr>
												<!-- /ko -->
											</tbody>
										</table>
									</div>
									<footer class="panel-footer" data-bind="with: table">
										<ul class="pagination">
											<li data-bind="css: leftPagerClass, click: prevPage"><a
												href="#">&laquo;</a></li>
											<!-- ko foreach: {data: (new Array(pages()))} -->
											<li data-bind="css: $parent.pageClass($index() + 1)"><a
												href="#"
												data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
											</li>
											<!-- /ko -->
											<li data-bind="css: rightPagerClass, click: nextPage"><a
												href="#">&raquo;</a></li>
										</ul>
									</footer>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div role="dialog" aria-hidden="true" class="modal fade"
		data-bind="modal: { show: isAdd }">
		<div class='modal-dialog modal-lg' style="width: 600px;">
			<div class='modal-content'>
				<div class='modal-header'>
					<button type="button" class="close" data-dismiss="modal">
						<span aria-hidden="true">&times;</span>
					</button>
					<h3 class='modal-title' data-bind="ifnot: directoryVO().uuid">创建服务目录</h3>
					<h3 class='modal-title' data-bind="if: directoryVO().uuid">修改服务目录</h3>
				</div>
				<div class='modal-body form-horizontal row'>
					<div class="form-group">
						<label class="col-xs-3 control-label">服务目录名称</label>
						<div class="col-xs-8">
							<input type="text" class="form-control" placeholder="请输入名称"
								data-bind="value: directoryVO().name">
						</div>
						<div class="col-xs-1">
							<span class="text-danger inline m-l-n m-t-sm">*</span>
						</div>
					</div>
					<div class="form-group">
						<label class="col-xs-3 control-label">上级服务目录</label>
						<div class="col-xs-8">
							<input type="text" class="form-control" placeholder="请输入名称" disabled="disabled"
								data-bind="value: directoryVO().parentName">
						</div>
						<div class="col-xs-1">
							<span class="text-danger inline m-l-n m-t-sm">*</span>
						</div>
					</div>
				</div>
				<div class='modal-footer' style="text-align: center;">
					<a class="btn btn-default btn-info" data-bind="click: save">确定</a> 
					<a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- page specific plugin scripts -->
<script type="text/javascript">
  var scripts = [null, 'assets/lib/zTree/js/jquery.ztree.core.js', null]
  $('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
    //inline scripts related to this page
    var dirUuid = 0;
    <!--
    var setting = {
      view:{
        showIcon:false,
        showLine:false
      },
      callback : {
          //beforeClick: beforeClick,
          onClick : function(srcEvent, treeId, node, clickFlag) {
              srcEvent.preventDefault();
              dirUuid = node.uuid;
              viewModel.search(node.uuid)
          }
      }
    };    

    $(document).ready(function(){
    	loadTree();
    });
    
    function loadTree(){
    	csc.rest.get('api/v5.0.0/service/directory',function(data){
            $.fn.zTree.init($("#serverDefinitionsTree"), setting, data);
        });
    }
    //-->
            
    function ViewModel(){
      //服务目录start
      var self = this;
      this.isAdd = ko.observable(false);

      this.directoryVO = ko.validatedObservable({    	  
          name: ko.observable().extend({required: true}),          
          parentName: ko.observable("服务目录")
      });      
      
      //新增           
      this.add = function(){
    	var treeObj = $.fn.zTree.getZTreeObj("serverDefinitionsTree");
    	var nodes = treeObj.getSelectedNodes();
    	if(nodes.length > 0){
    	   this.isAdd(true);    	   
           this.directoryVO.fromJSON({
               uuid: null,
               name: "",
               parentName: nodes[0].name,
               parentUuid: nodes[0].uuid
           });	
    	}else{
    		alert('请选择根目录！');
    	}
        
      }
      //保存
      this.save = function(){
          ko.validation.group(this.directoryVO).showAllMessages();          
          if(this.directoryVO.isValid()){       	  
              if(this.directoryVO().uuid){
                  csc.rest.put('api/v5.0.0/service/directory/'+this.directoryVO().uuid,this.directoryVO.toJSON(),function(data){
                	  self.isAdd(false);
                	  self.table.refreshData();
                	  loadTree();
                      alert('修改目录成功！');                
                  }); 
              }else{
                  csc.rest.post('api/v5.0.0/service/directory',this.directoryVO.toJSON(),function(data){
                	  self.isAdd(false);
                	  self.table.refreshData();
                	  loadTree();
                      alert('添加目录成功！');                     
                  }); 
              }
          }
      }
      //删除      
      this.delDir = function(object, event){
    	  var treeObj = $.fn.zTree.getZTreeObj("serverDefinitionsTree");
          var nodes = treeObj.getSelectedNodes();          
          if(nodes.length > 0){
              if(nodes[0].uuid == 0){
                  systemMsg.alert('根目录不能删除！');
              }else{
            	  confirm("确定要删除目录 "+nodes[0].name+" ?",function(){
                      csc.rest.del('api/v5.0.0/service/directory/'+nodes[0].uuid, function(data){
                    	  loadTree();
                          self.table.refreshData();
                          alert('删除目录成功！');                          
                      });
                  }); 
              }                
           }else{
               alert('请选择要删除的目录！');
           }    	  
      }
      //修改
      this.editDir = function(object, event){
    	  var treeObj = $.fn.zTree.getZTreeObj("serverDefinitionsTree");
          var nodes = treeObj.getSelectedNodes();          
          if(nodes.length > 0){
        	  if(nodes[0].uuid == 0){
        		  alert('根目录不能修改！');
        	  }else{
        		  this.isAdd(true);           
                  this.directoryVO.fromJSON({
                      uuid: nodes[0].uuid,
                      name: nodes[0].name,
                      parentName: nodes[0].parentName,
                      parentUuid: nodes[0].uuid
                  }); 
        	  }                
           }else{
               alert('请选择要修改的目录！');
           }
      }
      //服务目录end
            
      this.searchParam = ko.observable({
    	  dirUUID: dirUuid,
          state: "",
          product: "",
          serviceName: ""
      })
      
      this.search = function(dirUuid){    	  
    	  if(typeof(dirUuid) != "object"){
    	     this.searchParam().dirUUID = dirUuid;
    	  }
          this.table.params(this.searchParam());
      }
      
      this.table = new DataTable([], {path: 'api/v5.0.0/service'});
                  
    }
    var viewModel = new ViewModel();
    ko.applyBindings(viewModel, $('#page-content')[0]);

  });
</script>