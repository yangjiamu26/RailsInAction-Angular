<div class="bg-light lter b-b wrapper-sm">
	<ol class="breadcrumb">
		<li>当前位置：</li>
		<li>应用</li>
		<li class="active">安装日志</li>
	</ol>
</div>

<div class='wrapper-md'>
	<div class='panel panel-default b-blue'>
		<div class="row wrapper">
			<div class="col-xs-2">
				<div class="input-group">
					<span class="input-group-addon">安装状态</span> <select
						class="form-control input-sm"
						data-bind="value: searchParam().status">
						<option value="">全部</option>
						<option value="0">安装中</option>
						<option value="1">安装成功</option>
						<option value="2">安装失败</option>
					</select>
				</div>
			</div>
			<div class="col-xs-3">
				<div class="input-group">
					<span class="input-group-addon">虚拟机</span> <input
						class="input-sm form-control" placeholder="请输入虚拟机名称"
						data-bind="value: searchParam().vmName" />
				</div>
			</div>
			<div class="col-xs-3">
				<div class="input-group">
					<span class="input-group-addon">软件</span> <input
						class="input-sm form-control" placeholder="请输入软件名称"
						data-bind="value: searchParam().softwareName" />
				</div>
			</div>
			<div class="col-xs-2">
				<div class="input-group">
					<span class="input-group-addon">订单</span> <input
						class="input-sm form-control" placeholder="请输入订单编号"
						data-bind="value: searchParam().orderNo" />
				</div>
			</div>
			<div class="col-xs-2">
				<button class="btn btn-sm" type="button">重置</button>
				<button class="btn btn-sm btn-default" data-bind="click: search">搜索</button>
			</div>
		</div>
		<div class='table-responsive' data-bind="with: table">
			<table class='table table-striped table-hover'>
				<thead>
					<tr>
						<th>软件名称</th>
						<th>虚拟机名称</th>
						<th>订单编号</th>
						<th>时间</th>
						<th>软件安装进度</th>
						<th>软件安装状态</th>
						<th>静默安装属性</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody>
					<tr data-bind="visible: showNoData">
						<td colspan="8" class="aligncenter">This table has no data.</td>
					</tr>
					<!-- ko foreach: {data: pagedRows, as: '$row'}  -->
					<tr>
						<td data-bind="text: $row.softwareName"></td>
						<td data-bind="text: $row.vmUuid"></td>
						<td data-bind="text: $row.billingUuid"></td>
						<td data-bind="text: $row.installTime"></td>
						<td data-bind="attr: {id: $row.uuid}"></td>
						<td data-bind="text: $row.statusName"></td>
						<td><a data-bind="click:$root.showLogText">查看</a> | <a href="#">修改</a></td>
						<td><a href="#">重安装</a> | <a href="#">查看日志</a></td>
					</tr>
					<!-- /ko -->
				</tbody>
			</table>
		</div>
		<footer class="panel-footer"
			data-bind="with: table, visible: table.pages() > 1">
			<ul class="pagination">
				<li data-bind="css: leftPagerClass, click: prevPage"><a
					href="#">&laquo;</a></li>
				<!-- ko foreach: {data: (new Array(pages()))} -->
				<li data-bind="css: $parent.pageClass($index() + 1)"><a
					href="#"
					data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
				</li>
				<!-- /ko -->
				<li data-bind="css: rightPagerClass, click: nextPage"><a
					href="#">&raquo;</a></li>
			</ul>
		</footer>
	</div>
</div>

<!-- 安装日志弹窗   start -->
	<div role="dialog" aria-hidden="true" class="modal fade"
		data-bind="modal: { show: isLogText }">

		<div class='modal-dialog' role='document'>
			<div class='modal-content'>
				<div class='modal-header'>
					<button type="button" class="close" data-dismiss="modal">
						<span aria-hidden="true">&times;</span>
					</button>
					<h3 class='modal-title'>安装日志</h3>
				</div>
				<div class='modal-body form-horizontal'>
					<div class="form-group">
						<label class="col-xs-3 control-label"> 日志详情 </label>
					</div>
					<div class="form-group">
						<div class="col-xs-11">
							<textarea class="form-control" >
							</textarea>
						</div>
					</div>
					<div class='modal-footer' style="text-align: center">
						<button name="button" type="submit"
							class="btn btn-default btn btn-default" data-dismiss="modal">关闭</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 安装日志弹窗   end -->

<!-- page specific plugin scripts -->
<script type="text/javascript">
	var scripts = [ null, 'api/software/software.js', null ]
	$('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
		function ViewModel() {
			var self = this;
			
			this.isLogText = ko.observable(false);
			
			this.progressVO = ko.observable({});
			
			this.searchParam = ko.observable({
				status : "",
				vmName : "",
				softwareName : "",
				orderNo : ""
			});
			
			this.search = function() {
				this.table.params(this.searchParam());
			};

			this.table = new DataTable([], {
				path : 'api/v5.0.0/install/logs'
			});
			
			//获取进度数据
			this.getProgress = function(object) {
				var val = '0%';
				
				if (object.status == 0) {
					var intervalId = setInterval(function() {
						
						$('#'+object.uuid).html(val);
						
						$.SOFTWARE.getProgress(object.uuid, function(data) {
							
							$('#'+object.uuid).html(data.progress);
							
							//clearInterval(intervalId);
							if (data.progress == 'success' || data.progress == 'N/A') {
								clearInterval(intervalId);	
								self.table.refreshData();
							}
						});
					},3500);
				}
				
				return val;
			};
			
			//显示安装日志
			this.showLogText = function(object, event) {
				
			};
		}
		$(document).ready(function() {
			var viewModel = new ViewModel();
			ko.applyBindings(viewModel, $('#page-content')[0]);
		});
		
	});
</script>