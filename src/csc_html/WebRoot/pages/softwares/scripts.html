<link href="assets/lib/webuploader/webuploader.css" rel="stylesheet"
	type="text/css" />
	
<div class="bg-light lter b-b wrapper-sm">
	<ol class="breadcrumb">
		<li>当前位置：</li>
		<li>应用</li>
		<li class="active">脚本</li>
	</ol>
</div>

<div class='wrapper-md'>
	<div class='panel panel-default'>
		<div class="row wrapper">
			<div class="col-xs-2">
				<button class="btn btn-sm btn-primary" data-bind="click: add">添加</button>
				<button class="btn btn-sm btn-default" data-bind="click: remove">删除</button>
			</div>
			<div class="col-xs-3">
				<div class="input-group">
					<span class="input-group-addon">脚本类型</span> <select
						class="form-control input-sm"
						data-bind="value: searchParam().type, options: $root.typeNames, optionsText: 'name', optionsValue: 'name', optionsCaption: '全部'"></select>
				</div>
			</div>
			<div class="col-xs-3">
				<div class="input-group">
					<span class="input-group-addon">名称</span> <input type="text"
						class="input-sm form-control" placeholder="请输入名称"
						data-bind="value: searchParam().name">
				</div>
			</div>
			<div class="col-xs-1">
				<button class="btn btn-sm btn-default" type="button"
					data-bind="click: search">搜索</button>
			</div>
		</div>
		<div class='table-responsive' data-bind="with: table">
			<table class='table table-striped table-hover'>
				<thead>
					<tr>
						<th>
							<div class="checkbox">
								<label class="i-checks"> <input type="checkbox"
									data-bind="checked: isSelectedAll"> <i></i>
								</label>
							</div>
						</th>
						<th>脚本名称</th>
						<th>脚本类型</th>
						<th>适用操作系统</th>
						<th>关联软件</th>
						<th>创建日期</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody>
					<tr data-bind="visible: showNoData">
						<td colspan=11 class="aligncenter">This table has no data.</td>
					</tr>
					<!-- ko foreach: {data: pagedRows, as: '$row'}  -->
					<tr>
						<td>
							<div class="checkbox">
								<label class="i-checks"> <input type="checkbox"
									data-bind="checkedValue: $data, checked: $parent.chosenItems">
									<i></i>
								</label>
							</div>
						</td>
						<td data-bind="text: $row.name"></td>
						<td data-bind="text: $row.softTypeName"></td>
						<td data-bind="text: $row.supportOs"></td>
						<td data-bind="text: $row.softwareNames"></td>
						<td data-bind="text: $row.createTime"></td>
						<td><a data-bind="click: $root.removeOne">删除</a></td>
					</tr>
					<!-- /ko -->
				</tbody>
			</table>
		</div>
		<footer class="panel-footer"
			data-bind="with: table, visible: table.pages() > 1">
			<ul class="pagination">
				<li data-bind="css: leftPagerClass, click: prevPage"><a
					href="#">&laquo;</a></li>
				<!-- ko foreach: {data: (new Array(pages()))} -->
				<li data-bind="css: $parent.pageClass($index() + 1)"><a
					href="#"
					data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
				</li>
				<!-- /ko -->
				<li data-bind="css: rightPagerClass, click: nextPage"><a
					href="#">&raquo;</a></li>
			</ul>
		</footer>
	</div>
</div>

<div role="dialog" aria-hidden="true" class="modal fade" id="showScriptModal"
	data-bind="modal: { show: isAdd }">
	<div class='modal-dialog modal-lg' role='document'>
		<div class='modal-content'>
			<div class='modal-header'>
				<button type="button" class="close" data-dismiss="modal">
					<span aria-hidden="true">&times;</span>
				</button>
				<h3 class='modal-title' data-bind="ifnot: currentVO().Id">添加脚本</h3>
				<h3 class='modal-title' data-bind="if: currentVO().Id">修改脚本</h3>
			</div>
			<div class='modal-body'>
				<div class="form-group string required">
					<div class="col-xs-12 form-inline">
						脚本名称： <input type="text" class="form-control"
							data-bind="value: name" />&nbsp;&nbsp;&nbsp;&nbsp; 脚本类型： <select
							class="form-control"
							data-bind="value: currentVO().softTypeName, options: $root.typeNames, optionsText: 'name', optionsValue: 'name', optionsCaption: '全部'">
						</select>
					</div>
				</div>
				<hr />
				<div class="form-group string required">
					<div class="col-xs-12 form-inline">
						脚本文件：
						<div id="picker" class="btn">浏览</div>
						<button class="btn btn-default" data-bind="click: uploadFile">上传</button>
					</div>
				</div>
				<div>
					<table class="table">
						<thead>
							<tr>
								<th>脚本名称</th>
								<th>大小</th>
								<th>上传进度</th>
								<th>路径</th>
								<th>脚本属性</th>
								<th>上传日期</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody data-bind="foreach: fileTable">
							<tr>
								<td data-bind="text:name"></td>
								<td data-bind="text:size"></td>
								<td data-bind="text:progress"></td>
								<td data-bind="text:path"></td>
								<td data-bind="text:isExecName"></td>
								<td data-bind="text:uploadTime"></td>
								<td><a data-bind="if: Id, click: $root.downloadFile">下载</a>
									| <a data-bind="click: $root.openUpdateFile">修改</a> | <a
									data-bind="click: $root.removeFile">移除</a></td>
							</tr>
						</tbody>
					</table>
				</div>
				<hr />
				<h4>
					<button class="btn btn-default btn-sm pull-right"
						data-bind="click: openDefaultAttr">添加参数</button>
					静默安装属性
				</h4>
				<p>&nbsp;</p>
				<div>
					<table class="table">
						<thead>
							<tr>
								<th>参数名称</th>
								<th>参数代码</th>
								<th>默认值</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody data-bind="foreach: attrTable">
							<tr>
								<td data-bind="text:name"></td>
								<td data-bind="text:code"></td>
								<td data-bind="text:value"></td>
								<td><a data-bind="click: $root.updateAttr">修改</a> | <a
									data-bind="click: $root.removeAttr">移除</a></td>
							</tr>
						</tbody>
					</table>
				</div>
				<hr />
				<h4>
					<button class="btn btn-default btn-sm pull-right"
						data-bind="click: openBindSoftware">添加软件</button>
					关联软件
				</h4>
				<p>&nbsp;</p>
				<table class="table">
					<thead>
						<tr>
							<th>软件名称</th>
							<th>软件类型</th>
							<th>软件版本</th>
							<th>适用操作系统</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody data-bind="foreach: softwareTable">
						<tr>
							<td data-bind="text:name"></td>
							<td data-bind="text:softTypeName"></td>
							<td data-bind="text:version"></td>
							<td data-bind="text:osName"></td>
							<td><a data-bind="click: $root.removeBindSoft">移除</a></td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class='modal-footer' style="text-align: center">
				<input type="button" name="commit" value="确定"
					class="btn btn-default btn-info" data-bind="click: save" />
				<button name="button" type="submit"
					class="btn btn-default btn btn-default" data-dismiss="modal">取消</button>
			</div>
		</div>
	</div>
</div>

<!-- 脚本文件维护弹窗   start -->
<div role="dialog" aria-hidden="true" class="modal fade"
	data-bind="modal: { show: isScriptFile }">

	<div class='modal-dialog' role='document'>
		<div class='modal-content'>
			<div class='modal-header'>
				<button type="button" class="close" data-dismiss="modal">
					<span aria-hidden="true">&times;</span>
				</button>
				<h3 class='modal-title'>修改脚本属性</h3>
			</div>
			<div class='modal-body form-horizontal'>
				<div class="form-group">
					<label class="col-xs-3 control-label"> 脚本名称 </label>
					<div class="col-xs-8">
						<input class="string required form-control" type="text"
							data-bind="value: scriptFileVO().name, enable: false" />
					</div>
					<div class="col-xs-1">
						<span class="text-danger inline m-l-n m-t-sm">*</span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-3 control-label"> 脚本属性</label>
					<div class="col-xs-8">
						<select class="form-control" data-bind="value: scriptFileVO().isExec">
							<option value="">--请选则--</option>
							<option value="0">不可执行</option>
							<option value="1">可执行</option>
						</select>
					</div>
					<div class="col-xs-1">
						<span class="text-danger inline m-l-n m-t-sm">*</span>
					</div>
				</div>
				<div class='modal-footer' style="text-align: center">
					<input type="button" name="commit" value="确定"
						class="btn btn-default btn-info" data-bind="click: updateFile" />
					<button name="button" type="submit"
						class="btn btn-default btn btn-default" data-dismiss="modal">取消</button>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- 脚本文件维护弹窗   end -->

<!-- 默认安装属性维护弹窗   start -->
<div role="dialog" aria-hidden="true" class="modal fade"
	data-bind="modal: { show: isDefaultAttr }">

	<div class='modal-dialog' role='document'>
		<div class='modal-content'>
			<div class='modal-header'>
				<button type="button" class="close" data-dismiss="modal">
					<span aria-hidden="true">&times;</span>
				</button>
				<h3 class='modal-title' data-bind="ifnot: defaultAttrVO().uuid">添加安装属性</h3>
				<h3 class='modal-title' data-bind="if: defaultAttrVO().uuid">修改安装属性</h3>
			</div>
			<div class='modal-body form-horizontal'>
				<div class="form-group">
					<label class="col-xs-3 control-label"> 参数名称 </label>
					<div class="col-xs-8">
						<input class="string required form-control" type="text"
							data-bind="value: defaultAttrVO().name" />
					</div>
					<div class="col-xs-1">
						<span class="text-danger inline m-l-n m-t-sm">*</span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-3 control-label"> 参数代码</label>
					<div class="col-xs-8">
						<input class="string required form-control" type="text"
							data-bind="value: defaultAttrVO().code" />
					</div>
					<div class="col-xs-1">
						<span class="text-danger inline m-l-n m-t-sm">*</span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-3 control-label"> 默认值</label>
					<div class="col-xs-8">
						<input class="string required form-control" type="text"
							data-bind="value: defaultAttrVO().value" />
					</div>
					<div class="col-xs-1">
						<span class="text-danger inline m-l-n m-t-sm">*</span>
					</div>
				</div>
				<div class='modal-footer' style="text-align: center">
					<input type="button" name="commit" value="确定"
						class="btn btn-default btn-info" data-bind="click: saveAttr" />
					<button name="button" type="submit"
						class="btn btn-default btn btn-default" data-dismiss="modal">取消</button>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- 默认安装属性维护弹窗   end -->

<!-- 关联软件甄选弹窗   start -->
<div role="dialog" aria-hidden="true" class="modal fade" id="showSoftwareModal"
	data-bind="modal: { show: isBindSoft }">
	<div class='modal-dialog' role='document'>
		<div class='modal-content'>
			<div class='modal-header'>
				<button type="button" class="close" data-dismiss="modal">
					<span aria-hidden="true">&times;</span>
				</button>
				<h3 class='modal-title'>关联脚本</h3>
			</div>
			<div class='modal-body form-horizontal'>
				<div class="form-group string required">
					<div class="col-xs-12 form-inline">
						软件类型名称：
						<select class="form-control input-sm"
							data-bind="value: searchSoftwareParams().softTypeName, options: $root.typeNames, optionsText: 'name', optionsValue: 'name', optionsCaption: '全部'">
						</select>
						软件名称：
						<input type="text" class="form-control" data-bind="value: searchSoftwareParams().softwareNm" />
						<button class="btn btn-default" data-bind="click: searchSoftware">查询</button>
					</div>
				</div>
				
				<div class="table-responsive" data-bind="with: chooseSoftwareTable">
					<table class="table">
						<thead>
							<tr>
								<th>
									<div class="checkbox">
										<label class="i-checks"> <input type="checkbox"
											data-bind="checked: isSelectedAll"> <i></i>
										</label>
									</div>
								</th>
								<th>软件名称</th>
								<th>软件类型</th>
								<th>软件版本</th>
								<th>适用操作系统</th>
							</tr>
						</thead>
						<tbody>
							<tr data-bind="visible: showNoData">
								<td colspan=11 class="aligncenter">This table has no data.</td>
							</tr>
							<!-- ko foreach: {data: pagedRows, as: '$row'}  -->
							<tr>
								<td>
									<div class="checkbox">
										<label class="i-checks"> <input type="checkbox"
											data-bind="checkedValue: $data, checked: $parent.chosenItems">
											<i></i>
										</label>
									</div>
								</td>
								<td data-bind="text: $row.name"></td>
								<td data-bind="text: $row.softTypeName"></td>
								<td data-bind="text: $row.version"></td>
								<td data-bind="text: $row.osName"></td>
							</tr>
							<!-- /ko -->
						</tbody>
					</table>
				</div>
			</div>

			<div class='modal-footer'>
				<div data-bind="with: chooseSoftwareTable, visible: chooseSoftwareTable.pages() > 1">
					<ul class="pagination">
						<li data-bind="css: leftPagerClass, click: prevPage"><a
							href="#">&laquo;</a></li>
						<!-- ko foreach: {data: (new Array(pages()))} -->
						<li data-bind="css: $parent.pageClass($index() + 1)"><a
							href="#"
							data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
						</li>
						<!-- /ko -->
						<li data-bind="css: rightPagerClass, click: nextPage"><a
							href="#">&raquo;</a></li>
					</ul>
				</div>
				<!-- <div>
					<button name="button" type="submit"
						class="btn btn-default btn btn-default" data-dismiss="modal">关闭</button>
				</div> -->
			</div>
		</div>
	</div>
</div>
<!-- 关联软件甄选弹窗   end -->


<!-- page specific plugin scripts -->
<script type="text/javascript">
	var scripts = [ null, 'api/software/software.js',
	                'assets/lib/webuploader/webuploader.js', null ]
	$('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
				function ViewModel() {
					this.isAdd = ko.observable(false);

					this.isScriptFile = ko.observable(false);

					this.isDefaultAttr = ko.observable(false);

					this.isBindSoft = ko.observable(false);

					this.typeNames = ko.observableArray([]);

					var self = this;

					/** 脚本数据描述对象 **/
					this.currentVO = ko.validatedObservable({
						Id : null,
						uuid : 'N/A',
						name : ko.observable().extend({
							required : true
						}),
						softTypeName : ko.observable().extend({
							required : true
						}),
						// 此为针对已经持久化的数据的编辑提交
						newScriptFiles : [],
						updateScriptFiles: [],
						deleteScriptFiles: [],
						newDefaultAttrs: [],
						updateDefaultAttrs: [],
						deleteDefaultAttrs: [],
						newSoftwares: [],
						deleteSoftwares[]
					});
					
					/** 脚本文件数据描述对象 **/
					this.scriptFileVO = ko.validatedObservable({
						Id: null,
						uuid: null,
						scriptUuid: null,
						name : ko.observable().extend({required : true}),
						isExec : ko.observable().extend({required : true}),
						fileTableRow: null
					});
					
					/** 默认安装属性数据描述对象 **/
					this.defaultAttrVO = ko.validatedObservable({
						Id: null, 
						uuid: null,
						name: ko.observable().extend({required : true}),
						code: ko.observable().extend({required : true}),
						value: ko.observable().extend({required : true}),
						attrTableRow: null
					});
					
					/** 构建文件上传器 **/
			      	this.initUploader = function () {
			      		self.uploader = WebUploader.create({
							// 文件接收服务端。
							threads : 1,
							fileNumLimit : 1,
							chunked : false,
							resize : false
						});
			      		
			      		self.uploader.on('beforeFileQueued', function(file) {
							//重置上传队列
							self.uploader.reset();
						});
			      		
			      		self.uploader.on('fileQueued', function(file) {
			      			var flag = true;
			      			
			      			$.each(self.fileTable(), function(i, val) {
			      				if (val.name == file.name) {
			      					systemMsg.alert('已存在同名文件:' + val.name);
			      					flag = false;
			      					return;
			      				}
			      			});

			      			if (!flag) {
			      				return;
			      			}
			      			
			      			var addFile = {
		      					Id: null,
								uuid: null,
								name: file.name,
								progress: ko.observable(),
								size: csc.util.bytesToSize(file.size),
								path: ko.observable(),
								isExec: (self.fileTable().length == 0 ? 1 : 0),
								isExecName: self.fileTable().length == 0 ? 
										ko.observable('可执行') : ko.observable('不可执行'),
								uploadTime: ''
			      			};
			      			
							self.fileTable.push(addFile);
						});
			      		
			      		self.uploader.on('uploadProgress', function(file, progress) {
			      			self.fileTable()[self.fileTable().length-1].progress((progress*100).toFixed(0) + "%");		
			      		});
			      		
			      		self.uploader.on('uploadSuccess', function(file, response) {
			      			$.each(self.fileTable(), function(i, val) {
			      				if (val.name == file.name) {
			      					val.path(response.path);
			      					val.uploadTime(response.uploadTime);
			      					return;
			      				}
			      			});
			      		});
			      	};
			      	
			      	/** 上传脚本文件 **/
			      	this.uploadFile = function() {
			      		var uploadKey = WebUploader.guid('csc_upload_');
			      		
			      		self.uploader.options.server = '/file/uploadServlet?handler=cscScript&actionKey='
	      											+ uploadKey + '&dataKey=' + uploadKey;
			      		
			      		self.uploader.upload();
			      	};
					/** 脚本列表数据 **/
					this.table = new DataTable([], {
						path : 'api/v5.0.0/script/scripts'
					});
		
					/** 脚本文件列表数据 **/
					this.fileTable = ko.observableArray([]);

					/** 关联的默认安装属性列表数据 **/
					this.attrTable = ko.observableArray([]);

					/** 已绑定软件列表数据 **/
					this.softwareTable = ko.observableArray([]);
					
					/** 选择软件列表数据 **/
					this.chooseSoftwareTable = new DataTable([], {
						path : 'api/v5.0.0/soft/bind/softwares?softTypeName='
								+ self.currentVO().softTypeName()
					});

					/** 下载脚本文件 **/
					this.downloadFile = function(object, event) {
						console.log(object);
					};

					/** 加载脚本文件数据 **/
					this.loadSctipFileData = function() {
						if (self.currentVO().uuid && self.currentVO().uuid != 'N/A') {
							$.SOFT_SCRIPT.loadScriptFileData({scriptUuid: self.currentVO().uuid}, function (data) {
								$.each(data.results, function(i, val) {
									self.fileTable.push(val);
								});
							});
						}
					};
					
					/** 修改脚本文件 弹窗**/
					this.openUpdateFile = function(object, event) {
						self.scriptFileVO.fromJSON(object);
						
						self.scriptFileVO().fileTableRow = object;
						
						self.isScriptFile(true);
					};
					
					/** 修改脚本 **/
					this.updateFile = function() {
						self.scriptFileVO().fileTableRow.isExec = self.scriptFileVO().isExec();
						
						self.scriptFileVO().fileTableRow.isExecName(self.scriptFileVO().isExec == '1' ?
								'可执行' : '不可执行');
						self.isScriptFile(false);
					};

					/** 移除脚本文件 **/
					this.removeFile = function(object, event) {
						if (object.path() && !object.Id) {
							$.SOFT_SCRIPT.deleteScriptFile({filePathStr: object.path()}, function(data) {
								self.fileTable.remove(object);
							});
						} else {
							self.fileTable.remove(object);
							self.currentVO().deleteScriptFiles.push(object);
						}
					};

					/** 加载默认安装属性数据 **/
					this.loadDefaultAttrData = function() {
						if (self.currentVO().uuid && self.currentVO().uuid != 'N/A') {
							$.SOFT_SCRIPT.loadDefaultAttrData({scriptUuid: self.currentVO().uuid}, function (data) {
								$.each(data.results, function(i, val) {
									self.attrTable.push(val);
								});
							});
						}
					};
					
					/** 更新默认安装属性 **/
					this.saveAttr = function() {
						
						if (self.defaultAttrVO.attrTableRow) {
							
						} else {
							self.attrTable.push({
								Id: null,
								uuid: null,
								name: ko.observable(self.defaultAttrVO().name()),
								code: ko.observable(self.defaultAttrVO().code()),
								value: ko.observable(self.defaultAttrVO().value())
							});
						}
						
						self.isDefaultAttr(false);
					};

					/** 删除默认安装属性 **/
					this.removeAttr = function(object, event) {
						
						if (object.uuid) {
							self.currentVO().deleteDefaultAttrs.push(object);
						}
						
						self.attrTable.remove(object);
					};

					/** 默认安装属性弹窗（新增） **/
					this.openDefaultAttr = function() {
						
						self.defaultAttrVO.fromJSON({
							Id: null, 
							uuid: null,
							name: '',
							code: '',
							value: '',
							attrTableRow: null
						});
						self.isDefaultAttr(true);
					};
					
					/** 默认安装属性弹窗（修改）  **/
					this.updateAttr = function(object, event) {
						self.defaultAttrVO.fromJSON({
							Id: object.Id,
							uuid: object.uuid,
							name: object.name(),
							code: object.code(),
							value: object.value()
						});
						
						self.defaultAttrVO.attrTableRow = object;
						
						self.isDefaultAttr(true);
					};

					/** 查询软件参数 **/
					this.searchSoftwareParams = ko.observable({
						softTypeName: '',
						softwareNm: ''
					});
					
					/** 加载关联软件数据 **/
					this.loadBindedSoftware = function() {
						if (self.currentVO().uuid && self.currentVO().uuid != 'N/A') {
							$.SOFTWARE.getSoftware({scriptUuid: self.currentVO().uuid}, function (data) {
								$.each(data.results, function(i, val) {
									self.softwareTable.push(val);
								});
							});
						}
					};
					
					/** 选择软件弹窗 **/
					this.openBindSoftware = function() {
						
						if (!self.currentVO().softTypeName()) {
							systemMsg.alert('请先选择脚本类型');
							return;
						}
						
						self.searchSoftwareParams().softTypeName = self.currentVO().softTypeName();
						
						self.chooseSoftwareTable.params(this.searchSoftwareParams());
						
						self.isBindSoft(true);
					};

					/** 删除绑定软件 **/
					this.removeBindSoft = function(object, event) {
						console.log(object);
					};
					
					/** 查询软件 **/
					this.searchSoftware = function() {
						console.log(self.searchSoftwareParams());
						this.chooseSoftwareTable.params(this.searchSoftwareParams());
					};
					

					// 脚本类型下拉选择
					this.loadTypeNames = function(params, callback) {
						
						$.SOFT_TYPE.loadSoftTypeList(params, function(data) {
							
							self.typeNames(data);

							if (callback) {
								callback(data);
							}
						});
					};

					// 新增脚本弹窗
					this.add = function() {
						self.currentVO.fromJSON({
							Id : null,
							uuid : 'N/A',
							name : '',
							softTypeName : '',
							newScriptFiles : [],
							updateScriptFiles: [],
							deleteScriptFiles: [],
							newDefaultAttrs: [],
							updateDefaultAttrs: [],
							deleteDefaultAttrs: [],
							newSoftwares: [],
							deleteSoftwares[]
						});
						
						self.fileTable().splice(0, self.fileTable().length);
						self.attrTable().splice(0, self.attrTable().length);
						self.softwareTable().splice(0, self.softwareTable().length);
						
						self.isAdd(true);
					};
					
					/** 验证提交 **/
					this.validSubmit = function() {
						var flag = true;
						
						if (self.currentVO.isValid()) {
							$.each(self.fileTable(), function(i, val) {
								if (!val.path) {
									flag = false;
									
									return flag; 
								}
							});
						} else {
							flag = false;
						}
						
						return flag;
					};
					
					// 保存脚本数据
					this.save = function() {
						
						if (!self.validSubmit()) {
							return;
						}
						
						$.each(self.fileTable(), function(i, val) {
							if (val.uuid) {
								self.currentVO().updateScriptFiles.push(val);
							} else {
								self.currentVO().newScriptFiles.push(val);
							}
						});
						
						$.each(self.attrTable(), function(i, val) {
							if (val.uuid) {
								self.currentVO().updateDefaultAttrs.push(val);
							} else {
								self.currentVO().newDefaultAttrs.push(val);
							}
						});
						
						this.isAdd(false);
					};
					
					if (self.scriptFileVO().fileTableRow.scriptUuid) {
						self.currentVO().updateScriptFiles.remove(self.scriptFileVO().fileTableRow);
						self.currentVO().updateScriptFiles.push(self.scriptFileVO().fileTableRow);
					}
					
					this.remove = function() {
						console.log("removeSelected");
					};
					this.removeOne = function(object, event) {
						console.log(object);
					};

					this.searchParam = ko.observable({
						type : "",
						name : ""
					});
					this.search = function() {
						this.table.params(this.searchParam());
					};

					this.types = ko.observableArray([]);
					
					this.loadTypeNames({});
					
				}
				
				$(document).ready(function() {
					
					var viewModel = new ViewModel();
					
					ko.applyBindings(viewModel, $('#page-content')[0]);
					
					/** 脚本编辑弹窗打开回调 **/
					$("#showScriptModal").on("shown.bs.modal", function() {
						
						viewModel.initUploader();
						
						viewModel.uploader.addButton({
							id : '#picker',
							multiple : false
						});
						
						viewModel.loadSctipFileData();
						
						viewModel.loadDefaultAttrData();
						
						viewModel.loadBindedSoftware();
					});
					
					/** 脚本编辑弹窗关闭回调 **/
					$("#showScriptModal").on("shown.bs.modal", function() {
						// 删除未确认的已上传脚本文件
						
						var filePathStr = '';
						
						$.each(viewModel.fileTable(), function(i, val) {
							if (val.path()) {
								filePathStr += (val.path() + ',');	
							}
						});
						
						if (filePathStr != '') {
							$.SOFT_SCRIPT.deleteScriptFile({"filePathStr": filePathStr}, function(data) {
							});
						}
					})；
					
					
					/** 软件甄选弹窗关闭回调 **/
					$('#showSoftwareModal').on('hidden.bs.modal', function() {
						
						var chosenSoft = viewModel.chooseSoftwareTable.chosenItems();
						
						$.each(chosenSoft, function(i, val) {
							viewModel.softwareTable.push(val);
						});
					});
				});
			});
</script>