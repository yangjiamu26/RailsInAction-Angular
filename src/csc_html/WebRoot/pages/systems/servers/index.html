<div class="bg-light lter b-b wrapper-sm">
  <ol class="breadcrumb">
    <li>当前位置：</li>
    <li>系统</li>
    <li class="active">服务器配置</li>
  </ol>
</div>
<div class='wrapper-md'>
  <div class="nav-tabs-alt bg-white-only">
    <ul class="nav nav-tabs" role="tablist">
      <li class="active" role="presentation">
        <a aria-controls="report" data-toggle="tab" href="#report"  role="tab">集算报表平台配置</a>
      </li>
      <li role="presentation">
        <a aria-controls="ftp" data-toggle="tab" href="#ftp" role="tab">FTP配置</a>
      </li>
      <li role="presentation">
        <a aria-controls="chef" data-toggle="tab" href="#chef" role="tab">Chef配置</a>
      </li>
      <li role="presentation">
        <a aria-controls="email" data-toggle="tab" href="#email" role="tab">邮件服务器配置</a>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane active" id="report" role="tabpanel">
        <div class="panel panel-default">
          <div class="panel-heading"><span class="text-muted">CSC与集算报表平台对接，为自定义报表提供上传报表文件、下载报表文件、删除报表文件、查看报表文件、检测报表文件接口</span></div>
          <div class="panel-body">
            <form class="form-horizontal">
                <div class="form-group">
                    <label class="col-xs-2 control-label" for="">URL地址：</label>
                    <div class="col-xs-6">
                        <input type="text" class="form-control" placeholder="" data-bind="value: server_rep().url">
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>            
                <div class="form-group">
                    <label class="col-xs-2 control-label" for="">用户名：</label>
                    <div class="col-xs-6">
                        <input type="text" class="form-control" placeholder="" data-bind="value: server_rep().user">
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>            
                <div class="form-group">
                    <label class="col-xs-2 control-label" for="">密码：</label>
                    <div class="col-xs-6">
                        <input type="password" class="form-control" placeholder="" data-bind="value: server_rep().password">
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>            
                <div class="form-group">
                    <div class="col-xs-6 col-xs-offset-2">
                        <button class="btn btn-primary" type="button" data-bind="click: $root.reportTest">连接测试</button>
                        <button class="btn btn-info" type="button" data-bind="click: $root.reportSave">保存</button>
                    </div>                 
                </div> 
            </form>
          </div>
        </div>      
      </div>
      
      <div class="tab-pane" id="ftp" role="tabpanel">
        <div class="panel panel-default">
          <div class="panel-heading"><span class="text-muted">通过配置FTP服务器软件库及脚本库的存放目录，可将软件及脚本上传至FTP服务器</span></div>
          <div class="panel-body">
            <form class="form-horizontal" >
                <div class="form-group">
                    <label class="col-xs-2 control-label" for="">服务器地址：</label>
                    <div class="col-xs-6">
                        <input type="text" class="form-control" placeholder="" data-bind="value: server_ftp().url">
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>            
                <div class="form-group">
                    <label class="col-xs-2 control-label" for="">端口：</label>
                    <div class="col-xs-6">
                        <input type="text" class="form-control" placeholder="" data-bind="value: server_ftp().port">
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>            
                <div class="form-group">
                    <label class="col-xs-2 control-label" for="">软件库存放目录：</label>
                    <div class="col-xs-6">
                        <input type="text" class="form-control" placeholder="" data-bind="value: server_ftp().softPath">
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>            
                <div class="form-group">
                    <label class="col-xs-2 control-label" for="">脚本库存放目录：</label>
                    <div class="col-xs-6">
                        <input type="text" class="form-control" placeholder="" data-bind="value: server_ftp().scriptPath">
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>            
                <div class="form-group">
                    <label class="col-xs-2 control-label" for="">用户名：</label>
                    <div class="col-xs-6">
                        <input type="text" class="form-control" placeholder="" data-bind="value: server_ftp().user">
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>                      
                <div class="form-group">
                    <label class="col-xs-2 control-label" for="">密码：</label>
                    <div class="col-xs-6">
                        <input type="password" class="form-control" placeholder="" data-bind="value: server_ftp().password">
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>            
                <div class="form-group">
                    <div class="col-xs-6 col-xs-offset-2">
                        <button class="btn btn-primary" type="button" data-bind="click: $root.ftpTest">连接测试</button>
                        <button class="btn btn-info" type="button" data-bind="click: $root.ftpSave">保存</button>
                    </div>                 
                </div>            
            </form>
          </div>
        </div>      
      </div>
      
      <div class="tab-pane" id="chef" role="tabpanel">
        <div class="panel panel-default">
          <div class="panel-body">
            <form class="form-horizontal">
                <div class="form-group">
                    <label class="col-xs-2 control-label" for="">IP地址：</label>
                    <div class="col-xs-6">
                        <input type="text" class="form-control" placeholder="" data-bind="value: server_chef().url">
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>                  
                <div class="form-group">
                    <label class="col-xs-2 control-label" for="">端口：</label>
                    <div class="col-xs-6">
                        <input type="text" class="form-control" placeholder="" data-bind="value: server_chef().port">
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>                      
                <div class="form-group">
                    <label class="col-xs-2 control-label" for="">用户名：</label>
                    <div class="col-xs-6">
                        <input type="text" class="form-control" placeholder="" data-bind="value: server_chef().user">
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>                      
                <div class="form-group">
                    <label class="col-xs-2 control-label" for="">密码：</label>
                    <div class="col-xs-6">
                        <input type="password" class="form-control" placeholder="" data-bind="value: server_chef().password">
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>            
                <div class="form-group">
                    <div class="col-xs-6 col-xs-offset-2">
                        <button class="btn btn-primary" type="button" data-bind="click: $root.chefTest">连接测试</button>
                        <button class="btn btn-info" type="button" data-bind="click: $root.chefSave">保存</button>
                    </div>                 
                </div>            
            </form>
          </div>
        </div>      
      </div>
      
      <div class="tab-pane" id="email" role="tabpanel">
        <div class="panel panel-default">
          <div class="panel-heading">
              <span class="text-muted">是否启用邮件发送通知</span>
              <label class="i-switch v-middle">
                <input type="checkbox" data-bind="checked: email.active">
                <i></i>
              </label>              
          </div>
          <div class="panel-body">
            <div class="row">
              <div class="col-xs-6">
                  <div class="panel-heading m-b font-bold">邮件发送服务器配置</div>
                  <form class="form-horizontal" data-bind="with: emailVO">      
                      <div class="form-group">
                          <label class="col-xs-4 control-label" for="">服务器名：</label>
                          <div class="col-xs-6">
                              <input type="text" class="form-control" placeholder="" data-bind="value: url">
                          </div>
                          <div class="col-xs-1">
                            <span class="text-danger inline m-l-n m-t-sm">*</span>
                          </div>                    
                      </div>            
                      <div class="form-group">
                          <label class="col-xs-4 control-label" for="">用户名：</label>
                          <div class="col-xs-6">
                              <input type="text" class="form-control" placeholder="" data-bind="value: username">
                          </div>
                          <div class="col-xs-1">
                            <span class="text-danger inline m-l-n m-t-sm">*</span>
                          </div>                    
                      </div>                      
                      <div class="form-group">
                          <label class="col-xs-4 control-label" for="">密码：</label>
                          <div class="col-xs-6">
                              <input type="password" class="form-control" placeholder="" data-bind="value: password">
                          </div>
                          <div class="col-xs-1">
                            <span class="text-danger inline m-l-n m-t-sm">*</span>
                          </div>                    
                      </div>            
                      <div class="form-group">
                          <div class="col-xs-7 col-xs-offset-4">
                              <button class="btn btn-info" type="button" data-bind="click: $root.emailSave">保存</button>
                          </div>                 
                      </div>            
                  </form>                
              </div>
              <div class="col-xs-6" data-bind="with: email_test">
                  <div class="panel-heading m-b font-bold">邮件发送测试</div>
                  <form class="form-horizontal" data-bind="">      
                      <div class="form-group">
                          <label class="col-xs-3 control-label" for="">邮箱：</label>
                          <div class="col-xs-8">
                              <input type="email" class="form-control" placeholder="" data-bind="value: email">
                          </div>                  
                      </div>            
                      <div class="form-group">
                          <label class="col-xs-3 control-label" for="">标题：</label>
                          <div class="col-xs-8">
                              <input type="text" class="form-control" placeholder="" data-bind="value: title">
                          </div>                  
                      </div>                      
                      <div class="form-group">
                          <label class="col-xs-3 control-label" for="">内容：</label>
                          <div class="col-xs-8">
                              <textarea cols="5" rows="5" class="form-control" data-bind="value: content"></textarea>
                          </div>                 
                      </div>            
                      <div class="form-group">
                          <div class="col-xs-8 col-xs-offset-3">
                              <button class="btn btn-primary" type="button" data-bind="click: $root.emailTest">发送测试</button>
                          </div>                 
                      </div>            
                  </form>
              </div>
            </div>
          </div>
        </div>      
      </div>

    </div>

  </div>
</div>

<!-- page specific plugin scripts -->
<script type="text/javascript">
  
  var scripts = [ null];
  $('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
    function ViewModel(){
    	var self = this;	
    	this.isAdd = ko.observable(false);
      this.server_rep = ko.observable({
    	  url:ko.observable(),
    	  user:ko.observable(),
      	  password:ko.observable()
      });
      
      this.server_ftp = ko.observable({
    	  url:ko.observable(''),
    	  port:ko.observable(''),
    	  softPath:ko.observable(''),
    	  scriptPath:ko.observable(''),
    	  user:ko.observable(''),
      	  password:ko.observable('')
      });
      
      this.server_chef = ko.observable({
    	  url:ko.observable(''),
    	  port:ko.observable(''),
    	  user:ko.observable(''),
      	  password:ko.observable('')
      });
      
      
      this.emailVO= ko.observable({
    	  "active": false,
          "url": "192.168.5.9",
          "username": "username",
          "password": "password"
      })
      this.email_test = ko.observable({
          "email": "wulj@winhong.com",
          "title": "你好",
          "content": "大家好"
        })
	
        //初始化数据
      this.initData = function(){
    	  
    	  csc.rest.get('api/v5.0.0/serverConf/repoConfGet', function(data) {
    		  //debugger;
    		  if(csc.util.isNotNull(data)){
	    		  //集算
	    		  //debugger;
	    		  var test = data.url;
	    		  self.server_rep().url(data.url);
	    		  self.server_rep().user(data.user);
    		  }
    	  });
    	  
    	  
    	  csc.rest.get('api/v5.0.0/serverConf/ftpConfGet', function(data) {
    		  if(csc.util.isNotNull(data)){
	    		  //ftp
	    		  self.server_ftp().url(data.url);
	    		  self.server_ftp().port(data.port);
	    		  self.server_ftp().softPath(data.softPath);
	    		  self.server_ftp().scriptPath(data.scriptPath);
	    		  self.server_ftp().user(data.user);
    		  }
    	  });
    	  
    	  
    	  csc.rest.get('api/v5.0.0/serverConf/chefConfGet', function(data) {
    		  if(csc.util.isNotNull(data)){
	    		  //chef
	    		  self.server_chef().url(data.url);
	    		  self.server_chef().port(data.port);
	    		  self.server_chef().user(data.user);
    		  }
    	  });
 	  }
 	  this.initData();
	
 	  //连接集算测试
      this.reportTest = function(){
          self.checkCollRepoConnect();        
      }
        this.checkCollRepoConnect = function(){
        	var url = /^(http|https):\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"\"])*$/;
        	if(csc.util.isNull(self.server_rep().url())||!url.test(self.server_rep().url())){
		    	alert("请输入正确的url地址！");
		    }else if(csc.util.isNull(self.server_rep().user())||csc.util.isNull(self.server_rep().password())){
		    	alert("请输入用户名或密码！");
		    }else{
		    	var putBody = {};
		    	putBody.url = self.server_rep().url();
		    	putBody.user = self.server_rep().user();
		    	putBody.password = self.server_rep().password();
	      		//putBody.serverName = "report";
	      		//putBody.serverConf = "url:"+self.server_rep().url()+",user:"+self.server_rep().user()+",password:"+self.server_rep().password();
	      		  csc.rest.put("api/v5.0.0/serverConf/repoConn",putBody,function(data){
	      			  if(data && data.msg) {
	    	      			alert(data.msg + '！');
	    	      		}
	      		  });
		    }
        }
 	  //保存集算配置
      this.reportSave = function(){
	  	  var url = /^(http|https):\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"\"])*$/;
			if(csc.util.isNull(self.server_rep().url())||!url.test(self.server_rep().url())){
		    	alert("请输入正确的url地址！");
		    }else if(csc.util.isNull(self.server_rep().user())||csc.util.isNull(self.server_rep().password())){
		    	alert("请输入用户名或密码！");
		    }else{
		    	var postBody = {};
		    	postBody.url = self.server_rep().url();
		    	postBody.user = self.server_rep().user();
		    	postBody.password = self.server_rep().password();
			  	//postBody.serverName = "report";
			  	//postBody.serverConf = "url:"+self.server_rep().url()+",user:"+self.server_rep().user()+",password:"+self.server_rep().password();
		    	csc.rest.post('api/v5.0.0/serverConf/reportSave',postBody , function(){
		            self.isAdd(false);
		            alert("保存配置成功！");
		            })
		    }
        
      }
      
	//连接ftp测试
      this.ftpTest = function(){
        self.checkFtpConnect();
        
      }
      this.checkFtpConnect = function(){
    	  var ipReg = /^(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9])\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])/;
	      	var port =  /^\d{1,5}$/;//端口号正则表达式，0-65535
			if(csc.util.isNull(self.server_ftp().url())||!ipReg.test(self.server_ftp().url())){			//判断ip地址格式是否正确
	        	alert("请输入正确的服务器地址！");
	        }else if(csc.util.isNull(self.server_ftp().port())||!port.test(self.server_ftp().port())){		//判断端口号格式是否正确
	        	alert("请输入正确的端口号！");
	        }else if(csc.util.isNull(self.server_ftp().softPath())){
	        	alert("请输入软件库地址！");
	        }else if(csc.util.isNull(self.server_ftp().scriptPath())){
	        	alert("请输入脚本库地址！");
	        }else if(csc.util.isNull(self.server_ftp().user())||csc.util.isNull(self.server_ftp().password())){
	        	alert("请输入用户名或密码！");
	        }else{
	      	  var putBody = {};
		      	putBody.url = self.server_ftp().url();
		      	putBody.user = self.server_ftp().user();
		      	putBody.port = self.server_ftp().port();
		      	putBody.password = self.server_ftp().password();
	    	  //putBody.serverName = "ftp";
	    	  //putBody.serverConf = "url:"+self.server_ftp().url()+",port:"+self.server_ftp().port()+",softPath:"+self.server_ftp().softPath()+",scriptPath:"+self.server_ftp().scriptPath()+",user:"+self.server_ftp().user()+",password:"+self.server_ftp().password();
	    		  csc.rest.put('api/v5.0.0/serverConf/ftpConn', putBody ,function(data){
	    			  if(data && data.msg){
	  	      			alert(data.msg + '！');
	  	      		}
	    		  });

	        }
      }
      //保存ftp配置
      this.ftpSave = function(){
    	  var ipReg = /^(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9])\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])/;
	      	var port =  /^\d{1,5}$/;//端口号正则表达式，0-65535
			if(csc.util.isNull(self.server_ftp().url())||!ipReg.test(self.server_ftp().url())){			//判断ip地址格式是否正确
	        	alert("请输入正确的服务器地址！");
	        }else if(csc.util.isNull(self.server_ftp().port())||!port.test(self.server_ftp().port())){		//判断端口号格式是否正确
	        	alert("请输入正确的端口号！");
	        }else if(csc.util.isNull(self.server_ftp().softPath())){
	        	alert("请输入软件库地址！");
	        }else if(csc.util.isNull(self.server_ftp().scriptPath())){
	        	alert("请输入脚本库地址！");
	        }else if(csc.util.isNull(self.server_ftp().user())||csc.util.isNull(self.server_ftp().password())){
	        	alert("请输入用户名或密码！");
	        }else{
	        	var postBody = {};
	        	postBody.url = self.server_ftp().url();
	        	postBody.port = self.server_ftp().port();
	        	postBody.softPath = self.server_ftp().softPath();
	        	postBody.scriptPath = self.server_ftp().scriptPath();
	        	postBody.user = self.server_ftp().user();
	        	postBody.password = self.server_ftp().password();
	         	//postBody.serverName = "ftp";
	         	//postBody.serverConf = "url:"+self.server_ftp().url()+",port:"+self.server_ftp().port()+",softPath:"+self.server_ftp().softPath()+",scriptPath:"+self.server_ftp().scriptPath()+",user:"+self.server_ftp().user()+",password:"+self.server_ftp().password();
	        	csc.rest.post('api/v5.0.0/serverConf/ftpSave', postBody , function(){
	                  self.isAdd(false);
	                  alert("保存配置成功！");
	                })
	        }
      }   
      
	  //chef测试
      this.chefTest = function(){
    	  self.checkChefConnect();
      }
      this.checkChefConnect = function(){
    	  var ipReg = /^(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9])\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])/;
        	var port =  /^\d{1,5}$/;//端口号正则表达式
        	 if(csc.util.isNull(self.server_chef().url())||!ipReg.test(self.server_chef().url())){		//判断ip地址格式是否正确
        	   alert("请输入正确的ip地址！");
           }else if(csc.util.isNull(self.server_chef().port())||!port.test(self.server_chef().port())){		//判断端口号格式是否正确
        	   alert("请输入正确的端口号！");
           }else if(csc.util.isNull(self.server_chef().user())||csc.util.isNull(self.server_chef().password())){
        	   alert("请输入用户名或密码！");
           }else{
        	   var putBody = {};
        	   putBody.url = self.server_chef().url();
        	   putBody.port = self.server_chef().port();
        	   putBody.user = self.server_chef().user();
        	   putBody.password = self.server_chef().password();
         	  //putBody.serverName = "chef";
         	  //putBody.serverConf = "url:"+self.server_chef().url()+",port:"+self.server_chef().port()+",user:"+self.server_chef().user()+",password:"+self.server_chef().password();
         		  csc.rest.put("api/v5.0.0/serverConf/chefConn",putBody,function(data){
         			  if(data && data.resultMsg) {
       	      			alert(data.resultMsg + '！');
       	      		}
         		  });
           }
      }
	  //保存chef连接
      this.chefSave = function(){
        var ipReg = /^(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9])\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])/;
      	var port =  /^\d{1,5}$/;//端口号正则表达式
      	 if(csc.util.isNull(self.server_chef().url())||!ipReg.test(self.server_chef().url())){		//判断ip地址格式是否正确
      	   alert("请输入正确的ip地址！");
         }else if(csc.util.isNull(self.server_chef().port())||!port.test(self.server_chef().port())){		//判断端口号格式是否正确
      	   alert("请输入正确的端口号！");
         }else if(csc.util.isNull(self.server_chef().user())||csc.util.isNull(self.server_chef().password())){
      	   alert("请输入用户名或密码！");
         }else{
        	 var postBody = {};
        	 postBody.url = self.server_chef().url();
        	 postBody.port = self.server_chef().port();
        	 postBody.user = self.server_chef().user();
        	 postBody.password = self.server_chef().password();
         	 //postBody.serverName = "chef";
         	 //postBody.serverConf = "url:"+self.server_chef().url()+",port:"+self.server_chef().port()+",user:"+self.server_chef().user()+",password:"+self.server_chef().password();
        	 csc.rest.post('api/v5.0.0/serverConf/chefSave', postBody, function(data){
                 self.isAdd(false);
                 alert("保存配置成功！");
             })
         }
      }
	  //TODO 邮箱相关
      this.emailTest = function(object){
      }
      this.emailSave = function(object){
      };
      
    }

    ko.applyBindings(new ViewModel(), $('#page-content')[0]); 
  });
</script>