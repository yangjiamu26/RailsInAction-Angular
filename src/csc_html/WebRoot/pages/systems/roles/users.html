<link href="assets/lib/zTree/css/ibos/ibos.css" rel="stylesheet"
	type="text/css" />
<div class="bg-light lter b-b wrapper-sm">
	<ol class="breadcrumb">
		<li>当前位置：</li>
		<li>系统</li>
		<li><a href="#pages/systems/roles/index">角色管理</a></li>
		<li class="active">角色分配用户</li>
	</ol>
</div>
<div class="wrapper">
	<a class="btn btn-sm btn-default" href="#pages/systems/roles/index"><i
		class="fa fa-arrow-left"></i> 返回</a>
</div>
<div class='wrapper'>
	<div class="row">
		<div class="col-xs-3">
			<div class="bg-white">
				<ul class="nav nav-tabs" role="tablist">
					<li role="presentation" class="active"><a href="#tab1"
						aria-controls="home" role="tab" data-toggle="tab">组织架构</a></li>
				</ul>
				<div class="tab-content">
					<div role="tabpanel" class="tab-pane active" id="tab1">
						<ul class="ztree" id="orgZtree"></ul>
					</div>
				</div>
			</div>
		</div>
		<div class="col-xs-9">
			<div class="wrapper bg-white clearfix">
				<div class='col-xs-5' data-bind="with:tableLeft">
					<p>预分配用户：</p>
					<table class="table table-striped table-bordered">
						<thead>
							<tr>
								<th>选择</th>
								<th>用户名</th>
								<th>用户状态</th>
							</tr>
						</thead>
						<tbody>
							<tr data-bind="visible: showNoData">
								<td colspan=5 class="aligncenter">This table has no data.</td>
							</tr>
							<!-- ko foreach: {data: pagedRows, as: '$row'}  -->
							<tr>
								<td>
									<div class="checkbox">
										<label class="i-checks"> <input type="checkbox"
											value="" data-bind="checkedValue: $data, checked: $parent.chosenItems"> <i></i>
										</label>
									</div>
								</td>
								<td data-bind="text: $row.name"></td>
								<td><span class="label label-success">有效</span></td>
							</tr>
							<!-- /ko -->
						</tbody>
					</table>
				</div>

				<div class="col-xs-1">
					<button class="btn btn-block btn-default" style="margin-top: 150px"
						data-bind="click: addRoleUsers">
						<i class="fa fa-arrow-right"></i>
					</button>
					<button class="btn btn-block btn-default"
						data-bind="click: removeRoleUsers">
						<i class="fa fa-arrow-left"></i>
					</button>
				</div>
				<div class='col-xs-5' data-bind="with:tableRight">
					<p>角色已分配用户：</p>
					<table class="table table-striped table-bordered">
						<thead>
							<tr>
								<th>选择</th>
								<th>用户名</th>
								<th>用户状态</th>
							</tr>
						</thead>
						<tbody>
							<tr data-bind="visible: showNoData">
								<td colspan=5 class="aligncenter">This table has no data.</td>
							</tr>
							<!-- ko foreach: {data: pagedRows, as: '$row'}  -->
							<tr>
								<td>
									<div class="checkbox">
										<label class="i-checks"> <input type="checkbox"
											data-bind="checkedValue: $data, checked: $parent.chosenItems"> <i></i>
										</label>
									</div>
								</td>
								<td data-bind="text: $row.name"></td>
								<td><span class="label label-success">有效</span></td>
							</tr>
							<!-- /ko -->
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	var scripts = [ null, 'assets/lib/zTree/js/jquery.ztree.core.js', null ]
	$('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
        var roleId = args.roleId;
		function ViewModel() {
			var self = this;
			var setting = {
				view : {
					showIcon : false,
					showLine : false
				},
				callback : {
					onClick: search
				}
			};
			var searchParamLeft
			var searchParamRight;
			var orgId = '';
			function search(event, treeId, treeNode) {
				if(treeNode.code == '0'){
				    searchParamLeft = {
				    		orgId : "",
				    		userType : treeNode.userType
				    		};
				    searchParamRight = {
							orgId : "",
							roleId : roleId,
							userType : treeNode.userType
						};
				}else{
				    searchParamLeft = {
							orgId : treeNode.code,
							userType : treeNode.userType
							};
				    searchParamRight = {
							orgId : treeNode.code,
							roleId : roleId,
							userType : treeNode.userType
						};
				}
					
			    orgId = treeNode.code;
	            self.tableLeft.params(searchParamLeft);
	            self.tableRight.params(searchParamRight);
	            
			   // alert(treeNode.code + ", " + treeNode.name);
			};
			
			$(document).ready(function() {
				csc.rest.get('api/v5.0.0/uap/organizations', function(data) {
					$.fn.zTree.init($("#orgZtree"), setting, data);
				})
			});
			
			
			this.addRoleUsers = function() {
				var param = {};
				var temps = '';
				$.each(self.tableLeft.chosenItems(), function(i,val){
					temps += (val.id + ',');
			  	});   
				csc.rest.get('api/v5.0.0/uap/users?roleId='+roleId,
					    function(data) {
						  for(var i=0;i<data.results.length;i++){
							  temps += (data.results[i].id + ',');
						}
						    param.name = temps;
						    csc.rest.put('api/v5.0.0/uap/'+roleId , param,
									function() {
								      self.tableLeft.refreshData();
								      self.tableRight.refreshData();
									});
					});  
			};
			this.removeRoleUsers = function() {
				var param = {};
				var check = '';
				
				$.each(self.tableRight.chosenItems(), function(i,val){
					check += (val.id + ',');
			  	}); 
		
				csc.rest.get('api/v5.0.0/uap/users?roleId='+roleId,
					    function(data) {
					      param.name = getCharge(check,data);
						  csc.rest.put('api/v5.0.0/uap/'+roleId, param,
									function() {
								      self.tableLeft.refreshData();
								      self.tableRight.refreshData();
									});
					}); 
				
				
			};
			
			function getCharge(check,data) {
			  var userId = [];
			  var temps = '';
		      userId = check.split(',');
		      
			  for(var i=0;i<data.results.length;i++){
				  if(determine(userId,data.results[i].id)){
					  temps += (data.results[i].id + ',');
				  }
			  }
			  return temps;
			}
			
			function determine(userId,data){
				for(var j=0;j<userId.length-1;j++){
					if(data == userId[j]){
						return false;
					}
				}
				return true;
			}

            //初始化预分配表格
			this.tableLeft = new DataTable([], {
				perPage : 15,
				path : '/csc/api/v5.0.0/uap/users'
			});
			//初始化已分配表格
			this.tableRight = new DataTable([], {
				path : '/csc/api/v5.0.0/uap/users?roleId='+ roleId
			});
            self.tableRight.params(searchParamRight);

		}
		ko.applyBindings(new ViewModel(), $('#page-content')[0]);
	});
</script>