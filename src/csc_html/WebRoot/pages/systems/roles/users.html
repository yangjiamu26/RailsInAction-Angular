<link href="assets/lib/zTree/css/ibos/ibos.css" rel="stylesheet"
	type="text/css" />
<div class="bg-light lter b-b wrapper-sm">
	<ol class="breadcrumb">
		<li>当前位置：</li>
		<li>系统</li>
		<li><a href="#pages/systems/roles/index">角色管理</a></li>
		<li class="active">角色分配用户</li>
	</ol>
</div>
<div class="wrapper">
	<a class="btn btn-sm btn-default" href="#pages/systems/roles/index"><i
		class="fa fa-arrow-left"></i> 返回</a>
</div>
<div class='wrapper'>
	<div class="row">
		<div class="col-xs-3">
			<div class="bg-white">
				<ul class="nav nav-tabs" role="tablist">
					<li role="presentation" class="active"><a href="#tab1"
						aria-controls="home" role="tab" data-toggle="tab">组织架构</a></li>
				</ul>
				<div class="tab-content">
					<div role="tabpanel" class="tab-pane active" id="tab1">
						<ul class="ztree" id="orgZtree"
							data-bind="value:searchParamLeft().orId"></ul>
					</div>
				</div>
			</div>
		</div>
		<div class="col-xs-9">
			<div class="wrapper bg-white clearfix">
				<div class='col-xs-5' data-bind="with:tableLeft">
					<p>预分配用户：</p>
					<table class="table table-striped table-bordered">
						<thead>
							<tr>
								<th>选择</th>
								<th>用户名</th>
								<th>用户状态</th>
							</tr>
						</thead>
						<tbody>
							<tr data-bind="visible: showNoData">
								<td colspan=5 class="aligncenter">This table has no data.</td>
							</tr>
							<!-- ko foreach: {data: pagedRows, as: '$row'}  -->
							<tr>
								<td>
									<div class="checkbox">
										<label class="i-checks"> <input type="checkbox"
											value="" data-bind="checkedValue: $data, checked: $parent.chosenItems"> <i></i>
										</label>
									</div>
								</td>
								<td data-bind="text: $row.name"></td>
								<td><span class="label label-success">有效</span></td>
							</tr>
							<!-- /ko -->
						</tbody>
					</table>
				</div>

				<div class="col-xs-1">
					<button class="btn btn-block btn-default" style="margin-top: 150px"
						data-bind="click: addRoleUsers">
						<i class="fa fa-arrow-right"></i>
					</button>
					<button class="btn btn-block btn-default"
						data-bind="click: removeRoleUsers">
						<i class="fa fa-arrow-left"></i>
					</button>
				</div>
				<div class='col-xs-5' data-bind="with:tableRight">
					<p>角色已分配用户：</p>
					<table class="table table-striped table-bordered">
						<thead>
							<tr>
								<th>选择</th>
								<th>用户名</th>
								<th>用户状态</th>
							</tr>
						</thead>
						<tbody>
							<tr data-bind="visible: showNoData">
								<td colspan=5 class="aligncenter">This table has no data.</td>
							</tr>
							<!-- ko foreach: {data: pagedRows, as: '$row'}  -->
							<tr>
								<td>
									<div class="checkbox">
										<label class="i-checks"> <input type="checkbox"
											data-bind="checkedValue: $data, checked: $parent.chosenItems"> <i></i>
										</label>
									</div>
								</td>
								<td data-bind="text: $row.name"></td>
								<td><span class="label label-success">有效</span></td>
							</tr>
							<!-- /ko -->
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	var scripts = [ null, 'assets/lib/zTree/js/jquery.ztree.core.js', null ]
	$('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
        console.log(args);
        var roleId = args.roleId;
		function ViewModel() {
			var self = this;

			var setting = {
				view : {
					showIcon : false,
					showLine : false
				},
				callback : {
					onClick: search
				}
			};
		
			
			function search(event, treeId, treeNode) {
				console.log(treeNode.code);
				var searchParamLeft = {orgId : treeNode.code};
				
				var searchParamRight = {
						orgId : treeNode.code,
						roleId : roleId 
					};
	            
	            self.tableLeft.params(searchParamLeft);
	            self.tableRight.params(searchParamRight);
	            
			   // alert(treeNode.code + ", " + treeNode.name);
			};
			
			$(document).ready(function() {
				csc.rest.get('api/v5.0.0/uap/organizations', function(data) {
					$.fn.zTree.init($("#orgZtree"), setting, data);
				})
			});
			
			
			this.addRoleUsers = function() {
				
				var ids = '';
				var params = [];
				
				$.each(self.tableLeft.chosenItems(), function(i,val){
					params.push({roleId:roleId,id:val.id});
			  	});   
				csc.rest.get('api/v5.0.0/uap/users',
				    function(data) {
					  console.log(data);
					  for(var i=0;i<data.results.length;i++){
					  params.push({roleId:roleId,id:data.results[i].id});
					}
					console.log(params);
				});
				//var params = {ids: ids.substring(0, ids.length-1)};
				csc.rest.put('api/v5.0.0/uap/users/' + roleId , params,
					function() {
					  self.tableLeft.refreshData();
					  self.tableRight.refreshData();
				});
				
			};
			
			this.removeRoleUsers = function() {
				var ids = '';
				var params = [];
				$.each(self.tableRight.chosenItems(), function(i,val){
					//ids += (val.id + ',');
					console.log(val);
					params.push({roleId:roleId,id:val.id});
					
			  	}); 
				csc.rest.get('api/v5.0.0/uap/users',
					    function(data) {
						  console.log(data);
						  for(var i=0;i<data.results.length;i++){
						  params.push({roleId:roleId,id:data.results[i].id});
						}
						console.log(params);
					});
				//var params = {ids: ids.substring(0, ids.length-1)};
				csc.rest.put('api/v5.0.0/uap/users' + roleId , params,
						function() {
					      self.tableLeft.refreshData();
					      self.tableRight.refreshData();
						});
			}
            
			//获取该组织下角色未分配的用户
            this.searchParamLeft = ko.observable({
				orgId : "",
			});
            /* //根据组织id,角色id获取该角色在该组织下已分配的用户
			this.searchParamRight = ko.observable({
				orgId : "",
				roleId: "",
			}); */
			
			//点击组织按钮后刷新角色分配表格
            /*function search() {
				this.tableLeft.params(this.searchParamLeft());
				this.tableRight.params(this.searchParamRight())
			}; */

			this.tableLeft = new DataTable([], {
				path : '/csc/api/v5.0.0/uap/roleUsers'
			});
			this.tableRight = new DataTable([], {
				path : '/csc/api/v5.0.0/uap/roleUsers'
			});

		}
		ko.applyBindings(new ViewModel(), $('#page-content')[0]);
	});
</script>