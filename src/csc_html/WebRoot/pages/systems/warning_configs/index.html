<div class="bg-light lter b-b wrapper-sm">
  <ol class="breadcrumb">
    <li>当前位置：</li>
    <li>系统</li>
    <li class="active">告警配置</li>
  </ol>
</div>
<div class='wrapper-md'>
    <div class="panel panel-default b-blue">

      <div class="row wrapper">
          <div class="col-xs-3">
            <div class="input-group">
              <span class="input-group-addon">告警类型</span>
              <select class="form-control input-sm" data-bind="value: searchParam().type">
                <option value="">全部</option>
                <option value="系统告警">系统告警</option>
                <option value="VDC配额告警">VDC配额告警</option>
              </select>
            </div>
          </div>
          <div class="col-xs-3">
            <div class="input-group">
               <span class="input-group-addon">告警指标</span>
               <input type="text" value="" class="form-control input-sm" data-bind="value: searchParam().target">
            </div>        
          </div>
          <div class="col-xs-1">
            <button class="btn btn-default btn-sm" type="submit" data-bind="click: search">搜索</button>       
          </div>          
      </div>

      <div class='table-responsive' data-bind="with: table">
        <table class='table table-striped table-hover'>
          <thead>
            <tr>
              <th>告警类型</th>
              <th>告警指标</th>
              <th>告警临界值(%)</th>
              <th>操作</th></tr>
          </thead>
          <tbody>
            <tr data-bind="visible: showNoData">
              <td colspan=4 class="aligncenter">
                	暂无数据
              </td>
            </tr>
            <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
            <tr>
              <td data-bind="text:type">CSC平台告警</td>
              <td data-bind="text:target">CPU</td>
              <td data-bind="text:threshold">80</td>
              <td>
                <a data-bind="click: $root.edit">修改</a>
              </td>
            </tr>
            <!-- /ko -->
          </tbody>
        </table>
      </div>
      <footer class="panel-footer"
			data-bind="with: table, visible: table.pages() > 1">
			<ul class="pagination">
				<li data-bind="css: leftPagerClass, click: gotoPage(1)"><a
					href="#">首页</a></li>
				<li data-bind="css: leftPagerClass, click: prevPage"><a
					href="#">&laquo;</a></li>
				<li><a href="#" data-bind="text: currentPage"></a></li>
				<li data-bind="css: rightPagerClass, click: nextPage"><a
					href="#">&raquo;</a></li>
				<li data-bind="css: rightPagerClass, click: gotoPage(pages())">
					<a href="#">末页</a>
				</li>
				<li class="page-control-li">
					<div class="input-group form-group-sm">
						<input type="text" class="form-control"
							data-bind="value: targetPage" />
						<div class="input-group-btn">
							<a href="#" class="btn btn-sm btn-default"
								data-bind="click: gotoTargetPage()">跳转</a>
						</div>
					</div>
					<div class="page-info-div" data-bind="text: recordsText"></div>
				</li>
			</ul>
		</footer>
    </div>    
    
</div>

<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isEdit }">
    <div class='modal-dialog modal-md' role='document'>
        <div class='modal-content'>
            <div class='modal-header'>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>修改告警配置</h3>
            </div>
            <div class='modal-body form-horizontal' >
                <div class="form-group">
                    <label class="col-xs-3 control-label" for="">告警类型：</label>
                    <div class="col-xs-8">
                        <input type="text" class="form-control" value="VDC资源告警" data-bind="value: currentVO().type" disabled>
                    </div>                    
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>
                <div class="form-group">
                    <label class="col-xs-3 control-label" for="">告警指标：</label>
                    <div class="col-xs-8">
                        <input type="text" class="form-control" value="DISK" data-bind="value: currentVO().target" disabled>
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>
                <div class="form-group">
                    <label class="col-xs-3 control-label" for="">告警临界值：</label>
                    <div class="col-xs-8">
                        <div class="input-group">
                          <input type="text" class="form-control" value="10" data-bind="value: currentVO().threshold">
                          <span class="input-group-addon">%</span>
                        </div>                    
                    </div>
                    <div class="col-xs-1">
                      <span class="text-danger inline m-l-n m-t-sm">*</span>
                    </div>                    
                </div>

            </div>
            <div class='modal-footer'>
                <input type="button" class="btn btn-info" value="确定" data-bind="click: update"/>
                <button name="button" type="button" class="btn btn-default btn btn-default" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>

<!-- page specific plugin scripts -->
<script type="text/javascript">
  var scripts = [null, "api/systems/alarmConfig/alarmConfig.js"]
  $('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {

    function ViewModel(){
      this.isEdit = ko.observable(false);

      var self = this;
      this.currentVO = ko.validatedObservable({});
      
	  //显示修改dialog
      this.edit = function(object,event){
		self.currentVO({
			uuid: object.uuid,//uuid，保存的时候会有这个
	        type    :   object.type,
	        target	:	object.target,
	        threshold	:	ko.observable(object.threshold).extend({ required: true, digit: true ,min:0,max:100 }),
		});
		  
        self.isEdit(true);
      };
      
      this.update = function(){
    	  $.ALARM_CONFIG.modifyAlarmConfig(self.currentVO().uuid,self.currentVO.toJSON(),function(data){
    		  if(data.uuid){
    			  alert('修改成功');
    			  self.isEdit(false);
    			  self.table.refreshData();//刷新列表          
    		  }
    	  });
    	  
      }
      
      
      this.searchParam = ko.observable({
        type: "",
        target: ""
      });

      this.search = function(){
        this.table.params(this.searchParam());
      };

      this.table = new DataTable([], {perPage:10,path: 'api/v5.0.0/alarmConfigs'});
    }

    ko.applyBindings(new ViewModel(), $('#page-content')[0]);

  });
</script>