<div class="bg-light lter b-b wrapper-sm">
    <ol class="breadcrumb">
        <li>当前位置：</li>
        <li>系统</li>
        <li class="active">通知</li>
    </ol>
</div>
<div class='wrapper-md'>
    <div class="nav-tabs-alt bg-white-only b b-blue">
        <ul id="headTab" class="nav nav-tabs" role="tablist">
            <li class="active" role="presentation">
                <a id="sysTab" aria-controls="system" data-toggle="tab" href="#system" role="tab">系统通知</a>
            </li>
            <li role="presentation">
                <a aria-controls="message" data-toggle="tab" href="#message" role="tab">短信通知</a>
            </li>
            <li role="presentation">
                <a aria-controls="email" data-toggle="tab" href="#email" role="tab">邮件通知</a>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane active" id="system" role="tabpanel">

                <div class="row wrapper">
                    <div class="col-xs-1">
                        <button class="btn btn-sm btn-info" data-bind="click: read">设为已阅</button>
                    </div>
                    <div class="col-xs-3">
                        <div class="input-group">
                            <span class="input-group-addon">通知类型</span>
                            <select class="form-control input-sm" data-bind="value: searchParam().noticeCategory">
                                <option value="null" selected="selected">所有</option>
                                <option value="SerOutExpire">服务过期提醒</option>
                                <option value="ResExpire">资源到期提醒</option>
                                <option value="ResToDelete">资源删除待办</option>
                                <option value="ResOutExpire">资源过期提醒</option>
                                <option value="ResConstrSuccess">资源施工成功</option>
                                <option value="ResConstrFail">资源施工失败</option>
                                <option value="ResToConstr">资源待施工</option>
                                <option value="ConstrStopNotice">施工终止通知</option>
                                <option value="OrderAuditPass">订单审核通过</option>
                                <option value="OrderAuditFail">订单审核不通过</option>
                                <option value="OrderCancleNotice">订单取消通知</option>
                                <option value="SoftwareToConstr">软件待施工</option>
                                <option value="SoftwareConstrSuccess">软件施工成功</option>
                                <option value="SoftwareConstrFail">软件施工失败</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                            <input type="text" class="form-control input-sm" id="system_daterange"
                                   data-bind="value: searchParam().noticeTime">
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="input-group">
                            <span class="input-group-addon">通知详情</span>
                            <input type="text" value="" class="form-control input-sm"
                                   data-bind="value: searchParam().noticeContent">
                        </div>
                    </div>
                    <div class="col-xs-2">
                        <button class="btn btn-sm" type="button" data-bind="click: reset">重置</button>
                        <button class="btn btn-default btn-sm" type="submit" data-bind="click: search">搜索</button>
                    </div>

                </div>
                <div class="table-responsive" data-bind="with: table">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>
                                <div class="checkbox">
                                    <label class="i-checks">
                                        <input type="checkbox" data-bind="checked: isSelectedAll">
                                        <i></i>
                                    </label>
                                </div>
                            </th>
                            <th style="width: 10%;">通知标题</th>
                            <th style="width: 10%;">通知类别</th>
                            <th style="width: 40%;">通知详情</th>
                            <th>通知时间</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr data-bind="visible: showNoData">
                            <td colspan=7 class="aligncenter">
                                	暂无数据
                            </td>
                        </tr>
                        <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
                        <tr>
                            <td>
                                <div class="checkbox">
                                    <label class="i-checks">
                                        <input type="checkbox"
                                               data-bind="disable:noticeState=='YesRealize',checkedValue: $data, checked: $parent.chosenItems">
                                        <i></i>
                                    </label>
                                </div>
                            </td>
                            <td data-bind="text:noticeTitle"></td>
                            <td>
                            	<span class="" data-bind="if:noticeCategory=='SerOutExpire'">服务过期提醒</span>
                            	<span class="" data-bind="if:noticeCategory=='ResExpire'">资源到期提醒</span>
                            	<span class="" data-bind="if:noticeCategory=='ResToDelete'">资源删除待办</span>
                            	<span class="" data-bind="if:noticeCategory=='ResOutExpire'">资源过期提醒</span>
                            	<span class="" data-bind="if:noticeCategory=='ResConstrSuccess'">资源施工成功</span>
                            	<span class="" data-bind="if:noticeCategory=='ResConstrFail'">资源施工失败</span>
                            	<span class="" data-bind="if:noticeCategory=='ResToConstr'">资源待施工</span>
                            	<span class="" data-bind="if:noticeCategory=='ConstrStopNotice'">施工终止通知</span>
                            	<span class="" data-bind="if:noticeCategory=='OrderAuditPass'">订单审核通过</span>
                            	<span class="" data-bind="if:noticeCategory=='OrderAuditFail'">订单审核不通过</span>
                            	<span class="" data-bind="if:noticeCategory=='OrderCancleNotice'">订单取消通知</span>
                            	<span class="" data-bind="if:noticeCategory=='SoftwareToConstr'">软件待施工</span>
                            	<span class="" data-bind="if:noticeCategory=='SoftwareConstrSuccess'">软件施工成功</span>
                            	<span class="" data-bind="if:noticeCategory=='SoftwareConstrFail'">软件施工失败</span>
                            </td> 
                            <td data-bind="text:noticeContent"></td>
                            <td data-bind="text:noticeTime"></td>
                            <td>
                                <span class="label label-success" data-bind="if:noticeState=='YesRealize'">已阅</span>
                                <span class="label label-danger" data-bind="if:noticeState=='NoRealize'">未阅</span>
                            </td>
                            <td>
                                <a data-bind="click: $root.readOne,visible:noticeState=='NoRealize'">设为已阅</a>
                            </td>
                        </tr>
                        <!-- /ko -->
                        </tbody>
                    </table>
                </div>
                <footer class="panel-footer" data-bind="with: table, visible: table.pages() > 1">
                    <ul class="pagination">
                        <li data-bind="css: leftPagerClass, click: prevPage">
                            <a href="#">&laquo;</a>
                        </li>
                        <!-- ko foreach: {data: (new Array(pages()))} -->
                        <li data-bind="css: $parent.pageClass($index() + 1)">
                            <a href="#" data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
                        </li>
                        <!-- /ko -->
                        <li data-bind="css: rightPagerClass, click: nextPage">
                            <a href="#">&raquo;</a>
                        </li>
                    </ul>
                </footer>

            </div>
            <div class="tab-pane" id="message" role="tabpanel">

                <div class="row wrapper">
                    <div class="col-xs-3">
                        <div class="input-group">
                            <span class="input-group-addon">通知类型</span>
                            <select class="form-control input-sm" data-bind="value: searchParam().noticeCategory">
                                <option value="null" selected="selected">全部</option>
                                <option value="SerOutExpire">资源到期提醒</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="input-group">
                            <span class="input-group-addon">发送结果</span>
                            <select class="form-control input-sm" data-bind="value: searchParam().noticeSendState">
                                <option value="null" selected="selected">全部</option>
                                <option value="SendSuccess">发送成功</option>
                                <option value="SendFailed">发送失败</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="input-group">
                            <span class="input-group-addon">账号</span>
                            <input type="text" value="" class="form-control input-sm"
                                   data-bind="value: searchParam().noticeAccount">
                        </div>
                    </div>
                    <div class="col-xs-2">
                        <button class="btn btn-sm" type="button" data-bind="click: reset">重置</button>
                        <button class="btn btn-default btn-sm" type="submit" data-bind="click: search">搜索</button>
                    </div>

                </div>
                <div class="table-responsive" data-bind="with: table">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>通知类型</th>
                            <th>短信内容</th>
                            <th>用户</th>
                            <th>账号</th>
                            <th>手机号码</th>
                            <th>通知时间</th>
                            <th>发送结果</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr data-bind="visible: showNoData">
                            <td colspan=6 class="aligncenter">
                                	暂无数据
                            </td>
                        </tr>
                        <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
                        <tr>
                            <td>
                            	<span class="" data-bind="if:noticeCategory=='SerOutExpire'">服务过期提醒</span>
                            	<span class="" data-bind="if:noticeCategory=='ResExpire'">资源到期提醒</span>
                            	<span class="" data-bind="if:noticeCategory=='ResToDelete'">资源删除待办</span>
                            	<span class="" data-bind="if:noticeCategory=='ResOutExpire'">资源过期提醒</span>
                            	<span class="" data-bind="if:noticeCategory=='ResConstrSuccess'">资源施工成功</span>
                            	<span class="" data-bind="if:noticeCategory=='ResConstrFail'">资源施工失败</span>
                            	<span class="" data-bind="if:noticeCategory=='ResToConstr'">资源待施工</span>
                            	<span class="" data-bind="if:noticeCategory=='ConstrStopNotice'">施工终止通知</span>
                            	<span class="" data-bind="if:noticeCategory=='OrderAuditPass'">订单审核通过</span>
                            	<span class="" data-bind="if:noticeCategory=='OrderAuditFail'">订单审核不通过</span>
                            	<span class="" data-bind="if:noticeCategory=='OrderCancleNotice'">订单取消通知</span>
                            	<span class="" data-bind="if:noticeCategory=='SoftwareToConstr'">软件待施工</span>
                            	<span class="" data-bind="if:noticeCategory=='SoftwareConstrSuccess'">软件施工成功</span>
                            	<span class="" data-bind="if:noticeCategory=='SoftwareConstrFail'">软件施工失败</span>
                            </td>
                            <td data-bind="text:noticeContent"></td>
                            <td data-bind="text:noticeUserName"></td>
                            <td data-bind="text:noticeAccount"></td>
                            <td data-bind="text:noticePhoneNum"></td>
                            <td data-bind="text:noticeTime"></td>
                            <td>
                                <span class="label label-success" data-bind="if:noticeSendState=='SendSuccess'">发送成功</span>
                                <span class="label label-danger" data-bind="if:noticeSendState=='SendFailed'">发送失败</span>
                            </td>
                        </tr>
                        <!-- /ko -->
                        </tbody>
                    </table>
                </div>
                <footer class="panel-footer" data-bind="with: table, visible: table.pages() > 1">
                    <ul class="pagination">
                        <li data-bind="css: leftPagerClass, click: prevPage">
                            <a href="#">&laquo;</a>
                        </li>
                        <!-- ko foreach: {data: (new Array(pages()))} -->
                        <li data-bind="css: $parent.pageClass($index() + 1)">
                            <a href="#" data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
                        </li>
                        <!-- /ko -->
                        <li data-bind="css: rightPagerClass, click: nextPage">
                            <a href="#">&raquo;</a>
                        </li>
                    </ul>
                </footer>
            </div>
            <div class="tab-pane" id="email" role="tabpanel">

                <div class="row wrapper">
                    <div class="col-xs-3">
                        <div class="input-group">
                            <span class="input-group-addon">通知类型</span>
                            <select class="form-control input-sm" data-bind="value: searchParam().noticeCategory">
                                <option value="null">全部</option>
                                <option value="SerOutExpire">资源到期提醒</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="input-group">
                            <span class="input-group-addon">发送结果</span>
                            <select class="form-control input-sm" data-bind="value: searchParam().noticeSendState">
                                <option value="null" selected="selected">全部</option>
                                <option value="SendSuccess">发送成功</option>
                                <option value="SendFailed">发送失败</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="input-group">
                            <span class="input-group-addon">账号</span>
                            <input type="text" value="" class="form-control input-sm"
                                   data-bind="value: searchParam().noticeAccount">
                        </div>
                    </div>
                    <div class="col-xs-2">
                        <button class="btn btn-sm" type="button" data-bind="click: reset">重置</button>
                        <button class="btn btn-default btn-sm" type="submit" data-bind="click: search">搜索</button>
                    </div>

                </div>
                <div class="table-responsive" data-bind="with: table">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>通知类型</th>
                            <th>邮件内容</th>
                            <th>用户</th>
                            <th>账号</th>
                            <th>邮箱</th>
                            <th>通知时间</th>
                            <th>发送结果</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr data-bind="visible: showNoData">
                            <td colspan=6 class="aligncenter">
                                	暂无数据
                            </td>
                        </tr>
                        <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
                        <tr>
                            <td>
                            	<span class="" data-bind="if:noticeCategory=='SerOutExpire'">服务过期提醒</span>
                            	<span class="" data-bind="if:noticeCategory=='ResExpire'">资源到期提醒</span>
                            	<span class="" data-bind="if:noticeCategory=='ResToDelete'">资源删除待办</span>
                            	<span class="" data-bind="if:noticeCategory=='ResOutExpire'">资源过期提醒</span>
                            	<span class="" data-bind="if:noticeCategory=='ResConstrSuccess'">资源施工成功</span>
                            	<span class="" data-bind="if:noticeCategory=='ResConstrFail'">资源施工失败</span>
                            	<span class="" data-bind="if:noticeCategory=='ResToConstr'">资源待施工</span>
                            	<span class="" data-bind="if:noticeCategory=='ConstrStopNotice'">施工终止通知</span>
                            	<span class="" data-bind="if:noticeCategory=='OrderAuditPass'">订单审核通过</span>
                            	<span class="" data-bind="if:noticeCategory=='OrderAuditFail'">订单审核不通过</span>
                            	<span class="" data-bind="if:noticeCategory=='OrderCancleNotice'">订单取消通知</span>
                            	<span class="" data-bind="if:noticeCategory=='SoftwareToConstr'">软件待施工</span>
                            	<span class="" data-bind="if:noticeCategory=='SoftwareConstrSuccess'">软件施工成功</span>
                            	<span class="" data-bind="if:noticeCategory=='SoftwareConstrFail'">软件施工失败</span>
                            </td>
                            <td data-bind="text:noticeContent"></td>
                            <td data-bind="text:noticeUserName"></td>
                            <td data-bind="text:noticeAccount"></td>
                            <td data-bind="text:noticeEmail"></td>
                            <td data-bind="text:noticeTime"></td>
                            <td>
                                <span class="label label-success" data-bind="if:noticeSendState=='SendSuccess'">发送成功</span>
                                <span class="label label-danger" data-bind="if:noticeSendState=='SendFailed'">发送失败</span>
                            </td>
                        </tr>
                        <!-- /ko -->
                        </tbody>
                    </table>
                </div>
                <footer class="panel-footer" data-bind="with: table, visible: table.pages() > 1">
                    <ul class="pagination">
                        <li data-bind="css: leftPagerClass, click: prevPage">
                            <a href="#">&laquo;</a>
                        </li>
                        <!-- ko foreach: {data: (new Array(pages()))} -->
                        <li data-bind="css: $parent.pageClass($index() + 1)">
                            <a href="#" data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
                        </li>
                        <!-- /ko -->
                        <li data-bind="css: rightPagerClass, click: nextPage">
                            <a href="#">&raquo;</a>
                        </li>
                    </ul>
                </footer>
            </div>

        </div>

    </div>
</div>

<!-- page specific plugin scripts -->
<script type="text/javascript">
    var scripts = [null, "assets/lib/moment/moment.js", "assets/lib/bootstrap-daterangepicker/daterangepicker.js"]
    $('.page-content-area').ace_ajax('loadScripts', scripts, function (args) {

        // daterange
        $('#system_daterange').val(moment().subtract('days', 29).format('YYYY/MM/DD') + ' 至 ' + moment().format('YYYY/MM/DD')).daterangepicker(
                {
                    format: 'YYYY/MM/DD',
                    startDate: moment().subtract('days', 29),
                    endDate: moment(),
                    separator: '至',
                    locale: {
                        applyLabel: '确认',
                        cancelLabel: '取消',
                        fromLabel: '开始日期',
                        toLabel: '结束日期',
                        weekLabel: '周',
                        customRangeLabel: '自定义范围',
                        daysOfWeek: ["日", "一", "二", "三", "四", "五", "六"],
                        monthNames: ['01月', '02月', '03月', '04月', '05月', '06月', '07月', '08月', '09月', '10月', '11月', '12月',]
                    },
                    ranges: {
                        '当天': [moment(), moment()],
                        '昨天': [moment().subtract('days', 1), moment().subtract('days', 1)],
                        '近7天': [moment().subtract('days', 6), moment()],
                        '近30天': [moment().subtract('days', 29), moment()],
                        '当月': [moment().startOf('month'), moment().endOf('month')],
                        '上月': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
                    }
                }
        );

        function ViewModel(typeName) {

            // 复选框选中后执行此事件;
            this.read = function () {
                jsonArray = [];
                jsonArray = this.table.chosenItems();
                console.log(jsonArray);
                if (jsonArray.length > 0) {
                    // 有效数据列表;
                    var validArray = new Array();
                    $.each(jsonArray, function (index, obj) {
                        if (obj.noticeState == 'NoRealize') {
                        	// 只收集未阅信息json对象;  
                            validArray.push(obj);
                        }
                    });
                    if (validArray.length > 0) {
                        systemMsg.confirm("您确定将" + validArray.length + "条信息设为已阅？", function () {
                            ajaxUpdate(validArray);
                        });
                    } else {
                        systemMsg.alert("暂无可设置的告警信息！");
                    }
                } else {
                    systemMsg.alert("勾选列表为空，请重新提交！");
                }
                ;
            };
            var self = this;
            // 单个设置已阅事件;
            var jsonArray = new Array();
            this.readOne = function (object, event) {
                jsonArray = [];
                systemMsg.confirm("您确定将此条信息设为已阅？", function () {
                    // 处理ajax请求;
                    var json = {
                        'noticeCategory': object.noticeCategory,   // 通知小类;
                        'id': object.id,                      // 通知实体id;
                        'noticeState': object.noticeState,     //  通知  阅读状态;
                        'noticeType': object.noticeType      // 通知大类;
                    };
                    // console.log(json);
                    jsonArray.push(json);
                    ajaxUpdate(jsonArray);
                });
            };
            this.searchParam = ko.observable({
                noticeCategory: '', // 通知类别
                noticeContent: '',  // 通知详情:
                noticeSendState: '',// 发送结果   发送成功|失败
                noticeTime: '',     // 通知时间
                noticeAccount: '',  // 账户
                noticeType: typeName  // 通知类型    系统|短信|邮件
            });
            // 后台请求参数;
            function ajaxUpdate(array) {
                if (array.length != 0) {
                    $.ajax({
                        type: 'PUT',
                        url: "api/v5.0.0/notices/updateState",
                        data: JSON.stringify(array),
                        dataType: 'json',
                        success: function (data) {
                            systemMsg.alert("设置成功!");
                            // 关闭模态框窗口;
                            var modal = $("#systemMessageAlertModal");
                            modal.on("hidden.bs.modal", function () {
                                modal.remove();
                                self.table.refreshData(); // 重新加载table;
                            });
                        },
                        error: function () {
                            systemMsg.alert("设置时发生内部错误！");
                        }
                    });
                }
                ;
            };
            this.reset = function () {
                this.searchParam({
                    noticeCategory: 'null', // 通知类别
                    noticeContent: '',  // 通知详情:
                    noticeSendState: 'null',// 发送结果   发送成功|失败
                    noticeTime: '',     // 通知时间
                    noticeAccount: '',  // 账户
                    noticeType: typeName  // 通知类型    系统|短信|邮件
                });
                this.table.params(this.searchParam());
            };
            this.search = function () {
                this.table.params(this.searchParam());
            };

            // 调用接口查询数据;
            this.table = new DataTable([]);
            self.table.params(self.searchParam());
            console.log(self.searchParam());
            self.table.path('api/v5.0.0/notices/query');
        };

        $("#page-content .tab-pane").each(function (index, item) {
            // description by niuxl 20160805;
            // 循环创建viewModel对象，初始化对某些值进行赋值;
            // 这里index对应表结构中的通知类型noticeType 字段    1：系统通知 2：短信通知 3：邮件通知
            // noticeType字段含义用来初始化时加载table时查询不同的类型数据；
            var typeName = "";
            if(index==0){
            	typeName ="SysNotice";
            }else if (index==1){
            	typeName = "SmsNotice";
            }else if(index==2){
            	typeName = "EmailNotice";
            }
            ko.applyBindings(new ViewModel(typeName), item);
        });
        
        //获取URL参数对象
    	function UrlSearch() {
    		var name,value; 
    		var str=location.href; //取得整个地址栏
    		var num=str.indexOf("?") 
    		str=str.substr(num+1); //取得所有参数   stringvar.substr(start [, length ]
    	
    		var arr=str.split("&"); //各个参数放到数组里
    		for(var i=0;i < arr.length;i++){ 
    			num=arr[i].indexOf("="); 
    			if(num>0){ 
    				name=arr[i].substring(0,num);
    				value=arr[i].substr(num+1);
    				this[name]=value;
    			}
    		}
    	}
      	
    	var requestParam = new UrlSearch();
   		if(requestParam.showTab == 'sysTab'){
   			$("#sysTab").tab("show");
   			$("#headTab").hide();
   		}
    });
</script>