<div class="bg-light lter b-b wrapper-sm">
	<ol class="breadcrumb">
	  <li>当前位置：</li>
	  <li>报表</li>
	  <li class="active">自定义报表</li>
	</ol>
</div>
<div class='wrapper-md'>
	<div class="panel panel-default">
		<div class="row wrapper">
			<div class="col-xs-8">
				<button class="btn btn-sm btn-primary" data-bind="click: add">创建报表</button>
			</div>
			<div class="col-xs-3">
				<div class="input-group">
				    <span class="input-group-addon">报表名称</span>
				    <input type="text" value="" class="form-control input-sm" data-bind="value: searchParam().name">
			    </div>      
			</div>
			<div class="col-xs-1">
				<button class="btn btn-default btn-sm" type="submit" data-bind="click: search">搜索</button>
			</div>
		</div>
		<div class="table-responsive" data-bind="with: table">
			<table class="table table-striped">
				<thead>
					<tr>
						<th>序号</th>
						<th>报表名称</th>
						<th>报表文件</th>
						<th>参数模板文件</th>
						<th>备注</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody>
		            <tr data-bind="visible: showNoData">
		           		<td colspan="6" class="aligncenter">
		              		This table has no data.
		           		</td>
		            </tr>
		          	<!-- ko foreach: {data: pagedRows, as: '$row'}  -->
					<tr>
						<td data-bind="text:$index()+1"></td>
						<td data-bind="text:name"></td>
						<td data-bind="text:reportShowFile"><a href="#" class="text-info"></a></td>
						<td data-bind="text:paramShowFile"><a href="#" class="text-info"></a></td>
						<td data-bind="text:remark"></td>
						<td><a data-bind="click: $root.edit">修改</a> | <a data-bind="click: $root.remove">删除</a> | <a href="#pages/reports/show">预览</a></td>
					</tr>
		          	<!-- /ko -->
				</tbody>
			</table>
		</div>
		<footer class="panel-footer" data-bind="with: table">
			<ul class="pagination">
		        <li data-bind="css: leftPagerClass, click: prevPage">
		          <a href="#">&laquo;</a>
		        </li>
		        <!-- ko foreach: {data: (new Array(pages()))} -->
		        <li data-bind="css: $parent.pageClass($index() + 1)">
		          <a href="#" data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
		        </li>
		        <!-- /ko -->
		        <li data-bind="css: rightPagerClass, click: nextPage">
		          <a href="#">&raquo;</a>
		        </li>
		    </ul>
    	</footer>
	</div>		
</div>

<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isAdd }">
  <div class='modal-dialog'>
    <div class='modal-content'>
      <div class='modal-header'>
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
        <h3 class='modal-title' data-bind="ifnot: currentVO().id">创建报表</h3>
        <h3 class='modal-title' data-bind="if: currentVO().id">修改报表</h3>
      </div>
      <div class='modal-body form-horizontal row'>  
        <div class="form-group">
          <label class="col-xs-3 control-label">报表名称：</label>
          <div class="col-xs-8">
            <input type="text" class="form-control" data-bind="value: currentVO().name">
            <span style="color:red;" id="nameError"></span>
          </div>
		  <div class="col-xs-1">
			<span class="text-danger inline m-l-n m-t-sm">*</span>
		  </div>          
        </div>
        <div class="form-group">
          <label class="col-xs-3 control-label">报表定义文件：</label>
          <div class="col-xs-8 form-inline">
          	<input readonly="readonly" type="text" class="form-control" style="width:243px" data-bind="value: currentVO().defineFile">
          	<form name="uploadDFileForm" enctype="multipart/form-data" style="display:inline">
				<a href="javascript:;" class="btn btn-default" style="margin-left: 10px;display: inline-block;width: 54px;height: 34px;overflow: hidden;position:relative;">
					<input id="defineFile" type="file" style="opacity: 0;position: absolute;left:0;right:0;" 
					data-bind="event:{change:function(data, event){$root.setFile('report',self)}}"/>浏览
				</a>
	    		<a href="javascript:;" class="btn btn-default" 
	    			data-bind="click: function(data, event){ $root.deleteFile('report') }">删除</a>
	    		<br/>
				<span style="color:red;" id="dfileError"></span>
			</form>
          </div>
		  <div class="col-xs-1">
			<span class="text-danger inline m-l-n m-t-sm">*</span>
		  </div>           
        </div>
        <div class="form-group">
          <label class="col-xs-3 control-label">参数模板文件：</label>
          <div class="col-xs-8 form-inline">
          	<input readonly="readonly" type="text" class="form-control" style="width:243px" data-bind="value: currentVO().paramFile">
          	<form name="uploadDFileForm" enctype="multipart/form-data" style="display:inline">
				<a href="javascript:;" class="btn btn-default" style="margin-left: 10px;display: inline-block;width: 54px;height: 34px;overflow: hidden;position:relative;">
					<input id="paramFile" type="file" style="opacity: 0;position: absolute;left:0;right:0;" 
					data-bind="event:{change:function(data, event){$root.setFile('param',this)}}"/>浏览
				</a>
	    		<a href="javascript:;" class="btn btn-default" 
	    			data-bind="click: function(data, event){ $root.deleteFile('param') }">删除</a>
	    		<br/>
				<span style="color:red;" id="pfileError"></span>
			</form>
          </div>
        </div>
        <div class="form-group">
          <label class="col-xs-3 control-label">备注：</label>
          <div class="col-xs-8">
            <textarea name="" id="" cols="30" rows="4" class="form-control" 
            	data-bind="value: currentVO().remark"></textarea>
            <br/>
			<span style="color:red;" id="t_remarkError"></span>
          </div>
        </div>
      	
      </div>
      <div class='modal-footer' style="text-align:center;">
        <a class="btn btn-default btn-info" data-bind="click:save">确定</a>
        <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
      </div>
    </div>
  </div>
</div>

<!-- page specific plugin scripts -->
<script type="text/javascript">
	var scripts = [null, null]
  	$('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {

    	function ViewModel(){
      		this.isAdd = ko.observable(false);

      		this.currentVO = ko.validatedObservable({
      			name: ko.observable(),
      			defineFile: ko.observable(),
      			paramFile: ko.observable(),
      			reportShowFile:  ko.observable(),
      			reportSaveFile: ko.observable(),
      			paramShowFile: ko.observable(),
      			paramSaveFile: ko.observable(),
    	  		remark: ko.observable()
      		});

      		var self = this;
      		
      		this.setFile = function(type, value){
      			console.log(type, value);
      			if(type == 'report'){
      				this.currentVO().defineFile(value);
      			}
      			if(type == 'param'){
      				this.currentVO().paramFile(value);
      			}
      		}
      		//删除
      		this.deleteFile = function(type){
      			if(type == 'report'){
      				this.currentVO.fromJSON({
      					defineFile: ""
              		});
      			}else if(type == 'param'){
      				this.currentVO.fromJSON({
      					paramFile: ""
              		});
      			}
      		}
      		// 获取文件名称
      		this.getFileName = function(path) {
      			if(path==null||path==''){
      				return path;
      			}
      			var pos1 = path.lastIndexOf('/');
      			var pos2 = path.lastIndexOf('\\');
      			var pos = Math.max(pos1, pos2)
      			if (pos < 0)
      				return path;
      			else
      				return path.substring(pos + 1);
      		}
      		// 判断str1是否以str2结尾
      		this.endWith = function(str1, str2) {
      			if (str1 == null || str2 == null) {
      				return false;
      			}
      			if (str1.length < str2.length) {
      				return false;
      			} else if (str1 == str2) {
      				return true;
      			} else if (str1.substring(str1.length - str2.length) == str2) {
      				return true;
      			}
      			return false;
      		}
      		
      		this.add = function(){
        		self.isAdd(true);
        		this.currentVO.fromJSON({
           	 		id: null,
            		name: "",
            		defineFile: "",
          			paramFile: "",
      	  			reportShowFile: "",
      	  			paramShowFile: "",
      	  			remark: ""
          		});
      		}
      		
      		this.save = function(){
      			// 输入验证
      			$("#nameError").text('');
      			$("#t_remarkError").text('');
      			$("#dfileError").text('');
      			$("#pfileError").text('');
      			if(self.currentVO().name() == ""){
      				$("#nameError").text("报表名称不能为空！");
      				return;
      			}
      			if(!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(self.currentVO().name())){
      				$("#nameError").text("报表名称只能输入中文、数字、字母、下划线！");
      				return;
      			}
      			if(self.currentVO().remark() > 255){
      				$("#t_remarkError").text("最多只能输入255个字符！");
      				return;
      			}
      			if(self.currentVO().defineFile() == ''){
      				$("#dfileError").text("报表定义文件不能为空！");
      				return;
      			}
	        	//组装显示文件
	        	var dfShowName = self.getFileName(self.currentVO().defineFile());
	        	var pfShowName = self.getFileName(self.currentVO().paramFile());
	        	if(dfShowName.length>32){
	        		$("#dfileError").text("报表定义文件名称最长为32个字符！");
	        		return;
	        	}
	        	if(!self.endWith(dfShowName,'.rpx')){
	        		$("#dfileError").text("报表定义文件名称后缀名必须为.rpx！");
	        		return;
	        	}
	        	
	        	if(pfShowName!='' && pfShowName.length>32){
	        		$("#pfileError").text("参数模板文件名称最长为32个字符！");
	        		return;
	        	}
	        	
	        	if(pfShowName!='' && !self.endWith(pfShowName,'.rpx')){
	        		$("#pfileError").text("参数模板文件名称后缀名必须为.rpx！");
	        		return;
	        	}
	        	self.currentVO().reportShowFile(dfShowName);
	        	self.currentVO().paramShowFile(pfShowName);
	        	
	        	//检查报表名称是否存在
	        	if(self.currentVO().id){
	        		csc.rest.get('api/v5.0.0/reports/customReports/check?id='+self.currentVO().id+'&name='+self.currentVO().name(),function(data){
	        			if(data == 0){
	        				csc.rest.get('api/v5.0.0/reports/upload',self.currentVO.toJSON(),function(data){
	        					console.log('upload');
	        				});
	        				csc.rest.put('api/v5.0.0/reports/customReports/'+self.currentVO().id,self.currentVO.toJSON(),function(data){
						 		systemMsg.alert('修改自定义报表成功！');
						 		self.isAdd(false);
					        	self.table.refreshData();
						    });
	        			}else{
	        				$('#nameError').text('报表名称已经存在！');
	        			}
		        	});
	        	}else{
	        		csc.rest.get('api/v5.0.0/reports/customReports/check?name='+self.currentVO().name(),function(data){
	        			if(data == 0){
	        				csc.rest.post('api/v5.0.0/reports/upload',function(data){
	        					
	        				});
	        				csc.rest.post('api/v5.0.0/reports/customReports',self.currentVO.toJSON(),function(data){
						 		systemMsg.alert('添加自定义报表成功！');
						 		self.isAdd(false);
					        	self.table.refreshData();
						    });
	        			}else{
	        				$('#nameError').text('报表名称已经存在！');
	        			}
	        		});
	        	}
      		}
	      	//修改
	      	this.edit = function(object, event){
	      		console.log(object)
	        	self.currentVO.fromJSON({
	        		id: object.id,
            		name: object.name,
            		defineFile: object.reportShowFile,
          			paramFile: object.paramShowFile,
      	  			remark: object.remark
	        	});
	        	self.isAdd(true); 
	      	}
		  	//删除
	      	this.remove = function(object, event){
	      		systemMsg.confirm("确定要删除报表 "+object.name+" ?",function(){
	      			csc.rest.del('api/v5.0.0/reports/customReports/'+object.id,function(data){
				 		systemMsg.alert('删除自定义报表成功！');
				 		self.table.refreshData();
				    });
	      		});
	      	}
		  	//查询
	      	this.searchParam = ko.observable({
	    	  	name: "",
	      	})
	      	this.search = function(){
	        	this.table.params(this.searchParam());
	      	}
	      	this.table = new DataTable([], {path: 'api/v5.0.0/reports/customReports'});
    	}
    	ko.applyBindings(new ViewModel(), $('#page-content')[0]);  
  	});
</script>