
  <div class="panel panel-info" id="diskContent">
    <div class="panel-heading">申请信息</div>
    <div id="orderDetailedList" class="wrapper form-horizontal">
      <div class="row">
        <div class="col-xs-6">
          <div class="form-group">
            <label class="col-sm-2 control-label">云硬盘名称<i style="color:red">*</i></label>
            <div class="col-sm-10">
              <input type="text" class="form-control"  placeholder="云硬盘名称" data-bind="value: currentVO().name">
            </div>
          </div>
        </div>
        <div class="col-xs-6">
          <div class="form-group">
            <label class="col-sm-2 control-label">存储大小(G)</label>
            <div class="col-sm-10">
              <input type="text" class="form-control"  placeholder="存储大小" data-bind="value: currentVO().size,event:{change:$root.sizeChange}">
            </div>
          </div>
        </div>  

        <div class="col-xs-6">
          <div class="form-group">
            <label class="col-sm-2 control-label">所属VDC<i style="color:red" >*</i></label>
            <div class="col-sm-10">
              <select class="form-control" data-bind="options:vdcList,optionsText:'name',optionsValue:'uuid',value:currentVO().vdcUuid,optionsCaption:'请选择',event:{change:$root.vdcChange}">
              </select>
            </div>
          </div>
        </div>
        <div class="col-xs-6">
          <div class="form-group">
            <label class="col-sm-2 control-label">可用分区<i style="color:red">*</i></label>
            <div class="col-sm-10">
              <select class="form-control" data-bind="options:azList,optionsText:'name',optionsValue:'uuid',value:currentVO().azUuid,event:{change:$root.azChangeGetVm},optionsCaption:'请选择'">
                <option>可用分区1</option>
                <option>可用分区2</option>
              </select>
            </div>
          </div>
        </div>
        <div class="col-xs-6">
          <div class="form-group">
            <label class="col-sm-2 control-label">挂载云主机<i style="color:red">*</i></label>
            <div class="col-sm-10">
              <select class="form-control" data-bind="options:vmList,optionsText:'name',optionsValue:'uuid',value:currentVO().mountVmUuid,event:{change:$root.vmChangeGetDate},optionsCaption:'请选择'">
                <option>云主机1</option>
                <option>云主机2</option>
              </select>
            </div>
          </div>
        </div>  
      </div>
      <div class="row">
        <div class="col-xs-6">
          <div class="form-group">
            <label class="col-sm-2 control-label">备注<i style="color:red">*</i></label>
            <div class="col-sm-10">
              <textarea class="form-control" data-bind="value: currentVO().remark"></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-6">
          <div class="form-group">
            <label class="col-sm-2 control-label">申请时长：<i style="color:red">*</i></label>
            <div class="col-sm-10">
              有效期至 <input type="text" class="form-control" id="timerange" style="width:250px;display:inline-block;" data-bind="value: currentVO().applyTime,attr:{disabled:true}" />
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-6">
          <div class="form-group">
            <label class="col-sm-2 control-label">套餐：<i style="color:red">*</i></label>
            <div class="col-sm-10">
              <select class="form-control" style="width:150px;display:inline-block;" data-bind="options:billRuleArray,optionsText:'name',optionsValue:'value',value:currentVO().billRuleUuid,event:{change:function(data, event){ $root.chargeChange('size',data,event) }},optionsCaption:'请选择'">
                <option>包月</option>
                <option>包年</option>
              </select> 
              <span class="control-label col-sm-5 text-left" style="height:34px;" data-bind="value:currentVO().price"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


<script type="text/javascript">
  var scripts = [null, "assets/lib/moment/moment.js","assets/lib/bootstrap-daterangepicker/daterangepicker.js"]
  $('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
	  debugger
    if(!args.type){
      $(".order-base-info").remove();
    }else{
      if(args.type == 'order')
        $("#orderBaseInfoType").html('订单号');
      else
        $("#orderBaseInfoType").html('任务ID');
    };

    $("#timerange").daterangepicker();
    
    if(args.taskId){
		function ViewModel(){
		  var self = this;
		  var diskChargeType;
		  
		  this.currentVO = ko.validatedObservable({
		        name: ko.observable(),
		        size: ko.observable("").extend({required: true}),
		        azUuid: ko.observable().extend({required: true}),
		        vdcUuid: ko.observable("").extend({required: true}),
		        applyTime: ko.observable("").extend({required: true}),
		        mountVmUuid:ko.observable(""),
		        billRuleUuid:ko.observable(""),
		        remark:ko.observable(),
		        serviceUuid:ko.observable(),
		        price:ko.observable(""),
		        unitPrice:ko.observable("")
		      });
		  csc.rest.get('api/v5.0.0/workflows/tasks/'+args.taskId,function(data){
    	     var processInstanceId = data.taskInfo[0].processInstanceId;
			 //获取订单数据
	      	 csc.rest.get('api/v5.0.0/order/byFlowInstanceUuid/'+processInstanceId,function(data){
	      		debugger
	      		var test = {};
	      		test.name="xx";
	      		test.size="100";
	      		test.azUuid="02";
	      		test.vdcUuid="02";
	      		test.applyTime="1986-01-10";
	      		test.mountVmUuid="12313";
	      		test.remark="12313123aad";
	      		test.billRuleUuid='DAY';
	      		test.serviceUuid = '66769923-ba8e-478e-8f14-587a91259886';
	      		diskChargeType = setArrayCharge(test.billRuleUuid);
	      		test.price='20';
	      		test.unitPrice='10';
	      		
	      		 self.currentVO.fromJSON(test);
	      	 })
		  })
		  
		    //vdc下拉列表
		    this.vdcList = ko.observableArray();
	        csc.rest.get("api/v5.0.0/cart/getselect", function(data){
	        	debugger
	        	self.vdcList(data);
	        });
		    //}
		   //可用分区下拉列表
		    this.azList = ko.observableArray();
		   
		    this.vdcChange = function(obj){//根据变化的vdc及服务ID查找其下的可用分区
		    	var _self = this;
		    	_self.azList.removeAll();
		        csc.rest.get("api/v5.0.0/vdcs/"+obj.currentVO().vdcUuid()+"/azs", function(data){
		        	_self.azList(data.results);
		        });	        
		    };
		    
		    //虚拟机列表
		    this.vmList = ko.observableArray();
		    this.azChangeGetVm = function(obj){	
		    	var _self = this;
		        csc.rest.get("api/v5.0.0/vms?vdcUuid="+obj.currentVO().vdcUuid()+"&azUuid="+obj.currentVO().azUuid(), function(data){
		        	_self.vmList(data.results);
		        });	    	
		    }
		    
		    this.billRuleArray = ko.observableArray(diskChargeType);
		    //有效时间
		    this.vmChangeGetDate = function(obj){
		    	var _self = this;
	  			var vmItem = _.findWhere(_self.vmList(), {uuid: _self.currentVO().mountVmUuid()});
				if (typeof(vmItem) == "undefined") { 
					_self.currentVO().applyTime("");
				}else{
					_self.currentVO().applyTime(vmItem.expiryTime);
				}
		    	
		    }
		    
		    this.chargeChange = function(arg,data,event){//除了VDC其他申请用这个方法
		    	csc.rest.get("api/v5.0.0/billing/rules/calculate?serviceUuid="+this.currentVO().serviceUuid()+"&cycle="+this.currentVO().billRuleUuid(), function(result){
		    		debugger
		    		var _self = this;
		    		var type = _self.currentVO().billRuleUuid();
		    		var price;
		    		if(typeof(type)=="undefined"){
		    			currentVO().price("");
		    			return;
		    		}
		    		if(arg=="size"){
		    			var num = _self.currentVO().size();
		    			_self.currentVO().unitPrice(result.ruleList[0].unitPrice);
		    			price = num*(result.ruleList[0].unitPrice);
		    			price = "费用:"+price;
		    		}else{
		    			price= "费用:"+result.ruleList[0].unitPrice;
		    		}
		    		 
		    		if(type=="DAY"){
		    			price+="元/天";
		    		}else if(type=="MONTH"){
		    			price+="元/月";
		    		}else if(type=="QUARTER"){
		    			price+="元/季度";
		    		}else{
		    			price+="元/年";
		    		}
		    		currentVO().price(price);
		    	});	    	
		    }
		    
		    function setArrayCharge(value){
		    	var attr = getArrayByString(value);
		    	var arrayCharge = [];
		    	for(var i=0;i<attr.length;i++){
		    		if(attr[i]=="DAY"){
		    			arrayCharge.push({name:"按天",value:"DAY"});
		    		}else if(attr[i]=="MONTH"){
		    			arrayCharge.push({name:"按月",value:"MONTH"});
		    		}else if(attr[i]=="QUARTER"){
		    			arrayCharge.push({name:"按季度",value:"QUARTER"});
		    		}else{
		    			arrayCharge.push({name:"按年",value:"YEAR"});
		    		}
		    	}
		    	return arrayCharge;
		    }
		    
		  	function getArrayByString(type){
		  		var a = type.split(',');
		  		return a;
		  	}
		}
		
		ko.applyBindings(new ViewModel(), $('#diskContent')[0]); 
    }
  });
</script>