<link href="assets/lib/bootstrap-multiselect/bootstrap-multiselect.css" rel="stylesheet" type="text/css" />

<div class="bg-light lter b-b wrapper-sm">
  <ol class="breadcrumb">
    <li>当前位置：</li>
    <li class="active">业务系统</li>
  </ol>
</div>

<div class='wrapper-md'>
  <div class='panel panel-default b-blue'>
    <div class="">
      <div class="row wrapper">
        <div class="col-xs-8">
        <a class="btn btn-sm btn-info" data-bind="click: add">创建业务系统</a>
        </div>
        <div class="col-xs-3">          
            <div class="input-group">
              <span class="input-group-addon">名称</span>
              <input type="text" class="input-sm form-control" placeholder="请输入名称" data-bind="value: searchParam().name">
            </div>
        </div>
        <div class="col-xs-1">
            <button class="btn btn-sm btn-default" type="button" data-bind="click: search">搜索</button>
        </div>
      </div>
    </div>
    <div id='instance_projects'>
      <div class='table-responsive' data-bind="with: table">
        <table class='table table-striped'>
          <thead>
            <tr>
              <th>业务系统名称</th>
              <th>所属VDC</th>
              <th>系统负责人</th>
              <th>创建时间</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <tr data-bind="visible: showNoData">
              <td colspan="5" class="aligncenter">
                This table has no data.
              </td>
            </tr>
            <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
            <tr>
              <td data-bind="text:uuid" hidden></td>
              <td data-bind="text:desc" hidden></td>
              
              <td><a data-bind="attr:{href:'#pages/vdcs/businesses/show?subSysUuid='+uuid+'&vdcUuid='+vdcUuid}"><span data-bind="text:name"></span></a></td>
              <td data-bind="text:vdcName"></td>
              <td>张三（待取数据）</td>
              <td data-bind="text:createTime"></td>
              <td>
                <a data-bind="click: $root.edit">修改</a> |
                <a data-bind="click: $root.remove">删除</a>
              </td>
            </tr>
            <!-- /ko -->
          </tbody>
        </table>
      </div>
      <footer class="panel-footer" data-bind="with: table, visible: table.pages() > 1">
        <ul class="pagination">
          <li>
            <a href="#">首页</a>
          </li>
          <li data-bind="css: leftPagerClass, click: prevPage">
            <a href="#">&laquo;</a>
          </li>
          <li >
            <a href="#" >1</a>
          </li>
          <li data-bind="css: rightPagerClass, click: nextPage">
            <a href="#">&raquo;</a>
          </li>
          <li>
            <a href="#">末页</a>
          </li>
          <li class="page-control-li">
            <div class="input-group form-group-sm">
              <input type="text" class="form-control"  />
              <div class="input-group-btn">
                <button type="button" class="btn btn-sm btn-default" >跳转</button>
              </div>
            </div>
            <div class="page-info-div" >共5条记录，每页10条，共1页</div>
          </li>
        </ul>
      </footer>
    </div>
  </div>
</div>

<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isAdd }">
  <div class='modal-dialog modal-md' role='document'>
    <div class='modal-content'>
      <div class='modal-header'>
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
        <h3 class='modal-title' data-bind="ifnot: subsysVo().uuid">创建业务系统</h3>
        <h3 class='modal-title' data-bind="if: subsysVo().uuid">修改业务系统</h3>
      </div>
      <div class='modal-body form-horizontal'>
        <div class="form-group">
          <label for="inputEmail3" class="col-xs-3 control-label">业务系统名称</label>
          <div class="col-xs-8">
            <input type="text" class="form-control" placeholder="业务系统名称" data-bind="value:subsysVo().name">
          </div>
          <div class="col-xs-1">
            <span class="text-danger inline m-l-n m-t-sm">*</span>
          </div>           
        </div>
        <div class="form-group" data-bind="ifnot: subsysVo().uuid">
          <label for="inputEmail3" class="col-xs-3 control-label" >所属VDC</label>
          <div class="col-xs-8">
            <select class="form-control" data-bind="options:vdcList,optionsText:'name',optionsValue:'uuid',value:subsysVo().vdcUuid">              
            </select>
          </div>
          <div class="col-xs-1">
            <span class="text-danger inline m-l-n m-t-sm">*</span>
          </div>           
        </div>
        <div class="form-group" data-bind="ifnot: subsysVo().uuid">
          <label for="inputEmail3" class="col-xs-3 control-label">系统负责人</label>
          <div class="col-xs-8">
            <select multiple="true" max-size="5"  data-bind="options:managerUserList,optionsText:'account',optionsValue:'value',selectedOptions:subsysVo().accounts_string" class="form-control">

            </select>
          </div>
          <div class="col-xs-1">
            <span class="text-danger inline m-l-n m-t-sm">*</span>
          </div>           
        </div>
        <div class="form-group">
          <label for="inputEmail3" class="col-xs-3 control-label">备注</label>
          <div class="col-xs-8">
            <textarea class="form-control" data-bind="value:subsysVo().desc"></textarea>
          </div>
        </div>
      </div>
      <div class='modal-footer' style="text-align: center">
        <input id="add_submit" type="submit" name="commit" value="确定" data-bind="click: $root.addToSave" class="btn btn-default btn-info" />
        <button name="button" type="submit" class="btn btn-default btn btn-default" data-dismiss="modal">取消</button></div>
      </div>
    </div>
  </div>
</div>

<!-- page specific plugin scripts -->
<script type="text/javascript">
var scripts = [null, 'assets/lib/bootstrap-multiselect/bootstrap-multiselect.js']
$('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {

    function ViewModel(){
        var self = this;
        //定义属性
        this.subsysVo = ko.validatedObservable({
             uuid:ko.observable(""),
             name:ko.observable().extend({required:true}),
             vdcUuid:ko.observable("").extend({required:true}),
             accounts_string:ko.observableArray([]).extend({required:true}),
             accounts:[],//不是表单数据，用数组接收，传到后台
             desc:ko.observable("")
        
        });
        this.isAdd = ko.observable(false);
        
        /*********************显示下拉列表*************************/
        this.managerUserList = ko.observableArray([]);
        self.subsysVo().accounts_string.subscribe(function(value){
        	self.subsysVo().accounts = _.map(value, function(item){
        		return JSON.parse(item);
        	});
        })
        self.subsysVo().vdcUuid.subscribe(function(vdcUuid){//选vdc传uuid作为参数传递
            if(!vdcUuid) return;
        
            self.managerUserList([]);

            csc.rest.get("api/v5.0.0/vdcs/"+vdcUuid+"/users", function(data){
                if(data.results.length < 1) return;
                var results = [];
                for(var i = 0; i < data.results.length; i++){
                     var authType = data.results[i].authType;
                     if (authType=="1"){
                        authType = "AD域用户";
                     }else{
                         authType = "本地用户";
                     }
                     results.push({
                         value:JSON.stringify({
                             account: data.results[i].account,
                             authType: data.results[i].authType,
                             type: 'MANGER'
                          }),
                         account:authType + " : "+data.results[i].account
                     });
                }
                self.managerUserList(results);
             });	        
        });
        /*********************显示下拉列表*************************/
        /********************业务系统新增-start*******************/
        //vdc下拉列表
        this.vdcList = ko.observableArray([]);
        csc.rest.get("api/v5.0.0/vdcs", function(data){
            self.vdcList.removeAll();
            self.vdcList(data.results);
        });
        this.add = function(){
            self.isAdd(true);
            //清空表单
            self.subsysVo.fromJSON({
                id:null,
                uuid:null,
                name:"",
                vdcUuid: [],
                accounts_string: [],
                desc: ''
            });
        }

        //提交保存业务系统
        this.addToSave = function(){
            if(!self.subsysVo().name.isValid()){
                return;
            }
            if(!self.subsysVo().vdcUuid.isValid()){
                return;
            }
            if(!self.subsysVo().accounts_string.isValid()){
                return;
            }
            //置灰按钮
            $("#add_submit").attr("disabled","true");

           var uuid = self.subsysVo().uuid();
           if (uuid!=null&&uuid!=""){//修改
                csc.rest.put('api/v5.0.0/bussys/'+uuid,self.subsysVo.toJSON(),function(data){
                    systemMsg.alert('修改成功!');
                    self.isAdd(false);
                    self.table.refreshData();//刷新数据
                },function(data,textStatus) {
                    $("#add_submit").removeAttr("disabled");
                    systemMsg.alert('修改失败!');
                }); 
             }else{// 新增
                 csc.rest.post('api/v5.0.0/bussys',self.subsysVo.toJSON(),function(data){
                    systemMsg.alert('新增成功!');
                    self.isAdd(false);
                    self.table.refreshData();//刷新数据
              },function(data,textStatus) {
                  $("#add_submit").removeAttr("disabled");
                  systemMsg.alert('新增失败!');
              }); 
            }
        }

      /************************业务系统新增-end********************/
        
      /************************业务系统修改-start******************/
        this.edit = function(object, event){
            if(object.uuid==null)return;

            self.isAdd(true); 
            console.log(object)
            /**********获取业务中用户信息，组装用于回显********/
            csc.rest.get("api/v5.0.0/bussys/"+object.uuid, function(data){
            
        		var userList = data.userList;
   	        	var results = [];
        		if (userList!=null&&userList.length>0){
    	        	for(var i = 0; i < userList.length; i++){
    	        		
    	        		results.push(JSON.stringify({
	        				account: userList[i].account,
	        				authType: userList[i].authType,
	        				type: 'MANGER'
	        			}));
    	        	}
        		}
        		self.subsysVo().accounts_string(results);
        	});
            /**********获取业务中用户信息，组装用于回显********/
            self.subsysVo.fromJSON(object);
                   
         }
        /*********************业务系统修改-end**************************/
 

        /************************业务系统删除-start********************/
         this.remove = function(object,event){
        
        	 confirm("确定删除业务系统【"+object.name+"】?",function(arg){
        		 csc.rest.del('api/v5.0.0/bussys/'+object.uuid,function(data){
     		 		systemMsg.alert('删除业务系统成功!');
                    self.table.refreshData();
     		    },function(data,textStatus) {
     		 		systemMsg.alert('删除业务系统失败!');
     			});
 			 });
         }
       /************************业务系统删除-end**********************/

         this.searchParam = ko.observable({
             name: ""
         })
         this.search = function(){
              this.table.params(this.searchParam());
         }
    
        var busSyssUrl = "api/v5.0.0/bussys";
        this.table = new DataTable([], {path: busSyssUrl});
    
    }

    ko.applyBindings(new ViewModel(), $('#page-content')[0]);  

});
</script>