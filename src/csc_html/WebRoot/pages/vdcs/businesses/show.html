<style>
.capslock{
	position: absolute;
	z-index: 10;
	right: 0;
	background: #fff;
	padding: 5px 10px;
	border: 1px orange solid;
	top: 34px;
}
</style>
<div class="bg-light lter b-b wrapper-sm">
  <ol class="breadcrumb">
    <li>当前位置：</li>
    <li><a href="#pages/vdcs/businesses/index">业务系统</a></li>
  </ol>
</div>


<div class='wrapper-md'>
	<div class="nav-tabs-alt bg-white-only b b-blue">
		<ul class="nav nav-tabs" role="tablist">
			<li class="active" role="presentation">
				<a aria-controls="VM_OPERATION" data-toggle="tab" href="#VM_OPERATION" role="tab">业务系统详情</a>
			</li>
			<li role="presentation">
				<a aria-controls="router" data-toggle="tab" href="#router" role="tab">云主机</a>
			</li>
			<li role='presentation'>
        	<a aria-controls='partition_tasks' data-toggle='tab' href='#partition_tasks' role='tab'>调度任务</a></li>
		</ul>
		<div class="tab-content">
			<div class="tab-pane active" id="VM_OPERATION" role="tabpanel">
				<div class="wrapper-md">
                    <a class="btn btn-sm btn-default" href="#pages/vdcs/businesses/index"><i class="fa fa-arrow-left"></i> 返回</a>
					<p>&nbsp;</p>
					<div class="panel panel-default">
					  <div class="panel-heading">基本信息</div>
					  <div class="panel-body">
					    <p><strong>业务系统名称：</strong><span data-bind="text:busSysInfoVo().name"></span></p>
					    <p><strong>所属VDC：</strong><span data-bind="text:busSysInfoVo().vdcName"></span></p>
					    <p><strong>业务系统负责人：</strong><span data-bind="text:busSysInfoVo().managerUsers"></span></p>
					    <p><strong>备注：</strong><span data-bind="text:busSysInfoVo().desc"></span></p>
					  </div>
					</div>
				<div class="wrapper">
					<button class="btn btn-info btn-sm" data-bind="click: powerOnVm" id="button_onvm_" disabled>开机</button>
					<button class="btn btn-info btn-sm" data-bind="click: powerOffVm" id="button_offvm_" disabled>关机</button>
					<button class="btn btn-info btn-sm" data-bind="click: powerRestartVm" id="button_restartvm_" disabled>重启</button>
					|
				  	<button class="btn btn-info btn-sm " data-bind="visible: !editMode(), click: editVMOrder">设置启动顺序</button>
				  	<button class="btn btn-info btn-sm " data-bind="visible: editMode, click: confirmVMOrder" id="button_save_set_" disabled>保存</button>
				  	<button class="btn btn-info btn-sm " data-bind="visible: editMode, click: cancelVMOrder">取消</button>
				</div>

				<div class="wrapper">
					  <table class="table">
				  		<thead>
				  			<tr>
				  				<th>云主机名称</th>
				  				<th>启动顺序</th>
				  				<th>延迟间隔</th>
				  			</tr>
				  		</thead>
			  			<tr data-bind="visible: vmList().length==0">
							<td colspan="12" class="aligncenter">
                       			 暂无数据
                    		</td>
                 		</tr>
				  		<tbody data-bind="foreach: vmList"	>
				  			<tr>
				  				<td data-bind="text:uuid" hidden></td>
				  				<td data-bind="text:vmUuid" hidden></td>
				  				<td data-bind="text:vmName" ></td>
				  				<td >
				  				  <!-- ko if: $root.editMode -->
				  					<div class="input-append input-append-normal">
					                  <input maxlength="4" max="9999" min="0" style="width: 100px;" value="0" type="number" class="form-control input-sm" data-bind="value:startOrder"  onkeyup="checkNum(this)" />
				  					   <script type="text/javascript">
				  					     function checkNum(this_){
				  					    	try{ 
				  					    		var value_ = Number(this_.value)
				  					    		//赋值最小值
				  					    		if(value_<=-1||isNaN(value_)){
				  					    		    this_.value=0;
				  					    		//赋值最大值
				  					    		}else if(value_>=9999){
				  					    		    this_.value=9999;
				  					    		}else{
				  					    		    this_.value=value_;
				  					    		}
				  					    		
				  					    	}catch (e){ 
				  					    		this_.value=0;
				  					    	} 
				  					    	
				  					     }
				  					</script>
					                 </div>
					               <!-- /ko -->
					               <!-- ko ifnot: $root.editMode -->
					               <span data-bind="text:startOrder"></span>
					               <!-- /ko -->
				  				</td>
				  				<td >
					  				 <!-- ko if: $root.editMode -->
					  					<div class="input-append input-append-normal">
                                            <input maxlength="4" max="9999" min="0" style="width: 100px;" type="number" class="form-control input-sm" data-bind="value:delay" value="0" onkeyup="checkNum(this)" />
					  					<!-- 
						                  <span class="add-on w_numberBtn">
						                    <i class="w_upBtn" data-bind="click: $root.addDelayCount"><b></b></i>
						                    <i class="w_downBtn" data-bind="click: $root.decreaseDelayCount"><b></b></i>
						                  </span>
					  					 -->
						                 </div>
						               <!-- /ko -->
						               <!-- ko ifnot: $root.editMode -->
						               <span data-bind="text:delay"></span>
						               <!-- /ko -->
				  				</td>
				  			</tr>
				  		</tbody>
				  	</table>
				</div>
			</div>
                <!-- 操作云主机  输入用户密码modal -->
                <div role="dialog" aria-hidden="true" class="modal fade " id="verifyToPassModal" data-bind="modal: { show: verifyToPass }">
                    <div class='modal-dialog modal-md' role='document'>
                      <div class='modal-content'>
                        <div class='modal-header'>
                          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>用户验证</h3>
                        </div>
                        <div class='modal-body  form-horizontal'>
                          <div class="form-group">
                            <label class="col-xs-3 control-label">请输入密码：</label>
                            <div class="col-xs-9 input-group">
                              <input type="hidden" class="form-control" id="operation_state_">
                              <!-- 
                              <input type="password" class="form-control"  placeholder="" id="password_" autocomplete="off">
                               -->
                              <input name="password" placeholder="请输入密码" class="form-control" type="password" id="password_">
                            
                              <div>您需要输入当前登录用户的密码才能执行操作</div>
                            </div>
                          </div>
                          
                        </div>
                        <div class='modal-footer' style="text-align: center">
                          <input type="submit" name="commit" value="确定" class="btn btn-default btn-info" data-bind="click:operate" id="check_submit"/>
                          <button name="button" type="submit" class="btn btn-default btn btn-default" data-dismiss="modal">取消</button></div>
                        </div>
                     </div>
                    </div>
                <!-- 操作云主机  输入用户密码modal -->
			
		</div>
		
		<!-- 云主机tab页页面  -->
		<div class="tab-pane" id="router" role="tabpanel">
				<div class="row wrapper">
			        <div class="col-xs-8">
			        	<a class="btn btn-sm btn-primary" data-bind="click:addHost">添加</a>
			        </div>
		            <!-- 暂时不用，考虑数据量不多，也不做分页
			        <div class="col-xs-3">          
		                <div class="input-group">
		                  <span class="input-group-addon">名称</span>
		                  <input type="text" class="input-sm form-control" placeholder="请输入名称" data-bind="value: searchParam().name">
		                </div>
		            </div>
		            <div class="col-xs-1" >
		                <button class="btn btn-sm btn-default" type="button"  data-bind="click: searchVm">搜索qqq</button>
		            </div>
		             -->
		    	</div>		
			    <div class="table-responsive" data-bind="with: vmtable">
						<table class="table table-striped">
							<thead>
								<tr>
									<th>云主机名称</th>
									<th>CPU</th>
									<th>内存</th>
									<th>存储</th>
									<th>IP</th>
									<th>状态</th>
									<th>失效时间</th>
									<th>服务状态</th>
									<th>操作</th>
								</tr>
							</thead>
							<tbody>
								<tr data-bind="visible: showNoData">
									<td colspan="12" class="aligncenter">
	                       				 暂无数据
	                    			</td>
	                 			</tr>
							 <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
								<tr>
									<td data-bind="text:name"></td>
									<td data-bind="text:vcpu"></td>
									<td data-bind="text:memory"></td>
									<td data-bind="text:storage"></td>
									<td data-bind="text:ip"></td>
									<td >
									    <span class="label label-success" data-bind="if: state == 'ACTIVE' && taskState == null">运行中</span>
						                <span class="label label-danger" data-bind="if: state == 'SHUTOFF' && taskState == null">已关机</span>
						                <span class="label label-info" data-bind="if: state == 'SUSPENDED' && taskState == null">已挂起</span>
						                <span class="label label-warning" data-bind="if: taskState == 'POWERING_OFF'">正在关机</span>
						                <span class="label label-warning" data-bind="if: taskState == 'POWERING_ON'">正在启动</span>
						                <span class="label label-warning" data-bind="if: taskState == 'REBOOTING'">正在重启</span>
						                <span class="label label-warning" data-bind="if: taskState == 'REBOOTING_HARD'">正在强制重启</span>
						                <span class="label label-warning" data-bind="if: taskState == 'SUSPENDING'">正在挂起</span>
						                <span class="label label-warning" data-bind="if: taskState == 'RESUMING'">正在恢复</span>
						                <span class="label label-warning" data-bind="if: taskState == 'DELETING'">正在删除</span>
						                <span class="label label-warning" data-bind="if: taskState == 'RESIZING'">正在调整</span>
									</td>
									<td data-bind="text:expiryTime"></td>
									<td>
									    <span class="label label-success" data-bind="if: isValidate == true">正常</span>
									    <span class="label label-danger" data-bind="if: isValidate == false">过期</span>
									</td>
									<td><a data-bind="click: $root.remove">移除</a></td>
								</tr>
							<!-- /ko -->
							</tbody>
						</table>
					</div>	
			      <!-- 云主机tab页页面-->
			      
               <!--添云主机 modal  -->
		    	<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isAddHost }">
				  <div class='modal-dialog modal-lg' role='document'>
				    <div class='modal-content'>
				      <div class='modal-header'>
				        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>添加云主机</h3>
				      </div>
				      <div class='modal-body no-padder'>
				        <div class="row wrapper">
				          <div class="col-xs-8">
				          </div>
				          <div class="col-xs-3">          
				              <div class="input-group">
				                <span class="input-group-addon">名称</span>
				                <input type="text" class="input-sm form-control" placeholder="请输入名称" data-bind="value: searchAddVmParam().name">
				              </div>
				          </div>
				          <div class="col-xs-1">
				              <button class="btn btn-sm btn-default" type="button" data-bind="click: searchAddVm">搜索</button>
				          </div>
				        </div>  
				      <div class="table-responsive" data-bind="with:vmAddtable">        
				        <table class="table" >
				            <thead>
				              <tr>
				                <th>
				                  <div class="checkbox">
				                    <label class="i-checks">
				                      <input type="checkbox" data-bind="checked: isSelectedAll">
				                      <i></i>
				                    </label>
				                  </div>                    
				                </th> 
				                <th>云主机名称</th>
				                <th>CPU</th>
				                <th>内存</th>
				                <th>存储</th>
				                <th>IP</th>
				                <th>状态</th>
				                <th>失效时间</th>
				              </tr>
				            </thead>
				            <tbody>
				           		 <tr data-bind="visible: showNoData">
									<td colspan="12" class="aligncenter">
	                       				 暂无数据
	                    			</td>
	                 			</tr>
				             <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
				             <tr>
				                <td>
				                  <div class="checkbox">
				                    <label class="i-checks">
                                       <input type="checkbox" data-bind="checkedValue: $data, checked: $parent.chosenItems, enable: $root.isExistVM($data.uuid)">
				                      <i></i>
				                    </label>
				                  </div>  
				                </td>
				                <td data-bind="text:uuid" hidden="true"></td>
				                <td data-bind="text:name"></td>
				                <td data-bind="text:vcpu"></td>
				                <td data-bind="text:memory"></td>
				                <td data-bind="text:storage"></td>
				                <td data-bind="text:ip"></td>
				                <td>
			                        <span class="label label-success" data-bind="if: state == 'ACTIVE' && taskState == null">运行中</span>
					                <span class="label label-danger" data-bind="if: state == 'SHUTOFF' && taskState == null">已关机</span>
					                <span class="label label-info" data-bind="if: state == 'SUSPENDED' && taskState == null">已挂起</span>
					                <span class="label label-warning" data-bind="if: taskState == 'POWERING_OFF'">正在关机</span>
					                <span class="label label-warning" data-bind="if: taskState == 'POWERING_ON'">正在启动</span>
					                <span class="label label-warning" data-bind="if: taskState == 'REBOOTING'">正在重启</span>
					                <span class="label label-warning" data-bind="if: taskState == 'REBOOTING_HARD'">正在强制重启</span>
					                <span class="label label-warning" data-bind="if: taskState == 'SUSPENDING'">正在挂起</span>
					                <span class="label label-warning" data-bind="if: taskState == 'RESUMING'">正在恢复</span>
					                <span class="label label-warning" data-bind="if: taskState == 'DELETING'">正在删除</span>
					                <span class="label label-warning" data-bind="if: taskState == 'RESIZING'">正在调整</span>
				                </td>
				                <td data-bind="text:expiryTime"></td>
				              </tr>
				              <!--/ko  -->
				            </tbody>
				          </table>
				        </div>
				        <footer class="panel-footer" data-bind="with: vmAddtable, visible: vmAddtable.pages() > 1">
					        <ul class="pagination">
					          <li data-bind="css: leftPagerClass, click: prevPage">
					            <a href="#">&laquo;</a>
					          </li>
					          <!-- ko foreach: {data: (new Array(pages()))} -->
					          <li data-bind="css: $parent.pageClass($index() + 1)">
					            <a href="#" data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
					          </li>
					          <!-- /ko -->
					          <li data-bind="css: rightPagerClass, click: nextPage">
					            <a href="#">&raquo;</a>
					          </li>
					        </ul>
					     </footer>
				      </div>
				      <div class='modal-footer' style="text-align: center">
				        <input data-bind="click: $root.addVm" type="submit" name="commit" value="确定" class="btn btn-default btn-info" />
				        <button name="button" type="submit" class="btn btn-default btn btn-default" data-dismiss="modal">取消</button></div>
				      </div>
				    </div>
				  </div>  
		    	<!--modal end -->
                
                </div>	
        
        <!-- 调度任务 -->
			<div class='tab-pane' id='partition_tasks' role='tabpanel'>
				<div class="row wrapper">
				  <div class="col-xs-2">
				    <div class="input-group">
				      <span class="input-group-addon">任务名称</span>
				      <input type="text" class="input-sm form-control" maxlength="32" placeholder="请输入任务名称" data-bind="value: taskSearchParam().taskName">
				    </div>
				  </div>  
				  <div class="col-xs-2">
				    <div class="input-group">
				      <span class="input-group-addon">资源名称</span>
				      <input type="text" class="input-sm form-control" maxlength="32" placeholder="请输入资源名称" data-bind="value: taskSearchParam().targetName">
				    </div>
				  </div>                                    
				  <div class="col-xs-2">
				    <button class="btn btn-default btn-sm" type="submit" data-bind="click: searchTask">搜索</button>
				  </div>        
				</div>
				
				<div id='instance_tasks'>
				  <div class='table-responsive' data-bind="with: taskTable">
				    <table class='table table-striped'>
				      <thead>
				        <tr>
				          <th>任务编号</th>
				          <th>任务名称</th>
				          <th>任务进度（%）</th>
				          <th>任务状态</th>
				          <th>资源名称</th>
				          <th>资源类型</th>
				          <th>操作人</th>
				          <th>开始时间</th>
				          <th>完成时间</th>
				        </thead>
				        	<tbody>
				            <tr data-bind="visible: showNoData">
				              <td colspan=14 class="aligncenter">
				                	暂无数据
				              </td>
				            </tr>
				            <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
				            <tr> 
				                <td><a data-bind="text: taskId,click: $root.showTaskInfo"></a></td>
				                <td data-bind="text: taskName"></td>
				                <td data-bind="text: progress"></td>
				                <td>
				                	<span class="label label-success" data-bind="if: $row.state == 'success'">成功</span>
				                	<span class="label label-warning" data-bind="if: $row.state == 'in-progress'">进行中</span>
				                	<span class="label label-danger" data-bind="if: $row.state == 'completedAndError'">失败</span>
				                </td>
				                <td data-bind="text: targetName"></td>
				                <td>
				                	<span data-bind="if: $row.targetType == 'VM'">云主机</span>
				                	<span data-bind="if: $row.targetType == 'DISK'">云硬盘</span>
				                	<span data-bind="if: $row.targetType == 'PUBLICIP'">公网IP</span>
				                	<span data-bind="if: $row.targetType == 'LOAD_BALANCING'">负载均衡器</span>
				                	<span data-bind="if: $row.targetType == 'SECRET_KEY'">SSH密钥</span>
				                	<span data-bind="if: $row.targetType == 'OBJECT_STORAGE'">对象存储</span>
				                	<span data-bind="if: $row.targetType == 'business_system'">业务系统</span>
				                </td>
				                <td data-bind="text: user"></td>
				                <td data-bind="text: executeDate"></td>
				                <td data-bind="text: endDate"></td>
				            </tr>
				          	<!-- /ko -->
				          </tbody>
				        </table>
				      </div>
				      <footer class="panel-footer" data-bind="with: taskTable, visible: taskTable.pages() > 1">
					     <ul class="pagination">
					       <li data-bind="css: leftPagerClass, click: gotoPage(1)">
					         <a href="#">首页</a>
					       </li>
					       <li data-bind="css: leftPagerClass, click: prevPage">
					         <a href="#">&laquo;</a>
					       </li>
					       <li >
					         <a href="#"  data-bind="text: currentPage"></a>
					       </li>
					       <li data-bind="css: rightPagerClass, click: nextPage">
					         <a href="#">&raquo;</a>
					       </li>
					       <li data-bind="css: rightPagerClass, click: gotoPage(pages())">
					         <a href="#">末页</a>
					       </li>
					       <li class="page-control-li">
					         <div class="input-group form-group-sm">
					           <input type="text" class="form-control" data-bind="value: targetPage"  />
					           <div class="input-group-btn">
					             <a href="#" class="btn btn-sm btn-default" data-bind="click: gotoTargetPage()">跳转</a>
					           </div>
					         </div>
					         <div class="page-info-div" data-bind="text: recordsText"></div>
					       </li>
					     </ul>
					   </footer>
				</div>
				<!-- 调度任务详情 -->
				<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isLogText }"> 
			      <div class='modal-dialog' role='document'> 
			         <div class='modal-content'> 
			            <div class='modal-header'> 
			               <button type="button" class="close" data-dismiss="modal"> 
			                  <span aria-hidden="true">&times;</span> 
			               </button> 
			               <h3 class='modal-title'>任务日志</h3> 
			            </div> 
			            <div class='modal-body form-horizontal'> 
				            <div class="panel panel-info">
						        <div class="panel-heading">基本信息</div>
						        <div class="panel-body">
						            <div class="row">
						                <div class="col-xs-6">
						                    <p><strong>任务名称：</strong><span data-bind="text: taskLogVO().taskName"></span></p>
						                </div>
						                <div class="col-xs-6">
						                    <p><strong>任务进度：</strong><span data-bind="text: taskLogVO().progress"></span>%</p>
						                </div>
						            </div>
						            <div class="row">
						                <div class="col-xs-6">
						                    <p><strong>开始时间：</strong><span data-bind="text: taskLogVO().executeDate"></span></p>
						                </div>
						                <div class="col-xs-6">
						                    <p><strong>结束时间：</strong><span data-bind="text: taskLogVO().endDate"></span></p>
						                </div>
						            </div>
						        </div>
						    </div>
			            	<div class="panel panel-info">
						        <div class="panel-heading">详细信息</div>
						        <div class="panel-body">
					            	<div contenteditable="true" class="csc_dailyTextarea" id="task_log_text" style="width:519px;padding:3px 0 0 8px;"></div>
					            </div>
			               </div>
			               <div class='modal-footer' style="text-align: center"> 
			                  <button name="button" type="submit" 
			                     class="btn btn-default btn btn-default" data-dismiss="modal">关闭</button> 
			               </div> 
			            </div> 
			         </div> 
			      </div> 
			   </div>
				<!-- 调度任务详情 -->
			</div>
			<!-- 调度任务 -->
        
        </div>
    </div>
</div>

<!-- page specific plugin scripts -->
<script type="text/javascript">
    var scripts = [null, 'assets/lib/bootstrap-multiselect/bootstrap-multiselect.js']
    $('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
    	 function ViewModel(){
    		 /******调度任务******/
  	        //查询条件初始化
  	        this.taskSearchParam = ko.observable({
  				targetType : '',
  		        taskName : '',
  		        targetName : '',
  		        orderBy : 'executeDate:desc',
  		        taskCode : 'BUS_SYS_POWER',
  		        targetId : ''
  	        });
  	
  	        this.taskTable = new DataTable([]);
  	        
  	        this.searchTask = function() {
  	        	this.taskTable.params(this.taskSearchParam());
  	        }
  	
  	        this.reloadTaskList = function(subSysUuid){
 				this.taskSearchParam().targetId = subSysUuid;
 				this.taskTable.params(this.taskSearchParam());
 				this.taskTable.path('api/v5.0.0/tasks');
  	        }
  	        
  	      var self = this;
  	      //任务详情
  	      this.taskLogVO = ko.observable({});
  	      this.isLogText = ko.observable(false);
  	      
  	      this.showTaskInfo = function(object,event) {
  	    	  self.isLogText(true);
  	    	  self.taskLogVO(object);
  	    	  csc.rest.get("api/v5.0.0/tasks/"+object.taskId+"/logs",function(infoData){
  	    		  if(infoData){
  		    		  var logText = "";
  		    		  for(var i = 0;i < infoData.logs.length; i++){
  		    			  var executeTime = infoData.logs[i].executeTime;
  		    			  executeTime = self.integerToDate(executeTime);
  		    			  var message = infoData.logs[i].message;
  		    			  var state = infoData.logs[i].state;
  		    			  if(state == "completed"){
  		    				  state = "完成";
  		    			  }else if(state == "active"){
  		    				  state = "开始";
  		    			  }else if(state == "completedAndError"){
  		    				  state = "完成但有错误";
  		    			  }
  		    			  logText = logText + "<div>"+executeTime + "	-" + message + "	-" + state + "</div>";
  		    		  }
  		    		$("#task_log_text").html(logText);
  	    		  }
  	    	  });
  	      }
  	    this.integerToDate = function(timestamp){
  	      var d = new Date(timestamp);    //根据时间戳生成的时间对象
  	      var date = (d.getFullYear()) + "-" + 
  	                 (d.getMonth() + 1) + "-" +
  	                 (d.getDate()) + " " + 
  	                 (d.getHours()) + ":" + 
  	                 (d.getMinutes()) + ":" + 
  	                 (d.getSeconds());
  	      return date;
  	    }
  	        
  	        /******调度任务******/
    		 
    		 
    		 
    		   this.busSysInfoVo = ko.validatedObservable({
    			   name:ko.observable(""),
    			   vdcName:ko.observable(""),
    			   managerUsers:ko.observable(""),
    			   desc:ko.observable(""),
    			   uuid:ko.observable("")
    		   })
    		 
    	        this.vmList = ko.observableArray();
    	        
    	        function VM(busUuid,uuid,vmName,vmUuid, startOrder, delay){
    	        	this.busUuid = busUuid;
    	        	this.uuid = uuid;
    	        	this.vmName = vmName;
    	        	this.vmUuid = vmUuid;
    	        	this.startOrder = ko.observable(startOrder).extend({digit:{params:true,message:' '},required:{params:true,message:' '}});
    	        	this.delay = ko.observable(delay).extend({digit:{params:true,message:' '},required:{params:true,message:' '}});
    	        }
    	        
    	        this.loadSubSysInfo = function(){
                    csc.rest.get("api/v5.0.0/vms?vdcUuid="+args.vdcUuid,function(vmsdata){  
                        csc.rest.get("api/v5.0.0/bussys/"+args.subSysUuid, function(data){
                            var userList = data.userList;
                            var managerUsers = "";
                            if (userList!=null&&userList.length>0){
                            var uLength = userList.length;
                                for (var i=0;i<uLength;i++){
                                if(userList[i].type=="MANGER"){
                                    managerUsers += userList[i].account+","
                                }
                                }
                                if(managerUsers!=""){
                                    managerUsers = managerUsers.substr(0,managerUsers.length-1);
                                }
                            }
                            self.busSysInfoVo.fromJSON({
                                name:data.name,
                                managerUsers: managerUsers,
                                vdcName: data.vdcName,
                                desc: data.desc,
                                uuid: data.uuid
                            });
                            
                            var showVmList = [];
                            if(data.vmList!=null&&data.vmList.length>0){
                                for (var i=0;i<data.vmList.length;i++){
                                    var sOrder = data.vmList[i].startOrder;
                                    if (sOrder!='0'){
                                        showVmList.push(data.vmList[i]);
                                    }
                                }
                            }
                            
                            //转为对象
                            var list = ko.utils.arrayMap(data.vmList, function(result, index){
                                return ko.validatedObservable(new VM(result.busUuid,result.uuid,result.vmName,result.vmUuid, parseInt(result.startOrder), parseInt(result.delay)));
                            });
                            //云主机列表刷新
                            self.vmList(list);
                            
                            //将云主机电源操作按钮功能恢复
                            if(showVmList.length>0){
                                $("#button_save_set_").removeAttr("disabled");
                                $("#button_restartvm_").attr("disabled","true");
                                $("#button_onvm_").attr("disabled","true");
                                $("#button_offvm_").attr("disabled","true")
                                var isOn = self.checkVmsIsPowerOn(showVmList,vmsdata.results);
                                //说明有开机的云主机，恢复关机按钮
                                if(isOn){
                                    $("#button_restartvm_").removeAttr("disabled");
                                    $("#button_offvm_").removeAttr("disabled");
                                }
                                var isOff = self.checkVmsIsPowerOff(showVmList,vmsdata.results);
                                //说明有关机的云主机，恢复开机按钮
                                if(isOff){
                                    $("#button_onvm_").removeAttr("disabled");
                                }
                            }else{
                                $("#button_onvm_").attr("disabled","true");
                                $("#button_offvm_").attr("disabled","true");
                                $("#button_restartvm_").attr("disabled","true");
                                $("#button_save_set_").attr("disabled","true");
                            }
                            
                         });	
                        });
                    
                        //toCheckVmList:待比较的云主机，allVmsList：vdc下的全部云主机,判断待比较云主机内有开机的云主机
                        this.checkVmsIsPowerOn = function(toCheckVmList,allVmsList){
                            var isOn = false;
                            if(toCheckVmList.length==0||allVmsList.length==0){return isOn;}
                            
                            for(var i=0;i<toCheckVmList.length;i++){
                                for(var j=0;j<allVmsList.length;j++){
                                    if(toCheckVmList[i].vmUuid==allVmsList[j].uuid&&allVmsList[j].state=='ACTIVE'){
                                        isOn = true;
                                        return isOn;
                                    }
                                }
                            }
                            return isOn;
                        }
                    
                        //toCheckVmList:待比较的云主机，allVmsList：vdc下的全部云主机,判断待比较云主机内有关机的云主机
                        this.checkVmsIsPowerOff = function(toCheckVmList,allVmsList){
                            var isOff = false;
                            if(toCheckVmList.length==0||allVmsList.length==0){return isOff;}
                            for(var i=0;i<toCheckVmList.length;i++){
                                for(var j=0;j<allVmsList.length;j++){
                                    if(toCheckVmList[i].vmUuid==allVmsList[j].uuid&&allVmsList[j].state=='SHUTOFF'){
                                        isOff = true;
                                        return isOff;
                                    }
                                }
                            }
                            return isOff;
                        }
    	          
    	        }
    	        
    	        if(args.subSysUuid!=null&&typeof(args.subSysUuid)!="undefined"){
                    this.loadSubSysInfo();
                    this.reloadTaskList(args.subSysUuid);
    	        }
    	        
    	        this.editMode = ko.observable(false);
    	        
    	        this.editVMOrder = function(){
	    	        //查询uuid下所有的云主机列表
    	        	self.editMode(true);
	    	        if(self.vmList().length>0){
                        $("#button_save_set_").removeAttr("disabled");
	    	        }
    	        }
    	        this.cancelVMOrder = function(){
    	        	this.editMode(false);
    	        	self.loadSubSysInfo();
    	        }
    	        this.editVmList=ko.validatedObservable({
    	            vms:ko.observableArray()
    	        })
    	        this.confirmVMOrder = function(){
    	            //先置灰保存按钮 
    	            $("#button_save_set_").attr("disabled","true");
    	            
    	        	var list = this.vmList();
    	        	for(var i=0; i<list.length;i++){
    	        		var vm = list[i];
    	        		//数据不满足就返回
    	        		if(!vm.isValid()){
    	        			$("#button_save_set_").removeAttr("disabled");
    	        			return;
    	        		}
    	        	}
    	        	self.editVmList().vms(self.vmList);
    	        	
    	        	csc.rest.put("api/v5.0.0/bussys/"+args.subSysUuid+"/vmOrders",self.editVmList.toJSON(),function(data){
                          self.loadSubSysInfo();
                          self.editMode(false);
                      },function(data,textStatus) {
                          systemMsg.alert('修改失败！');
                          $("#button_save_set_").removeAttr("disabled");
                      });
    	        }
    	       
    	        //启动顺序加
    	        this.addCount = function(object, event){
    	            var orderNum = parseInt(object.startOrder())+1;
    	            if(orderNum==10000){
    	                return;
    	            }
    	        	object.startOrder(parseInt(object.startOrder())+1);
    	        }
    	        //启动顺序减
    	        this.decreaseCount = function(object, event){
    	            var orderNum = parseInt(object.startOrder())-1;
    	            if(orderNum==-1){
    	                return;
    	            }
    	        	object.startOrder(parseInt(object.startOrder())-1);
    	        }
    	        
    	        //延时间隔加
    	        this.addDelayCount = function(object, event){
    	            var delayNum = parseInt(object.delay())+1;
    	            if(delayNum==10000){
    	                return;
    	            }
    	        	object.delay(parseInt(object.delay())+1);
    	        }
    	        //延时间隔减
    	        this.decreaseDelayCount = function(object, event){
    	            var delayNum = parseInt(object.delay())-1;
    	            if(delayNum==-1){
    	                return;
    	            }
    	        	object.delay(parseInt(object.delay())-1);
    	        }
    	        
                 this.verifyToPass = ko.observable(false);
                 this.operationParam = ko.validatedObservable({
                     operate: "",
                     password: ""
                 })
                 
                 //对业务系统中云主机电源操作
                 this.operate  = function(){
                     //提交按钮置灰
                     $("#check_submit").attr("disabled","true");
                     var password_ = $("#password_").val().trim();
                     if(password_==""){
                         systemMsg.alert('密码不能为空！');
                         //提交按钮置恢复
                         $("#check_submit").removeAttr("disabled");
                         return;
                     }
                     self.operationParam().password=password_;
                     
                     csc.rest.put("api/v5.0.0/uap/checkUserPassWord",self.operationParam.toJSON(),function(data){
                         var result = data.result;
                         if(result){
                             //提交按钮置恢复
                             $("#check_submit").removeAttr("disabled");
                             //获取操作值
                             var operation_state_ = $("#operation_state_").val();
                             self.operationParam().operate=operation_state_;
                             //置空密码
                             self.operationParam().password="";
                             //隐藏验证框，注意：如果先隐藏，操作值operation_state_就获取不了
                             self.verifyToPass(false);
                             if(operation_state_=="START"){
                                 csc.rest.put("api/v5.0.0/bussys/"+args.subSysUuid+"/vmPowers",self.operationParam.toJSON(),function(data){
                                     systemMsg.alert('云主机开机请求成功！调度任务 ID：'+data.taskId);
                                 },function(data,textStatus) {
                                     systemMsg.alert('云主机开机失败！');
                                 }); 
                             }else if(operation_state_=="STOP"){
                                 csc.rest.put("api/v5.0.0/bussys/"+args.subSysUuid+"/vmPowers",self.operationParam.toJSON(),function(data){
                                     systemMsg.alert('云主机关机请求成功！调度任务 ID：'+data.taskId);
                                  },function(data,textStatus) {
                                      systemMsg.alert('云主机关机失败！');
                                 });
                             }else if (operation_state_=="RESTART"){
                                 csc.rest.put("api/v5.0.0/bussys/"+args.subSysUuid+"/vmPowers",self.operationParam.toJSON(),function(data){
                                     systemMsg.alert('云主机重启请求成功！调度任务 ID：'+data.taskId);
                                 },function(data,textStatus) {
                                      systemMsg.alert('云主机重启失败！');
                                 });
                             }
                             //重新加载调度任务
                             self.reloadTaskList(args.subSysUuid);
                         }else{
                             systemMsg.alert('验证不正确！');
                             $("#check_submit").removeAttr("disabled");
                         }
                     },function(data,textStatus) {
                         systemMsg.alert('验证不正确！');
                         $("#check_submit").removeAttr("disabled");
                     });
                 }
                 /******************开机操作*****************************/
                 this.powerOnVm = function(){
                     self.verifyToPass(true)
                     $("#operation_state_").val("START");
                     $("#password_").val("");
                     $("#password_").capsLockTip();
                  }
                /******************开机操作*****************************/

                /******************关机操作*****************************/
                 this.powerOffVm = function(){
                     self.verifyToPass(true);
                     $("#operation_state_").val("STOP");
                     $("#password_").val("");
                     $("#password_").capsLockTip();
                 }
                /******************关机操作*****************************/

                /******************重启操作*****************************/
                 this.powerRestartVm = function(){
                     self.verifyToPass(true);
                     $("#operation_state_").val("RESTART");
                     $("#password_").val("");
                     $("#password_").capsLockTip();
                  }
                /******************重启操作*****************************/
        }
        var v1 = new ViewModel();
        ko.applyBindings(v1, $('#VM_OPERATION')[0]); 
        //加载调度任务数据
        ko.applyBindings(v1, $('#partition_tasks')[0]);

        function ViewVmModel(){
            //定义云主机实例
	        this.vmVo = ko.validatedObservable({
	             busSysVmRelUuid:ko.observable(""),
	             name:ko.observable(""),
	             vcpu:ko.observable(""),
	             memory:ko.observable(""),
	             storage:ko.observable(""),
	             ip:ko.observable(""),
	             state:ko.observable(""),
	             expiryTime:ko.observable(""),
	             isValidate:ko.observable("")
            });

            this.isAddHost = ko.observable(false);
            var self = this;
            this.modalVmList = ko.observableArray();
            this.addHost = function(){
                //清空搜索框
                self.searchAddVmParam().name="";
                self.vmAddtable.refreshData();//刷新数据

                self.isAddHost(true)
                //查询已经关联的云主机
                csc.rest.get(busSysVmUrl, function(data){
                    self.modalVmList(data.results);
                });
            }

            this.searchParam = ko.observable({
                 name: ""
            })

            this.searchVm = function(){
                 this.vmtable.params(this.searchParam());
            }
            //云主机tab页面，通过业务系统uuid查询出关联的云主机
            var busSysVmUrl = "api/v5.0.0/bussys/"+args.subSysUuid+"/vms";
            this.vmtable = new DataTable([], {path: busSysVmUrl});
            this.isExistVM = function(uuid){
            	//查找modaoVmList中是否存在uuid的数据，是就返回false
            	var result = _.findWhere(this.modalVmList(), {uuid: uuid});
            	return !result;
            }

            /********************业务系统删除-start**************/
            this.remove = function(object,event){
                confirm("确定移除云主机【"+object.name+"】？",function(arg){
                   var delVmList = {};
                   var listJson = [];
                   listJson.push(new VM(args.subSysUuid,args.vdcUuid,object.vmName,object.uuid,'0','0'));
                   delVmList["delVms"] = listJson;

                   csc.rest.put("api/v5.0.0/bussys/"+args.subSysUuid+"/vms",delVmList,function(data){
                        systemMsg.alert('移除成功！');
                        self.vmtable.refreshData();//刷新数据
                        self.isAddHost(false);
                        
                        //刷新详情页信息
                        v1.loadSubSysInfo();
                        //重置设置按钮
                        v1.cancelVMOrder();
                    },function(data,textStatus) {
                        systemMsg.alert('移除失败！');
                    });
                })
            }
           /************************业务系统删除-end**************/
            //封装云主机和业务系统关系，及初始化部分值
           function VM(busUuid,vdcUuid,vmName,vmUuid,startOrder,delay){
                this.busUuid = busUuid;
                this.vdcUuid = vdcUuid;
                this.vmName = vmName;
                this.vmUuid = vmUuid;
                this.startOrder = startOrder;
                this.delay = delay;
           }
            this.addVmVo = ko.validatedObservable({
                 uuid:ko.observable(""),
                 name:ko.observable(""),
                 vcpu:ko.observable(""),
                 memory:ko.observable(""),
                 storage:ko.observable(""),
                 ip:ko.observable(""),
                 state:ko.observable(""),
                 expiryTime:ko.observable(""),
                 isValidate:ko.observable("")
            });

             this.searchAddVmParam = ko.observable({
                 name: "",
                 vdcUuid: args.vdcUuid
             })

             this.searchAddVm = function(){
                  this.vmAddtable.params(this.searchAddVmParam());
             }

             /************云主机tab页面，通过业务系统vdcUuid查询出关联的云主机-start***********/
             var vmUrl = "api/v5.0.0/vms?vdcUuid="+args.vdcUuid;
             this.vmAddtable = new DataTable([], {path: vmUrl,perPage:8});
            /************云主机tab页面，通过业务系统uuid查询出关联的云主机-end**************/

            /******************提交保存业务系统和云主机关系*****************************/
             var newVmList = {};
             this.addVm = function(){
                 //去重如果已经关联的业务系统，就不需要添加进来
                var chosenItems = _.reject(this.vmAddtable.chosenItems(), function(item){
                    return !self.isExistVM(item.uuid)
                });
                 
                 var vmUuids = _.pluck(chosenItems, "uuid")
                 var vmNames = _.pluck(chosenItems, "name")
                 //组装数据
                 if(vmUuids!=null&&vmUuids.length>0){
                     var listJson = []
                     for (var i=0;i<vmUuids.length;i++){
                         listJson.push(new VM(args.subSysUuid,args.vdcUuid,vmNames[i],vmUuids[i],'0','0'));
                     }
                 }else {
                     systemMsg.alert('没有选择数据，请检查！');
                     return;
                 }
                 newVmList["addVms"] = listJson;
                 csc.rest.put("api/v5.0.0/bussys/"+args.subSysUuid+"/vms",newVmList,function(data){
                     systemMsg.alert('添加成功！');
                     self.isAddHost(false);
                     self.vmtable.refreshData();//刷新数据
                     
                     //重置设置按钮
                     v1.cancelVMOrder();
                 },function(data,textStatus) {
                 }); 
             }
             
            /******************提交保存业务系统和云主机关系*****************************/
            
        }
        
        
        /************/
        var v2 = new ViewVmModel();
        ko.applyBindings(v2, $('#router')[0]);

    });
    
    /*--------------------密码输入框增加大写提示 start--------------------*/
    $.fn.extend({
        capsLockTip: function() {
            return this.each(function() {
                window.capsLockActived = false;
                var $element = $(this);
                var showTips = function(isShow,$element){
            		if(isShow) {
            		    hideTips();
            		    $element.after('<div class="capslock">大写锁定已打开</div>');
            		}else 
            			hideTips() 
            	}; 
            	var hideTips = function(){ 
            	  $(".capslock").remove(); 
            	} 
            	$element.bind("keypress", function (_event) { 
        			var e = _event || window.event; 
        			var kc = e.keyCode || e.which; 
        			var isShift = e.shiftKey || (kc == 16) || false; 
        			capsLockActived = false; 
        			if ((kc >= 65 && kc <= 90 && !isShift) || (kc >= 97 && kc <= 122 && isShift)){ 
        				capsLockActived = true;
        			}
        			showTips(capsLockActived,$element); 
        		}); 

        		$element.bind("keydown", function (_event) { 
        			var e = _event || window.event; 
        			var kc = e.keyCode || e.which; 
        			if (kc == 20 && null != capsLockActived){ 
        				capsLockActived = !capsLockActived; 
        				showTips(capsLockActived,$element); 
        			} 
        		}); 

        		$element.bind("focus", function (_event) { 
        			if (null != capsLockActived) 
        				showTips(capsLockActived,$element); 
        		}); 
        		
        		$element.bind("blur", function (_event) { 
        		    if (null != capsLockActived) 
        		        showTips(false,$element); 
        		});
            });
        }
    });
    
	/*--------------------密码输入框增加大写提示 end--------------------*/

</script>