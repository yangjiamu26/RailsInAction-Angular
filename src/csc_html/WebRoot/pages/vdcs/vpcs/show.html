<div class="bg-light lter b-b wrapper-sm">
	<ol class="breadcrumb">
		<li>当前位置：</li>
		<li><a href="#pages/vdcs/vpcs/index?type=0">VPC管理</a></li>
		<li class="active">VPC详情</li>
	</ol>
</div>

<div class='wrapper-md'>
	<div class="nav-tabs-alt bg-white-only">
		<ul class="nav nav-tabs" role="tablist">
			<li class="active" role="presentation">
				<a aria-controls="VPC" data-toggle="tab" href="#baseInfo" role="tab">基本信息</a>
			</li>
			<li role="presentation">
				<a aria-controls="router" data-toggle="tab" href="#topo" role="tab">网络拓扑图</a>
			</li>
		</ul>
		<div class="tab-content">
			<div class="tab-pane active" id="baseInfo" role="tabpanel">
				<div class="wrapper-md">
					<p><strong>VPC名称：</strong><span data-bind="text:vpcVO().name"></span></p>
					<p><strong>所属VDC：</strong><span data-bind="text:vpcVO().vdcName"></span></p>
					<p><strong>可用分区：</strong><span data-bind="text:vpcVO().azName"></span></p>
					<p><strong>外部网络：</strong>
					    <span data-bind="text:vpcExtNetQuery().name"></span>
						<button class="btn btn-default btn-sm" data-bind="click:addVpcExtNet,visible: shouldShowAddExt">添加</button>
						<button class="btn btn-default btn-sm" data-bind="click:removeVpcExtNet,visible: shouldShowRemoveExt">移除</button>
					</p>
          <p><strong>私有网络：</strong>
            <button class="btn btn-default btn-sm"  data-bind="click:createVpcNet" >创建</button>
          </p>
				</div>
				<div class="row wrapper">
					<div class="col-xs-8">
						
					</div>
					<div class="col-xs-3">          
                        <div class="input-group">
                          <span class="input-group-addon">名称</span>
                          <input type="text" class="input-sm form-control" placeholder="请输入名称" data-bind="value: searchVpcNetParam().name">
                        </div>
                    </div>
                    <div class="col-xs-1">
                        <button class="btn btn-sm btn-default" type="button" data-bind="click:searchVpcNet">搜索</button>
                    </div>
				</div>		
				<table class="table table-striped"  data-bind="with: netListTable">
					<thead>
						<tr>
							<th>子网名称</th>
							<th>网络类型</th>
							<th>网段</th>
							<th>IP总数</th>
							<th>创建时间</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody>
					   	<tr data-bind="visible: showNoData">
						            <td colspan=11 class="aligncenter">
						              This table has no data.
						            </td>
						</tr>
					    <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
						<tr>
							<td data-bind="text: $row.name"></td>
							<td data-bind="text: $row.name"></td>
							<td data-bind="text: $row.cidr"></td>
							<td data-bind="text: $row.ipTotal"></td>
							<td data-bind="text: $row.createTime"></td>
							<td>
								 <a data-bind="click:$root.delVpcNet">删除</a>
							</td>
						</tr>
						<!-- /ko -->
					</tbody>
				</table>
				<footer class="panel-footer" data-bind="with: netListTable, visible: netListTable.pages() > 1">
				      <ul class="pagination">
				        <li data-bind="css: leftPagerClass, click: prevPage">
				          <a href="#">&laquo;</a>
				        </li>
				        <!-- ko foreach: {data: (new Array(pages()))} -->
				        <li data-bind="css: $parent.pageClass($index() + 1)">
				          <a href="#" data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
				        </li>
				        <!-- /ko -->
				        <li data-bind="css: rightPagerClass, click: nextPage">
				          <a href="#">&raquo;</a>
				        </li>
				      </ul>
				 </footer>
			
			<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: addVpcExtNetModal }">
			  <div class='modal-dialog modal-lg' role='document'>
			    <div class='modal-content'>
			      <div class='modal-header'>
			        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>添加子网</h3>
			      </div>
			      <div class='modal-body form-horizontal'>
			        <div class="form-group string required">
			          <span>网络名称：</span>
			          <select class="form-control" style="display:inline-block;width:150px"  data-bind="options:vpcExtNetList,optionsText:'netWorkName',optionsValue:'netWorkUuid',value:vpcExtNetVO().vpcExtNetUuid"  id="netSelect">
			          </select>
			        </div>
			        </div>
			      <div class='modal-footer'>
			        <input type="button" name="commit" value="确定" data-bind="click:confirmAddVpcExtNet" class="btn btn-default btn-info" />
			        <button name="button" type="submit" class="btn btn-default btn btn-default" data-dismiss="modal">取消</button>
			      </div>
			    </div>
			  </div>
			</div>
				 
		   <div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: createVpcNetModal }">
			 <div class='modal-dialog' role='document' >
			    <div class='modal-content'>
			      <div class='modal-header'>
			        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>创建网络</h3>
			      </div>
			      <div class='modal-body form-horizontal'>
			        <div class="form-group">
			          <label class="col-xs-3 control-label">网络名称</label>
			          <div class="col-xs-5">
			            <input class="form-control" type="text"  data-bind="value: vpcNetVO().name"/>
			          </div>
			          <div class="col-xs-4">
			            <span class="text-danger inline m-l-n m-t-sm">*</span>
			          </div>          
			        </div>
			        <div class="form-group">
			          <label class="col-xs-3 control-label">网段</label>
			          <div class="col-xs-5">
			            <input class="form-control" type="text" data-bind="value: vpcNetVO().cidr,valueUpdate: 'afterkeydown'"/>
			          </div>
			          <div class="col-xs-4">
			            <span class="text-danger inline m-l-n m-t-sm">*</span> 格式如：192.168.1.0/24
			          </div>          
			        </div> 
			        <div class="form-group">
			          <label class="col-xs-3 control-label">子网掩码</label>
			          <div class="col-xs-5">
			            <input class="form-control" type="text" data-bind="value: vpcNetVO().mask,enable:false"/>
			          </div>
			        </div> 
			        <div class="form-group form-inline">
			          <label class="col-xs-3 control-label">可用IP段 </label>
			          <div class="col-xs-9 ">
			            <div>
			              <a data-bind="click: addNetPoolsItem">添加</a>
			            </div>      
			           </div>
			          <div class="col-xs-9 " data-bind="foreach: vpcNetVO().netPools">
			            <div>
			              <input class="form-control" style="width:140px" type="text"  data-bind="value:start" /> ~ <input class="form-control" style="width:140px" type="text" data-bind="value:end" /> 
			              <a data-bind="click: $root.removeNetPoolsItem">删除</a>
			            </div>
			          </div>       
			        </div>   
			        <div class="form-group">
			          <label class="col-xs-3 control-label">网关</label>
			          <div class="col-xs-5">
			            <input class="form-control" type="text" data-bind="value: vpcNetVO().gateway"/>
			          </div>
			          <div class="col-xs-4">
			            <span class="text-danger inline m-l-n m-t-sm">*</span>
			          </div>         
			        </div>
			        <div class="form-group">
			          <label class="col-xs-3 control-label">主DNS</label>
			          <div class="col-xs-5">
			            <input class="form-control" type="text" data-bind="value: vpcNetVO().masterDns"/>
			          </div>
			        </div>
			        <div class="form-group">
			          <label class="col-xs-3 control-label">备DNS</label>
			          <div class="col-xs-5">
			            <input class="form-control" type="text" data-bind="value: vpcNetVO().slaverDns"/>
			          </div>
			        </div>  
			      </div>
			      <div class='modal-footer'>
			        <input type="button" name="commit" value="确定" data-bind="click: vpcNetSubmit" class="btn btn-default btn-info" />
			        <button name="button" type="submit" class="btn btn-default btn btn-default" data-dismiss="modal">取消</button>
			      </div>
			    </div>
			  </div>
			</div>
		   </div>
			
			
			
			<div class="tab-pane" id="topo" role="tabpanel">
				<div class="row">
					<div class="col-xs-8">
						<canvas id="canvas1" width=850 height=550></canvas>
					</div>
					<div class="col-xs-4 form-horizontal" style="padding-right:30px;padding-top:15px;">
						<div class="panel panel-default">
							<div class="panel-heading">子网配置</div>
							<div class="panel-body">
								<div class="form-group">
									<label  class="col-xs-4 control-label">网络类型：</label>
									<div class="col-xs-7">
										<select class="form-control">
											<option>公有网络</option>
										</select>
									</div>
								</div>
								<div class="form-group">
									<label  class="col-xs-4 control-label">网络名称：</label>
									<div class="col-xs-7">
										<select class="form-control">
											<option>网络名称1</option>
											<option>网络名称2</option>
										</select>
									</div>
									<div class="col-xs-1">
							            <span class="text-danger inline m-l-n m-t-sm">*</span>
							        </div>
								</div>
								<div class="form-group">
									<label  class="col-xs-4 control-label">子网名称：</label>
									<div class="col-xs-7">
										<select class="form-control">
											<option>子网名称1</option>
											<option>子网名称2</option>
										</select>
									</div>
									<div class="col-xs-1">
							            <span class="text-danger inline m-l-n m-t-sm">*</span>
							        </div>
								</div>
							</div>
						</div>

						<div class="panel panel-default">
							<div class="panel-heading">子网配置</div>
							<div class="panel-body">
								<div class="form-group">
									<label  class="col-xs-4 control-label">网络类型：</label>
									<div class="col-xs-7">
										<select class="form-control">
											<option>私有网络</option>
										</select>
									</div>
								</div>
								<div class="form-group">
									<label  class="col-xs-4 control-label">子网名称：</label>
									<div class="col-xs-7">
										<input type="text" class="form-control">
									</div>
									<div class="col-xs-1">
							            <span class="text-danger inline m-l-n m-t-sm">*</span>
							        </div>
								</div>
							</div>
						</div>

						<div class="panel panel-default">
							<div class="panel-heading">路由器配置</div>
							<div class="panel-body">
								<div class="form-group">
									<label  class="col-xs-4 control-label">路由器名称：</label>
									<div class="col-xs-7">
										<input type="text" class="form-control">
									</div>
									<div class="col-xs-1">
							            <span class="text-danger inline m-l-n m-t-sm">*</span>
							        </div>
								</div>
								<div class="form-group">
									<label  class="col-xs-4 control-label">路由器地址：</label>
									<div class="col-xs-7">
										<input type="text" class="form-control">
									</div>
									<div class="col-xs-1">
							            <span class="text-danger inline m-l-n m-t-sm">*</span>
							        </div>
								</div>
							</div>
						</div>

						<div class="panel panel-default">
							<div class="panel-heading">路由器配置</div>
							<div class="panel-body">
								<div class="form-group">
									<label  class="col-xs-4 control-label">路由器名称：</label>
									<div class="col-xs-7">
										<input type="text" class="form-control">
									</div>
									<div class="col-xs-1">
							            <span class="text-danger inline m-l-n m-t-sm">*</span>
							        </div>
								</div>
								<div class="form-group">
									<label  class="col-xs-4 control-label">网络名称：</label>
									<div class="col-xs-7">
										<select class="form-control">
											<option>网络1</option>
											<option>网络2</option>
										</select>
									</div>
								</div>
							</div>
						</div>

						<div class="panel panel-default">
							<div class="panel-heading">防火墙配置</div>
							<div class="panel-body">
								<div class="form-group">
									<label  class="col-xs-4 control-label">配置方式：</label>
									<div class="col-xs-7">
										<select class="form-control">
											<option>网络1</option>
											<option>网络2</option>
										</select>
									</div>
								</div>
								<div class="form-group">
									<label  class="col-xs-4 control-label">防火墙名称：</label>
									<div class="col-xs-7">
										<input type="text" class="form-control">
									</div>
									<div class="col-xs-1">
							            <span class="text-danger inline m-l-n m-t-sm">*</span>
							        </div>
								</div>
								<div class="form-group">
									<label  class="col-xs-4 control-label">路由器：</label>
									<div class="col-xs-7">
										<select class="form-control">
											<option>路由器1</option>
											<option>路由器2</option>
										</select>
									</div>
									<div class="col-xs-1">
							            <span class="text-danger inline m-l-n m-t-sm">*</span>
							        </div>
								</div>
								<div class="form-group">
									<label  class="col-xs-4 control-label">规则：</label>
									<div class="col-xs-7">
										<a class="btn btn-link" onclick="showModal('pages/vpcs/topo_firewall.html')">查看</a>
									</div>
								</div>
							</div>
						</div>

						<div class="panel panel-default">
							<div class="panel-heading">防火墙配置</div>
							<div class="panel-body">
								<div class="form-group">
									<label  class="col-xs-4 control-label">配置方式：</label>
									<div class="col-xs-7">
										<select class="form-control">
											<option>网络1</option>
											<option>网络2</option>
										</select>
									</div>
								</div>
								<div class="form-group">
									<label  class="col-xs-4 control-label">防火墙名称：</label>
									<div class="col-xs-7">
										<input type="text" class="form-control">
									</div>
									<div class="col-xs-1">
							            <span class="text-danger inline m-l-n m-t-sm">*</span>
							        </div>
								</div>
								<div class="form-group">
									<label  class="col-xs-4 control-label">规则：</label>
									<div class="col-xs-7">
										<a class="btn btn-link" onclick="showModal('pages/vpcs/topo_firewall.html')">查看</a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- page specific plugin scripts -->
<script type="text/javascript">
	var scripts = [null,'assets/js/jtopo.js', "api/vpc/vpc.js", "api/vdc/vdc.js"]
	$('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
		var vpcUuid = args.vpcUuid;
		$.VPC.getVpcs({uuid:vpcUuid},function(data){
			  if(data.results && data.results.length > 0){
				    var vpcObj = data.results[0];
					function vpcInfoViewModel(){
			    		var self = this;
			    		self.vpcVO = ko.validatedObservable(vpcObj);
			    		
			    		self.vpcExtNetQuery = ko.observable({
			    			"name":"",
			    			 "uuid":""
			    		});
						self.shouldShowAddExt = ko.observable(false);
						self.shouldShowRemoveExt = ko.observable(false);
						
			    		$.VPC.getVpcNet({vpcUuid:vpcUuid,type:"EXTERNAL"},function(data){
			    			  if(data && data.results && data.results.length > 0){
			    				  var vpcNet = data.results[0];
			    				  self.vpcExtNetQuery(
			    						  {
			    							  "name":vpcNet.name,
			    							  "uuid":vpcNet.uuid
			    						  });
			    				  self.shouldShowAddExt(false);
			    				  self.shouldShowRemoveExt(true);
			    			  }else{
			    				  self.shouldShowAddExt(true);
			    				  self.shouldShowRemoveExt(false);
			    			  }
			    		});
			    		
			    		self.netListTable = new DataTable([], {path: 'api/v5.0.0/vpcNetworks?type=INNER&vpcUuid='+vpcUuid, perPage: 1});
			    		self.searchVpcNetParam = ko.observable({
		        	        name: ""
		        	    })
		        	    
			       	    self.searchVpcNet = function(){
			       	      self.netListTable.params(this.searchVpcNetParam());
			       	    }
			    		
			    		 /*  ko.validation.rules['ipRuleCheck'] = {
			    			    validator: function (val, otherVal) {
			    			        return val === otherVal;
			    			        	if(/^([1-9]|[1-9]\d|1\d\d|2[0-1]\d|22[0-3])(\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])){2}\.([1-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-4])$/.test(value)){
												return true;
										}
			    			    },
			    			    message: 'ip地址格式不正确，正确格式如：192.168.1.1'
			    			};
			    			ko.validation.registerExtenders();   */
			    		
			    		self.vpcNetVO = ko.validatedObservable({
		    			     "name":ko.observable().extend({required: true}),
							 "cidr":ko.observable().extend({required: true}),
							 "gateway":ko.observable().extend({required: true}),
							 "masterDns":ko.observable(),
							 "slaverDns":ko.observable(),
							 "mask":ko.observable(),
							 netPools: ko.observableArray()
							});
			    			
		    			  this.vpcNetVO().cidr.subscribe(function(){
		    				    try{
		    				    	 var mask = csc.util.segGetMask(self.vpcNetVO.toJSON().cidr);
				    				     self.vpcNetVO.fromJSON({mask:mask});
		    				    }catch(e){
		    				    }
		    			   });
			    			
			    		self.addNetPoolsItem = function(){
			    			self.vpcNetVO().netPools.push({
			    				start: "",
			    				end: ""
			    			});
			    		}
			    		self.removeNetPoolsItem = function(obj){
			    			self.vpcNetVO().netPools.remove(obj);
			    		}
			    		
			    		this.createVpcNetModal = ko.observable(false);
			    		this.createVpcNet = function(){
			    			self.vpcNetVO.fromJSON({"name":"testnet",
								 "cidr":"10.0.8.0/24",
								 "gateway": "10.0.8.254",
								 "masterDns":"8.8.8.8",
								 "slaverDns":"114.114.114.114"
								});
			    			self.createVpcNetModal(true)	
			    		}
			    		
			    		self.vpcNetSubmit = function(){
		    				    ko.validation.group(self.vpcNetVO).showAllMessages();
		    				    console.log(self.vpcNetVO.toJSON())
		    	    	        if(self.vpcNetVO.isValid()){
		    	    	        	var vpcNetJson = self.vpcNetVO.toJSON();
		    	    	        	var param = {};
		    	    	        	param.vpcUuid = vpcUuid;
		    	    	        	param.name = vpcNetJson.name;
		    	    	        	param.cidr = vpcNetJson.cidr;
		    	    	        	param.gateway = vpcNetJson.gateway;
		    	    	        	param.type="INNER";
		    	    	        	param.enableDhcp="true";
		    	    	        	param.dnsNames = [vpcNetJson.masterDns,vpcNetJson.slaverDns];
		    	    	        	param.pools =  vpcNetJson.netPools;
		    	    	        	/* var netPoolList = vpcNetJson.netPools;
		    	    	        	for(var i=0;i<netPoolList.length;i++){
		    	    	        		var netPool = netPoolList[i];
		    	    	        		param.netPool += netPool.start+"-"+netPool.end;
		    	    	        		if(i != netPoolList.length-1){
		    	    	        			param.netPool+=","
		    	    	        		}
		    	    	        	} */
		    	    	        	$.VPC.createVpcNetwork(param,function(data){
		    	        			 	self.createVpcNetModal(false);
		    	        		    	self.netListTable.refreshData();
		    	        			});
		    	    	        }
			    		}
			    		
			    		
			    		self.delVpcNet = function(rowObj){
			    			var vpcNetName = rowObj.name;
			    			confirm("确定删除网络["+vpcNetName+"]？",function(arg){
			    				$.VPC.delVpcNet(rowObj.uuid,function(data){
			    					  self.netListTable.refreshData();
			    					  alert("删除网络["+vpcNetName+"]成功！")
			           			});
			    			 });
			    		}
			    		
			    		
			    		/********ext network*******/
			    		self.vpcExtNetVO = ko.validatedObservable({
		    			        "vpcExtNetUuid":ko.observable().extend({required: true})
							});
			    		
			    		self.vpcExtNetList = ko.observableArray();
			    		self.addVpcExtNetModal = ko.observable(false);
			    		this.addVpcExtNet = function(){
			    			$.VDC.getVdcNetworks(vpcObj.vdcUuid,{},function(data){
			    				console.log(data)
			    				 if(data && data.results){
			    					 self.vpcExtNetList(data.results);
			    				 }
			    			});
			    			
			    			self.addVpcExtNetModal(true)	
			    		}
			    		
			    		self.removeVpcExtNet = function(){
			    			var extName = self.vpcExtNetQuery().name;
			    			var extUuid = self.vpcExtNetQuery().uuid;
			    			confirm("确定移除外部网络["+extName+"]？",function(arg){
			    				$.VPC.delVpcNet(extUuid,function(data){
			    					 self.vpcExtNetQuery({
		    							  "name":"",
		    							  "uuid":""
		    						  })
			    					 self.shouldShowAddExt(true);
									 self.shouldShowRemoveExt(false);
			    					  alert("移除外部网络["+extName+"]成功！")
			           			});
			    			 });
			    		}
			    		
			    		self.confirmAddVpcExtNet = function(){
			    			var vpcExtNetUuid = self.vpcExtNetVO.toJSON().vpcExtNetUuid;
			    			var param = {};
		    	    	     param.vpcUuid = vpcObj.uuid;
		    	    	     param.uuid = vpcExtNetUuid;
		    	    	     param.type = "EXTERNAL";
			    			$.VPC.createVpcNetwork(param,function(data){
			    				console.log(data)
			    				 if(data){
			    					 self.vpcExtNetQuery({
		    							  "name":data.name,
		    							  "uuid":data.uuid
		    						  })
				    				 self.shouldShowAddExt(false);
									 self.shouldShowRemoveExt(true);
			    				 }
			    				self.addVpcExtNetModal(false)	
			    			});
			    		}
			    	
			    		/************ext network******/
					}
					
				    ko.applyBindings(new vpcInfoViewModel(), $("#page-content")[0]);
			  }
	    });
		
 
});
</script>