<div class="row wrapper">
  <div class="col-xs-1">
    <button class="btn btn-sm btn-info" data-bind="click: addSecretkey">创建</button>
  </div>
  <div class="col-xs-3">
    <div class="input-group">
      <span class="input-group-addon">所属VDC</span>
      <select class="form-control input-sm" data-bind="value: searchParam().vdcUuid, options: $root.vdcs, optionsText: 'name', optionsValue: 'uuid'"></select>
    </div>      
  </div>  
  <div class="col-xs-3">
    <div class="input-group">
      <span class="input-group-addon">所属可用分区</span>
     <select class="form-control input-sm" data-bind="value: searchParam().azUuid, options: $root.partitions, optionsText: 'name', optionsValue: 'uuid'"></select>
    </div>      
  </div>                        
  <div class="col-xs-3">
    <div class="input-group">
            <span class="input-group-addon">名称</span>
            <input type="text" class="input-sm form-control" placeholder="请输入名称" data-bind="value: searchParam().name">
          </div>
  </div>
  <div class="col-xs-2">
    <button class="btn btn-sm" type="button" data-bind="click:reset">重置</button>
    <button class="btn btn-sm btn-default" type="button" data-bind="click:search">搜索</button>
  </div>
</div>                         
<div id='instance_sshkeys'>
  <div class='table-responsive' data-bind="with: table">
    <table class='table table-striped'>
      <thead>
        <tr>
          <th>密钥名称</th>
          <th>指纹</th>
          <th>公钥</th>
          <th>可用分区</th>
          <th>所属VDC</th>
          <th>服务状态</th>
          <th>有效期</th>
         <!--  <th>创建时间</th> -->
          <th>创建人</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
         <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
        <tr>
          <td data-bind="text:name">测试密钥1</td>
          <td data-bind="text:fingerprint">8a:c6:9a:8a:c6:9a:8a:c6:9a:8a:c6:9a:8a:c6:9a:8a:c6:9a</td>
          <td data-bind="text:publicKeyString,attr:{title:publicKey}">AAAAAAAAAA</td>
          <td data-bind="text:azName">AZ1</td>
          <td data-bind="text:vdcName">VDC1</td>
          <td>
    	<span class="label label-success" data-bind="if:isValidate">正常</span>
      	<span class="label label-danger" data-bind="ifnot:isValidate">已过期</span>
    </td>
    <td data-bind="text:expiryDate">2016-06-29 11:55</td>
   <!--  <td data-bind="text:createTime">2016-06-29 13:56</td> -->
    <td data-bind="text:userName">admin</td>
          <td><a href="#">下载</a> 
          | <a href="#" data-bind="click: $root.bindvmForSecretkey">查看挂载云主机</a> 
          | <a href="#" data-bind="click: $root.editValidateTime">有效时间变更</a>  
   	| <a href="#" data-bind="click: $root.validate">终止</a>   
   	| <a data-bind="click: $root.removeOne">删除</a></td>
        </tr>
         <!-- /ko -->
        </tbody>
      </table>
    </div>
     <footer class="panel-footer" data-bind="with: table, visible: table.pages() > 1">
<ul class="pagination">
  <li data-bind="css: leftPagerClass, click: prevPage">
    <a href="#">&laquo;</a>
  </li>
  <!-- ko foreach: {data: (new Array(pages()))} -->
<li data-bind="css: $parent.pageClass($index() + 1)">
  <a href="#" data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
</li>
<!-- /ko -->
    <li data-bind="css: rightPagerClass, click: nextPage">
      <a href="#">&raquo;</a>
    </li>
  </ul>
</footer>
    </div>
    <div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isBindvmForSecretkey}">
      <div class='modal-dialog modal-lg' style="width:600px;">
    <div class='modal-content'>
      <div class='modal-header'>
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>绑定云主机</h3>
      </div>
      <div class='modal-body form-horizontal row'>
        <div class="form-group">
          <label class="col-sm-3 control-label">密钥名称：</label>
          <div class="col-sm-8">
            <span>密钥111</span>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-3 control-label">云主机：</label>
          <div class="col-sm-8">
            <select class="form-control">
              <option value="1">1</option>
            </select>
          </div>
        </div>
        
      </div>
      <div class='modal-footer' style="text-align:center;">
        <a class="btn btn-default btn-info">确定</a>
        <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
      </div>
    </div>
  </div>
</div>

<!-- 创建SSH密钥 -->
<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isAddSecretkey }">
  <div class='modal-dialog modal-lg' style="width:600px;">
    <div class='modal-content'>
      <div class='modal-header'>
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>创建密钥</h3>
      </div>
      <div class='modal-body form-horizontal row' data-bind="with:currentVO">
        <div class="form-group">
          <label class="col-sm-3 control-label">SSH密钥名称</label>
          <div class="col-sm-8">
            <input type="text" class="form-control"  placeholder="SSH密钥名称" data-bind="value:name">
          </div>
          <div class="col-sm-1">
            <span class="text-danger inline m-l-n m-t-sm">*</span>
          </div>
        </div>
        <div class="form-group">
    <label class="col-sm-3 control-label">所属VDC</label>
    <div class="col-sm-8">
      <select class="form-control" data-bind="value:vdcUuid, options: $root.add_vdcs, optionsText: 'name', optionsValue: 'uuid',event: {change: $root.onchange_add_vdcs}"></select>
    </div>
    <div class="col-sm-1">
      <span class="text-danger inline m-l-n m-t-sm">*</span>
    </div>
  </div>

  <div class="form-group">
    <label class="col-sm-3 control-label">可用分区</label>
    <div class="col-sm-8">
      <select class="form-control" data-bind="value: azUuid, options: $root.add_partitions, optionsText: 'name', optionsValue: 'uuid'"></select>
    </div>
    <div class="col-sm-1">
      <span class="text-danger inline m-l-n m-t-sm">*</span>
    </div>
  </div>
        <div class="form-group">
          <label class="col-sm-3 control-label">申请时长</label>
          <div class="col-sm-9">
            <div>
              <label class="radio-inline" style="padding-top: 2px">
                <input type="radio"  name="inlineRadioOptions" id="inlineRadio1" value="option1" checked> 永久
              </label>
            </div>
            <div>
              <label class="radio-inline">
                <input type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2" style="margin-top:10px"> 
                <input type="text" class="form-control input-sm inline w-xxs">
                <select class="form-control inline w-xs input-sm">
                  <option value="">月</option>
                </select>  
              </label>
            </div>
            <div>
              <label class="radio-inline">
                <input type="radio" name="inlineRadioOptions" id="inlineRadio3" value="option3" style="margin-top:10px"> 有效期至
                   <input type="text" value="" class="form-control inline w input-sm" id="vm_duration">
              </label> 
            </div>                                   
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-3 control-label">备注</label>
          <div class="col-sm-8">
            <textarea class="form-control"></textarea>
          </div>
          <div class="col-sm-1">
            <span class="text-danger inline m-l-n m-t-sm">*</span>
          </div>
        </div>
        
      </div>
      <div class='modal-footer' style="text-align:center;">
        <a class="btn btn-default btn-info" data-bind="click:save">确定</a>
        <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
      </div>
    </div>
  </div>
</div>

 <!-- 修改有效期 -->
<div role="dialog" aria-hidden="true" id="modal_edit_validate_sshKey" class="modal fade" data-bind="modal: { show: isValidateTime }">
       <div class='modal-dialog modal-md'>
         <div class='modal-content'>
           <div class='modal-header'>
             <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>有效时间变更</h3>
           </div>
           <div class='modal-body form-horizontal row'>
             <div class="form-group">
               <label class="col-sm-3 control-label">有效期：</label>
               <div class="col-sm-8">
                 <input type="text" value="" class="form-control inline w" id="resource_instance_sshKey_validate_edit" data-bind="value: validateTimeVO().time">
               </div>
             </div>
           </div>
           <div class='modal-footer' style="text-align:center;">
        <a class="btn btn-default btn-info" data-bind="click: validateTime">确定</a>
        <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
      </div>
    </div>
  </div>
</div>
 
<script type="text/javascript">
  var scripts = [null, "assets/lib/moment/moment.js","assets/lib/bootstrap-daterangepicker/daterangepicker.js","api/resourceInstance/sshkey/sshkey.js"]
  $('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
    function ViewModel_SSHKey(){
  	  //系统当前登录用户标识
      var account = "";
      //当前用户所辖VDC列表（包括VDC对应的可用分区信息）
      var vdcList = [];
      //当前用户所辖可用分区列表
      var azList = [];
      var vdcListForAdd = [];
      //初始化vo
      this.currentVO = ko.validatedObservable();
      
      var self = this;
      this.isBindvmForSecretkey = ko.observable(false);
      this.isAddSecretkey = ko.observable(false);

      this.bindvmForSecretkey = function(){
        self.isBindvmForSecretkey(true);
      };

      //初始化vo
      this.currentVO = ko.validatedObservable();
    

      this.addSecretkey = function(){
    	  this.currentVO({
        	  name: ko.observable().extend({required: true}),
        	  vdcUuid:ko.observable().extend({required: true}),
          	  azUuid:ko.observable().extend({required: true}),
          	  remark:''
          });
    	//---------------------------弹出添加页面时加载-----------------------------------         
      	 //VDC
         this.add_vdcs = ko.observableArray([]);
         //可用分区
         this.add_partitions = ko.observableArray([]);
         this.add_vdcs_load = function(){
       	  csc.rest.get('api/v5.0.0/vdcs?account='+account,function(data){
       		  if(data.results){       			
       			  vdcListForAdd = data.results;
   		    	  self.add_vdcs(vdcListForAdd);
       		  }
       	  });
         }
         this.add_vdcs_load();
         
         //VDC->可用分区
         this.onchange_add_vdcs = function(){
       	  var vdcUuid = self.currentVO().vdcUuid();
       	  for(var i=0;i<vdcListForAdd.length;i++){
       		  if(vdcListForAdd[i].uuid == vdcUuid){
       			  self.add_partitions(vdcListForAdd[i].azs);
       			  break;
       		  }
       	  }
         }
        self.isAddSecretkey(true);
      };
      
      //保存
      this.save = function(){
    	  ko.validation.group(this.currentVO).showAllMessages();
	      if(this.currentVO.isValid()){
	    	  var postBody = {};
	    	  postBody.name = self.currentVO().name();
	    	  postBody.vdcUuid = self.currentVO().vdcUuid();
	    	  postBody.azUuid = self.currentVO().azUuid();
	    	  postBody.remark = self.currentVO().remark;
	    	  postBody.userName = "admin";//暂时默认，需要获取当前操作的用户，可以在后台添加
	    	  postBody.userUuid = "1";//
	    	  
	    	  var expiryTime = "";
	    	  var temp = document.getElementsByName("inlineRadioOptions");
	    	  for(var i=0;i<temp.length;i++)
	    	  {
	    	     if(temp[i].checked){
	    	    	 if(temp[i].value == "option1"){
	    	    		 expiryTime = "2099-12-30 23:59:59";
	    	    	 }else if(temp[i].value == "option2"){
	    	    		 if($("#resource_instance_vm_limit_option2_unit").val() == "MONTH"){
	    	    			 var plusMonth = parseInt($("#resource_instance_vm_limit_option2").val());
	    	    			 var dd = new Date();
	    	    			 var y = dd.getFullYear(); 
	    	    			 var m = dd.getMonth()+1+plusMonth;//获取当前月份的日期 
	    	    			 var selfM = dd.getMonth()+1;
	    	    			 var d = dd.getDate();
	    	    			 y = y + parseInt(m/12);
	    	    			 m = m%12;
	    	    			 if(m == 0){
	    	    				 m = selfM;
	    	    			 }
	    	    		 }else if($("#resource_instance_vm_limit_option2_unit").val() == "YEAR"){
	    	    			 var plusYear = parseInt($("#resource_instance_vm_limit_option2").val());
	    	    			 var dd = new Date();
	    	    			 var y = dd.getFullYear(); 
	    	    			 var m = dd.getMonth()+1;//获取当前月份的日期 
	    	    			 var d = dd.getDate();
	    	    			 y = y + plusYear;
	    	    		 }
	    	    		 expiryTime = y+"-"+m+"-"+d+" 23:59:59";
	    	    	 }else{
	    	    		 var timeStr = $("#resource_instance_vm_limit_option3").val();
	    	    		 expiryTime = $.trim(timeStr) + " 23:59:59";
	    	    	 }
	    	     }
	    	  }
	    	  postBody.expiryDate = expiryTime;
	    	 
	    	  console.log(postBody);
	    	  //return;
	    	  $.SSH_KEY.createSSHKey(postBody,function(data){
	    		  //成功
	    		  if(data.id){
	    			  self.table.refreshData();
		    		  self.isAddSecretkey(false);//关闭弹出框
		    		  alert('创建成功！');
	    		  }else{
	    			  alert('创建失败！');
	    		  }	    		  	    		  
	    	  },function(data){
	    		  console.log(data);
	    		  alert('创建失败！');
	    	  })
	      }
      }
      
      //删除
      this.removeOne = function(object, event){
    	  confirm("您确定要删除该密钥["+object.name+"]吗？",function(){    
    		  $.SSH_KEY.deleteSSHKey(object.uuid,function(data){
    			  alert('删除成功');
        		  self.table.refreshData();
    			  if(data.result == 'success'){
    				  alert('删除成功');
            		  self.table.refreshData();
    			  }else if(data.result == 'faile'){
    				  alert('删除底层数据失败');
    			  }else{
    				  alert('没有发现密钥！');
    			  }
        	  });
    	  });
      }
      
      
      
 
    //定义搜索下拉选择
      this.vdcs = ko.observableArray([]);
      this.partitions = ko.observableArray([]);
      this.loadVdcs = function(){
    	  csc.rest.get('api/v5.0.0/vdcs?account='+account,function(data){
    		  if(data.results){
    			  vdcList = data.results;
    			  //为备选列表添加一个名为"全部"的选项
    			  var vdcUuids = "";
		    	  for(var i=0;i<vdcList.length;i++){
		    		  if(i == (vdcList.length-1)){
						  vdcUuids = vdcUuids + vdcList[i].uuid;
					  }else{
						  vdcUuids = vdcUuids + vdcList[i].uuid + ",";
					  }
		    	  }
		    	  //var vdcDef = {"name":"全部","uuid":vdcUuids};
		    	  var vdcDef = {"name":"全部","uuid":""};
				  vdcList.unshift(vdcDef);
    			  self.vdcs(vdcList);
    		  }
    	  });
      }
      this.loadPartitions = function(){
    	  csc.rest.get('api/v5.0.0/azs?account='+account,function(data){
    		  if(data.results){
    			  azList = data.results;
    			  //为备选列表添加一个名为"全部"的选项
    			  var azUuids = "";
		    	  for(var i=0;i<azList.length;i++){
		    		  if(i == (azList.length-1)){
		    			  azUuids = azUuids + azList[i].uuid;
					  }else{
						  azUuids = azUuids + azList[i].uuid + ",";
					  }
		    	  }
		    	  //var azDef = {"name":"全部","uuid":azUuids};
		    	   var azDef = {"name":"全部","uuid":""};
		    	  azList.unshift(azDef);
    			  self.partitions(azList);
    		  }
    	  });
      }
      this.loadVdcs();
      this.loadPartitions();
      
 
      this.searchParam = ko.observable({
        azUuid: '',
        vdcUuid: '',
        name: ''
      })
      this.reset = function(){
        this.searchParam({
          azUuid: '',
          vdcUuid: '',
          name: ''
        });
        
        this.table.params({});
      }
      this.search = function(){
    	  console.log('11111111');
        this.table.params(this.searchParam());
      }
      this.table = new DataTable([], {path: 'api/v5.0.0/sshKeys',loader:function(result){
    	  //由于公钥太长，采用省略号
    	  var publicKeyString = result.publicKey.substring(0,25)+'....';
    	  result.publicKeyString = publicKeyString;
    	  
    	  console.log(result);
    	  //将时间转换一下
    	  var expiryDate = result.expiryDate;    	  
    	  result.expiryDate = expiryDate.substring(0,10);
    	  return result;
      }});
      
      
    //------------------------------------------修改有效期开始----------------------------
      this.isValidateTime = ko.observable(false);
       //modal_edit_validate
       $("#modal_edit_validate_sshKey").on("shown.bs.modal",function(){
           // daterange             
            $('#resource_instance_sshKey_validate_edit').val(self.validateTimeVO().time()).daterangepicker(
             {
               format:'YYYY-MM-DD',
               minDate:moment(),
               singleDatePicker: true,
               locale:{
                 applyLabel: '确认',
                 cancelLabel: '取消',
                 weekLabel: '周',
                 daysOfWeek:["日","一","二","三","四","五","六"],
                 monthNames:['01月','02月','03月','04月','05月','06月','07月','08月','09月','10月','11月','12月',]
               }
             }
           ); 
       })
       this.validateTimeVO = ko.validatedObservable({
     	  time: ko.observable(),
     	  uuid: ko.observable()
       });
       this.editValidateTime = function(object, event){
     	  self.isValidateTime(true);
     	  self.validateTimeVO().uuid(object.uuid);
     	  console.log(object.expiryDate)
     	  self.validateTimeVO().time(object.expiryDate);
       }
       //修改有效期
       this.validateTime = function(){
     	  var putBody = {};
     	  putBody.expiryDate = self.validateTimeVO().time() + " 23:59:59";
     	  csc.rest.put('api/v5.0.0/resourceInstances/'+self.validateTimeVO().uuid(),putBody,function(data){
 		 		systemMsg.alert('SSH密钥修改有效期成功！');
 		 		self.isValidateTime(false);
 		 		self.table.refreshData();
 		  });
       }
       //------------------------------------------修改有效期结束----------------------------
       
       //终止（服务实例）
       this.validate = function(object, event){
     	  systemMsg.confirm("确定要终止SSH密钥 "+object.name+"？",function(){
     		var putBody = {"expiryDate":""};
   			csc.rest.put('api/v5.0.0/resourceInstances/'+object.uuid,putBody,function(data){
 			 		systemMsg.alert('SSH密钥终止成功！');
 			 		self.table.refreshData();
 			    });
   		});
       }
      
      
     

      
      
    };   
     ko.applyBindings(new ViewModel_SSHKey(), $('#partition_sshkeys')[0]); 
  })
</script>

