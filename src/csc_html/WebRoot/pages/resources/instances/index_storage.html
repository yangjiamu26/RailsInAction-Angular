<div class="row wrapper">
    <div class="col-xs-1">
        <button class="btn btn-sm btn-info" data-bind="click: addvdisk">创建</button>
    </div>
    <div class="col-xs-3">
        <div class="input-group">
            <span class="input-group-addon">所属VDC</span>
            <select class="form-control input-sm" data-bind="value: searchParam().vdcUuid, options: $root.vdcs, optionsText: 'name', optionsValue: 'uuid'"></select>
        </div>
    </div>
    <div class="col-xs-3">
        <div class="input-group">
            <span class="input-group-addon">所属可用分区</span>
            <select class="form-control input-sm" data-bind="value: searchParam().azUuid, options: $root.partitions, optionsText: 'name', optionsValue: 'uuid'"></select>
        </div>
    </div>
    <div class="col-xs-3">
        <div class="input-group">
            <span class="input-group-addon">名称</span>
            <input type="text" class="input-sm form-control" placeholder="请输入名称" data-bind="value: searchParam().volumeName">
        </div>
    </div>
    <div class="col-xs-2">
        <button class="btn btn-sm" type="button" data-bind="click: reset">重置</button>
        <button class="btn btn-sm btn-default" type="button" data-bind="click: search">搜索</button>
    </div>
</div>
<div id='instance_storages'>
    <div class='table-responsive' data-bind="with: table">
        <table class='table table-striped'>
            <thead>
                <tr>
                    <th>云硬盘名称</th>
                    <th>所属可用分区</th>
                    <th>所属VDC</th>
                    <!-- <th>所属VPC</th> -->
                    <th>大小(单位：G)</th>
                    <th>状态</th>
                    <th>关联云主机</th>
                    <th>路径</th>
                    <!-- <th>是否共享</th> -->
                    <th>创建人</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <tr data-bind="visible: showNoData">
                    <td colspan=11 class="aligncenter">
                        This table has no data.
                    </td>
                </tr>
                <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
                <tr>
                    <td data-bind="text:volumeName"></td>
                    <td data-bind="text:azName"></td>
                    <td data-bind="text:vdcName"></td>
                    <!-- <td data-bind="text:vpcName"></td> -->
                    <td data-bind="text:volumeSize"></td>
                    <td data-bind="text:volumeStatus"></td>
                    <td data-bind="text:volumeServerName"></td>
                    <td data-bind="text:path"></td>
                    <!-- <td data-bind=""></td> -->
                    <td data-bind="text:userName"></td>
                    <td><a href="#" data-bind="click: $root.storageExpand">扩展</a> | <a data-bind="click: $root.removeOne">删除</a></td>
                </tr>
                <!-- /ko -->
            </tbody>
        </table>
    </div>
    <footer class="panel-footer" data-bind="with: table, visible: table.pages() > 1">
        <ul class="pagination">
            <li data-bind="css: leftPagerClass, click: prevPage">
                <a href="#">&laquo;</a>
            </li>
            <!-- ko foreach: {data: (new Array(pages()))} -->
            <li data-bind="css: $parent.pageClass($index() + 1)">
                <a href="#" data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
            </li>
            <!-- /ko -->
            <li data-bind="css: rightPagerClass, click: nextPage">
                <a href="#">&raquo;</a>
            </li>
        </ul>
    </footer>
    <!-- 创建云硬盘弹窗 -->
    <div role="dialog" aria-hidden="true" id="modal_addvdisk" class="modal fade" data-bind="modal: { show: isAddvdisk }">
        <div class='modal-dialog'>
            <div class='modal-content'>
                <div class='modal-header'>
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
                    <h3 class='modal-title'>创建云硬盘</h3>
                </div>
                <div class='modal-body form-horizontal row' data-bind="with: currentVO">
                    <div class="form-group">
                        <label class="col-xs-3 control-label">云硬盘名称</label>
                        <div class="col-xs-8">
                            <input type="text" class="form-control" data-bind="value:volumeName">
                        </div>
                        <div class="col-xs-1">
                            <span class="text-danger inline m-l-n m-t-sm">*</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-3 control-label">存储大小(GB)</label>
                        <div class="col-xs-8">
                            <input type="text" class="form-control" data-bind="value:volumeSize">
                        </div>
                        <div class="col-xs-1">
                            <span class="text-danger inline m-l-n m-t-sm">*</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-3 control-label">所属VDC</label>
                        <div class="col-xs-8">
                            <select class="form-control input-sm" data-bind="value: vdcUuid, options: $root.vdcs_add, optionsText: 'name', optionsValue: 'uuid',event: {change: $root.onchange_vdcs_add}"></select>
                        </div>
                        <div class="col-xs-1">
                            <span class="text-danger inline m-l-n m-t-sm">*</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-3 control-label">可用分区</label>
                        <div class="col-xs-8">
                            <select class="form-control input-sm" data-bind="value: azUuid, options: $root.partitions, optionsText: 'name', optionsValue: 'uuid',event: {change: $root.onchange_azs_add}"></select>
                        </div>
                        <div class="col-xs-1">
                            <span class="text-danger inline m-l-n m-t-sm">*</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-3 control-label">挂载云主机</label>
                        <div class="col-xs-8">
                            <select class="form-control" data-bind="value:vmUuid, options: $root.vms, optionsText: 'name', optionsValue: 'uuid'">
                                <option value="">云主机1</option>
                            </select>
                        </div>
                        <div class="col-xs-1">
                            <span class="text-danger inline m-l-n m-t-sm">*</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-3 control-label">申请有效期至</label>
                        <div class="col-xs-8">
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                                <input type="text" value="" class="form-control input-sm" id="vdisk_duration" data-bind="value:effectiveDate">
                            </div>
                        </div>
                        <div class="col-xs-1">
                            <span class="text-danger inline m-l-n m-t-sm">*</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-3 control-label">备注</label>
                        <div class="col-xs-8">
                            <textarea class="form-control" cols="5" rows="5" data-bind="value:description"></textarea>
                        </div>
                    </div>
                </div>
                <div class='modal-footer' style="text-align:center;">
                    <a class="btn btn-default btn-info" data-bind="click:ok">确定</a>
                    <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
                </div>
            </div>
        </div>
    </div>
    <!-- end -->
    <div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isStorageExpand }">
        <div class='modal-dialog modal-lg' style="width:600px;">
            <div class='modal-content'>
                <div class='modal-header'>
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
                    <h3 class='modal-title'>拓展云硬盘</h3>
                </div>
                <div class='modal-body form-horizontal row' data-bind="with: currentVO()">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">云硬盘名称：</label>
                        <div class="col-sm-8">
                            <input type="email" class="form-control" placeholder="" data-bind="value:volumeName" disabled>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">云硬盘大小(GB)：</label>
                        <div class="col-sm-8">
                            <input type="email" class="form-control" placeholder=""  data-bind="value:volumeSize" disabled>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">拓展后大小(GB)：</label>
                        <div class="col-sm-8">
                            <input type="email" class="form-control" placeholder="" data-bind="value:newSize"> 可调整范围为：<span data-bind="text:volumeSize"></span>至39.38
                        </div>
                    </div>
                </div>
                <div class='modal-footer' style="text-align:center;">
                    <a class="btn btn-default btn-info" data-bind="click:ok">确定</a>
                    <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
var scripts = [null, "assets/lib/moment/moment.js", "assets/lib/bootstrap-daterangepicker/daterangepicker.js"]
$('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
    function ViewModel_Storage() {
        //系统当前登录用户标识
        var account = "";
        //当前用户所辖VDC列表（包括VDC对应的可用分区信息）
        var vdcList = [];

        this.isAddvdisk = ko.observable(false);
        var self = this;

        this.currentVO = ko.validatedObservable({
            volumeName: ko.observable().extend({
                required: true
            }),
            volumeSize: ko.observable().extend({
                required: true
            })
        });

        //点击创建
        this.addvdisk = function() {
            this.currentVO.fromJSON({
            	uuid:null,
                volumeId: null,
                volumeName: '',
                volumeSize: '',
                vmUuid: '',
                vpcUuid: '',
                vdcUuid: '',
                azUuid: '',
                effectiveDate: '2016-09-01 00:00:00',
                description: ''
            });
            self.loadVdcs_add();

            self.isAddvdisk(true);
        }

        /* $("#modal_addvdisk").on("shown.bs.modal",function(){
            // daterange             
            $('#vdisk_duration').val(moment().format('YYYY/MM/DD')).daterangepicker(
              {
                format:'YYYY/MM/DD',
                minDate:moment(),
                singleDatePicker: true,
                locale:{
                  applyLabel: '确认',
                  cancelLabel: '取消',
                  weekLabel: '周',
                  daysOfWeek:["日","一","二","三","四","五","六"],
                  monthNames:['01月','02月','03月','04月','05月','06月','07月','08月','09月','10月','11月','12月',]
                }
              }
            ); 
        }) */

        this.ok = function() {
            //console.log(this.currentVO.toJSON());
            ko.validation.group(self.currentVO).showAllMessages();
            var volumeUuid = self.currentVO.toJSON().uuid;
            if (self.currentVO.isValid()) {
            	if(!volumeUuid){
	                csc.rest.post('api/v5.0.0/volumes', this.currentVO.toJSON(), function(data) {
	                    alert("正在创建云硬盘，调度任务ID[" + data.taskId + "]！");
	                    self.isAddvdisk(false);
	                    self.table.refreshData();
	                });
            	}else{
    	   			csc.rest.put('api/v5.0.0/volumes/'+volumeUuid, this.currentVO.toJSON(), function(){
    	   	            self.isEdit(false);
    	   	            self.table.refreshData();
    	   			});
    	   		}
            }
        }

        this.isStorageExpand = ko.observable(false);

        //云硬盘拓展
        this.storageExpand = function(object, event) {
        	object.newSize = '';
        	self.currentVO.fromJSON(object);
            self.isStorageExpand(true);
        };

        this.remove = function() {

        }

        this.removeOne = function(object, event) {
            var voumeName = object.volumeName;
            var uuid = object.uuid;
            confirm("确定删除云硬盘[" + voumeName + "]？", function(arg) {
                csc.rest.del('api/v5.0.0/volumes/' + uuid, function(data) {
                    alert("正在删除，调度任务ID[" + data.taskId + "]！");
                    self.table.refreshData();
                });
            });
        }

        this.searchParam = ko.observable({
            azUuid: '',
            vdcUuid: '',
            volumeName: ''
        });

        this.reset = function() {
            this.searchParam({
                azUuid: '',
                vdcUuid: '',
                volumeName: ''
            })
        }
        this.search = function() {
            console.log(this.searchParam());
            this.table.params(this.searchParam());
        }
        this.table = new DataTable([]);


        /** 下拉级联选择--------------------------------------------START **/
        //查询：下拉选择，加载VDC
        this.vdcs = ko.observableArray([]);
        //获取可用分区数据
        this.partitions = ko.observableArray([]);
        //获取可用分区数据列表
        this.loadPartitions = function() {
                csc.rest.get('api/v5.0.0/azs?account=' + account, function(data) {
                    if (data.results) {
                        azList = data.results;
                        //为备选列表添加一个名为"全部"的选项
                        var azUuids = "";
                        for (var i = 0; i < azList.length; i++) {
                            if (i == (azList.length - 1)) {
                                azUuids = azUuids + azList[i].uuid;
                            } else {
                                azUuids = azUuids + azList[i].uuid + ",";
                            }
                        }
                        var azDef = {
                            "name": "全部",
                            "uuid": azUuids
                        };
                        azList.unshift(azDef);
                        //self.reBandai();
                        self.partitions(azList);
                    }
                    self.table.params(self.searchParam());
                    self.table.path('api/v5.0.0/volumes?type=Disk');
                });
            }
            //新增：云主机下拉列表
        this.vms = ko.observableArray([]);
        //查询加载 VDC下拉列表
        this.loadVdcs = function() {
            csc.rest.get('api/v5.0.0/vdcs?account=' + account, function(data) {
                console.log(1);
                if (data.results) {
                    vdcList = data.results;
                    console.log(vdcList);
                    //为备选列表添加一个名为"全部"的选项
                    var vdcUuids = "";
                    for (var i = 0; i < vdcList.length; i++) {
                        if (i == (vdcList.length - 1)) {
                            vdcUuids = vdcUuids + vdcList[i].uuid;
                        } else {
                            vdcUuids = vdcUuids + vdcList[i].uuid + ",";
                        }
                    }
                    var vdcDef = {
                        "name": "全部",
                        "uuid": vdcUuids
                    };
                    vdcList.unshift(vdcDef);
                    self.vdcs(vdcList);
                }
                console.log(2);
                self.loadPartitions();
            });
        }

        //查询：选择不同VDC后，可用分区下拉框要跟着改变
        this.onchange_vdcs = function() {
            var vdcUuid = self.searchParam().vdcUuid;
            csc.rest.get('api/v5.0.0/vdcs/' + vdcUuid + '/azs', function(data) {
                if (data.results) {
                    self.partitions(data.results);
                }
            });
        }

        //查询：下拉选择，加载VDC
        this.vdcs_add = ko.observableArray([]);
        //新增页面加载，不需要全部选项
        this.loadVdcs_add = function() {
                csc.rest.get('api/v5.0.0/vdcs', function(data) {
                    if (data.results) {
                        vdcList = data.results;
                        self.vdcs_add(vdcList);
                    }
                });
            }
            //新增：选择不同VDC后，可用分区下拉框要跟着改变
        this.onchange_vdcs_add = function() {
            var vdcUuid = self.currentVO.toJSON().vdcUuid;
            csc.rest.get('api/v5.0.0/vdcs/' + vdcUuid + '/azs', function(data) {
                if (data.results) {
                    self.partitions(data.results);
                }
            });
        }

        //修改：选择不同的可用分区云主机列表也要跟着改变
        this.onchange_azs_add = function() {
            self.loadVms();
        }

        this.loadVms = function() {
            var vdcUuid = self.currentVO.toJSON().vdcUuid;
            var azUuid = self.currentVO.toJSON().azUuid;
            //console.log(vdcUuid);
            //console.log(azUuid);
            csc.rest.get('api/v5.0.0/vms?vdcUuid=' + vdcUuid + '&azUuid=' + azUuid, function(data) {
                if (data.results) {
                    vms = data.results;
                    self.vms(vms);
                }
            });
        }

        /* 为VDC和可用分区下拉框添加"全部"备选项*/
        /* this.reBandai = function(){
        var vdcUuids = "";
        var azs = [];
          for(var i=0;i<vdcList.length;i++){
          if(i == (vdcList.length-1)){
            vdcUuids = vdcUuids + vdcList[i].uuid;
          }else{
            vdcUuids = vdcUuids + vdcList[i].uuid + ",";
          }
          azs.push(vdcList[i].azs);
          var azList = vdcList[i].azs;
          var azUuids = "";
          if(azList){
            for(var j=0;j<azList.length;j++){
              if(j == (azList.length-1)){
                azUuids = azUuids + azList[i].uuid;
              }else{
                azUuids = azUuids + azList[i].uuid + ",";
              }
            }
            var azDef = {"name":"全部","uuid":azUuids};
            azList.unshift(azDef);
          }
          }
          var vdcDef = {"name":"全部","uuid":vdcUuids,"azs":azs};
        vdcList.unshift(vdcDef);
        } */

        this.loadVdcs();
        //this.loadPartitions();
        /** 下拉级联选择--------------------------------------------END **/

    }
    ko.applyBindings(new ViewModel_Storage(), $('#partition_storages')[0]);
})
</script>
