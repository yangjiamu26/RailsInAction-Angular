<!-- 创建与搜索栏 -->
<div class="row wrapper">
  <div class="col-xs-1">
    <div class="input-group">
      <button class="btn btn-info btn-sm" data-bind="click:showCreatePage">创建</button>
    </div>      
  </div>
  <div class="col-xs-3">
    <div class="input-group">
      <span class="input-group-addon">所属VDC</span>
      <select class="form-control input-sm" data-bind="value: searchParam().vdcUuid, options: $root.searchVdcList, optionsText: 'name', optionsValue: 'uuid'">
        <option value="f91c14a2-5981-405c-bcba-5170f5b3a86d">crnVDC</option>
      </select>
    </div>      
  </div>   
  <div class="col-xs-3">
    <div class="input-group">
      <span class="input-group-addon">所属可用分区</span>
      <select class="form-control input-sm" data-bind="value: searchParam().azUuid, options: $root.searchAzList, optionsText: 'name', optionsValue: 'uuid'"></select>
    </div>      
  </div> 
           
  <div class="col-xs-3">
    <div class="input-group">
      <span class="input-group-addon">名称</span>
      <input type="text" class="input-sm form-control" placeholder="请输入名称" data-bind="value: searchParam().name">
    </div>
  </div>
  <div class="col-xs-2">
    <button class="btn btn-sm" type="button" data-bind="click: reset">重置</button>
    <button class="btn btn-sm btn-default" type="button" data-bind="click: search">搜索</button>
  </div>
</div>  
 <!-- 公网IP列表 -->                      
<div id='instance_publicips'>
  <div class='table-responsive' data-bind="with: publicIpTable">
    <table class='table table-striped'>
      <thead>
        <tr>
          <th>公网IP名称</th>
          <th>IP地址</th>
          <th>子网掩码</th>
          <th>可用分区</th>
          <th>所属VDC</th>
          <th>所属VPC</th>
          <th>路由器</th>
          <th>云主机</th>
          <th>服务状态</th>
          <th>创建时间</th>
          <th>有效期</th>
          <th>创建人</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
      	<tr data-bind="visible: showNoData">
            <td colspan=13 class="aligncenter">
             	 暂无数据
            </td>
          </tr>
          <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
        	<tr>
            <td data-bind="text: $row.name"></td> <!-- 公网IP名称 -->
            <td data-bind="text: $row.ip"></td><!-- IP地址 -->
            <td data-bind="text: $row.cidr"></td><!-- 子网掩码 -->
            <td data-bind="text: $row.azName"></td><!-- 可用分区 -->
            <td data-bind="text: $row.vdcName"></td><!-- 所属VDC -->
            <td data-bind="text: $row.vpcName"></td><!-- 所属VPC -->
            <td data-bind="text: $row.routerName"></td><!-- 路由器 -->
            <td data-bind="text: $row.vmName"></td><!-- 云主机 -->
            <td>
            	<span class="label label-success" data-bind="if: $row.isValidate == true">正常</span>
	            <span class="label label-danger" data-bind="if: $row.isValidate == false">已过期</span>
            </td>
            <td data-bind="text: $row.createTime"></td><!-- 创建时间 -->
            <td data-bind="text: $row.expiredDate"></td><!-- 有效期 -->
            <td data-bind="text: $row.userName"></td><!-- 创建人 -->
            <td><!-- 操作 -->
            	<span data-bind="if: csc.util.isNull($row.vmUuid)">
            		<a href="#" data-bind="click: $root.showBindingPage">绑定云主机</a>
            	</span>
            	<span data-bind="if: csc.util.isNotNull($row.vmUuid)">
            		<a href="#" data-bind="click: $root.unbindVm">解绑</a>
            	</span>
            	| <a href="#" data-bind="click: $root.showChangeValiTimePage">有效时间变更</a> |
            	<span data-bind="if: $row.isValidate == true">
            		<a href="#" data-bind="click: $root.terminateService">终止</a>
            	</span>
            	<span data-bind="if: $row.isValidate == false">
            		<a href="#" data-bind="click: $root.deleteIp">删除</a>
            	</span> 
            </td>
        	</tr>
        	<!-- /ko -->
      </tbody>
    </table>
  </div>
  <!-- 分页DIV --> 
    <footer class="panel-footer" data-bind="with: publicIpTable, visible: publicIpTable.pages() > 1">
      <ul class="pagination">
        <li data-bind="css: leftPagerClass, click: gotoPage(1)">
          <a href="#">首页</a>
        </li>
        <li data-bind="css: leftPagerClass, click: prevPage">
          <a href="#">&laquo;</a>
        </li>
        <li >
          <a href="#"  data-bind="text: currentPage"></a>
        </li>
        <li data-bind="css: rightPagerClass, click: nextPage">
          <a href="#">&raquo;</a>
        </li>
        <li data-bind="css: rightPagerClass, click: gotoPage(pages())">
          <a href="#">末页</a>
        </li>
        <li class="page-control-li">
          <div class="input-group form-group-sm">
            <input type="text" class="form-control" data-bind="value: targetPage"  />
            <div class="input-group-btn">
              <a href="#" class="btn btn-sm btn-default" data-bind="click: gotoTargetPage()">跳转</a>
            </div>
          </div>
          <div class="page-info-div" data-bind="text: recordsText"></div>
        </li>
      </ul>
    </footer>

<!-- 创建公网IP页面 -->
  <div role="dialog" aria-hidden="true" id="modal_addPublicIp" class="modal fade" data-bind="modal:{show:isShowCreatePage}">
    <div class='modal-dialog' role='document'>
      <div class='modal-content'>
        <div class='modal-header'>
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
          </button>
          <h3 class='modal-title'>创建公网IP</h3>
        </div>
        <div class='modal-body form-horizontal row'  data-bind="with:currentIpVo">

          <div class="form-group">
            <label class="col-sm-3 control-label">公网IP名称</label>
            <div class="col-sm-8">
              <input type="text" class="form-control"  placeholder="公网IP名称" data-bind="value: name">
            </div>
            <div class="col-sm-1">
              <span class="text-danger inline m-l-n m-t-sm">*</span>
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-3 control-label">所属VDC</label>
            <div class="col-sm-8">
              <select class="form-control" data-bind="options:$root.vdcList,optionsText:'name',value: vdcUuid,optionsValue:'uuid'">
                <option value="f91c14a2-5981-405c-bcba-5170f5b3a86d">crnVDC</option>
                <option>研发部2</option>
              </select>
            </div>
            <div class="col-sm-1">
              <span class="text-danger inline m-l-n m-t-sm">*</span>
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-3 control-label">可用分区</label>
            <div class="col-sm-8">
              <select class="form-control" data-bind="options:$root.azList,optionsText:'name',optionsValue:'uuid',value: azUuid, disable: vdcUuid==null">
                <option>可用分区1</option>
              </select>
            </div>
            <div class="col-sm-1">
              <span class="text-danger inline m-l-n m-t-sm">*</span>
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-3 control-label">所属VPC</label>
            <div class="col-sm-8">
              <select class="form-control" data-bind="options:$root.vpcList,optionsText:'name',optionsValue:'uuid',value: vpcUuid, disable: csc.util.isNull(azUuid)">
                <option>208</option>
                <option>206</option>
              </select>
            </div>
            <div class="col-sm-1">
              <span class="text-danger inline m-l-n m-t-sm">*</span>
            </div>
          </div>
          
          <div class="form-group">
            <label class="col-sm-3 control-label">网络名称</label>
            <div class="col-sm-8">
              <select class="form-control" data-bind="options:$root.networkList,optionsText:'name',optionsValue:'uuid',value: networkUuid, disable: vpcUuid==null">
                <option>网络1</option>
                <option>网络2</option>
              </select>
            </div>
            <div class="col-sm-1">
              <span class="text-danger inline m-l-n m-t-sm">*</span>
            </div>
          </div>
          <!-- 有效期 -->
		  <div class="form-group">
               <label class="col-sm-3 control-label no-padder-h">申请时长</label>
               <div class="col-sm-9">
               	 <div>
	                 <label class="radio-inline" style="padding-top: 2px">
	                   <input type="radio" name="publicIpExpiredRadioOptions" value="option1" checked="checked"> 永久
	                 </label>
               	 </div>
               	 <div>
	               	 <label class="radio-inline">
	                   <input type="radio" name="publicIpExpiredRadioOptions" value="option2" style="margin-top:10px"> 
	                   <input type="text" class="form-control inline w-xxs" id="resource_public_ip_time_value">
	                   <select class="form-control inline w-xs" id="resource_public_ip_time_unit">
	                     <option value="MONTH">月</option>
	                     <option value="YEAR">年</option>
	                   </select>  
	                 </label>
               	 </div>
                 <div>
	                 <label class="radio-inline">
	                   <input type="radio" name="publicIpExpiredRadioOptions" value="option3" style="margin-top:10px"> 有效期至
	                   <input type="text" value="" class="form-control inline w" id="resource_public_ip_datePicker">
	                 </label>
               	 </div>
               </div>
               <div class="col-xs-1">
                 <span class="text-danger inline m-l-n m-t-sm">*</span>
               </div>
          </div>
          

          <div class="form-group">
            <label class="col-sm-3 control-label">备注</label>
            <div class="col-sm-8">
              <textarea class="form-control" data-bind="text: desc"></textarea>
            </div>
            <div class="col-sm-1">
              <span class="text-danger inline m-l-n m-t-sm">*</span>
            </div>
          </div>
        </div>
        
        <div class='modal-footer'>
          <button name="button" type="submit" class="btn btn-primary "  data-bind="click: createPublicIp">确定</button>
          <button name="button" type="submit" class="btn btn-default " data-dismiss="modal">取消</button>
        </div>
      </div>
    </div>
  </div>

<!-- 绑定云主机页面 -->
  <div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isShowBindingPage }">
    <div class='modal-dialog modal-lg' style="width:600px;">
      <div class='modal-content'>
        <div class='modal-header'>
          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>绑定云主机</h3>
        </div>
        <div class='modal-body form-horizontal' data-bind="with: bindingVo">
          <div class="form-group">
            <label class="col-sm-3 control-label">公网IP：</label>
            <div class="col-sm-8">
              <span data-bind="text: ip">150.152.11.25</span>
            </div>
          </div>
          <div class="form-group">
            <label class="col-sm-3 control-label">云主机：</label>
            <div class="col-sm-8">
              <select class="form-control" data-bind="options:$root.vmList,optionsText:'vmName', value: vm">
                <option value="1">1</option>
              </select>
            </div>
          </div>

        </div>
        <div class='modal-footer' style="text-align:center;">
          <a class="btn btn-default btn-info" data-bind="click: $root.bindVm">确定</a>
          <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
        </div>
      </div>
    </div>
  </div>  
  
  <!-- 修改有效期 -->
  <div role="dialog" aria-hidden="true" class="modal fade"  id="modal_publicIp_valiTime" data-bind="modal: { show: isValidateTime }">
     <div class='modal-dialog modal-md'>
       <div class='modal-content'>
         <div class='modal-header'>
           <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>有效时间变更</h3>
         </div>
         <div class='modal-body form-horizontal row'>
           <div class="form-group">
             <label class="col-sm-3 control-label">有效期：</label>
             <div class="col-sm-8">
               <input type="text" value="" class="form-control inline w" id="resource_publicIp_validate_edit" data-bind="value: validateTimeVO().time">
             </div>
           </div>
         </div>
         <div class='modal-footer' style="text-align:center;">
           <a class="btn btn-default btn-info" data-bind="click: changeExpiredTime">确定</a>
           <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
         </div>
       </div>
     </div>
   </div>

</div>

<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isDeleteProcess }">
          <div class='modal-dialog modal-md'>
            <div class='modal-content'>
              <div class='modal-header'>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>资源删除</h3>
              </div>
              <div class='modal-body form-horizontal row'>
		<div class='wrapper-md'>
		    <div class="panel panel-info">
		        <div class="panel-heading">基本信息</div>
		        <div class="panel-body">
		            <div class="row">
		                <div class="col-xs-6">
		                    <p><strong>流程类型：</strong>资源删除</p>
		                </div>
		                <div class="col-xs-6">
		                    <p><strong>流程状态：</strong><span class="label label-info">未提交</span></p>
		                </div>
		            </div>
		            <div class="row">
		                <div class="col-xs-6">
		                    <p><strong>申请人：<span data-bind="text: deleteProcessVO().user"></span></strong></p>
		                </div>
		                <div class="col-xs-6">
		                    <p><strong>申请日期：<span data-bind="text: deleteProcessVO().time"></span></strong></p>
		                </div>
		            </div>
		        </div>
		    </div>

		    <div class="panel panel-info">
		        <div class="panel-heading">申请信息</div>
		        <div id="orderDetailedList" class="wrapper">
		
		          <div class="row">
		            <div class="col-xs-6"><p>资源名称：<span data-bind="text: deleteProcessVO().name"></span></p></div>
		            <div class="col-xs-6"><p>资源类型：公网IP</p></div>
		          </div>
		        </div>
		    </div>
		</div>         
		</div>     
			<div class='modal-footer' style="text-align:center;">
              <a class="btn btn-default btn-info" data-bind="click: deleteProcessPost">确定</a>
              <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
           </div>
       </div>
   </div>
</div>

<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isValidateProcess }">
          <div class='modal-dialog modal-md'>
            <div class='modal-content' style="width:700px;">
              <div class='modal-header'>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>有效时间变更</h3>
              </div>
              <div class='modal-body form-horizontal row'>
		<div class='wrapper-md'>
		    <div class="panel panel-info">
		        <div class="panel-heading">基本信息</div>
		        <div class="panel-body">
		            <div class="row">
		                <div class="col-xs-6">
		                    <p><strong>流程类型：</strong>有效时间变更</p>
		                </div>
		                <div class="col-xs-6">
		                    <p><strong>流程状态：</strong><span class="label label-info">未提交</span></p>
		                </div>
		            </div>
		            <div class="row">
		                <div class="col-xs-6">
		                    <p><strong>申请人：<span data-bind="text: validateProcessVO().user"></span></strong></p>
		                </div>
		                <div class="col-xs-6">
		                    <p><strong>申请日期：<span data-bind="text: validateProcessVO().time"></span></strong></p>
		                </div>
		            </div>
		        </div>
		    </div>

		    <div class="panel panel-info">
		        <div class="panel-heading">申请信息</div>
		        <div id="orderDetailedList" class="wrapper">
		          <div class="row">
		            <div class="col-xs-6"><p>资源名称：<span data-bind="text: validateProcessVO().name"></span></p></div>
		            <div class="col-xs-6"><p>资源类型：公网IP</p></div>
		          </div>
		          <div class="row">
		            <div class="col-xs-6"><p>调整前失效时间：<input type="text" value="" class="form-control inline w" data-bind="value: validateProcessVO().validateTime" disabled="disabled"></p></div>
		            <div class="col-xs-6"><p>调整后失效时间：<input type="text" value="" class="form-control inline w" id="resource_instance_ip_validate_process" data-bind="value: validateProcessVO().targetValidateTime"></p></div>
		          </div>
		        </div>
		    </div>
		</div>         
		</div>     
			<div class='modal-footer' style="text-align:center;">
              <a class="btn btn-default btn-info" data-bind="click: validateProcessPost">确定</a>
              <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
           </div>
       </div>
   </div>
</div>
<script type="text/javascript">
  var scripts = ["api/vpc/vpc.js", 
                 "api/vdc/vdc.js",
                 "api/resource/network/port.js",
                 "api/resourceInstance/instance.js",
                 "api/resourceInstance/publicIp/publicIp.js", 
                 "assets/lib/moment/moment.js",
                 "assets/lib/bootstrap-daterangepicker/daterangepicker.js"]
  $('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
	  
    function ViewModel_PublicIP(){
      var self = this;
      //搜索栏
      this.searchVdcList = ko.observableArray();
      this.searchAzList = ko.observableArray();
      
      /************************** 创建公网IP ********************************/
      //创建页面
      this.vdcList = ko.observableArray();
      this.azList = ko.observableArray();
      this.vpcList = ko.observableArray();
      this.networkList = ko.observableArray();
      
      $("#modal_addPublicIp").on("shown.bs.modal",function(){
          // daterange             
          $('#resource_public_ip_datePicker').val(moment().format('YYYY-MM-DD')).daterangepicker(
            {
              minDate:moment(),
              singleDatePicker: true,
              locale:{
                applyLabel: '确认',
                cancelLabel: '取消',
                weekLabel: '周',
                daysOfWeek:["日","一","二","三","四","五","六"],
                monthNames:['01月','02月','03月','04月','05月','06月','07月','08月','09月','10月','11月','12月',]
              }
            }
          ); 
      })
      
      this.isShowCreatePage = ko.observable(false);
      
      this.currentIpVo = ko.validatedObservable({
    	  "name": ko.observable("").extend({required: true}),
    	  "vdcUuid": ko.observable("").extend({required: true}),
  		  "azUuid":  ko.observable("").extend({required: true}),
  		  "vpcUuid": ko.observable("").extend({required: true}),
  		  "networkUuid": ko.observable("").extend({required: true}),
  		  "timeType": "",
  		  "timeValue":"",
    	  "desc": "",
    	  "ip":"",
    	  "cidr":"",
    	  "azName":"",
    	  "routerName":"",
    	  "vmName":"",
    	  "vmIp":"",
    	  "state":"",
    	  "createTime":"",
    	  "valiTime":"",
    	  "userName":"",
    	  "expiredDate":""
	  });
      
      this.vmObj = ko.observable({
    	  "portId":"",
    	  "portName": ""
      });
      
      //弹出创建页面
      var subscriptionVdc;//subscription.dispose();
      var subscriptionAz;
      var subscriptionVpc;
      this.showCreatePage = function(){
      		self.isShowCreatePage(true);
      		self.vdcList([]);
			self.azList([]);
			self.vpcList([]);
			self.networkList([]);
			
			self.currentIpVo.fromJSON({
				"name":"",
				"vdcUuid":"",
				"azUuid":  "",
		  		"vpcUuid": "",
		  		"networkUuid": "",
		  		"timeType": "",
		  		"timeValue":"",
		    	"desc": ""
			});
			$.VDC.getVDCs({},function(data){
				 if(data && data.results){
					 self.vdcList(data.results);
				 }
			});
			
			//vdc获取AZ
			subscriptionVdc = self.currentIpVo().vdcUuid.subscribe(function(val){
			    self.azList([]);
			    if(csc.util.isNotNull(val)){
			    	$.VDC.getVdcAzs(val,{},function(data){
		   				 if(data && data.results){
		   					 self.azList(data.results);
		   				 }
		   			});
			    }
    	    	
    	    });
			//AZ获取VPC
			subscriptionAz = self.currentIpVo().azUuid.subscribe(function(val){
			    self.vpcList([]);
			    if(csc.util.isNotNull(val)){
			    	$.VPC.getVpcs({azUuid:val},function(data){
		   				 if(data && data.results){
		   					 self.vpcList(data.results);
		   				 }
		   			});
			    }
    	    	
    	    });
			//VPC获取Network
			subscriptionVpc = self.currentIpVo().vpcUuid.subscribe(function(val){
			    self.networkList([]);
			    if(csc.util.isNotNull(val)){
			    	$.VPC.getVpcNet({vpcUuid:val,type:"EXTERNAL"},function(data){
		   				 if(data && data.results){
		   					 self.networkList(data.results);
		   				 }
		   			});
			    }
    	    });
      		
      };
      //创建
      this.createPublicIp = function(object, event){
    	  //console.log(self.currentIpVo());
    	  ko.validation.group(self.currentIpVo).showAllMessages();
    	  
          if(self.currentIpVo.isValid()){
        	  var p = {
   	    		"name": self.currentIpVo().name(),
   	    		"vdcUuid": self.currentIpVo().vdcUuid(),
   	    		"azUuid":	self.currentIpVo().azUuid(),
   	    		"vpcUuid": self.currentIpVo().vpcUuid(),
   	    		"networkUuid": self.currentIpVo().networkUuid(),
   	    		"desc": self.currentIpVo().desc
   	    	  };
        	  
        	  var expiryTime = "";
      	  	  var temp = document.getElementsByName("publicIpExpiredRadioOptions");
      	  	  for(var i=0;i<temp.length;i++){
      	      if(temp[i].checked){
      	    	 if(temp[i].value == "option1"){
      	    		 expiryTime = "2099-12-30 23:59:59";
      	    	 }else if(temp[i].value == "option2"){
      	    		 if($("#resource_public_ip_time_unit").val() == "MONTH"){
      	    			 var plusMonth = parseInt($("#resource_public_ip_time_value").val());
      	    			 var dd = new Date();
      	    			 var y = dd.getFullYear(); 
      	    			 var m = dd.getMonth()+1+plusMonth;//获取当前月份的日期 
      	    			 var selfM = dd.getMonth()+1;
      	    			 var d = dd.getDate();
      	    			 y = y + parseInt(m/12);
      	    			 m = m%12;
      	    			 if(m == 0){
      	    				 m = selfM;
      	    			 }
      	    		 }else if($("#resource_public_ip_time_unit").val() == "YEAR"){
      	    			 var plusYear = parseInt($("#resource_public_ip_time_value").val());
      	    			 var dd = new Date();
      	    			 var y = dd.getFullYear(); 
      	    			 var m = dd.getMonth()+1;//获取当前月份的日期 
      	    			 var d = dd.getDate();
      	    			 y = y + plusYear;
      	    		 }
      	    		 expiryTime = y+"-"+m+"-"+d+" 23:59:59";
      	    	 }else{
      	    		 var timeStr = $("#resource_public_ip_datePicker").val();
      	    		 expiryTime = $.trim(timeStr) + " 23:59:59";
      	    	 }
      	       }
      	  	  }
        	  p.timeType = "0";
        	  p.timeValue = "0";
        	  p.expiredDate = expiryTime;
        	  
   	    	  $.PUBLIC_IP.createPublicIp(p, function(data){
   	    		  self.isShowCreatePage(false);
   	    		  self.publicIpTable.refreshData();
   				  alert("创建公网IP成功！");
   	    	  })
          }
      };
      
      //弹出绑定云主机页面
      this.isShowBindingPage = ko.observable(false);
      this.bindingVo = ko.validatedObservable({
    	  uuid: 	ko.observable(),
    	  vm: 		ko.observable(),
    	  ip:		ko.observable()
      });
      this.vmList = ko.observableArray();
      this.showBindingPage = function(vo){
           self.isShowBindingPage(true);
           //对当前公网IP对象进行绑定
           self.bindingVo({
        	   uuid: vo.uuid,
        	   vm:	"",
        	   ip:	vo.ip
           });
           var p = {
            	   tenantId: vo.tenantId,
            	   networkUuid:vo.networkUuid,
            	   azUuid: vo.azUuid
           };
           self.vmList([]);
           $.PORT.getBindableVmList(p, function(data){
        	   if(data && data.results){
        		   self.vmList(data.results);
        	   }
           })
      };
	  
      this.bindVm = function(){
    	  var uuid = self.bindingVo().uuid;
    	  var portId = self.bindingVo().vm.portId;
    	  var vmUuid = self.bindingVo().vm.vmUuid;
    	  var vmName = self.bindingVo().vm.vmName;
    	  
    	  var p = {
    			"portId":portId,
    			"vmUuid":vmUuid,
    			"vmName":vmName
    	  };
    	  $.PUBLIC_IP.bindPublicIp(uuid, p, function(data){
				self.publicIpTable.refreshData();
				self.isShowBindingPage(false);
				alert("绑定云主机[" + vmName + "]成功！")
   		});
      };
      
      //解绑公网IP
      this.unbindVm = function(vo){
    	  var name = vo.name;
    	  var p = {
    			 "vmUuid": vo.vmUuid,
    			 "portId": vo.portId
    	  };
		  confirm("确定解绑公网IP[" + name + "]？", function(arg){
			$.PUBLIC_IP.unbindPublicIp(vo.uuid, p, function(data){
				self.publicIpTable.refreshData();
				alert("解绑公网IP[" + name + "]成功！")
     		});
		  });
      }
      
      //修改有效时间
      //修改有效时间
      $("#modal_publicIp_valiTime").on("shown.bs.modal",function(){
          // daterange             
          $('#resource_publicIp_validate_edit').val(self.validateTimeVO().time()).daterangepicker(
            {
              minDate:moment(),
              singleDatePicker: true,
              locale:{
                applyLabel: '确认',
                cancelLabel: '取消',
                weekLabel: '周',
                daysOfWeek:["日","一","二","三","四","五","六"],
                monthNames:['01月','02月','03月','04月','05月','06月','07月','08月','09月','10月','11月','12月',]
              }
            }
          ); 
      });
      this.isValidateTime = ko.observable(false);
      this.validateTimeVO = ko.validatedObservable({
    	  uuid: ko.observable(),
    	  name: ko.observable(),
    	  time: ko.observable()
      });
      this.showChangeValiTimePage = function(object, event){
    	  if(csc.util.isNotNull(object.serviceInstanceUuid)){
     		  //走流程
     		  self.doValidateProcessPost(object);
     	  }else{
     		  //不走流程
	    	  self.isValidateTime(true);
	    	  //设置修改对象的uuid
	    	  self.validateTimeVO().uuid(object.uuid);
	    	  self.validateTimeVO().name(object.name);
     	  }
      }
      
      this.changeExpiredTime = function(){
    	  var uuid = self.validateTimeVO().uuid();
    	  var name = self.validateTimeVO().name();
    	  var p = {
    		  expiryDate : self.validateTimeVO().time() + " 23:59:59"
    	  };
    	  $.INSTANCE.setExpiredDate(uuid, p, function(data){
    		  self.publicIpTable.refreshData();
		 	  self.isValidateTime(false);
		 	  alert('修改公网IP['+ name+ ']有效期成功！');
    	  });
      }
      
      //终止服务
      this.terminateService = function(vo){
    	  var name = vo.name;
		  confirm("确定终止公网IP[" + name + "]服务？", function(arg){
			  $.INSTANCE.terminalService(vo.uuid, function(data){
				self.publicIpTable.refreshData();
				alert("终止公网IP[" + name + "]服务成功！")
     		});
		  });
      }
      
      //删除公网IP
      this.deleteIp = function(vo){
    	  if(csc.util.isNotNull(vo.serviceInstanceUuid)){
     		  //走流程
     		  self.doDeleteProcessPost(vo);
     	  }else{
     		  //不走流程
	    	  var name = vo.name;
			  confirm("确定删除公网IP[" + name + "]？", function(arg){
				$.PUBLIC_IP.delPublicIp(vo.uuid, function(data){
					self.publicIpTable.refreshData();
					alert("删除公网IP[" + name + "]成功！")
	     		});
			  });
     	  }
      }

      this.searchParam = ko.observable({
    	  vdcUuid: ko.observable(""),
          azUuid: ko.observable(""),
          name: ''
      })
      
      //初始化查询参数
      var subSearchVdc;//subscription.dispose();
      this.init = function(){
    	  self.searchVdcList([{"name": "全部", "uuid": ""}]);
    	  $.VDC.getVDCs({},function(data){
    			if(data && data.results){
    				data.results.unshift({"name": "全部", "uuid": ""});
    				self.searchVdcList(data.results);
    			}
    	  });
    	  self.searchAzList([{"name": "全部", "uuid": ""}]);
    	  $.AZ.getAzs({},function(data){
			 if(data && data.results){
				 data.results.unshift({"name": "全部", "uuid": ""});
				 self.searchAzList(data.results);
			 }
		 });
    	  subSearchVdc = self.searchParam().vdcUuid.subscribe(function(val){
			    self.searchAzList([{"name": "全部", "uuid": ""}]);
			    if(csc.util.isNotNull(val)){
			    	$.VDC.getVdcAzs(val,{},function(data){
		   				 if(data && data.results){
		   					 data.results.unshift({"name": "全部", "uuid": ""});
		   					 self.searchAzList(data.results);
		   				 }
		   			});
			    }else{
			    	$.AZ.getAzs({},function(data){
		   				 if(data && data.results){
		   					 data.results.unshift({"name": "全部", "uuid": ""});
		   					 self.searchAzList(data.results);
		   				 }
		   			});
			    }
    	    	
    	    });
    	  
    	  
      }();
      
      //重置
      this.reset = function(){
          this.searchParam({
          	vdcUuid: '',
          	azUuid: '',
          	name: ''
          });
          this.publicIpTable.params({})
      }
      //搜索
      this.search = function(){
    	  var p = {
    		  "vdcUuid": this.searchParam().vdcUuid(),
    		  "azUuid": this.searchParam().azUuid(),
    		  "name": this.searchParam().name
    	  };
          this.publicIpTable.params(p);
      }
      //公网IP表格
      this.publicIpTable = new DataTable({
    		  perPage: 10,
              path: 'api/v5.0.0/publicIps',
              loader: function(result){
                  //result.userName_ = "超级管理员"; 
                  return result;
              }
      });
      
    //------------------------------------------删除-流程开始--------------------------------
      this.isDeleteProcess = ko.observable(false);
      
      this.doDeleteProcessPost = function(object){
    	  self.isDeleteProcess(true);
		  self.deleteProcessVO().name(object.name);
		  self.deleteProcessVO().uuid(object.uuid);
		  self.deleteProcessVO().vdcUuid(object.vdcUuid);
		  self.deleteProcessVO().azUuid(object.azUuid);
		  self.deleteProcessVO().serviceInstanceUuid(object.serviceInstanceUuid);
		  var myDate = new Date();
		  self.deleteProcessVO().time(myDate.toLocaleString());
		  self.deleteProcessVO().user("");
      }
  
      this.deleteProcessVO = ko.observable({
    	  name: ko.observable(),
    	  uuid: ko.observable(),
    	  vdcUuid: ko.observable(),
    	  azUuid: ko.observable(),
    	  serviceInstanceUuid: ko.observable(),
    	  time: ko.observable(),
    	  user: ko.observable()
      });
      
      this.deleteProcessPost = function(){
       	  var orderItem = {};
       	  orderItem.instanceName = self.deleteProcessVO().name();
       	  orderItem.serviceInstanceUuid = self.deleteProcessVO().serviceInstanceUuid();
       	  orderItem.resourceType = "PUBLICIP";
       	  orderItem.resourceUuid = self.deleteProcessVO().uuid();
   	  	  orderItem.vdcUuid = self.deleteProcessVO().vdcUuid;
   	  	  orderItem.azUuid = self.deleteProcessVO().azUuid();
       	  orderItem.metaData =  "{\"resBaseInfo\": {}}";
       	  
       	  var orderItems = [];
       	  orderItems.push(orderItem);
       	  
       	  var postBody = {}; 
       	  postBody.resourceType = "PUBLICIP";
       	  postBody.orderItems = orderItems;
       	  
       	  csc.rest.post("api/v5.0.0/orders/deleteResource",postBody,function(data){
       		  if(data.code){
       			systemMsg.alert('删除资源申请成功，订单编号：'+data.code+'！');
     		 		self.isDeleteProcess(false);
       		  }
       	  });
 		}
      
      //------------------------------------------删除-流程结束--------------------------------
    

    //------------------------------------------有效期-流程开始--------------------------------
	  this.isValidateProcess = ko.observable(false);
      
      this.doValidateProcessPost = function(object){
    	  self.isValidateProcess(true);
		  self.validateProcessVO().name(object.name);
		  self.validateProcessVO().uuid(object.uuid);
		  self.validateProcessVO().vdcName(object.vdcName);
		  self.validateProcessVO().serviceInstanceUuid(object.serviceInstanceUuid);
		  var myDate = new Date();
		  self.validateProcessVO().time(myDate.toLocaleString());
		  self.validateProcessVO().user("");
		  
		  self.validateProcessVO().validateTime(object.expiredDate);
		  self.validateProcessVO().targetValidateTime("");
		  
		  $('#resource_instance_ip_validate_process').val(moment().format('YYYY/MM/DD')).daterangepicker(
		            {
		              format:'YYYY/MM/DD',
		              minDate:moment(),
		              singleDatePicker: true,
		              locale:{
		                applyLabel: '确认',
		                cancelLabel: '取消',
		                weekLabel: '周',
		                daysOfWeek:["日","一","二","三","四","五","六"],
		                monthNames:['01月','02月','03月','04月','05月','06月','07月','08月','09月','10月','11月','12月',]
		              }
		            }
		  ); 
      }
  
      this.validateProcessVO = ko.observable({
    	  name: ko.observable(),
    	  uuid: ko.observable(),
    	  vdcName:ko.observable(),
    	  time: ko.observable(),
    	  user: ko.observable(),
    	  serviceInstanceUuid: ko.observable(),
    	  
    	  validateTime: ko.observable(),
    	  targetValidateTime: ko.observable()
      });
      
      //申请
      this.validateProcessPost = function(){
    	  var metaData =  "{\"resBaseInfo\": {\"vdcName\": \"" + self.validateProcessVO().vdcName() 
            + "\",\"metaExpireTime\": \"" + self.validateProcessVO().validateTime() + "\"}}";
    	  var orderItem = {};
    	  orderItem.instanceName = self.validateProcessVO().name();
    	  orderItem.serviceInstanceUuid = self.validateProcessVO().serviceInstanceUuid();
    	  orderItem.expireTime = self.validateProcessVO().targetValidateTime() + " 23:59:59";
    	  orderItem.resourceType = "PUBLICIP";
    	  orderItem.resourceUuid = self.validateProcessVO().uuid();
    	  orderItem.metaData = metaData;
    	  
    	  var orderItems = [];
    	  orderItems.push(orderItem);
    	  
    	  var postBody = {};
    	  postBody.resourceType = "PUBLICIP";
    	  postBody.orderItems = orderItems;
    	  
    	  csc.rest.post("api/v5.0.0/orders/changeResource",postBody,function(data){
    		  if(data.code){
    			systemMsg.alert('有效时间变更申请成功，订单编号：'+data.code+'！');
  		 		self.isValidateProcess(false);
    		  }
    	  });
      }
      //------------------------------------------有效期-流程结束--------------------------------
      
    }
     ko.applyBindings(new ViewModel_PublicIP(), $('#partition_publicips')[0]);
  })
</script>