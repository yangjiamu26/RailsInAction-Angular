<div class="row wrapper">
  <div class="col-xs-1">
    <button class="btn btn-sm  btn-info" data-bind="click:createDisk">创建</button>
  </div>
  <div class="col-xs-3">
    <div class="input-group">
      <span class="input-group-addon">所属VDC</span>
      <select class="form-control input-sm" data-bind="value: searchParam().vdcUuid, options: $root.vdcs, optionsText: 'name', optionsValue: 'uuid'"></select>
    </div>      
  </div>  
  <div class="col-xs-3">
    <div class="input-group">
      <span class="input-group-addon">所属可用分区</span>
      <select class="form-control input-sm" data-bind="value: searchParam().azUuid, options: $root.partitions, optionsText: 'name', optionsValue: 'uuid'"></select>
    </div>      
  </div> 
                                   
  <div class="col-xs-3">
    <div class="input-group">
      <span class="input-group-addon">名称</span>
      <input type="text" class="input-sm form-control" placeholder="请输入名称" data-bind="value: searchParam().name">
    </div>
  </div>
  <div class="col-xs-2">
    <button class="btn btn-sm" type="button" data-bind="click: reset">重置</button>
    <button class="btn btn-sm btn-default" type="button" data-bind="click: search">搜索</button>
  </div>
</div>       
<div id='instance_object_storages'>
  <div class='table-responsive' data-bind="with: table">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>对象存储名称</th>
          <th>可用分区</th>
          <th>所属VDC</th>
          <th>总大小(GB)</th>
          <th>已使用(GB)</th>
          <th>剩余(GB)</th>
          <th>服务状态</th>
          <th>有效期</th>
          <th>创建时间</th>
          <th>创建人</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr data-bind="visible: showNoData">
          <td colspan=11 class="aligncenter">
            This table has no data.
          </td>
        </tr>
        <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
        <tr>
          <td><a  href="#" data-bind="text:name,click:$root.showFileTable">cdisk</a></td>
          <td data-bind="text:azName">AX1</td>
          <td data-bind="text:vdcName">VDC1</td>
          <td data-bind="text:applySize">50</td>
          <td data-bind="text:havedSize">25</td>
          <td data-bind="text:availableSize">25</td>
          <td>
          	<span class="label label-success" data-bind="if:isValidate">正常</span>
            	<span class="label label-danger" data-bind="ifnot:isValidate">已过期</span>
          </td>
          <td data-bind="text:expiryDate">2016-06-29 11:55</td>
          <td data-bind="text:createTime">2016-06-29 13:56</td>
          <td data-bind="text:userName">admin</td>
          <td><a data-bind="click: $root.upload">上传文件</a> | <a>有效时间变更</a> | <a>终止</a> | <a data-bind="click: $root.removeOne">删除</a></td>
        </tr>
        <!-- /ko -->
      </tbody>
    </table>           
  </div>
  <footer class="panel-footer" data-bind="with: table, visible: table.pages() > 1">
    <ul class="pagination">
      <li data-bind="css: leftPagerClass, click: prevPage">
        <a href="#">&laquo;</a>
      </li>
      <!-- ko foreach: {data: (new Array(pages()))} -->
      <li data-bind="css: $parent.pageClass($index() + 1)">
        <a href="#" data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
      </li>
      <!-- /ko -->
      <li data-bind="css: rightPagerClass, click: nextPage">
        <a href="#">&raquo;</a>
      </li>
    </ul>
  </footer>
</div>
<!-- 存储详情 -->
<div id="instance_object_storage_detail" style="display: none">
  <h3 class="m-l">cdisk</h3>
  <div class="row wrapper">
    <div class="col-xs-7 m-b-xs">
      <a class="btn btn-sm btn-default" href="#" onclick="$('#instance_object_storages').show().siblings().hide();$('#instance_object_storages').prev().show()"><i class="fa fa-arrow-left"></i> 返回</a>
      <button class="btn btn-sm btn-primary">上传</button>
    </div>
    <div class="col-xs-3">
      <div class="input-group">
        <span class="input-group-addon">名称</span>
        <input type="text" class="input-sm form-control" placeholder="请输入名称">
      </div>
    </div>
    <div class="col-xs-2">
      <button class="btn btn-sm" type="button">重置</button>
      <button class="btn btn-sm btn-default" type="button">搜索</button>
    </div>
  </div>
  <div class="wrapper">
    <div class='panel panel-default'>       
      <div class='table-responsive' data-bind="with: fileTable">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>名称</th>
              <th>大小(GB)</th>
              <th>创建时间</th>
              <th>修改时间</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <tr data-bind="visible: showNoData">
              <td colspan=4 class="aligncenter">
                This table has no data.
              </td>
            </tr>
            <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
            <tr>
              <td>centos7.iso</td>
              <td>1G</td>
              <td>2016-06-29 13:56</td>
              <td><a>下载</a> | <a data-bind="click: $root.removeOneObject">删除</a></td>
            </tr>
            <!-- /ko -->
          </tbody>
        </table>           
      </div>
      <footer class="panel-footer" data-bind="with: table, visible: table.pages() > 1">
        <ul class="pagination">
          <li data-bind="css: leftPagerClass, click: prevPage">
            <a href="#">&laquo;</a>
          </li>
          <!-- ko foreach: {data: (new Array(pages()))} -->
          <li data-bind="css: $parent.pageClass($index() + 1)">
            <a href="#" data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
          </li>
          <!-- /ko -->
          <li data-bind="css: rightPagerClass, click: nextPage">
            <a href="#">&raquo;</a>
          </li>
        </ul>
      </footer>
    </div>
  </div>   
</div>




<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal:{show:isCreateDisk}">
  <div class='modal-dialog' role='document'>
    <div class='modal-content'>
      <div class='modal-header'>
        <button type="button" class="close" data-dismiss="modal">
          <span aria-hidden="true">&times;</span>
        </button>
        <h3 class='modal-title'>创建对象存储</h3>
      </div>
      <div class='modal-body form-horizontal' data-bind="with:currentVO">

        <div class="form-group">
          <label class="col-sm-3 control-label">对象存储名称</label>
          <div class="col-sm-8">
            <input type="text" class="form-control"  placeholder="对象存储名称" data-bind="value:name">
          </div>
          <div class="col-sm-1">
            <span class="text-danger inline m-l-n m-t-sm">*</span>
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-3 control-label">存储大小(GB)</label>
          <div class="col-sm-8">
            <input type="text" class="form-control"  placeholder="存储大小" data-bind="value : applySize">
          </div>
          <div class="col-sm-1">
            <span class="text-danger inline m-l-n m-t-sm">*</span>
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-3 control-label">所属VDC</label>
          <div class="col-sm-8">
            <select class="form-control" data-bind="value:vdcUuid, options: $root.vdcsAdd, optionsText: 'name', optionsValue: 'uuid'"></select>
          </div>
          <div class="col-sm-1">
            <span class="text-danger inline m-l-n m-t-sm">*</span>
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-3 control-label">可用分区</label>
          <div class="col-sm-8">
            <select class="form-control" data-bind="value: azUuid, options: $root.partitionsAdd, optionsText: 'name', optionsValue: 'uuid'"></select>
          </div>
          <div class="col-sm-1">
            <span class="text-danger inline m-l-n m-t-sm">*</span>
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-3 control-label">申请时长</label>
          <div class="col-sm-9">
            <div>
              <label class="radio-inline" style="padding-top: 2px">
                <input type="radio"  name="inlineRadioOptions" id="inlineRadio1" value="option1" checked> 永久
              </label>
            </div>
            <div>
              <label class="radio-inline">
                <input type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2" style="margin-top:10px"> 
                <input type="text" class="form-control input-sm inline w-xxs">
                <select class="form-control inline w-xs input-sm">
                  <option value="">月</option>
                </select>  
              </label>
            </div>
            <div>
              <label class="radio-inline">
                <input type="radio" name="inlineRadioOptions" id="inlineRadio3" value="option3" style="margin-top:10px"> 有效期至
                <input type="text" value="" class="form-control inline w input-sm" id="vm_duration">
              </label> 
            </div>                                   
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-3 control-label">备注</label>
          <div class="col-sm-8">
            <textarea class="form-control" data-bind="value:remark"></textarea>
          </div>
          <div class="col-sm-1">
            <span class="text-danger inline m-l-n m-t-sm"></span>
          </div>
        </div>
      </div>
      <div class='modal-footer'>
        <button name="button" class="btn btn-primary " data-bind="click:save">确定</button>
        <button name="button" class="btn btn-default " data-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  var scripts = [null, "assets/lib/moment/moment.js","assets/lib/bootstrap-daterangepicker/daterangepicker.js","api/resourceInstance/objectStorage/objectStorage.js"]
  $('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
    function ViewModel_ObjectStorage(){
      var self = this;
      this.isCreateDisk = ko.observable(false);
      //初始化vo
      this.currentVO = ko.validatedObservable();
      
      this.createDisk = function(){ 
    	  this.currentVO({
        	  name: ko.observable().extend({required: true}),
        	  vdcUuid:ko.observable().extend({required: true}),
          	  azUuid:ko.observable().extend({required: true}),
          	  applySize:ko.observable().extend({required: true}),
          	  remark:''
          });
        //初始化创建的弹窗       
        self.isCreateDisk(true);
      };
      this.save = function(){
    	  ko.validation.group(this.currentVO).showAllMessages();
	      if(this.currentVO.isValid()){
	    	  var postBody = {};
	    	  postBody.name = self.currentVO().name();
	    	  postBody.vdcUuid = self.currentVO().vdcUuid();
	    	  postBody.azUuid = self.currentVO().azUuid();
	    	  postBody.applySize = self.currentVO().applySize();
	    	  postBody.remark = self.currentVO().remark;
	    	  postBody.userName = "admin";//暂时默认，需要获取当前操作的用户，可以在后台添加
	    	  postBody.userUuid = "1";//
	    	  
	    	  var expiryTime = "";
	    	  var temp = document.getElementsByName("inlineRadioOptions");
	    	  for(var i=0;i<temp.length;i++)
	    	  {
	    	     if(temp[i].checked){
	    	    	 if(temp[i].value == "option1"){
	    	    		 expiryTime = "2099-12-30 23:59:59"
	    	    	 }else if(temp[i].value == "option2"){
	    	    		 expiryTime = "2099-12-30 23:59:59"
	    	    	 }else{
	    	    		 var timeStr = $("#resource_instance_vm_limit_"+temp[i].value).val();
	    	    		 expiryTime = timeStr.split("至")[0] + " 23:59:59";
	    	    	 }
	    	     }
	    	  }
	    	  postBody.expiryTime = expiryTime;
	    	 
	    	  console.log(postBody);
	    	  //return;
	    	  $.OBJECT_STORAGE.createObjectStorage(postBody,function(data){
	    		  console.log(data);
	    		  //成功
	    		  if(data.id){
	    			  self.table.refreshData();
		    		  self.isCreateDisk(false);//关闭弹出框
		    		  alert('创建成功！');
	    		  }else{
	    			  alert('创建失败！');
	    		  }	    		  	    		  
	    	  },function(data){
	    		  console.log(data);
	    		  alert('创建失败！');
	    	  })
	      }
      }
      
      
      this.upload = function(object, event){

      }

      this.remove = function(){

      }

      this.removeOne = function(object, event){
    	  confirm("您确定要删除该对象存储["+object.name+"]吗？",function(){    
    		  $.OBJECT_STORAGE.deleteObjectStorage(object.uuid,function(data){
        		  alert('删除成功');
        		  self.table.refreshData();
        	  });
    	  });
      }
      

      this.searchParam = ko.observable({
        azUuid: '',
        vdcUuid: '',
        name: ''
      });
      
      this.reset = function(){
        this.searchParam({
          azUuid: '',
          vdcUuid: '',
          name: ''
        });
        
        this.table.params({});
      }
      
      this.search = function(){
        this.table.params(this.searchParam());
      }
      
      this.table = new DataTable([], {path: 'api/v5.0.0/objectStorages'});

      //定义搜索下拉选择
      this.vdcs = ko.observableArray([]);
      this.loadVdcs = function(){
        $.ajax("pages/resources/instances/object_storages_vdcs.json").done(function(data){
          self.vdcs(data.results);
        });
      }
      this.partitions = ko.observableArray([]);
      this.loadPartitions = function(){
        $.ajax("pages/resources/instances/object_storages_azs.json").done(function(data){
          self.partitions(data.results);
        });
      }
      //加载搜索下拉框数据
      this.loadVdcs();
      this.loadPartitions();
      
      //添加时下拉，可以加载页面时加载，也可以弹窗时加载
      this.vdcsAdd = ko.observableArray([]);
      this.loadVdcsAdd = function(){
        $.ajax("pages/resources/instances/object_storages_vdcs.json").done(function(data){
          self.vdcsAdd(data.results);
        });
      }
      this.partitionsAdd = ko.observableArray([]);
      this.loadPartitionsAdd = function(){
        $.ajax("pages/resources/instances/object_storages_azs.json").done(function(data){
          self.partitionsAdd(data.results);
        });
      }
      //加载创建弹出框中的vdc和az
      this.loadVdcsAdd();
      this.loadPartitionsAdd();
      
      
      
      //-------------------对象-------------------------------------------
      /* this.showFileTable = function(){
    	  $('#instance_object_storage_detail').show().siblings().hide();
    	  
    	  console.log(object);      
      	
      	self.subnetTable.params({'objectStorageUuid':object.uuid});
      }

      this.removeOneObject = function(object,event){
    	  confirm("您确定要删除该对象["+object.name+"]吗？",function(){    
    		  $.OBJECT_STORAGE.deleteObject(object.objcetStorageUuid,object.name,function(data){
        		  alert('删除成功');
        	  });
    	  }
      }
      this.fileTable = new DataTable([], {path: 'api/v5.0.0/objectStorages/334/objects'}); */
      
      
      
      
      
    }
     ko.applyBindings(new ViewModel_ObjectStorage(), $('#partition_object_storages')[0]);
  })
</script>