  <div class="row wrapper">
      <div class="col-xs-1">
        <button class="btn btn-sm btn-info" data-bind="click: addvm">创建</button>
      </div>            
      <div class="col-xs-3">
        <div class="input-group">
          <span class="input-group-addon">所属可用分区</span>
          <select class="form-control input-sm" data-bind="value: searchParam().azUuid, options: $root.partitions, optionsText: 'name', optionsValue: 'uuid'"></select>
        </div>      
      </div>  
      <div class="col-xs-2">
        <div class="input-group">
          <span class="input-group-addon">状态</span>
          <select class="form-control input-sm" data-bind="value: searchParam().state">
            <option value="">全部</option>
            <option value="ACTIVE">运行中</option>
            <option value="SHUTOFF">已关机</option>
            <option value="SUSPENDED">已挂起</option>
          </select>
        </div>      
      </div>        
      <div class="col-xs-2">
        <div class="input-group">
          <span class="input-group-addon">所属VDC</span>
          <select class="form-control input-sm" data-bind="value: searchParam().vdcUuid, options: $root.vdcs, optionsText: 'name', optionsValue: 'uuid',event: {change: $root.onchange_vdcs}"></select>
        </div>      
      </div>       
      <div class="col-xs-2">
        <div class="input-group">
          <span class="input-group-addon">名称</span>
          <input type="text" class="input-sm form-control" placeholder="请输入名称" data-bind="value: searchParam().name">
        </div>
      </div>                                     
      <div class="col-xs-2">
        <button class="btn btn-sm" type="button" data-bind="click: reset">重置</button>
        <button class="btn btn-default btn-sm" type="submit" data-bind="click: search">搜索</button>
      </div>        
  </div>        

  <div id='instance_vms'>
    <div class='table-responsive' data-bind="with: table">
      <table class='table table-striped'>
        <thead>
          <tr>
            <th>云主机名称</th>
            <th>状态</th>
            <th>所属可用分区</th>
            <th>所属VDC</th>
            <th>所属VPC</th>
            <th>有效期</th>
            <th>VCPU</th>
            <th>内存（MB）</th>
            <th>存储（GB）</th>                                  
            <th>IP地址</th>                                  
            <th>服务状态</th>
            <th>创建人</th>
            <th>操作</th>
          </thead>
          <tbody>
            <tr data-bind="visible: showNoData">
              <td colspan=14 class="aligncenter">
                This table has no data.
              </td>
            </tr>
            <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
            <tr> 
                <td>
               	 	<a data-url="" data-bind="text: $row.name,attr:{href:'#pages/resources/instances/vms/show?vmUuid='+$row.uuid+'&vmId='+$row.id}"></a>
               	</td>
                <td>
	                <span class="label label-success" data-bind="if: state == 'ACTIVE'">运行中</span>
	                <span class="label label-danger" data-bind="if: state == 'SHUTOFF'">已关机</span>
	                <span class="label label-info" data-bind="if: state == 'SUSPENDED'">已挂起</span>
	                <span class="label label-warning" data-bind="if: state == 'POWERING_OFF'">正在关机</span>
	                <span class="label label-warning" data-bind="if: state == 'POWERING_ON'">正在启动</span>
	                <span class="label label-warning" data-bind="if: state == 'REBOOTING'">正在重启</span>
	                <span class="label label-warning" data-bind="if: state == 'REBOOTING_HARD'">正在强制重启</span>
	                <span class="label label-warning" data-bind="if: state == 'SUSPENDING'">正在挂起</span>
	                <span class="label label-warning" data-bind="if: state == 'RESUMING'">正在恢复</span>
	                <span class="label label-warning" data-bind="if: state == 'DELETING'">正在删除</span>
	                <span class="label label-warning" data-bind="if: state == 'RESIZING'">正在调整</span>
                </td>
                <td data-bind="text: azName"></td>
                <td data-bind="text: vdcName"></td>
                <td data-bind="text: vpcName"></td>
                <td data-bind="text: expiryTime"></td>
                <td data-bind="text: vcpu"></td>
                <td data-bind="text: memory"></td>
                <td data-bind="text: storage"></td>
                <td data-bind="text: ip"></td>
                <td>
                	<span class="label label-success" data-bind="if: isValidate == true">正常</span>
	                <span class="label label-danger" data-bind="if: isValidate == false">已过期</span>
                </td>
                <td data-bind="text: userName"></td>
                <td><a data-bind="click: $root.console">控制台</a> | <a href="#" data-bind="click: $root.vmAdjustment">调整资源</a> |
                  <div class="btn-group">
                    <a class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                      更多<span class="fa fa-caret-down"></span>
                    </a>
                    <ul style="right:0;min-width:50px;left:auto;" class="dropdown-menu">
                      <li>
                        <a data-bind="click: $root.editValidateTime">有效时间变更</a>
                       <!--  <a data-bind="click: $root.startOne,if: state == 'SHUTOFF'">开机</a>
                        <a data-bind="click: $root.shutoffOne,if: state == 'ACTIVE'">关机</a>
                        <a data-bind="click: $root.restartOne,if: state == 'ACTIVE'">重启</a>
                        <a data-bind="click: $root.restartForceOne,if: state == 'ACTIVE'">强制重启</a>
                        <a data-bind="click: $root.suspend,if: state == 'ACTIVE'">挂起</a>
                        <a data-bind="click: $root.resume,if: state == 'SUSPENDED'">恢复</a> -->
                        <a data-bind="click: $root.startOne">开机</a>
                        <a data-bind="click: $root.shutoffOne">关机</a>
                        <a data-bind="click: $root.restartOne">重启</a>
                        <a data-bind="click: $root.restartForceOne">强制重启</a>
                        <a data-bind="click: $root.suspend">挂起</a>
                        <a data-bind="click: $root.resume">恢复</a>
                        <a data-bind="click: $root.validate">终止</a>
                        <!-- <a data-bind="click: $root.removeOne,if: state == 'SHUTOFF' || state == 'ACTIVE'">删除</a> -->
                        <a data-bind="click: $root.removeOne">删除</a>
                      </li>
                    </ul>
                  </div>                     
                </td>
              </tr>
              <!-- /ko -->
            </tbody>
          </table>
        </div>
        <footer class="panel-footer" data-bind="with: table, visible: table.pages() > 1">
          <ul class="pagination">
            <li data-bind="css: leftPagerClass, click: prevPage">
              <a href="#">&laquo;</a>
            </li>
            <!-- ko foreach: {data: (new Array(pages()))} -->
            <li data-bind="css: $parent.pageClass($index() + 1)">
              <a href="#" data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
            </li>
            <!-- /ko -->
            <li data-bind="css: rightPagerClass, click: nextPage">
              <a href="#">&raquo;</a>
            </li>
          </ul>
        </footer>


        <!-- 创建云主机弹窗 -->
        <div role="dialog" aria-hidden="true" id="modal_addvm" class="modal fade" data-bind="modal: { show: isAddvm }">
          <div class='modal-dialog modal-lg'>
            <div class='modal-content'>
              <div class='modal-header'>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>创建云主机</h3>
              </div>
              <div class='modal-body form-horizontal'>

                <div class="panel panel-default">
                  <div class="panel-heading">基本信息</div>
                  <div class="panel-body">
                    <div class="form-group">
                      <label class="col-xs-1 control-label no-padder-h">云主机名称</label>
                      <div class="col-xs-2">
                        <input type="text" class="form-control" data-bind="value: currentVO().name" placeholder="请输入名称"/>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">所属VDC</label>
                      <div class="col-xs-2">
                      	<select class="form-control input-sm" data-bind="optionsCaption: '请选择VDC',value: currentVO().vdc, options: $root.add_vdcs, optionsText: 'name', optionsValue: 'uuid',event: {change: $root.onchange_add_vdcs}"></select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">可用分区</label>
                      <div class="col-xs-2">
                        <select class="form-control input-sm" data-bind="optionsCaption: '请选择分区', value: currentVO().partition, options: $root.add_partitions, optionsText: 'name', optionsValue: 'uuid',event: {change: $root.onchange_add_partitions}"></select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-xs-1 control-label no-padder-h">镜像</label>
                      <div class="col-xs-2">
                        <select class="form-control input-sm" data-bind="optionsCaption: '请选择镜像',value: currentVO().image, options: $root.add_images, optionsText: 'imageName', optionsValue: 'imageId'"></select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">CPU(个)</label>
                      <div class="col-xs-2">
                        <input type="text" class="form-control" data-bind="value: currentVO().vcpu" placeholder="请输入CPU"/>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">内存(GB)</label>
                      <div class="col-xs-2">
                        <input type="text" class="form-control" data-bind="value: currentVO().memory" placeholder="请输入内存"/>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-xs-1 control-label no-padder-h">存储(GB)</label>
                      <div class="col-xs-2">
                        <input type="text" class="form-control" data-bind="value: currentVO().storage" placeholder="请输入存储"/>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">VPC</label>
                      <div class="col-xs-2">
                        <select class="form-control input-sm" data-bind="optionsCaption: '请选择VPC',value: currentVO().vpc, options: $root.add_vpcs, optionsText: 'name', optionsValue: 'uuid',event: {change: $root.onchange_add_vpcs}"></select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">网络名称</label>
                      <div class="col-xs-2">
                        <select class="form-control input-sm" data-bind="optionsCaption: '请选择网络',value: currentVO().network, options: $root.add_networks, optionsText: 'name', optionsValue: 'originalId'"></select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                    </div>
                    <div class="form-group">
                     <!--  <label class="col-xs-1 control-label no-padder-h">指定IP</label>
                      <div class="col-xs-2">
                        <input type="text" class="form-control">
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                        <a href="#" class="text-info">选择</a>
                      </div> -->
                      <label class="col-xs-1 control-label no-padder-h">绑定密钥</label>
                      <div class="col-xs-2">
                        <select class="form-control" data-bind="value: currentVO().isBind, options: $root.add_isBinds, optionsText: 'text', optionsValue: 'option', event: {change: $root.onchange_add_isBind}">
                        </select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <div id="resource_instance_vm_add_ssh">
	                      <label class="col-xs-1 control-label no-padder-h">选择密钥</label>
	                      <div class="col-xs-2">
	                        <select class="form-control input-sm" data-bind="optionsCaption: '请选择密钥',value: currentVO().sshKey, options: $root.add_sshKeys, optionsText: 'name', optionsValue: 'name'"></select>
	                      </div>
	                      <div class="col-xs-1">
	                        <span class="text-danger inline m-l-n m-t-sm">*</span>
	                      </div>
                      </div>
                    </div>
                    <!-- <div class="form-group">
                    <label class="col-xs-1 control-label no-padder-h">主机账号</label>
                      <div class="col-xs-2">
                        <input type="text" class="form-control">
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">密码</label>
                      <div class="col-xs-2">
                        <input type="password" class="form-control">
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div> 
                      <label class="col-xs-1 control-label no-padder-h">重复密码</label>
                      <div class="col-xs-2">
                        <input type="password" class="form-control">
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                     
                    </div> -->
                    <div class="form-group">
                      <label class="col-xs-1 control-label no-padder-h">申请时长</label>
                      <div class="col-xs-10">
                        <label class="radio-inline" style="padding-top: 2px">
                          <input type="radio" name="inlineRadioOptions" id="inlineRadio1" value="option1" checked="checked"> 永久
                        </label>
                        <label class="radio-inline">
                          <input type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2" style="margin-top:10px"> 
                          <input type="text" class="form-control inline w-xxs" id="resource_instance_vm_limit_option2">
                          <select class="form-control inline w-xs" id="resource_instance_vm_limit_option2_unit">
                            <option value="MONTH">月</option>
                            <option value="YEAR">年</option>
                          </select>  
                        </label>
                        <label class="radio-inline">
                          <input type="radio" name="inlineRadioOptions" id="inlineRadio3" value="option3" style="margin-top:10px"> 有效期至
                          <input type="text" value="" class="form-control inline w" id="resource_instance_vm_limit_option3">
                        </label>                                    
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="panel panel-default">
                  <div class="panel-heading">
                    挂载云硬盘
                    <a href="#" class="pull-right" data-bind="click: $root.addAction">添加硬盘</a>
                  </div>
                  <div class="panel-body">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th >云硬盘名称*</th>
                          <th >存储大小(GB)*</th>
                          <th>操作</th>
                        </tr>
                      </thead>
                      <tbody data-bind="foreach: diskItems">
                        <tr>
                          <td><input type="text" class="form-control input-sm" data-bind="value: volumeName"/></td>
                          <td><input type="text" class="form-control input-sm" data-bind="value: volumeSize"/></td>
                          <td><a data-bind="click:$root.delAction">删除</a></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                <!-- <div class="panel panel-default">
                  <div class="panel-heading">
                    安装软件
                    <a href="#" class="pull-right">添加软件</a>
                  </div>
                  <div class="panel-body">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>软件名称</th>
                          <th>软件分类</th>
                          <th>软件类型</th>
                          <th>软件版本</th>
                          <th>静默安装属性</th>
                          <th>操作</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>oracle</td>
                          <td>数据库</td>
                          <td>oracle</td>
                          <td>10g企业版</td>
                          <td><a href="#">查看</a> | <a href="#">修改</a></td>
                          <td><a href="#">删除</a></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div> -->
                <!-- <div class="panel panel-default">
                  <div class="panel-heading">
                    系统盘分区
                    <a href="#" class="pull-right">添加分区</a>
                  </div>
                  <div class="panel-body">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>分区名称</th>
                          <th>分区大小</th>
                          <th>操作</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>NFS</td>
                          <td>100G</td>
                          <td><a href="#">修改</a> | <a href="#">删除</a></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div> -->
                <!-- <div class="panel panel-default">
                  <div class="panel-heading">高级选项</div>
                  <div class="panel-body">
                    <div class="form-group">
                      <label class="col-xs-3 control-label">所属业务系统</label>
                      <div class="col-xs-8">
                        <select class="form-control">
                          <option value="">VDC1</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-xs-3 control-label">备注</label>
                      <div class="col-xs-8">
                        <textarea cols="5" rows="5" class="form-control"></textarea>
                      </div>
                    </div>
                  </div>
                </div> -->
              </div>
              <div class='modal-footer' style="text-align:center;">
                <a class="btn btn-default btn-info" data-bind="click:save">确定</a>
                <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
              </div>
            </div>
          </div>
        </div>
        <!-- end -->

        <div role="dialog" aria-hidden="true" id="modal_edit_validate" class="modal fade" data-bind="modal: { show: isValidateTime }">
          <div class='modal-dialog modal-md'>
            <div class='modal-content'>
              <div class='modal-header'>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>有效时间变更</h3>
              </div>
              <div class='modal-body form-horizontal row'>
                <div class="form-group">
                  <label class="col-sm-3 control-label">有效期：</label>
                  <div class="col-sm-8">
                    <input type="text" value="" class="form-control inline w" id="resource_instance_vm_validate_edit" data-bind="value: validateTimeVO().time">
                  </div>
                </div>
              </div>
              <div class='modal-footer' style="text-align:center;">
                <a class="btn btn-default btn-info" data-bind="click: validateTime">确定</a>
                <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
              </div>
            </div>
          </div>
        </div>
        
        <div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isVmAdjustment }">
          <div class='modal-dialog modal-md'>
            <div class='modal-content'>
              <div class='modal-header'>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>调整资源</h3>
              </div>
              <div class='modal-body form-horizontal row'>
                <div class="form-group">
                  <label class="col-sm-3 control-label">VCPU数：</label>
                  <div class="col-sm-8">
                    <input type="email" class="form-control" data-bind="value: adjustmentVO().vcpu">
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-sm-3 control-label">内存(MB)：</label>
                  <div class="col-sm-8">
                    <input type="email" class="form-control" data-bind="value: adjustmentVO().memory">
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-sm-3 control-label">存储(GB)：</label>
                  <div class="col-sm-8">
                    <input type="email" class="form-control" data-bind="value: adjustmentVO().storage">
                  </div>
                </div>
              </div>
              <div class='modal-footer' style="text-align:center;">
                <a class="btn btn-default btn-info" data-bind="click: adjust">确定</a>
                <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
     <div id="resource_instance_index_vm_console" style="display:none;"></div> 
<script type="text/javascript">
  var scripts = [null, "assets/lib/moment/moment.js","assets/lib/bootstrap-daterangepicker/daterangepicker.js"];
  $('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
    function ViewModel_VM(){
    	//系统当前登录用户标识
      var account = "";
    	//当前用户所辖VDC列表（包括VDC对应的可用分区信息）
      var vdcList = [];
    	//当前用户所辖可用分区列表
      var azList = [];
      var vdcListForAdd = [];
    	
    	
      var self = this;

      this.isVmAdjustment = ko.observable(false);

      this.isAddvm = ko.observable(false);
      
      this.isValidateTime = ko.observable(false);
      
      this.addvm = function(){
        self.isAddvm(true);
      }

      $("#modal_addvm").on("shown.bs.modal",function(){

          // daterange             
          $('#resource_instance_vm_limit_option3').val(moment().format('YYYY/MM/DD')).daterangepicker(
            {
              format:'YYYY/MM/DD',
              minDate:moment(),
              singleDatePicker: true,
              locale:{
                applyLabel: '确认',
                cancelLabel: '取消',
                weekLabel: '周',
                daysOfWeek:["日","一","二","三","四","五","六"],
                monthNames:['01月','02月','03月','04月','05月','06月','07月','08月','09月','10月','11月','12月',]
              }
            }

          ); 

      })
	  //控制台
      this.console = function(object, event){
    	  csc.rest.get('api/v5.0.0/vms/'+object.uuid+'/vmConsole',function(data){
    		  if(data.consoleUrl){
    			  var consoleUrl = data.consoleUrl;
        		  //模拟点击
        		  $("#resource_instance_index_vm_console").html("<a id='resource_instance_index_vm_console_a' href='"+consoleUrl+"' target='_blank'></a>");
          		  $("#resource_instance_index_vm_console_a")[0].click();
    		  }
		  });
      }
      //启动
      this.startOne = function(object, event){
    		systemMsg.confirm("确定要启动云主机 "+object.name+"？",function(){
    			var startPutBody = {"operationType":"START"};
      			csc.rest.put('api/v5.0.0/vms/'+object.uuid,startPutBody,function(data){
			 		systemMsg.alert('启动云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.table.refreshData();
			    });
      		});
      }
      //关机
      this.shutoffOne = function(object, event){
    	  systemMsg.confirm("确定要关闭云主机 "+object.name+"？",function(){
  			var startPutBody = {"operationType":"STOP"};
    			csc.rest.put('api/v5.0.0/vms/'+object.uuid,startPutBody,function(data){
			 		systemMsg.alert('关闭云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.table.refreshData();
			    });
    		});
      }
      //重启
      this.restartOne = function(object, event){
    	  systemMsg.confirm("确定要重启云主机 "+object.name+"？",function(){
  			var startPutBody = {"operationType":"RESTART"};
    			csc.rest.put('api/v5.0.0/vms/'+object.uuid,startPutBody,function(data){
			 		systemMsg.alert('重启云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.table.refreshData();
			    });
    		});
      }
      //强制重启
      this.restartForceOne = function(object, event){
    	  systemMsg.confirm("确定要强制重启云主机 "+object.name+"？",function(){
  			var startPutBody = {"operationType":"FORCERESTART"};
    			csc.rest.put('api/v5.0.0/vms/'+object.uuid,startPutBody,function(data){
			 		systemMsg.alert('强制重启云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.table.refreshData();
			    });
    		});
      }
      //挂起
      this.suspend = function(object, event){
    	  systemMsg.confirm("确定要挂起云主机 "+object.name+"？",function(){
  			var startPutBody = {"operationType":"SUSPEND"};
    			csc.rest.put('api/v5.0.0/vms/'+object.uuid,startPutBody,function(data){
			 		systemMsg.alert('挂起云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.table.refreshData();
			    });
    		});
      }
      //恢复（从挂起状态）
      this.resume = function(object, event){
    	  systemMsg.confirm("确定要恢复云主机 "+object.name+"？",function(){
  			var startPutBody = {"operationType":"RESUME"};
    			csc.rest.put('api/v5.0.0/vms/'+object.uuid,startPutBody,function(data){
			 		systemMsg.alert('恢复云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.table.refreshData();
			    });
    		});
      }
      //删除
      this.removeOne = function(object, event){
    	  systemMsg.confirm("确定要删除云主机 "+object.name+"？",function(){
    			csc.rest.del('api/v5.0.0/vms/'+object.uuid,function(data){
			 		systemMsg.alert('删除云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.table.refreshData();
			    });
    		});
      }
      
      //终止（服务实例）
      this.validate = function(object, event){
    	  systemMsg.confirm("确定要终止云主机 "+object.name+"？",function(){
    		var putBody = {"expiryDate":""};
  			csc.rest.put('api/v5.0.0/resourceInstances/'+object.uuid,putBody,function(data){
			 		systemMsg.alert('云主机终止成功！');
			 		self.table.refreshData();
			    });
  		});
      }
      //查询条件初始化
      this.searchParam = ko.observable({
        state: '',
        name: '',
        vdcUuid: '',
        azUuid: ''
      })
      
      //重置查询条件
      this.reset = function(){
    	  this.searchParam({
    	        state: '',
    	        name: '',
    	        vdcUuid: '',
    	        azUuid: ''
    	  })
      }
      
      this.search = function(){
        this.table.params(this.searchParam());
      }
      this.table = new DataTable([]);
      //获取可用分区数据
      this.partitions = ko.observableArray([]);
      this.loadPartitions = function(){
    	  csc.rest.get('api/v5.0.0/azs?account='+account,function(data){
    		  if(data.results){
    			  azList = data.results;
    			  //为备选列表添加一个名为"全部"的选项
    			  var azUuids = "";
		    	  for(var i=0;i<azList.length;i++){
		    		  if(i == (azList.length-1)){
		    			  azUuids = azUuids + azList[i].uuid;
					  }else{
						  azUuids = azUuids + azList[i].uuid + ",";
					  }
		    	  }
		    	  var azDef = {"name":"全部","uuid":azUuids};
		    	  azList.unshift(azDef);
    			  //self.reBandai();
    			  self.partitions(azList);
    		  }
    		  self.table.params(self.searchParam());
    		  self.table.path('api/v5.0.0/vms');
    	  });
      }
      
      
      //获取VDC数据
      this.vdcs = ko.observableArray([]);
      this.loadVdcs = function(){
    	  csc.rest.get('api/v5.0.0/vdcs?account='+account,function(data){
    		  if(data.results){
    			  vdcList = data.results;
    			  //为备选列表添加一个名为"全部"的选项
    			  var vdcUuids = "";
		    	  for(var i=0;i<vdcList.length;i++){
		    		  if(i == (vdcList.length-1)){
						  vdcUuids = vdcUuids + vdcList[i].uuid;
					  }else{
						  vdcUuids = vdcUuids + vdcList[i].uuid + ",";
					  }
		    	  }
		    	  var vdcDef = {"name":"全部","uuid":vdcUuids};
				  vdcList.unshift(vdcDef);
    			  //self.reBandai();
    			  self.vdcs(vdcList);
    		  }
    		  self.loadPartitions();
    	  });
      }
      
      this.loadVdcs();
      
      /* //选择不同VDC后，可用分区下拉框要跟着改变
      this.onchange_vdcs = function(){
    	  var vdcUuid = self.searchParam().vdcUuid;
    	  for(var i=0;i<vdcList.length;i++){
    		  if(vdcList[i].uuid == vdcUuid){
    			  self.loadPartitions(vdcList[i].azs);
    		      self.table.params(self.searchParam());
    			  break;
    		  }
    	  }
      } */
      
      /* 为VDC和可用分区下拉框添加"全部"备选项
      "Well briefly, Sir, I am the Permanent Under Secretary of State, 
      known as the Permanent Secretary. 
      Woolley here is your Principal Private Secretary, 
      I too have a Principal Private Secretary and he is the Principal Private Secretary to the Permanent Secretary. 
      Directly responsible to me are 10 Deputy Secretaries, 
      87 Under Secretaries and 219 Assistant Secretaries. 
      Directly responsible to the Principal Private Secretary are plain Private Secretaries, 
      and the Prime Minister will be appointing 2 Parliamentary Under Secretaries and you will be appointing your own Parliamentary Private Secretary." */
      /* this.reBandai = function(){
		  var vdcUuids = "";
		  var azs = [];
    	  for(var i=0;i<vdcList.length;i++){
			  if(i == (vdcList.length-1)){
				  vdcUuids = vdcUuids + vdcList[i].uuid;
			  }else{
				  vdcUuids = vdcUuids + vdcList[i].uuid + ",";
			  }
			  azs.push(vdcList[i].azs);
			  var azList = [];
			  var azUuids = "";
			  if(vdcList[i].azs != null){
				  azList = vdcList[i].azs;
				  for(var j=0;j<azList.length;j++){
					  if(j == (azList.length-1)){
						  azUuids = azUuids + azList[j].uuid;
					  }else{
						  azUuids = azUuids + azList[j].uuid + ",";
					  }
				  }
			  }
			  var azDef = {"name":"全部","uuid":azUuids};
			  azList.unshift(azDef);
    	  }
    	  var vdcDef = {"name":"全部","uuid":vdcUuids,"azs":azs};
		  vdcList.unshift(vdcDef);
      } */

      //------------------------------------------创建开始------------------------------
      
      //初始化
      this.isAddvm = ko.observable(false);
      this.currentVO = ko.validatedObservable({
			name: ko.observable().extend({required: true}),
			vdc: ko.observable().extend({required: true}),
			partition: ko.observable().extend({required: true}),
			image:  ko.observable().extend({required: true}),
			vcpu: ko.observable().extend({required: true}),
			memory: ko.observable().extend({required: true}),
			storage: ko.observable().extend({required: true}),
			vpc: ko.observable().extend({required: true}),
			network: ko.observable().extend({required: true}),
			ip: ko.observable(),
			isBind: ko.observable(),
			sshKey: ko.observable()
	  });
      
      //是否绑定
      this.add_isBinds = ko.observableArray([]);
      this.isBinds_def = function(){
    	  var bindList = [];
    	  bindList.push({text:"是",option:"YES"})
    	  bindList.push({text:"否",option:"NO"});
    	  self.add_isBinds(bindList);
      }
      this.isBinds_def();
      
      //是否绑定->SSH
      this.onchange_add_isBind = function(){
    	  if(this.currentVO().isBind() == "YES"){
    		  $("#resource_instance_vm_add_ssh").show();
    	  }else{
    		  $("#resource_instance_vm_add_ssh").hide();
    	  }
      }
      
      //SSH
      this.add_sshKeys = ko.observableArray([]);
      
      //VDC
      this.add_vdcs = ko.observableArray([]);
      this.add_vdcs_def = function(){
    	  csc.rest.get('api/v5.0.0/vdcs?account='+account,function(data){
    		  if(data.results){
    			  vdcListForAdd = data.results;
		    	  self.add_vdcs(vdcListForAdd);
    		  }
    	  });
      }
      this.add_vdcs_def();
      
      //VDC->可用分区
      this.onchange_add_vdcs = function(){
    	  var vdcUuid = self.currentVO().vdc();
    	  for(var i=0;i<vdcListForAdd.length;i++){
    		  if(vdcListForAdd[i].uuid == vdcUuid){
    			  self.add_partitions(vdcListForAdd[i].azs);
    			  break;
    		  }
    	  }
    	  self.add_vpcs_def();
      }
      
      //可用分区
      this.add_partitions = ko.observableArray([]);
      
      //可用分区->镜像+SSH
      this.onchange_add_partitions = function(){
    	  var azUuid = self.currentVO().partition();
    	  csc.rest.get('api/v5.0.0/images?azUuid='+azUuid,function(data){
    		  self.add_images(data.results);
    	  });
    	  csc.rest.get('api/v5.0.0/sshKeys?azUuid='+azUuid,function(data){
    		  self.add_sshKeys(data.results);
    	  });
      }
      
      //镜像
      this.add_images = ko.observableArray([]);
      
      //VPC
      this.add_vpcs = ko.observableArray([]);
      this.add_vpcs_def = function(){
    	  var vdcUuid = self.currentVO().vdc();
    	  csc.rest.get('api/v5.0.0/vpcs?vdcUuid='+vdcUuid,function(data){
    		  self.add_vpcs(data.results);
    	  });
      }
      
      //VPC->网络
      this.onchange_add_vpcs = function(){
    	  var vpcUuid = self.currentVO().vpc();
    	  csc.rest.get('api/v5.0.0/vpcNetworks?type=INNER&vpcUuid='+vpcUuid,function(data){
    		  self.add_networks(data.results);
    	  });
      }
      
      //网络
      this.add_networks = ko.observableArray([]);
      
      //提交创建
      this.save = function(){
    	  ko.validation.group(this.currentVO).showAllMessages();
	      if(this.currentVO.isValid()){
	    	  var postBody = {};
	    	  postBody.name = self.currentVO().name();
	    	  postBody.vdcUuid = self.currentVO().vdc();
	    	  postBody.azUuid = self.currentVO().partition();
	    	  postBody.imageUuid = self.currentVO().image();
	    	  postBody.vcpu = self.currentVO().vcpu();
	    	  postBody.memory = self.currentVO().memory();
	    	  postBody.storage = self.currentVO().storage();
	    	  postBody.vpcUuid = self.currentVO().vpc();
	    	  var networkList= [];
	    	  var networkInfo = {};
	    	  networkInfo.networkId = self.currentVO().network();
	    	  networkList.push(networkInfo);
	    	  postBody.networkList = networkList;
	    	  postBody.sshKeyUuid = self.currentVO().sshKey();
	    	  
	    	  var expiryTime = "";
	    	  var temp = document.getElementsByName("inlineRadioOptions");
	    	  for(var i=0;i<temp.length;i++)
	    	  {
	    	     if(temp[i].checked){
	    	    	 if(temp[i].value == "option1"){
	    	    		 expiryTime = "2099-12-30 23:59:59";
	    	    	 }else if(temp[i].value == "option2"){
	    	    		 if($("#resource_instance_vm_limit_option2_unit").val() == "MONTH"){
	    	    			 var plusMonth = parseInt($("#resource_instance_vm_limit_option2").val());
	    	    			 var dd = new Date();
	    	    			 var y = dd.getFullYear(); 
	    	    			 var m = dd.getMonth()+1+plusMonth;//获取当前月份的日期 
	    	    			 var selfM = dd.getMonth()+1;
	    	    			 var d = dd.getDate();
	    	    			 y = y + parseInt(m/12);
	    	    			 m = m%12;
	    	    			 if(m == 0){
	    	    				 m = selfM;
	    	    			 }
	    	    		 }else if($("#resource_instance_vm_limit_option2_unit").val() == "YEAR"){
	    	    			 var plusYear = parseInt($("#resource_instance_vm_limit_option2").val());
	    	    			 var dd = new Date();
	    	    			 var y = dd.getFullYear(); 
	    	    			 var m = dd.getMonth()+1;//获取当前月份的日期 
	    	    			 var d = dd.getDate();
	    	    			 y = y + plusYear;
	    	    		 }
	    	    		 expiryTime = y+"-"+m+"-"+d+" 23:59:59";
	    	    	 }else{
	    	    		 var timeStr = $("#resource_instance_vm_limit_option3").val();
	    	    		 expiryTime = $.trim(timeStr) + " 23:59:59";
	    	    	 }
	    	     }
	    	  }
	    	  postBody.expiryTime = expiryTime;
	    	  postBody.diskList = [];
	    	  postBody.diskList = ko.toJS(self.diskItems());
	    	  var isDiskPass = true;
	    	  for(var i=0;i<postBody.diskList.length;i++){
	    		  var name = postBody.diskList[i].volumeName.trim();
	    		  var size = postBody.diskList[i].volumeSize.trim();
	    		  if(csc.util.isNull(name) || csc.util.isNull(size)){
	    			  isDiskPass = false;
	    			  break;
	    		  }
	    	  }
	    	  if(!isDiskPass){
	    		  systemMsg.alert('云硬盘信息缺失，请检查！');
	    		  return;
	    	  }
	    	  csc.rest.post('api/v5.0.0/vms',postBody,function(data){
			 		systemMsg.alert('创建云主机请求成功，任务ID：'+data.taskId+'！');
			 		self.isAddvm(false);
		        	self.table.refreshData();
			  });
	      }
      }
      //------------------------------------------创建结束------------------------------
      
      //------------------------------------------调整配置开始------------------------------
      this.adjustmentVO = ko.validatedObservable({
    	  vcpu: ko.observable(),
    	  memory: ko.observable(),
    	  storage: ko.observable(),
    	  vmUuid: ko.observable()
      });
      
      this.vmAdjustment = function(object, event){
          self.isVmAdjustment(true);
          self.adjustmentVO().vcpu(object.vcpu);
          self.adjustmentVO().memory(object.memory);
          self.adjustmentVO().storage(object.storage);
          self.adjustmentVO().vmUuid(object.uuid);
      };
      
      //调整资源
      this.adjust = function(){
    	  var putBody = {};
    	  putBody.operationType = "RESIZE";
    	  putBody.vcpu = self.adjustmentVO().vcpu();
    	  putBody.memory = self.adjustmentVO().memory();
    	  putBody.storage = self.adjustmentVO().storage();
    	  csc.rest.put('api/v5.0.0/vms/'+self.adjustmentVO().vmUuid(),putBody,function(data){
		 		systemMsg.alert('云主机调整资源请求成功，调度任务ID：'+data.taskId+'！');
		 		self.isVmAdjustment(false);
		 		self.table.refreshData();
		  });
      }
      //------------------------------------------调整配置结束------------------------------
      
      //------------------------------------------云硬盘列表开始----------------------------
      this.diskItems = ko.observableArray();
      //增加一条数据
      function PerDisk(){
        this.volumeName = ko.observable("");
        this.volumeSize = ko.observable("");
      };
      this.addAction = function(){
    	  this.diskItems.push(new PerDisk());
      }
      //删除数据
      this.delAction = function(){
        //调用删除接口，成功后回调以下方法
        self.diskItems.remove(this);
      }
      
      //------------------------------------------云硬盘列表结束----------------------------
      
      //------------------------------------------修改有效期开始----------------------------
      //modal_edit_validate
      $("#modal_edit_validate").on("shown.bs.modal",function(){
		  
          // daterange             
          $('#resource_instance_vm_validate_edit').val(self.validateTimeVO().time()).daterangepicker(
            {
              format:'YYYY/MM/DD',
              minDate:moment(),
              singleDatePicker: true,
              locale:{
                applyLabel: '确认',
                cancelLabel: '取消',
                weekLabel: '周',
                daysOfWeek:["日","一","二","三","四","五","六"],
                monthNames:['01月','02月','03月','04月','05月','06月','07月','08月','09月','10月','11月','12月',]
              }
            }

          ); 

      })
      this.validateTimeVO = ko.validatedObservable({
    	  time: ko.observable(),
    	  uuid: ko.observable()
      });
      
      this.editValidateTime = function(object, event){
    	  self.isValidateTime(true);
    	  self.validateTimeVO().uuid(object.uuid);
    	  self.validateTimeVO().time(object.expiryTime)
      }
      
      //修改有效期
      this.validateTime = function(){
    	  var putBody = {};
    	  putBody.expiryDate = self.validateTimeVO().time() + " 23:59:59";
    	  csc.rest.put('api/v5.0.0/resourceInstances/'+self.validateTimeVO().uuid(),putBody,function(data){
		 		systemMsg.alert('云主机修改有效期成功！');
		 		self.isValidateTime(false);
		 		self.table.refreshData();
		  });
      }
      //------------------------------------------修改有效期结束----------------------------
    }
    ko.applyBindings(new ViewModel_VM(), $('#partition_vms')[0]);
  })
</script>