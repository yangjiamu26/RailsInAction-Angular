<div class='panel panel-default'>
  <div class="wrapper">
    <div class="row">
      <div class="col-xs-1">
        <button class="btn btn-sm btn-primary" data-bind="click: addvm">创建</button>
      </div> 
      <div class="col-xs-2">
        <div class="input-group">
          <span class="input-group-addon">所属VDC</span>
          <select class="form-control input-sm" data-bind="value: searchParam().vdc, options: $root.vdcs, optionsText: 'name', optionsValue: 'id', optionsCaption: '全部'"></select>
        </div>      
      </div>            
      <div class="col-xs-3">
        <div class="input-group">
          <span class="input-group-addon">所属可用分区</span>
          <select class="form-control input-sm" data-bind="value: searchParam().partition, options: $root.partitions, optionsText: 'name', optionsValue: 'id', optionsCaption: '全部'"></select>
        </div>      
      </div>  
      <div class="col-xs-2">
        <div class="input-group">
          <span class="input-group-addon">状态</span>
          <select class="form-control input-sm" data-bind="value: searchParam().status">
            <option value="">全部</option>
            <option value="ACTIVE">运行中</option>
            <option value="SHUTOFF">已关机</option>
            <option value="SUSPENDED">已挂起</option>
          </select>
        </div>      
      </div>        
            
      <div class="col-xs-2">
        <div class="input-group">
          <span class="input-group-addon">名称</span>
          <input type="text" class="input-sm form-control" placeholder="请输入名称" data-bind="value: searchParam().name">
        </div>
      </div>                                     
      <div class="col-xs-2">
        <button class="btn btn-sm" type="button">重置</button>
        <button class="btn btn-default btn-sm" type="submit" data-bind="click: search">搜索</button>
      </div>        
    </div>
  </div>        

  <div id='instance_vms'>
    <div class='table-responsive' data-bind="with: table">
      <table class='table table-striped'>
        <thead>
          <tr>
            <th>云主机名称</th>
            <th>状态</th>
            <th>所属可用分区</th>
            <th>所属VDC</th>
            <th>所属VPC</th>
            <th>有效期</th>
            <th>VCPU</th>
            <th>内存（MB）</th>
            <th>存储（GB）</th>                                  
            <th>IP地址</th>                                  
            <th>操作系统</th>
            <th>创建人</th>
            <th>操作</th>
          </thead>
          <tbody>
            <tr data-bind="visible: showNoData">
              <td colspan=14 class="aligncenter">
                This table has no data.
              </td>
            </tr>
            <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
            <tr> 
              <td>
                <a href="#pages/resources/instances/vms/1" data-bind="text:name">云主机-0-0</a></td>
                <td>
	                <span class="label label-success" data-bind="if: state == 'ACTIVE'">运行中</span>
	                <span class="label label-danger" data-bind="if: state == 'SHUTOFF'">已关机</span>
	                <span class="label label-info" data-bind="if: state == 'ACTIVE'">已挂起</span>
	                <span class="label label-warning" data-bind="if: state == 'POWERING_OFF'">正在关机</span>
	                <span class="label label-warning" data-bind="if: state == 'POWERING_ON'">正在启动</span>
	                <span class="label label-warning" data-bind="if: state == 'REBOOTING'">正在重启</span>
	                <span class="label label-warning" data-bind="if: state == 'REBOOTING_HARD'">正在强制重启</span>
	                <span class="label label-warning" data-bind="if: state == 'SUSPENDING'">正在挂起</span>
	                <span class="label label-warning" data-bind="if: state == 'RESUMING'">正在恢复</span>
	                <span class="label label-warning" data-bind="if: state == 'DELETING'">正在删除</span>
	                <span class="label label-warning" data-bind="if: state == 'RESIZING'">正在调整</span>
                </td>
                <td data-bind="text: azName"></td>
                <td data-bind="text: vdcName"></td>
                <td data-bind="text: vpcName"></td>
                <td data-bind="text: expiryDate"></td>
                <td data-bind="text: vcpu"></td>
                <td data-bind="text: memory"></td>
                <td data-bind="text: storage"></td>
                <td data-bind="text: ip"></td>
                <td data-bind="text: os"></td>
                <td data-bind="text: userName"></td>
                <td><a data-bind="click: $root.console">控制台</a> | <a href="#" data-bind="click: $root.vmAdjustment">调整资源</a> |
                  <div class="btn-group">
                    <a class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                      更多<span class="fa fa-caret-down"></span>
                    </a>
                    <ul style="right:0;min-width:50px;left:auto;" class="dropdown-menu">
                      <li>
                        <a>有效时间变更</a>
                        <a data-bind="click: $root.startOne,if: state == 'SHUTOFF'">开机</a>
                        <a data-bind="click: $root.shutoffOne,if: state == 'ACTIVE'">关机</a>
                        <a data-bind="click: $root.restartOne,if: state == 'ACTIVE'">重启</a>
                        <a data-bind="click: $root.restartForceOne,if: state == 'ACTIVE'">强制重启</a>
                        <a data-bind="click: $root.suspend,if: state == 'ACTIVE'">挂起</a>
                        <a data-bind="click: $root.resume,if: state == 'SUSPENDED'">恢复</a>
                        <a>终止</a>
                        <a data-bind="click: $root.removeOne,if: state == 'SHUTOFF' || state == 'ACTIVE'">删除</a>
                      </li>
                    </ul>
                  </div>                     
                </td>
              </tr>
              <!-- /ko -->
            </tbody>
          </table>
        </div>
        <footer class="panel-footer" data-bind="with: table, visible: table.pages() > 1">
          <ul class="pagination">
            <li data-bind="css: leftPagerClass, click: prevPage">
              <a href="#">&laquo;</a>
            </li>
            <!-- ko foreach: {data: (new Array(pages()))} -->
            <li data-bind="css: $parent.pageClass($index() + 1)">
              <a href="#" data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
            </li>
            <!-- /ko -->
            <li data-bind="css: rightPagerClass, click: nextPage">
              <a href="#">&raquo;</a>
            </li>
          </ul>
        </footer>


        <!-- 创建云主机弹窗 -->
        <div role="dialog" aria-hidden="true" id="modal_addvm" class="modal fade" data-bind="modal: { show: isAddvm }">
          <div class='modal-dialog modal-lg'>
            <div class='modal-content'>
              <div class='modal-header'>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>创建云主机</h3>
              </div>
              <div class='modal-body form-horizontal'>

                <div class="panel panel-default">
                  <div class="panel-heading">基本信息</div>
                  <div class="panel-body">
                    <div class="form-group">
                      <label class="col-xs-1 control-label no-padder-h">云主机名称</label>
                      <div class="col-xs-2">
                        <input type="text" class="form-control">
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">所属VDC</label>
                      <div class="col-xs-2">
                        <select class="form-control">
                          <option value="">VDC1</option>
                        </select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">可用分区</label>
                      <div class="col-xs-2">
                        <select class="form-control">
                          <option value="">可用分区1</option>
                        </select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-xs-1 control-label no-padder-h">镜像</label>
                      <div class="col-xs-2">
                        <select class="form-control">
                          <option value="">windows</option>
                        </select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">CPU(个)</label>
                      <div class="col-xs-2">
                        <select class="form-control">
                          <option value="">1</option>
                        </select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">内存(GB)</label>
                      <div class="col-xs-2">
                        <select class="form-control">
                          <option value="">2</option>
                        </select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-xs-1 control-label no-padder-h">存储(GB)</label>
                      <div class="col-xs-2">
                        <input type="text" class="form-control">
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">VPC/IP池</label>
                      <div class="col-xs-2">
                        <select class="form-control">
                          <option value="">VPC1</option>
                        </select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">网络名称</label>
                      <div class="col-xs-2">
                        <select class="form-control">
                          <option value="">208</option>
                        </select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-xs-1 control-label no-padder-h">指定IP</label>
                      <div class="col-xs-2">
                        <input type="text" class="form-control">
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                        <a href="#" class="text-info">选择</a>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">主机账号</label>
                      <div class="col-xs-2">
                        <input type="text" class="form-control">
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">密码</label>
                      <div class="col-xs-2">
                        <input type="password" class="form-control">
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-xs-1 control-label no-padder-h">重复密码</label>
                      <div class="col-xs-2">
                        <input type="password" class="form-control">
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">绑定密钥</label>
                      <div class="col-xs-2">
                        <select class="form-control">
                          <option value="">是</option>
                        </select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                      <label class="col-xs-1 control-label no-padder-h">选择密钥</label>
                      <div class="col-xs-2">
                        <select class="form-control">
                          <option value="">密钥1</option>
                        </select>
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-xs-1 control-label no-padder-h">申请时长</label>
                      <div class="col-xs-10">
                        <label class="radio-inline" style="padding-top: 2px">
                          <input type="radio" name="inlineRadioOptions" id="inlineRadio1" value="option1"> 永久
                        </label>
                        <label class="radio-inline">
                          <input type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2" style="margin-top:10px"> 
                          <input type="text" class="form-control inline w-xxs">
                          <select class="form-control inline w-xs">
                            <option value="">月</option>
                          </select>  
                        </label>
                        <label class="radio-inline">
                          <input type="radio" name="inlineRadioOptions" id="inlineRadio3" value="option3" style="margin-top:10px"> 有效期至
                          <input type="text" value="" class="form-control inline w" id="vm_duration">
                        </label>                                    
                      </div>
                      <div class="col-xs-1">
                        <span class="text-danger inline m-l-n m-t-sm">*</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="panel panel-default">
                  <div class="panel-heading">
                    挂载云硬盘
                    <a href="#" class="pull-right">添加硬盘</a>
                  </div>
                  <div class="panel-body">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>序号</th>
                          <th>云硬盘名称*</th>
                          <th>存储大小(GB)*</th>
                          <th>申请时长</th>
                          <th>操作</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>1</td>
                          <td><input type="text" class="form-control input-sm"></td>
                          <td><input type="text" class="form-control input-sm"></td>
                          <td>有效期至2017-06-22</td>
                          <td><a href="#">删除</a></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="panel panel-default">
                  <div class="panel-heading">
                    安装软件
                    <a href="#" class="pull-right">添加软件</a>
                  </div>
                  <div class="panel-body">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>软件名称</th>
                          <th>软件分类</th>
                          <th>软件类型</th>
                          <th>软件版本</th>
                          <th>静默安装属性</th>
                          <th>操作</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>oracle</td>
                          <td>数据库</td>
                          <td>oracle</td>
                          <td>10g企业版</td>
                          <td><a href="#">查看</a> | <a href="#">修改</a></td>
                          <td><a href="#">删除</a></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="panel panel-default">
                  <div class="panel-heading">
                    系统盘分区
                    <a href="#" class="pull-right">添加分区</a>
                  </div>
                  <div class="panel-body">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>分区名称</th>
                          <th>分区大小</th>
                          <th>操作</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>NFS</td>
                          <td>100G</td>
                          <td><a href="#">修改</a> | <a href="#">删除</a></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="panel panel-default">
                  <div class="panel-heading">高级选项</div>
                  <div class="panel-body">
                    <div class="form-group">
                      <label class="col-xs-3 control-label">所属业务系统</label>
                      <div class="col-xs-8">
                        <select class="form-control">
                          <option value="">VDC1</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-xs-3 control-label">备注</label>
                      <div class="col-xs-8">
                        <textarea cols="5" rows="5" class="form-control"></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class='modal-footer' style="text-align:center;">
                <a class="btn btn-default btn-info">确定</a>
                <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
              </div>
            </div>
          </div>
        </div>
        <!-- end -->

        <div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isVmAdjustment }">
          <div class='modal-dialog modal-md'>
            <div class='modal-content'>
              <div class='modal-header'>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>调整资源</h3>
              </div>
              <div class='modal-body form-horizontal row'>
                <div class="form-group">
                  <label class="col-sm-3 control-label">VCPU数：</label>
                  <div class="col-sm-8">
                    <input type="email" class="form-control" placeholder="6">
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-sm-3 control-label">内存(GB)：</label>
                  <div class="col-sm-8">
                    <input type="email" class="form-control" placeholder="4">
                  </div>
                </div>
              </div>
              <div class='modal-footer' style="text-align:center;">
                <a class="btn btn-default btn-info">确定</a>
                <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
`     <div id="resource_instance_index_vm_console" style="display:none;"></div> 
<script type="text/javascript">
  var scripts = [null, "assets/lib/moment/moment.js","assets/lib/bootstrap-daterangepicker/daterangepicker.js"]
  $('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
    function ViewModel_VM(){
      var self = this;

      this.isVmAdjustment = ko.observable(false);

      this.vmAdjustment = function(){
        self.isVmAdjustment(true);
      };

      this.isAddvm = ko.observable(false);

      this.addvm = function(){
        self.isAddvm(true);
      }

      $("#modal_addvm").on("shown.bs.modal",function(){

          // daterange             
          $('#vm_duration').val(moment().subtract('days', 29).format('YYYY/MM/DD') + ' 至 ' + moment().format('YYYY/MM/DD')).daterangepicker(
            {
              format:'YYYY/MM/DD',
              startDate: moment().subtract('days', 29),
              endDate: moment(),
              separator:'至',
              locale:{
                applyLabel: '确认',
                cancelLabel: '取消',
                fromLabel: '开始日期',
                toLabel: '结束日期',
                weekLabel: '周',
                customRangeLabel: '自定义范围',                            
                daysOfWeek:["日","一","二","三","四","五","六"],
                monthNames:['01月','02月','03月','04月','05月','06月','07月','08月','09月','10月','11月','12月',]
              },
              ranges: {
               '当天': [moment(), moment()],
               '昨天': [moment().subtract('days', 1), moment().subtract('days', 1)],
               '近7天': [moment().subtract('days', 6), moment()],
               '近30天': [moment().subtract('days', 29), moment()],
               '当月': [moment().startOf('month'), moment().endOf('month')],
               '上月': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
              }
            }

          ); 

      })
	  //控制台
      this.console = function(object, event){
    	  csc.rest.get('api/v5.0.0/vms/'+object.uuid+'/vmConsole',{},function(data){
    		  if(data.consoleUrl){
    			  var consoleUrl = data.consoleUrl;
        		  //模拟点击
        		  $("#resource_instance_index_vm_console").html("<a id='resource_instance_index_vm_console_a' href='"+consoleUrl+"' target='_blank'></a>");
          		  $("#resource_instance_index_vm_console_a")[0].click();
    		  }
		  });
      }
      //启动
      this.startOne = function(object, event){
    		systemMsg.confirm("确定要启动云主机 "+object.name+"？",function(){
    			var startPutBody = {"operationType":"SATRT"};
      			csc.rest.put('api/v5.0.0/vms/'+object.uuid,startPutBody.toJSON(),function(data){
			 		systemMsg.alert('启动云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.table.refreshData();
			    });
      		});
      }
      //关闭
      this.stopOne = function(object, event){
    	  systemMsg.confirm("确定要关闭云主机 "+object.name+"？",function(){
  			var startPutBody = {"operationType":"STOP"};
    			csc.rest.put('api/v5.0.0/vms/'+object.uuid,startPutBody.toJSON(),function(data){
			 		systemMsg.alert('关闭云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.table.refreshData();
			    });
    		});
      }
      //重启
      this.restartOne = function(object, event){
    	  systemMsg.confirm("确定要重启云主机 "+object.name+"？",function(){
  			var startPutBody = {"operationType":"RESTART"};
    			csc.rest.put('api/v5.0.0/vms/'+object.uuid,startPutBody.toJSON(),function(data){
			 		systemMsg.alert('重启云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.table.refreshData();
			    });
    		});
      }
      //强制重启
      this.restartForceOne = function(object, event){
    	  systemMsg.confirm("确定要强制重启云主机 "+object.name+"？",function(){
  			var startPutBody = {"operationType":"FORCERESTART"};
    			csc.rest.put('api/v5.0.0/vms/'+object.uuid,startPutBody.toJSON(),function(data){
			 		systemMsg.alert('强制重启云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.table.refreshData();
			    });
    		});
      }
      //终止（服务实例）
      this.pause = function(){

      }
      //挂起
      this.suspend = function(object, event){
    	  systemMsg.confirm("确定要挂起云主机 "+object.name+"？",function(){
  			var startPutBody = {"operationType":"SUSPEND"};
    			csc.rest.put('api/v5.0.0/vms/'+object.uuid,startPutBody.toJSON(),function(data){
			 		systemMsg.alert('挂起云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.table.refreshData();
			    });
    		});
      }
      //恢复（从挂起状态）
      this.resume = function(object, event){
    	  systemMsg.confirm("确定要恢复云主机 "+object.name+"？",function(){
  			var startPutBody = {"operationType":"RESUME"};
    			csc.rest.put('api/v5.0.0/vms/'+object.uuid,startPutBody.toJSON(),function(data){
			 		systemMsg.alert('恢复云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.table.refreshData();
			    });
    		});
      }
      //删除
      this.removeOne = function(object, event){
    	  systemMsg.confirm("确定要删除云主机 "+object.name+"？",function(){
    			csc.rest.del('api/v5.0.0/vms/'+object.uuid,function(data){
			 		systemMsg.alert('删除云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.table.refreshData();
			    });
    		});
      }

      this.searchParam = ko.observable({
        partition: '',
        status: '',
        vdc: ko.observable(""),
        name: ''
      })
      this.reset = function(){
        this.searchParam({
          partition: '',
          status: '',
          vdc: '',
          name: ''
        })
        this.table.params({});
      }
      
      this.search = function(){
        this.table.params(this.searchParam());
      }
      this.table = new DataTable([], {path: 'api/v5.0.0/vms'})
 
    //获取VDC数据
      this.vdcs = ko.observableArray([]);
      this.loadVdcs = function(){
        $.ajax("api/v5.0.0/vdcs").done(function(data){
          self.vdcs(data.results);
        });
      }
    //获取可用分区数据
      this.partitions = ko.observableArray([]);
      this.loadPartitions = function(vdcUuids){
    	var vdcUrl = "api/v5.0.0/azs" 
    	if(vdcUuids != ""){
    		vdcUrl += "?vdcUuid=" + vdcUuids;
    	};
        $.ajax(vdcUrl).done(function(data){
        	
        	//data.shift()
        	//{};
          self.partitions(data.results);
        });
      }
      this.loadVdcs();
      this.loadPartitions("");
      //选择不同VDC后，可用分区下拉框要跟着改变
      this.searchParam().vdc.subscribe(function(){
    	  //searchParam().vdc();
	  });
    }
    ko.applyBindings(new ViewModel_VM(), $('#partition_vms')[0]);
  })
</script>