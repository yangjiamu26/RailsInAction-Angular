<div class="bg-light lter b-b wrapper-sm">
  <ol class="breadcrumb">
    <li>当前位置：</li>
    <li>资源</li>
    <li><a href="#pages/resources/instances/index">资源实例</a></li>
    <li class="active" data-bind="text: $root.show_vm_name"></li>
  </ol>
</div>
<div class="wrapper-md">
  <div class='nav-tabs-alt bg-white-only'>
    <ul class='nav nav-tabs' role='tablist'>
      <li class='active' role='presentation'>
        <a aria-controls='instance_vm_summary' data-toggle='tab' href='#instance_vm_summary' role='tab'>云主机摘要</a></li>
      <li role='presentation'>
        <a aria-controls='instance_vm_softwares' data-toggle='tab' id="vm_monitor_tab" href='#instance_vm_monitor' role='tab'>监控</a></li>
      <li role='presentation'>
    </ul>
    <div class='tab-content'>
      <div class='tab-pane active' id='instance_vm_summary' role='tabpanel'>
        <div class='panel panel-default'>
          <div class="row wrapper">
            <div class="col-xs-9 m-b-xs">
              <a class="btn btn-sm btn-default" href="#pages/resources/instances/index"><i class="fa fa-arrow-left"></i> 返回</a>
              <a data-bind="click: $root.startOne,if: vmVO().state == 'SHUTOFF'"><button class="btn btn-sm btn-default" >开机</button></a>
              <a data-bind="click: $root.shutoffOne,if: vmVO().state == 'ACTIVE'"><button class="btn btn-sm btn-default" >关机</button></a>
              <a data-bind="click: $root.restartOne,if: vmVO().state == 'ACTIVE'"><button class="btn btn-sm btn-default" >重启</button></a>
              <a data-bind="click: $root.restartForceOne,if: vmVO().state == 'ACTIVE'"><button class="btn btn-sm btn-default" >强制重启</button></a>
              <a data-bind="click: $root.console"><button class="btn btn-sm btn-default" >控制台</button></a>
              <a data-bind="click: $root.suspend,if: vmVO().state == 'ACTIVE'"><button class="btn btn-sm btn-default" >挂起</button></a>
              <a data-bind="click: $root.resume,if: vmVO().state == 'SUSPENDED'"><button class="btn btn-sm btn-default" >恢复</button></a>
              <a data-bind="click: $root.vmAdjustment"><button class="btn btn-sm btn-default" >调整资源</button></a>
              <a data-bind="click: $root.editValidateTime"><button class="btn btn-sm btn-default">有效时间变更</button></a>
              <a data-bind="click: $root.validate"><button class="btn btn-sm btn-default">终止</button></a>
              <a data-bind="click: $root.removeOne"><button class="btn btn-sm btn-default" >删除</button></a>
            </div>
          </div> 
          <div class="row wrapper">
            <div class="col-xs-6">
              <div class="panel panel-default">
                <div class='panel-heading'>基本信息</div>
                <div class="table-responsive">
                  <table class="table table-properties">
                    <tr><th>云主机名称</th><td data-bind="text:vmVO().name"></td></tr>
                    <tr><th>所属可用分区</th><td data-bind="text:vmVO().azName"></td></tr>
                    <tr><th>所属VDC</th><td data-bind="text:vmVO().vdcName"></td></tr>
                    <tr><th>所属VPC</th><td data-bind="text:vmVO().vpcName"></td></tr>
                    <tr><th>业务系统</th><td data-bind="text:vmVO().vappName"></td></tr>
                    <tr><th>云主机状态</th>
                    	<td>
                    		<span class="label label-success" data-bind="if: vmVO().state == 'ACTIVE'">运行中</span>
							<span class="label label-danger" data-bind="if: vmVO().state == 'SHUTOFF'">已关机</span>
							<span class="label label-info" data-bind="if: vmVO().state == 'SUSPENDED'">已挂起</span>
							<span class="label label-warning" data-bind="if: vmVO().state == 'POWERING_OFF'">正在关机</span>
							<span class="label label-warning" data-bind="if: vmVO().state == 'POWERING_ON'">正在启动</span>
							<span class="label label-warning" data-bind="if: vmVO().state == 'REBOOTING'">正在重启</span>
							<span class="label label-warning" data-bind="if: vmVO().state == 'REBOOTING_HARD'">正在强制重启</span>
							<span class="label label-warning" data-bind="if: vmVO().state == 'SUSPENDING'">正在挂起</span>
							<span class="label label-warning" data-bind="if: vmVO().state == 'RESUMING'">正在恢复</span>
							<span class="label label-warning" data-bind="if: vmVO().state == 'DELETING'">正在删除</span>
							<span class="label label-warning" data-bind="if: vmVO().state == 'RESIZING'">正在调整</span>
                    	</td>
                    </tr>
                    <tr><th>操作系统</th><td data-bind="text:vmVO().os"></td></tr>
                    <tr><th>IP地址</th><td data-bind="text:vmVO().ip"></td></tr>
                    <tr><th>所属物理机</th><td data-bind="text:vmVO().hostName"></td></tr>
                    <tr><th>创建人</th><td data-bind="text:vmVO().userName"></td></tr>
                    <tr><th>UUID</th><td data-bind="text:vmVO().originalId"></td></tr>
                  </table>
                </div>
              </div>
            </div>
            <div class="col-xs-3">
              <div class="panel panel-default">
                <div class='panel-heading'>资源配置</div>
                <table class="table table-properties">
                  <tr><th>CPU（个）</th><td data-bind="text:vmVO().vcpu"></td></tr>
                  <tr><th>内存（MB）</th><td data-bind="text:vmVO().memory"></td></tr>
                  <tr><th>存储（GB）</th><td data-bind="text:vmVO().storage"></td></tr>
                </table>
              </div>
              <div class="panel panel-default">
                <div class='panel-heading'>资源使用率</div>
                <table class="table table-properties">
                  <tr><th>CPU使用率</th><td data-bind="text:vmVO().cpuUsedPer"></td></tr>
                  <tr><th>内存使用率</th><td data-bind="text:vmVO().memoryUsedPer"></td></tr>
                </table>
              </div>              
            </div>
            <div class="col-xs-3">
              <div class="panel panel-default">
                <div class='panel-heading'>服务信息</div>
                <div class="table-responsive">
                  <table class="table table-properties">
                    <tr><th>服务状态</th>
                    	<td>
                    		<span class="label label-success" data-bind="if: vmVO().isValidate == true">正常</span>
                    		<span class="label label-danger" data-bind="if: vmVO().isValidate == false">已过期</span>
                    	</td>
                    </tr>
                    <tr><th>生效时间</th><td data-bind="text:vmVO().effectiveTime"></td></tr>
                    <tr><th>失效时间</th><td data-bind="text:vmVO().expiryTime"></td></tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
          
          <div role="dialog" aria-hidden="true" id="modal_edit_validate_1" class="modal fade" data-bind="modal: { show: isValidateTime }">
          <div class='modal-dialog modal-md'>
            <div class='modal-content'>
              <div class='modal-header'>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>有效时间变更</h3>
              </div>
              <div class='modal-body form-horizontal row'>
                <div class="form-group">
                  <label class="col-sm-3 control-label">有效期：</label>
                  <div class="col-sm-8">
                    <input type="text" value="" class="form-control inline w" id="resource_instance_vm_validate_edit_1" data-bind="value: validateTimeVO().time">
                  </div>
                </div>
              </div>
              <div class='modal-footer' style="text-align:center;">
                <a class="btn btn-default btn-info" data-bind="click: validateTime">确定</a>
                <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
              </div>
            </div>
          </div>
        </div>
        
          <div class="row wrapper">
            <div class="col-xs-9 m-b-xs">
              <h4>云硬盘列表</h4>
            </div>
            <div class="col-xs-3 m-b-xs">
              <button class="btn btn-sm btn-default pull-right" data-bind="click: $root.reloadVolume">刷新</button>
            </div>
          </div>         
          <div id='instance_storages'>
            <div class='table-responsive no-height' data-bind="with: vm_volume_table">
              <table class='table table-striped'>
                <thead>
                  <tr>
                    <th>云硬盘名称</th>
                    <th>云硬盘类型</th>
                    <th>虚拟化类型</th>
                    <th>存储池</th>
                    <th>大小（GB）</th>
                    <th>状态</th>
                    <th>保存路径</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
	                <tr data-bind="visible: showNoData">
		              <td colspan=14 class="aligncenter">
		                This table has no data.
		              </td>
		            </tr>
	            	<!-- ko foreach: {data: pagedRows, as: '$row'}  -->
	                <tr>
	                    <td data-bind="text: volumeName"></td>
	                    <td ></td>
	                    <td ></td>
	                    <td ></td>
	                    <td data-bind="text: volumeSize"></td>
	                    <td data-bind="text: volumeStatus"></td>
	                    <td data-bind="text: path"></td>
	                    <td>
	                      <a data-bind="click: $root.storageExpand">扩展</a>
	                    </td>
                  	</tr>
                  	<!-- /ko -->
                </tbody>
              </table>
            </div>
          </div>
          <div class="row wrapper">
            <div class="col-xs-9 m-b-xs">
              <h4>软件列表</h4>
            </div>
            <div class="col-xs-3 m-b-xs">
              <button class="btn btn-sm btn-default pull-right">刷新</button>
            </div>
          </div>    
          <div class="row wrapper">
            <div class="col-xs-1">
              <a class="btn btn-primary btn-sm" data-bind="click: install">安装软件</a>
            </div>
            <div class="col-xs-3">
              <div class="input-group w">
                <span class="input-group-addon">软件类型</span>
                <select class="form-control input-sm">
                  <option value="0">类型1</option>
                  <option value="1">类型2</option>
                  <option value="2">类型3</option>
                  <option value="3">类型4</option>
                </select>
              </div>                
            </div>            
            <div class="col-xs-5">
              <div class="input-group w">
                <span class="input-group-addon">安装类型</span>
                <select class="form-control input-sm">
                  <option value="0">类型1</option>
                  <option value="1">类型2</option>
                  <option value="2">类型3</option>
                  <option value="3">类型4</option>
                </select>
              </div>                
            </div>            
            <div class="col-xs-3">
              <div class="input-group">
                <input type="text" class="input-sm form-control" placeholder="请输入软件名称">
                <span class="input-group-btn">
                  <button class="btn btn-sm btn-default" type="button">搜索</button>
                </span>
              </div>
            </div>
          </div>                     
          <div id='instance_storages'>
            <div class='table-responsive no-height'>
              <table class='table table-striped'>
                <thead>
                  <tr>
                    <th>软件名称</th>
                    <th>软件版本</th>
                    <th>软件类型</th>
                    <th>静默安装属性</th>
                    <th>安装时间</th>
                    <th>安装状态</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>MQ</td>
                    <td>7.5</td>
                    <td>cnware</td>
                    <td><a>查看</a> | <a>修改</a></td>
                    <td>2016-07-22 14:12:21</td>
                    <td>安装成功</td>
                    <td><a>重安装</a> | <a>安装日志</a> | <a data-bind="click: update">升级</a></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>          
        </div>
      </div>
      <div class='tab-pane' id='instance_vm_monitor' role='tabpanel'>
        <div class='panel panel-default'>

          <div class="row wrapper">
            <div class="col-xs-9">
              <strong>采集</strong>
              <select class="input-sm form-control w-sm inline v-middle" id="minute_select">
                 <option value="10">10</option>
                 <option value="20">20</option>
                 <option value="30">30</option>
                 <option value="60">60</option>
              </select>
              <strong>之前数据</strong>&nbsp;
              <button class="btn btn-sm btn-default" data-bind="click: config">告警配置</button>
            </div>
          </div> 
          
          <div class="wrapper">
            <div class="row">
              <div class="col-xs-6">
                <div class="panel panel-default">
                  <div class='panel-heading'>CPU使用率(%)</div>
                  <div class="panel-body">
                    <div id="cpuUse_chart" style="height:150px;"></div>
                  </div>
                </div>
              </div>
              <div class="col-xs-6">
                <div class="panel panel-default">
                  <div class='panel-heading'>内存使用率(%)</div>
                  <div class="panel-body">
                    <div id="memoryUse_chart" style="height:150px;"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-6">
                <div class="panel panel-default">
                  <div class='panel-heading'>存储使用率(%)</div>
                  <div class="panel-body">
                    <div id="storageUse_chart" style="height:150px;"></div>
                  </div>
                </div>
              </div>
            </div> 
            
          </div>

        </div>
      </div>
      
      
    </div>
  </div>
</div>

<div role="dialog" aria-hidden="true" id="alarmModal" class="modal fade" data-bind="modal: { show: isConfig }">
  <div class='modal-dialog modal-md'>
    <div class='modal-content'>
      <div class='modal-header'>
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>告警配置</h3>
      </div>
      <div class='modal-body form-horizontal wrapper'>

        <p class="text-muted">在这里，您可以启用虚拟机的资源使用率监控项，包括对CPU、磁盘、网络的监控</p>
        <h4>监控选择</h4>
        <div class="text-dark">
            <div class="checkbox inline">
              <label class="i-checks">
                <input type="checkbox" value="cpu_util" name="checkbox" id="cpu_util" onclick="cpuCheckboxClick(this);">
                <i></i>
              </label>
            </div>
            启用CPU使用率告警       
        </div>
        <div class="m-t m-l-lg text-primary">
           当CPU使用率超过
           <div class="inline v-middle">
             <div class="input-group w-xs">
                 <input type="text" value="50" class="form-control input-sm" disabled="disabled" id="cpu_util_threshold">
                 <span class="input-group-addon">%</span>
              </div>
           </div>
          ，且持续时间超过
          <div class="inline v-middle">
              <div class="input-group w-xs">
                 <input type="text" value="5" class="form-control input-sm" disabled="disabled" id="cpu_util_period">
                 <span class="input-group-addon">分钟</span>
              </div>
          </div>，触发告警     
        </div>
        
        <div class="text-dark">
            <div class="checkbox inline">
              <label class="i-checks">
                <input type="checkbox" value="memory.resident" name="checkbox" id="memory_resident" onclick="cpuCheckboxClick(this);">
                <i></i>
              </label>
            </div>
            启用内存使用速告警       
        </div>
        <div class="m-t m-l-lg text-primary">
           当内存使用率超过
           <div class="inline v-middle">
             <div class="input-group w-xs">
                 <input type="text" value="50" class="form-control input-sm" disabled="disabled" id="memory_resident_threshold">
                 <span class="input-group-addon">%</span>
              </div>
           </div>
          ，且持续时间超过
          <div class="inline v-middle">
              <div class="input-group w-xs">
                 <input type="text" value="1" class="form-control input-sm" disabled="disabled" id="memory_resident_period">
                 <span class="input-group-addon">分钟</span>
              </div>
          </div>，触发告警     
        </div>
        
        <!--
        <h4>告警配置</h4>
        <div class="m-t m-l-lg text-primary">
           告警重复间隔
           <div class="inline v-middle">
             <div class="input-group w-xs">
                 <input type="text" value="60" class="form-control input-sm" disabled="disabled">
                 <span class="input-group-addon">分钟</span>
              </div>
           </div>    
        </div>
	     -->
      </div>
      <div class='modal-footer' style="text-align:center;">
        <a class="btn btn-default btn-info"  onclick="confirmBtn();">确定</a>
        <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
      </div>
    </div>
  </div>
</div>

<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isInstall }">
  <div class='modal-dialog modal-lg' role='document' data-bind="visible: !isInstallVM()">
    <div class='modal-content'>
      <div class='modal-header'>
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>安装软件</h3>
      </div>
      <div class='modal-body form-horizontal'>
        <div>
          <button class="btn btn-default btn-sm pull-right" data-bind="click: installVM">选择软件</button>
          虚拟机名称:DB2
        </div>
        <hr />
        <p class="text-muted">注：没有密钥对的虚拟机需输入虚拟机用户密码。</p>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>软件名称</th>
              <th>软件版本</th>
              <th>软件类型</th>
              <th>软件分类</th>
              <th>静默安装属性</th>
              <th>是否重复安装</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>a</td>
              <td>1.0</td>
              <td></td>
              <td></td>
              <td></td>
              <td>是</td>
              <td>
                <a>移除</a>
              </td>
            </tr>
            <tr>
              <td>b</td>
              <td>1.0</td>
              <td></td>
              <td></td>
              <td></td>
              <td>是</td>
              <td>
                <a>移除</a>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class='modal-footer' style="text-align: center">
        <input type="button" name="commit" value="确定安装" class="btn btn-default btn-info" />
        <button name="button" type="submit" class="btn btn-default btn btn-default" data-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
  <div class='modal-dialog modal-lg' role='document' data-bind="visible: isInstallVM()">
    <div class='modal-content'>
      <div class='modal-header'>
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>安装软件</h3>
      </div>
      <div class='modal-body form-horizontal'>
        <div>
          虚拟机名称：DB2
        </div>
        <hr />
        <div class="form-inline">
          软件名称：<input type="text" class="form-control" />&nbsp;&nbsp;
          软件分类：
          <select class="form-control">
            <option>分类1</option>
            <option>分类2</option>
            <option>分类3</option>
          </select>&nbsp;&nbsp;
          软件类型：
          <select class="form-control">
            <option>类型1</option>
            <option>类型2</option>
            <option>类型3</option>
          </select>&nbsp;&nbsp;&nbsp;&nbsp;
          <button class="btn btn-default">搜索</button>
        </div>
        <p>&nbsp;</p>
        <table class="table">
          <thead>
            <tr>
              <th>选择</th>
              <th>软件名称</th>
              <th>软件版本</th>
              <th>软件类型</th>
              <th>软件分类</th>
              <th>静默安装属性</th>
              <th>是否重复安装</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <div class="checkbox">
                  <label class="i-checks">
                    <input type="checkbox" value="">
                    <i></i>
                  </label>
                </div> 
              </td>
              <td>a</td>
              <td>1</td>
              <td></td>
              <td></td>
              <td></td>
              <td>是</td>
            </tr>
            <tr>
              <td>
                <div class="checkbox">
                  <label class="i-checks">
                    <input type="checkbox" value="">
                    <i></i>
                  </label>
                </div> 
              </td>
              <td>a</td>
              <td>1</td>
              <td></td>
              <td></td>
              <td></td>
              <td>是</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class='modal-footer'>
        <input type="button" name="commit" value="选择" class="btn btn-default btn-primary" data-bind="click: installVMConfirm" />
        <button name="button" class="btn btn-default btn btn-default" data-bind="click: installVMCancel">取消</button>
      </div>
    </div>
  </div>
</div>

<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isUpdate }">
  <div class='modal-dialog modal-lg' role='document'>
    <div class='modal-content'>
      <div class='modal-header'>
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>软件升级</h3>
      </div>
      <div class='modal-body'>
        <div>
           脚本名称：DB2 软件版本：1
        </div>
        <hr />
        <table class="table table-bordered">
          <thead>
            <tr>
              <th style="width:60px" class="text-center">选择</th>
              <th>软件名称</th>
              <th>软件名称版本</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <div class="radio">
                  <label class="i-checks">
                    <input type="radio" name="softwareupdate" />
                    <i></i>
                  </label>
                </div>
              </td>
              <td>MQ</td>
              <td>8.0</td>
            </tr>
            <tr>
              <td>
                <div class="radio">
                  <label class="i-checks">
                    <input type="radio" name="softwareupdate" />
                    <i></i>
                  </label>
                </div>
              </td>
              <td>MQ</td>
              <td>8.0</td>
            </tr>
          </tbody>
        </table>
        <div class="form-inline">
          用户名：<input type="text" class="form-control" />&nbsp;&nbsp;&nbsp;&nbsp; 密码：<input type="password" class="form-control" />
        </div>
      </div>
      <div class='modal-footer'>
        <input type="button" name="commit" value="确定升级" class="btn btn-default btn-primary" />
        <button name="button" type="submit" class="btn btn-default btn btn-default" data-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isVmAdjustment }">
	<div class='modal-dialog modal-md'>
		<div class='modal-content'>
			<div class='modal-header'>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>调整资源</h3>
			</div>
			<div class='modal-body form-horizontal row'>
				<div class="form-group">
                  <label class="col-sm-3 control-label">VCPU数：</label>
                  <div class="col-sm-8">
                    <input type="email" class="form-control" data-bind="value: adjustmentVO().vcpu">
                  </div>
                </div>
				<div class="form-group">
	                  <label class="col-sm-3 control-label">内存(MB)：</label>
	                  <div class="col-sm-8">
	                    <input type="email" class="form-control" data-bind="value: adjustmentVO().memory">
	                  </div>
				</div>
				<div class="form-group">
	                  <label class="col-sm-3 control-label">存储(GB)：</label>
	                  <div class="col-sm-8">
	                    <input type="email" class="form-control" data-bind="value: adjustmentVO().storage">
	                  </div>
				</div>
			</div>
			<div class='modal-footer' style="text-align:center;">
	                <a class="btn btn-default btn-info" data-bind="click: adjust">确定</a>
	                <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
			</div>
		</div>
	</div>
</div>

<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isStorageExpand }">
    <div class='modal-dialog modal-lg' style="width:600px;">
      <div class='modal-content'>
        <div class='modal-header'>
          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button><h3 class='modal-title'>拓展云硬盘</h3>
        </div>
        <div class='modal-body form-horizontal row'>
          <div class="form-group">
            <label class="col-sm-3 control-label">云硬盘名称：</label>
            <div class="col-sm-8">
              <input type="email" class="form-control" placeholder="盘1">
            </div>
          </div>
          <div class="form-group">
            <label class="col-sm-3 control-label">云硬盘大小(GB)：</label>
            <div class="col-sm-8">
              <input type="email" class="form-control" placeholder="4">
            </div>
          </div>
          <div class="form-group">
            <label class="col-sm-3 control-label">拓展后大小(GB)：</label>
            <div class="col-sm-8">
              <input type="email" class="form-control" placeholder="">
              可调整范围为：16至39.38
            </div>
          </div>

        </div>
        <div class='modal-footer' style="text-align:center;">
          <a class="btn btn-default btn-info">确定</a>
          <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
        </div>
      </div>
    </div>
</div>        
        
<div id="resource_instance_show_vm_console" style="display:none;"></div> 
<!-- page specific plugin scripts -->
<script type="text/javascript">
  //var scripts = [null, "assets/lib/highcharts/highstock.js"]
  var scripts = [null, "assets/lib/moment/moment.js","assets/lib/bootstrap-daterangepicker/daterangepicker.js","assets/lib/highcharts/highstock.js"];
  
  var cpu_chart ;
  var vmUuid;
  $('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
    vmUuid = args.vmUuid;
	var vmId = args.vmId;
	this.show_vm_name = ko.observable("");
    function ViewModel(){
      var self = this;
    	
      this.isConfig = ko.observable(false);
      this.isInstall = ko.observable(false);
      this.isInstallVM = ko.observable(false);
      this.isUpdate = ko.observable(false);
      this.isVmAdjustment = ko.observable(false);
      this.isValidateTime = ko.observable(false);

      this.install = function(){
        this.isInstall(true);
      }
      this.installVM = function(){
        this.isInstallVM(true);
      }
      this.installVMConfirm = function(){
        this.isInstallVM(false);
      }
      this.installVMCancel = function(){
        this.isInstallVM(false);
      }
      this.config = function(){
        this.isConfig(true);
      };
      this.update = function(){
        this.isUpdate(true);
      };
      
      //获取云主机摘要
      this.vmVO = ko.validatedObservable({});
      
      this.reloadVmInfo = function(){
    	  csc.rest.get('api/v5.0.0/vms/'+vmUuid,function(data){
    		  if(data){
    			  self.vmVO(data);
    			  self.reloadVolume();
    		  }
    	  });
      }
      
      this.reloadVmInfo();
      
      //------------------------------------------云硬盘列表开始----------------------------
      this.vm_volume_table = new DataTable([]);
      
      this.volume_param = ko.observable({
    	  firstResult: -1,
    	  maxResult: -1,
          volumeServerId: vmUuid
      })
        
      this.reloadVolume = function(){
    	  self.vm_volume_table.params(self.volume_param());
		  self.vm_volume_table.path('api/v5.0.0/volumes');
      }
      
      this.isStorageExpand = ko.observable(false);

      this.storageExpand = function(){
        self.isStorageExpand(true);
      };
      //------------------------------------------云硬盘列表结束----------------------------
      
      
      
      //--------------------------------操作开始---------------------------------
      
      //控制台
      this.console = function(){
    	  csc.rest.get('api/v5.0.0/vms/'+vmUuid+'/vmConsole',function(data){
    		  if(data.consoleUrl){
    			  var consoleUrl = data.consoleUrl;
        		  //模拟点击
        		  $("#resource_instance_show_vm_console").html("<a id='resource_instance_show_vm_console_a' href='"+consoleUrl+"' target='_blank'></a>");
          		  $("#resource_instance_show_vm_console_a")[0].click();
    		  }
		  });
      }
      //启动
      this.startOne = function(){
    		systemMsg.confirm("确定要启动云主机 "+self.vmVO().name+"？",function(){
    			var startPutBody = {"operationType":"START"};
      			csc.rest.put('api/v5.0.0/vms/'+self.vmVO().uuid,startPutBody,function(data){
			 		systemMsg.alert('启动云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.reloadVmInfo();
			    });
      		});
      }
      //关闭
      this.shutoffOne = function(){
    	  systemMsg.confirm("确定要关闭云主机 "+self.vmVO().name+"？",function(){
  			var startPutBody = {"operationType":"STOP"};
    			csc.rest.put('api/v5.0.0/vms/'+self.vmVO().uuid,startPutBody,function(data){
			 		systemMsg.alert('关闭云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.reloadVmInfo();
			    });
    		});
      }
      //重启
      this.restartOne = function(){
    	  systemMsg.confirm("确定要重启云主机 "+self.vmVO().name+"？",function(){
  			var startPutBody = {"operationType":"RESTART"};
    			csc.rest.put('api/v5.0.0/vms/'+self.vmVO().uuid,startPutBody,function(data){
			 		systemMsg.alert('重启云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.reloadVmInfo();
			    });
    		});
      }
      //强制重启
      this.restartForceOne = function(){
    	  systemMsg.confirm("确定要强制重启云主机 "+self.vmVO().name+"？",function(){
  			var startPutBody = {"operationType":"FORCERESTART"};
    			csc.rest.put('api/v5.0.0/vms/'+self.vmVO().uuid,startPutBody,function(data){
			 		systemMsg.alert('强制重启云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.reloadVmInfo();
			    });
    		});
      }
      //挂起
      this.suspend = function(){
    	  systemMsg.confirm("确定要挂起云主机 "+self.vmVO().name+"？",function(){
  			var startPutBody = {"operationType":"SUSPEND"};
    			csc.rest.put('api/v5.0.0/vms/'+self.vmVO().uuid,startPutBody,function(data){
			 		systemMsg.alert('挂起云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.reloadVmInfo();
			    });
    		});
      }
      //恢复（从挂起状态）
      this.resume = function(){
    	  systemMsg.confirm("确定要恢复云主机 "+self.vmVO().name+"？",function(){
  			var startPutBody = {"operationType":"RESUME"};
    			csc.rest.put('api/v5.0.0/vms/'+self.vmVO().uuid,startPutBody,function(data){
			 		systemMsg.alert('恢复云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.reloadVmInfo();
			    });
    		});
      }
      //删除
      this.removeOne = function(){
    	  systemMsg.confirm("确定要删除云主机 "+self.vmVO().name+"？",function(){
    			csc.rest.del('api/v5.0.0/vms/'+self.vmVO().uuid,function(data){
			 		systemMsg.alert('删除云主机请求成功，调度任务ID：'+data.taskId+'！');
			 		self.reloadVmInfo();
			    });
    		});
      }
      
      //终止（服务实例）
      this.validate = function(){
    	  systemMsg.confirm("确定要终止云主机 "+self.vmVO().name+"？",function(){
    		var putBody = {"expiryDate":""};
  			csc.rest.put('api/v5.0.0/resourceInstances/'+self.vmVO().uuid,putBody,function(data){
			 		systemMsg.alert('云主机终止成功！');
			 		self.reloadVmInfo();
			    });
  		});
      }
      
      //--------------------------------操作结束---------------------------------
      
      //------------------------------------------调整配置开始------------------------------
      this.adjustmentVO = ko.validatedObservable({
    	  vcpu: ko.observable(),
    	  memory: ko.observable(),
    	  storage: ko.observable(),
    	  vmUuid: ko.observable()
      });
      
      this.vmAdjustment = function(){
          self.isVmAdjustment(true);
          self.adjustmentVO().vcpu(self.vmVO().vcpu);
          self.adjustmentVO().memory(self.vmVO().memory);
          self.adjustmentVO().storage(self.vmVO().storage);
          self.adjustmentVO().vmUuid(self.vmVO().uuid);
      };
      
      //调整资源
      this.adjust = function(){
    	  var putBody = {};
    	  putBody.operationType = "RESIZE";
    	  putBody.vcpu = self.adjustmentVO().vcpu();
    	  putBody.memory = self.adjustmentVO().memory();
    	  putBody.storage = self.adjustmentVO().storage();
    	  csc.rest.put('api/v5.0.0/vms/'+self.adjustmentVO().vmUuid(),putBody,function(data){
		 		systemMsg.alert('云主机调整资源请求成功，调度任务ID：'+data.taskId+'！');
		 		self.isVmAdjustment(false);
		 		self.reloadVmInfo();
		  });
      }
      //------------------------------------------调整配置结束------------------------------
      
    //------------------------------------------修改有效期开始----------------------------
      //modal_edit_validate
     $("#modal_edit_validate_1").on("shown.bs.modal",function(){
		  
          // daterange             
          $('#resource_instance_vm_validate_edit_1').val(self.validateTimeVO().time()).daterangepicker(
            {
              format:'YYYY/MM/DD',
              minDate:moment(),
              singleDatePicker: true,
              locale:{
                applyLabel: '确认',
                cancelLabel: '取消',
                weekLabel: '周',
                daysOfWeek:["日","一","二","三","四","五","六"],
                monthNames:['01月','02月','03月','04月','05月','06月','07月','08月','09月','10月','11月','12月',]
              }
            }

          ); 

      })
      this.validateTimeVO = ko.validatedObservable({
    	  time: ko.observable(),
    	  uuid: ko.observable()
      });
      
      this.editValidateTime = function(){
    	  self.isValidateTime(true);
    	  self.validateTimeVO().uuid(self.vmVO().uuid);
    	  self.validateTimeVO().time(self.vmVO().expiryTime);
      }
      
      //修改有效期
      this.validateTime = function(){
    	  var putBody = {};
    	  putBody.expiryDate = self.validateTimeVO().time() + " 23:59:59";
    	  csc.rest.put('api/v5.0.0/resourceInstances/'+self.validateTimeVO().uuid(),putBody,function(data){
		 		systemMsg.alert('云主机修改有效期成功！');
		 		self.isValidateTime(false);
		 		self.reloadVmInfo();
		  });
      }
      //------------------------------------------修改有效期结束----------------------------
    }

    ko.applyBindings(new ViewModel(), $('#page-content')[0]);  

    //cpu使用率
    	cpu_chart = new Highcharts.Chart({
    		chart: {  
                //将报表对象渲染到层上  
            renderTo: 'cpuUse_chart'  
        },   
        title: {
            text: '',
        },
        credits:{
          enabled: false,
          text : ""
        },  
        colors: [
            '#E35733', // orange
            '#4c97d7', // blue
            '#52d74c', // green
            '#e268de' // purple
        ],               
        xAxis: {
            categories: []
        },
        yAxis: {
            title: {
                text: ''
            },
        },        
        tooltip: {
            valueSuffix: '%'
        },
        legend: {
            borderWidth: 0,
            itemMarginTop: 0,
            itemMarginBottom: 0
        },
        series: [{
            name: 'cpu使用率',
            data: []
        }]
    });

    // 内存使用率
    $('#memoryUse_chart').highcharts({
        title: {
            text: '',
        },
        credits:{
          enabled: false,
          text : ""
        },  
        colors: [
            '#E35733', // orange
            '#4c97d7', // blue
            '#52d74c', // green
            '#e268de' // purple
        ],               
        xAxis: {
            categories: ['15:55', '16:00', '16:05', '16:10', '16:15', '16:20','16:25', '16:30']
        },
        yAxis: {
            title: {
                text: ''
            },
        },        
        tooltip: {
            valueSuffix: '%'
        },
        legend: {
            borderWidth: 0,
            itemMarginTop: 0,
            itemMarginBottom: 0
        },
        series: [{
            name: '内存使用率',
            data: [7.0, 6.9, 9.5, 14.5, 18.2, 21.5, 25.2, 26.5]
        }]
    });
    // 存储使用率
    $('#storageUse_chart').highcharts({
        title: {
            text: '',
        },
        credits:{
          enabled: false,
          text : ""
        },  
        colors: [
            '#E35733', // orange
            '#4c97d7', // blue
            '#52d74c', // green
            '#e268de' // purple
        ],               
        xAxis: {
            categories: ['15:55', '16:00', '16:05', '16:10', '16:15', '16:20','16:25', '16:30']
        },
        yAxis: {
            title: {
                text: ''
            },
        },        
        tooltip: {
            valueSuffix: '%'
        },
        legend: {
            borderWidth: 0,
            itemMarginTop: 0,
            itemMarginBottom: 0
        },
        series: [{
            name: '存储使用率',
            data: [7.0, 6.9, 9.5, 14.5, 18.2, 21.5, 25.2, 26.5]
        }]
    });
    // 存储IO
    $('#storageIO_chart').highcharts({
        title: {
            text: '',
        },
        credits:{
          enabled: false,
          text : ""
        },  
        colors: [
            '#E35733', // orange
            '#4c97d7', // blue
            '#52d74c', // green
            '#e268de' // purple
        ],               
        xAxis: {
            categories: ['15:55', '16:00', '16:05', '16:10', '16:15', '16:20','16:25', '16:30']
        },
        yAxis: {
            title: {
                text: ''
            },
        },        
        tooltip: {
            valueSuffix: 'kB/s'
        },
        legend: {
            borderWidth: 0,
            itemMarginTop: 0,
            itemMarginBottom: 0
        },
        series: [
        {
            name: '写入速率',
            data: [428307, 414470, 452582, 412358, 425369, 42513, 401258, 402356]
        },
        {
            name: '读出速率',
            data: [73400, 65235, 56842, 85123, 45879, 56875, 65854, 45712]
        }        
        ]
    });
	
	
  });
  // 存放指标数据;
  var jsonArray = new Array();
  var meter ;
  // 指标选中事件;

	function cpuCheckboxClick(obj) {
		meter = $(obj).attr('id');
		if ($('#' + meter).prop("checked")) {
			$("#" + meter + "_threshold").removeAttr("disabled");
			$("#" + meter + "_period").removeAttr("disabled");
		} else {
			$("#" + meter + "_threshold").attr("disabled", "disabled");
			$("#" + meter + "_period").attr("disabled", "disabled");
		}
	};

   //弹出窗弹出后执行回调方法，对弹出窗里面的内容进行初始化操作;

	$("#alarmModal").on("shown.bs.modal", function() {
		$.ajax("api/v5.0.0/vms/" + vmUuid + "/configAlarm").done(function(data) {
			console.log(data);
			$.each(data, function(id, obj) {
				$("input:checkbox[name='checkbox']").each(function() {
					if (obj.meter == $(this).attr('value') && obj.enable == 'true') {
						$(this).attr("checked", "checked");
						// checkbox选中;
						meter = $(this).attr('id');
						// 指标名称;
						$("#" + meter + "_threshold").removeAttr("disabled");
						$("#" + meter + "_period").removeAttr("disabled");
						$("#" + meter + "_threshold").val(obj.threshold);
						$("#" + meter + "_period").val(obj.period);
					};
				});
			});
		});
	});

  // 确定按钮;
  function confirmBtn() {
    jsonArray = [];
    $("input:checkbox[name='checkbox']:checked").each(function() {
      meter = $(this).attr('id');  // 指标;
      var obj = {
        "meter"     : $(this).attr('value'),
        "threshold" : $("#" + meter + "_threshold").val(),
        "period"    : $("#" + meter + "_period").val(),
        "enable"    : true
      };
      jsonArray.push(obj);
    });
    if(jsonArray.length!=0){// 异步提交信息;
        $.ajax({
        type: 'PUT',
        url: "api/v5.0.0/vms/"+vmUuid+"/configAlarm",
        data: JSON.stringify(jsonArray),
        dataType:'json',
        success: function(data){
          console.log(data);
          systemMsg.alert("配置成功!");
        // 关闭模态框窗口;
        },
        error: function(){
          systemMsg.alert("配置时发生内部错误");
        }
      });
    }else{
      // 数组为空，提示重新选择;
      systemMsg.alert("请配置告警信息");
    }
  }

	// change事件;
	$("#minute_select").change(function() {
		var before = $("#minute_select option:selected").val();
		getMonitorData(before);
	});

	// 监控面板打开事件;
	$("#vm_monitor_tab").on("click", function() {
		// 获取select 选中内容;
		var before = $("#minute_select option:selected").val();
		getMonitorData(before);
	});

	// 查询监控指标数据;
	function getMonitorData(time) {
		var period = "60";
		// 周期不长, 可调整默认为60s;
		// 获取当前时间之前xx分钟;
		var nowDate = new Date();
		nowDate.setMinutes(nowDate.getMinutes() - time);
		console.log("api/v5.0.0/vms/" + vmUuid + "/performance?startTime=" + nowDate.getTime() + "&step=" + period);
		$.ajax("api/v5.0.0/vms/" + vmUuid + "/performance?startTime=" + nowDate.getTime() + "&step=" + period).done(function(data) {
			if(data!=null && data!=""){
				$.each(data,function(id,element){
					if(element.name.indexOf("CPU")!=-1){
						cpu_chart.series[0].setData(element.ydataList);    
						cpu_chart.xAxis[0].setCategories(element.xdataList);
					};
				});
			}else{
				systemMsg.alert("监控信息查询为空!");
			}
		});
	};
</script>