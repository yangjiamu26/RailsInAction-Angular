<div class="bg-light lter b-b wrapper-sm">
  <ol class="breadcrumb">
    <li>当前位置：</li>
    <li>资源</li>
    <li class="active">可用分区</li>
  </ol>
</div>

<div class="wrapper-md">
  <div class='bg-white-only b b-blue'>
    <div class="row wrapper">
      <div class="col-xs-8">
        <button class="btn btn-sm btn-info" data-bind="click: add">创建</button>
      </div>
      <div class="col-xs-3">
        <div class="input-group">
          <span class="input-group-addon">名称</span>
          <input type="text" class="input-sm form-control" placeholder="请输入名称" data-bind="value:searchParam().name">
        </div>
      </div>
      <div class="col-xs-1">
        <button class="btn btn-sm btn-default" type="button" data-bind="click:search">搜索</button>
      </div>
    </div>          
    <div class='table-responsive' data-bind="with:table">
      <table class='table table-striped table-hover'>
        <thead>
          <tr>
            <th>
              <div class="checkbox">
                <label class="i-checks">
                  <input type="checkbox" value="">
                  <i></i>
                </label>
              </div>                    
            </th>                
            <th>可用分区名称</th>
            <th>资源池数量</th>
            <th>数据中心</th>
            <th>云管理平台</th>
            <th>是否独占</th>
            <th>创建人</th>
            <th>创建时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr data-bind="visible: showNoData">
            <td colspan=9 class="aligncenter">
              This table has no data.
            </td>
          </tr>
          <!-- ko foreach: {data: pagedRows, as: '$row'}  -->
          <tr>
            <td>
              <div class="checkbox">
                <label class="i-checks">
                  <input type="checkbox" value="">
                  <i></i>
                </label>
              </div>                     
            </td>
            <td><a href="#pages/resources/partitions/partition_detail" data-bind="text:name,attr:{href:'#pages/resources/partitions/partition_detail?azUuid=' + $row.uuid + '&cloudPlatform='+$row.cloudPlatform + '&virtualHypervisor='+$row.virtualHypervisor+'&azName='+$row.name}"></a></td>
            <td data-bind="text:resourcePoolNum==null?0:resourcePoolNum"></td>
            <td data-bind="text:datacenterName"></td>
            <td data-bind="text:cloudplatformName"></td>
            <td data-bind="text:isPrivate=='1'?'是':'否'">
            </td>
            <td data-bind="text:userName"></td>
            <td data-bind="text:createTime"></td>
            <td><a data-bind="click:$root.edit">修改</a> | <a href="#" data-bind="click:$root.delAz">删除</a></td>
          </tr>
          <!-- /ko -->
        </tbody>
      </table>
    </div>
    <footer class="panel-footer" data-bind="with: table, visible: table.pages() > 1">
      <ul class="pagination">
        <li data-bind="css: leftPagerClass, click: prevPage">
          <a href="#">&laquo;</a>
        </li>
        <!-- ko foreach: {data: (new Array(pages()))} -->
        <li data-bind="css: $parent.pageClass($index() + 1)">
          <a href="#" data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
        </li>
        <!-- /ko -->
        <li data-bind="css: rightPagerClass, click: nextPage">
          <a href="#">&raquo;</a>
        </li>
      </ul>
    </footer>
  </div>
</div>

<div role="dialog" aria-hidden="true" class="modal fade" data-bind="modal: { show: isEdit }">
  <div class='modal-dialog'>
    <div class='modal-content'>
      <div class='modal-header'>
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
        <h3 class='modal-title' data-bind="ifnot: currentVO().uuid">创建可用分区</h3>
        <h3 class='modal-title' data-bind="if: currentVO().uuid">修改可用分区</h3>
      </div>
      <div class='modal-body form-horizontal row' data-bind="with:currentVO">
        <div class="form-group">
          <label class="col-xs-3 control-label">名称</label>
          <div class="col-xs-8">
            <input type="email" class="form-control" placeholder="请输入名称" data-bind="value:name">
          </div>
          <div class="col-xs-1">
            <span class="text-danger inline m-l-n m-t-sm">*</span>
          </div>          
        </div>
        <div class="form-group">
          <label class="col-xs-3 control-label">数据中心</label>
          <div class="col-xs-8">
            <select class="form-control" data-bind="value:datacenterUuid, options: $root.dcs, optionsText: 'name', optionsValue: 'uuid',event: {change: $root.onchange_dcs},attr:{disabled:id}">
              <option value="1">1</option>
              <option value="2">2</option>
            </select>
          </div>
          <div class="col-xs-1">
            <span class="text-danger inline m-l-n m-t-sm">*</span>
          </div>          
        </div>
        <div class="form-group">
          <label class="col-xs-3 control-label">云管理平台</label>
          <div class="col-xs-8">
            <select class="form-control" data-bind="value:cloudplatformUuid, options: $root.cloudPlatforms, optionsText: 'name', optionsValue: 'uuid',event: {change: $root.onchange_cloudPlatforms},attr:{disabled:id}">
              <option value="1">1</option>
              <option value="2">2</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="col-xs-3 control-label">虚拟化类型</label>
          <div class="col-xs-8">
            <select class="form-control" data-bind="value:virtualHypervisor, options: $root.virtualHypervisors, optionsText: 'name', optionsValue: 'name',attr:{disabled:id}">
              <!-- 
              <option value="1">1</option>
              <option value="2">2</option>
               -->
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="col-xs-3 control-label">是否独占</label>
          <div class="col-xs-8">
            <select class="form-control" data-bind="value:isPrivate">
              <option value="1">是</option>
              <option value="0">否</option>
            </select>
          </div>
        </div>
        <!-- 
        <div class="form-group">
          <label class="col-xs-3 control-label">资源池</label>
          <div class="col-xs-8">
            <div class="panel panel-default table-responsive no-height">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>
                      <div class="checkbox">
                        <label class="i-checks">
                          <input type="checkbox" value="">
                          <i></i>
                        </label>
                      </div>
                    </th>
                    <th>资源池名称</th>
                    <th>CPU</th>
                    <th>内存</th>
                    <th>存储</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <div class="checkbox">
                        <label class="i-checks">
                          <input type="checkbox" value="">
                          <i></i>
                        </label>
                      </div>
                    </td>
                    <td>资源池1</td>
                    <td>2</td>
                    <td>10</td>
                    <td>200</td>
                  </tr>
                </tbody>
                
              </table>
            </div>
          </div>
        </div>
         -->
        <div class="form-group">
          <label class="col-xs-3 control-label">描述</label>
          <div class="col-xs-8">
            <textarea class="form-control" cols="30" rows="3" data-bind="value:description"></textarea>
          </div>
        </div>
      </div>
      <div class='modal-footer' style="text-align:center;">
        <a class="btn btn-default btn-info" data-bind="click:ok">确定</a>
        <a class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
      </div>
    </div>
  </div>
</div>

<!-- page specific plugin scripts -->
<script type="text/javascript">
var scripts = [null, null]
$('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {

   function ViewModel(){
      this.isEdit = ko.observable(false);
      var self = this;
      
      var CurrentVO = function(){
        return ko.validatedObservable({
            "name": ko.observable().extend({required: true,
				 validation: {
		                validator: function (val, someOtherVal) {
		                	return csc.util.invalidValueParam(val);
		                },
		                message: '名称不能包含特殊字符！'
		            }
			})
        });
      };
      this.currentVO = new CurrentVO();
	  
      //数据中心,下拉列表
      this.dcs = ko.observableArray([]);
      //云平台,下拉列表
      this.cloudPlatforms = ko.observableArray([]);
      //虚拟化类型,下拉列表
      this.virtualHypervisors = ko.observableArray([]);
      //加载数据中心方法
      this.loadDcs = function(){
        $.ajax("api/v5.0.0/datacenters").done(function(data){
          self.dcs(data.results);
          self.onchange_dcs();
        });
      };
      //加载云平台方法
      this.loadCloudPlatforms = function(dcId, isFilterHasAz){
    	if(isFilterHasAz){
    		$.ajax("api/v5.0.0/cloudPlatforms?isFilterHasAz=true&dataCenterUUID=" + dcId).done(function(data){
   	          self.cloudPlatforms(data.results);
   	        });    		
    	}else{
    		$.ajax("api/v5.0.0/cloudPlatforms?dataCenterUUID=" + dcId).done(function(data){
   	          self.cloudPlatforms(data.results);
   	        });
    	}
      };
      //加载虚拟化类型方法
      this.loadVirtualHypervisors = function(type){
    	  self.virtualHypervisors([]);
    	  if(type == "OpenStack"){
    		  self.virtualHypervisors.unshift({name:"Kvm",cloudPlatform:'Kvm'});
    		  self.virtualHypervisors.unshift({name:"VMware",cloudPlatform:'VMware'});
    	  }else{
    		  self.virtualHypervisors.unshift({name:"Xen",cloudPlatform:'Xen'});
   			  self.virtualHypervisors.unshift({name:"WinServer",cloudPlatform:'WinServer'});
   			  self.virtualHypervisors.unshift({name:"VMware",cloudPlatform:'VMware'});		
   			  self.virtualHypervisors.unshift({name:"PowerVM",cloudPlatform:'PowerVM'});
    	  }
		
      };
      
      //数据中心下拉框onChange
      this.onchange_dcs = function(){
    	  var dcUuid = self.currentVO.toJSON().datacenterUuid;
    	  var azUuid = self.currentVO.toJSON().uuid;
    	  //结合可用分区UUID判断是新增还是修改
    	  if(azUuid){//修改 
    		self.loadCloudPlatforms(dcUuid, false);
    	  }else{//新增
	    	self.loadCloudPlatforms(dcUuid, true);
    	  }
      }
      //虚拟化云平台下拉框onChange
      this.onchange_cloudPlatforms = function(){
    	  //TODO 根据选中虚拟化云平台类型来联动加载
    	  
    	  self.loadVirtualHypervisors("OpenStack");
      }
      
      //console.log(this.dcs.toJSON());
      
      this.add = function(){
        this.currentVO.fromJSON({
          id: null,
          uuid:'',
          name:'',
          datacenterUuid:'',
          cloudplatformUuid:'',
          virtualHypervisor:'',
          isPrivate:'',
          description:''
        });
        self.loadDcs();
        self.isEdit(true);
      };

      this.edit = function(object, event){
        //console.log(object);
        self.loadDcs();
        self.currentVO.fromJSON(object);
        self.isEdit(true);        
      };
      
      this.delAz = function(rowObj){
  		var azName = rowObj.name;
  		var azUuid = rowObj.uuid;
  		confirm("确定删除AZ["+azName+"]？",function(arg){
  			csc.rest.del('api/v5.0.0/azs/'+azUuid, function(data){
  				systemMsg.alert("删除AZ：["+azName+"]成功！");
  		 		self.table.refreshData();
  		    });
  		 });
  	  }

      this.ok = function(){
    	ko.validation.group(self.currentVO).showAllMessages();
      	var azUuid = self.currentVO.toJSON().uuid;
      	
      	if(self.currentVO.isValid()){
	   		if(!azUuid){
	   			csc.rest.post('api/v5.0.0/azs', this.currentVO.toJSON(), function(){
	   	            self.isEdit(false);
	   	            self.table.refreshData();
	   			});
	   		}else{
	   			csc.rest.put('api/v5.0.0/azs/'+azUuid, this.currentVO.toJSON(), function(){
	   	            self.isEdit(false);
	   	            self.table.refreshData();
	   			});
	   		}
        }
      };

      this.searchParam = ko.observable({
        name: ""
      });

      this.search = function(){
        this.table.params(this.searchParam());
      };

      this.table = new DataTable([], {path: 'api/v5.0.0/azs'});
      
    }
    ko.applyBindings(new ViewModel(), $('#page-content')[0]);
  
});
</script>