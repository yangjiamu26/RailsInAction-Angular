<div class="bg-light lter b-b wrapper-sm">
	<ol class="breadcrumb">
		<li>当前位置：</li>
		<li>资源</li>
		<li class="active">业务割接</li>
		<li class="active" data-bind="text: $root.show_vm_name"></li>
	</ol>
</div>
<div class="wrapper-md">
	<div class='nav-tabs-alt bg-white-only b b-blue'>
		<div class='tab-content'>
			<div class='tab-pane active' id='instance_vm_summary' role='tabpanel'>
				<div class="wrapper">
					<a class="btn btn-sm btn-default" href="#pages/resources/partitions/business_cutover/index">
						<i class="fa fa-arrow-left"></i> 返回</a>
				</div>
				<div class="wrapper">
					<h5 class="text-black">
						<i class="fa fa-minus fa-rotate-90 text-info"></i>基本信息
					</h5>
					<div class="bg-light b-t b-b wrapper-sm text-nowarp">
						<div class="row m-b">
							<div class="col-xs-1 font-bold">云主机名称：</div>
							<div class="col-xs-3" data-bind="text: currentVO().name"></div>
							<div class="col-xs-1 font-bold">虚拟化：</div>
							<div class="col-xs-3" data-bind="text: currentVO().hypervisor"></div>
							<div class="col-xs-1 font-bold">IP池：</div>
							<div class="col-xs-3" data-bind="text: currentVO().ipPool"></div>
						</div>
						<div class="row m-b">
							<div class="col-xs-1 font-bold">操作系统：</div>
							<div class="col-xs-3" data-bind="text: currentVO().osVersion"></div>
							<div class="col-xs-1 font-bold">内存(GB)：</div>
							<div class="col-xs-3" data-bind="text: currentVO().memory"></div>
							<div class="col-xs-1 font-bold">所属物理机：</div>
							<div class="col-xs-3" data-bind="text: currentVO().ownerHost"></div>
						</div>
						<div class="row m-b">
							<div class="col-xs-1 font-bold">CNware数据中心：</div>
							<div class="col-xs-3" data-bind="text: currentVO().cnDatacenter"></div>
							<div class="col-xs-1 font-bold">资源池：</div>
							<div class="col-xs-3" data-bind="text: currentVO().resourcePool"></div>
							<div class="col-xs-1 font-bold">IP地址：</div>
							<div class="col-xs-3" data-bind="text: currentVO().ip"></div>
						</div>
						<div class="row m-b">
							<div class="col-xs-1 font-bold">CPU：</div>
							<div class="col-xs-3" data-bind="text: currentVO().cpu"></div>
							<div class="col-xs-1 font-bold">存储(GB)：</div>
							<div class="col-xs-3" data-bind="text: currentVO().storage"></div>
							<div class="col-xs-1 font-bold">状态：</div>
							<div class="col-xs-3">
								<span class="label label-success" data-bind="visible: currentVO().state() == 'OK'">运行中</span>
				                <span class="label label-danger" data-bind="visible: currentVO().state() == 'STOPPED'">已关机</span>
				                <span class="label label-info" data-bind="visible: currentVO().state() == 'SUSPENDED'">已挂起</span>
							</div>
						</div>
					</div>
				</div>

				<div class="wrapper">
					<div class="clear">
						<h5 class="pull-left text-black">
							<i class="fa fa-minus fa-rotate-90 text-info"></i>纳管配置
						</h5>
					</div>
					<div class="row padder-v">
						<div class="col-xs-3 form-group ">
							<div class="input-group w">
								<span class="input-group-addon">所属VDC</span> 
								<select class="form-control input-sm" data-bind="options:vdcList,optionsText:'name',optionsValue:'uuid',value: selected_vdc, event:{'change':changeVdcValue}">
								</select>
							</div>
							<div class="not-null">
								<span class="text-danger inline m-l-n m-t-sm">*</span>
							</div>
						</div>
						<div class="col-xs-3">
							<div class="input-group w">
								<span class="input-group-addon">可用分区</span> 
								<select class="form-control input-sm" data-bind="options: azList,optionsText: 'name',optionsValue: 'uuid',value: selected_az">
								</select>
							</div>
							<div class="not-null">
								<span class="text-danger inline m-l-n m-t-sm">*</span>
							</div>
						</div>
						<div class="col-xs-3">
							<div class="input-group w">
								<span class="input-group-addon">服务产品</span> 
								<select class="form-control input-sm" data-bind="options: serviceList,optionsText: 'name',optionsValue: 'uuid',value: selected_service, event:{'change':changeServiceValue}">
								</select>
							</div>
							<div class="not-null">
								<span class="text-danger inline m-l-n m-t-sm">*</span>
							</div>
						</div>
					</div>
					<div class="row padder-v">
						<div class="col-xs-3 form-inline">
							<div class="input-group w">
								<span class="input-group-addon">套餐</span> 
								<select class="form-control input-sm" data-bind="options: feeList,optionsText: 'name',optionsValue: 'value',value: selected_fee, event:{'change':changeFeeValue}">
								</select>
							</div>
							<span data-bind="text: fee_price"></span>
							<div class="not-null" style="right: 20px;">
								<span class="text-danger inline m-l-n m-t-sm">*</span>
							</div>
						</div>
						<div class="col-xs-3">
							<div class="input-group w">
								<span class="input-group-addon">业务系统</span> 
								<select class="form-control input-sm" data-bind="options: busList,optionsText: 'name',optionsValue: 'uuid',value: selected_bus">
								</select>
							</div>
							<div class="not-null">
								<span class="text-danger inline m-l-n m-t-sm">*</span>
							</div>
						</div>
						<div class="col-xs-3">
							<div class="input-group w">
								<span class="input-group-addon">接管人</span> 
								<select class="form-control input-sm" data-bind="options: userList,optionsText: 'account',optionsValue: 'account',value: selected_user">
								</select>
							</div>
							<div class="not-null">
								<span class="text-danger inline m-l-n m-t-sm">*</span>
							</div>
						</div>
					</div>
					<div class="row padder-v">
						<div class="col-xs-1 font-bold " style="line-height: 32px;">申请时长:</div>
						<div class="col-xs-6">
							<div class="radio">
								<label class="form-inline"> 
								<input type="radio" name="optionsRadios" id="optionsRadios1" value="1" checked
									data-bind="checked: currentVO().validTimeType"> 永久
								</label>
							</div>
							<div class="radio">
								<label class="form-inline"> 
								<input type="radio" class="form-control" style="top: 2px;" name="optionsRadios" id="optionsRadios2" value="2" data-bind="checked: currentVO().validTimeType"> 
									<select class="form-control" data-bind="value: currentVO().validTimeNum">
										<option value="1">1</option>
										<option value="2">2</option>
									</select> 个月
								</label>
							</div>
							<div class="radio disabled">
								<label class="form-inline"> 
									<input type="radio" class="form-control" style="top: 2px;" name="optionsRadios" id="optionsRadios3" value="3" data-bind="checked: currentVO().validTimeType"> 
									<input type="text" style="width: 206px" class="form-control" id="cutover_datePicker" data-bind="value: currentVO().rangeTime">
								</label>
							</div>
						</div>
						<div class="col-xs-1">
							<span class="text-danger inline m-l-n m-t-sm">*</span>
						</div>
					</div>
					
				</div>
				
				<div class="wrapper">
					<div class="clear">
						<h5 class="pull-left text-black">
							<i class="fa fa-minus fa-rotate-90 text-info"></i>挂载云硬盘
						</h5>
					</div>
					<div id='instance_storages'>
						<div class='table-responsive no-height'>
							<table class='table table-striped' data-bind="with:table">
								<thead>
									<tr>
										<th>云硬盘名称</th>
										<th>总大小（GB）</th>
										<th>服务产品</th>
										<th>套餐</th>
									</tr>
								</thead>
								<tbody>
									<!-- <tr data-bind="visible: showNoData">
										<td colspan=4 class="aligncenter">暂无数据.</td>
									</tr> -->
									 <!-- ko foreach: {data: pagedRows, as: '$row'} -->
									<tr>
										<td data-bind="text: $row.name"></td>
										<td data-bind="text: $row.size"></td>
										<!-- <td><select class="form-control" data-bind="options:$root.serviceDiskList,optionsText:'name',optionsValue:'uuid',value: $root.selected_diskService, event:{'change':$root.changeDiskServiceValue}, attr:{id: 'aa'+$index()}"></select></td> -->
										<td><select class="form-control" data-bind="options:$root.serviceDiskList,optionsText:'name',optionsValue:'uuid', event:{'change':$root.changeDiskServiceValue}, attr:{id: $index()}"></select></td>
										<!-- <td><select class="form-control" data-bind="options:$root.diskFeeList,optionsText:'name',optionsValue:'value',value: $root.selected_diskFee, attr:{id: 'bb'+$index()}"></select></td> -->
										<td><select class="form-control" data-bind="options:$root.diskFeeList,optionsText:'name',optionsValue:'value',attr:{id: 'bb'+$index()}"></select></td>
									</tr>
									<!-- /ko -->
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<div class="row padder-v" style="text-align: center;">
					<a class="btn btn-default btn-info" data-bind="click: saveCutOver">确定</a> 
					<a class="btn btn-default btn btn-default" href="#pages/resources/partitions/business_cutover/index">取消</a>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- page specific plugin scripts -->
<script type="text/javascript">
	//var scripts = [null, "assets/lib/highcharts/highstock.js"]
	var scripts = [ null, "assets/lib/moment/moment.js",
			"assets/lib/bootstrap-daterangepicker/daterangepicker.js","assets/lib/bootstrap-daterangepicker/date.js",
			"assets/lib/highcharts/highstock.js" ];
	$('.page-content-area').ace_ajax('loadScripts',scripts,function(args) {
		
		var vmId = args.id;
		var hypervisor = args.hypervisor;
		var cloudUuid = args.cloudUuid;
		
		var diskFeeId;
		var booldiskFee;
		
		$('#cutover_datePicker').val(moment().subtract( 29, 'days').format('YYYY-MM-DD')).daterangepicker({
			format : 'YYYY/MM/DD',
			minDate : moment(),
			startDate: moment().subtract( 29, 'days'),
			singleDatePicker : true
		});
		//获取VDC列表
		function loadVdcList(){
			csc.rest.get('api/v5.0.0/vdcs',function(data){
				detailModel.vdcList(data.results);
	        });
		}
		loadVdcList();
		//获取az列表
		function loadAzList(vdcUuid){
			csc.rest.get('api/v5.0.0/vdcs/'+vdcUuid+'/azs',function(data){
//				var newAzList
				data.results.forEach(function(e){
					if(e.cloudPlatform == 'CNware'){
						detailModel.azList.push(e);
					}
				})
//				detailModel.azList(data.results);
	        });
		}
		//获取业务系统列表
		function loadBusList(vdcUuid){
			csc.rest.get('api/v5.0.0/bussys?vdcUuid='+vdcUuid,function(data){
				detailModel.busList(data.results);
	        });
		}
		//获取用户列表
		function loadUserList(vdcUuid){
			csc.rest.get('api/v5.0.0/vdcs/'+vdcUuid+'/users',function(data){
				detailModel.userList(data.results);
	        });
		}
		//获取服务列表
		function loadServiceList(vdcUuid,type){
			if(type == "VM"){
				csc.rest.get('api/v5.0.0/service/getVdcService/'+vdcUuid+'/'+type,function(data){
					detailModel.serviceList(data.results);
		        });
			}else{
				csc.rest.get('api/v5.0.0/service/getVdcService/'+vdcUuid+'/'+type,function(data){
					detailModel.serviceDiskList(data.results);
		        });
			}
		}
		//获取套餐列表
		function loadCycleList(serviceUuid, type){
			if(type == "VM"){
				csc.rest.get('api/v5.0.0/cart/getCartSelectList?serviceUuid='+serviceUuid,function(data){
					detailModel.feeList(formatCharge(data.chargeList));
		        });
			}else{
				csc.rest.get('api/v5.0.0/cart/getCartSelectList?serviceUuid='+serviceUuid,function(data){
					if(booldiskFee){
						var aa = formatCharge(data.chargeList);
						var bb = "";
						aa.forEach(function(f){
							bb+= "<option value='"+f.value+"'>"+f.name+"</option>"
						})
						$("#bb"+diskFeeId).html("");
						$("#bb"+diskFeeId).append(bb);
					}else{
						detailModel.diskFeeList(formatCharge(data.chargeList));
					}
		        });
			}
			
		}
		//套餐列表转换
		function formatCharge(attr){
	    	var arrayCharge = [];
	    	if(attr !=null){
	    		for(var i=0;i<attr.length;i++){
		    		if(attr[i]=="DAY"){
		    			arrayCharge.push({name:"按天",value:"DAY"});
		    		}else if(attr[i]=="MONTH"){
		    			arrayCharge.push({name:"按月",value:"MONTH"});
		    		}else if(attr[i]=="QUARTER"){
		    			arrayCharge.push({name:"按季度",value:"QUARTER"});
		    		}else{
		    			arrayCharge.push({name:"按年",value:"YEAR"});
		    		}
		    	}
	    	}
	    	return arrayCharge;
	    }
		
		//获取费用
		function loadFee(serviceUuid,cycle){
			csc.rest.get("api/v5.0.0/billing/rules/calculate?serviceUuid="+serviceUuid+"&cycle="+cycle, function(result){
 	    		var price = 0;
 	    		var type = detailModel.selected_fee();
 	    		var cpu = detailModel.currentVO().cpu();
 	    		var memory = detailModel.currentVO().memory();
 	    		var storage = detailModel.currentVO().storage();
 	    		result.ruleList.forEach(function(e){
 	    			if(e.attrType=='CPU'){
 	    				price += cpu * e.unitPrice;
 	    			}else if(e.attrType=='MEMORY'){
 	    				price += memory * e.unitPrice;
 	    			}else if(e.attrType=='STORAGE'){
 	    				price += storage * e.unitPrice;
 	    			}/* else if(e.attrType=='DISK'){
 	    				price += size * e.unitPrice;
 	    			}else if(e.attrType=='LOAD_BALANCING'){
 	    				price +=e.unitPrice;
 	    			}else if(e.attrType=='SECRET_KEY'){
 	    				price +=e.unitPrice;
 	    			}else if(e.attrType=='OBJECT_STORAGE'){
 	    				price += size * e.unitPrice;
 	    			}else if(e.attrType=='PUBLICIP'){
 	    				price +=e.unitPrice;
 	    			} */
 	    		});
 	    		
 	    		if(parseInt(price)!=price){
 	    			price = price.toFixed(2);
 	    		}
 	    		if(type=="DAY"){
 	    			price+="元/天";
 	    		}else if(type=="MONTH"){
 	    			price+="元/月";
 	    		}else if(type=="QUARTER"){
 	    			price+="元/季度";
 	    		}else{
 	    			price+="元/年";
 	    		}
 	    		detailModel.fee_price(price);
 	    	});	
		}
		
		function ViewModel() {
			var self = this;
			
			this.table = new DataTable([]);
			
			this.currentVO = ko.validatedObservable({
				name: ko.observable(),
				hypervisor: ko.observable(),
				ipPool: ko.observable(),
				osVersion: ko.observable(),
				memory: ko.observable(),
				memoryMB: ko.observable(),
				ownerHost: ko.observable(),
				ownerHostId: ko.observable(),
				cnDatacenter: ko.observable(),
				resourcePool: ko.observable(),
				originalId: ko.observable(),
				hypervisor: ko.observable(),
				platform: ko.observable(),
				ip: ko.observable(),
				cpu: ko.observable(),
				storage: ko.observable(),
				state: ko.observable(),
				validTimeType: ko.observable("1"),
	    	    validTimeNum: ko.observable(),
	    	    rangeTime: ko.observable()
			});
			
			//vdc列表
			this.vdcList = ko.observableArray();
			this.selected_vdc = ko.observable().extend({required : true});
			//az列表
			this.azList = ko.observableArray();
			this.selected_az = ko.observable().extend({required : true});
			//业务系统列表
			this.busList = ko.observableArray();
			this.selected_bus = ko.observable().extend({required : true});
			//用户列表
			this.userList = ko.observableArray();
			this.selected_user = ko.observable().extend({required : true});
			//云主机服务列表
			this.serviceList = ko.observableArray();
			this.selected_service = ko.observable().extend({required : true});
			//云主机套餐列表
			this.feeList = ko.observableArray();
			this.selected_fee = ko.observable().extend({required : true});
			//费用价格
			this.fee_price = ko.observable();
			//云盘服务列表
			this.serviceDiskList = ko.observableArray();
			this.selected_diskService = ko.observable().extend({required : true});
			//云盘套餐列表
			this.diskFeeList = ko.observableArray();
			this.selected_diskFee = ko.observable().extend({required : true});
			//VDC选择事件
	        this.changeVdcValue = function(viewModel, event){
	        	loadAzList(viewModel.selected_vdc());
	        	loadBusList(viewModel.selected_vdc());
	        	loadUserList(viewModel.selected_vdc());
	        	loadServiceList(viewModel.selected_vdc(),"VM");
	        	loadServiceList(viewModel.selected_vdc(),"DISK");
	        }
			
	        //云主机服务选择事件
	        this.changeServiceValue = function(viewModel, event){
	        	loadCycleList(viewModel.selected_service(),"VM");
	        }
	        
	        //套餐选择事件
	        this.changeFeeValue = function(viewModel, event){
	        	loadFee(viewModel.selected_service(),viewModel.selected_fee());
	        }
	      	//云盘服务选择事件
	        this.changeDiskServiceValue = function(viewModel, event){
	        	diskFeeId = event.currentTarget.id;
	        	booldiskFee = event.bubbles;

				 if(event.bubbles){
				 	loadCycleList($("#"+event.currentTarget.id).val(),"DISK");
				 }else{
					 loadCycleList($("#"+event.currentTarget.id).val(),"DISK");
					 /* loadCycleList(self.selected_diskService(),"DISK"); */
				 }
	        }
	      	
	      	loadInitData();
	      	
	      	//获取数据详情
			function loadInitData(){
				csc.rest.get('api/v5.0.0/nanotubes/getVmInfo?vmId='+vmId+'&hypervisor='+hypervisor+'&cloudUuid='+cloudUuid,function(data){
					self.currentVO.fromJSON({
						name: data.name,
						hypervisor: data.platform,
						ipPool: data.ips,
						osVersion: data.osType,
						memory: data.memory/1024,
						memoryMB: data.memory,
						ownerHost: data.hostName,
						ownerHostId: data.hostId,
						originalId: data.originalId,
						cnDatacenter: "",
						resourcePool: data.poolName,
						hypervisor: data.hypervisor,
						platform: data.platform,
						ip: data.ip,
						cpu: data.vcpu,
						storage: data.storage,
						state: data.state,
						validTimeType: "1",
			    	    validTimeNum: "",
			    	    rangeTime: ""
					});
					self.table.pagedRows(data.volumeInfo);
					
		        });
			}	      	

	      	//保存
	      	this.saveCutOver = function(){
	      		var isTrue = true;
	      		if(self.selected_vdc() == null || self.selected_vdc() == ""){
	      			isTrue = false;
	      		}
	      		if(self.selected_az() == null || self.selected_az() == ""){
	      			isTrue = false;
	      		}
	      		if(self.selected_service() == null || self.selected_service() == ""){
	      			isTrue = false;
	      		}
	      		if(self.selected_fee() == null || self.selected_fee() == ""){
	      			isTrue = false;
	      		}
	      		if(self.selected_bus() == null || self.selected_bus() == ""){
	      			isTrue = false;
	      		}
	      		if(self.selected_user() == null || self.selected_user() == ""){
	      			isTrue = false;
	      		}
	      		if(!isTrue){
	      			alert("请检查必填项！");
	      			return;
	      		}
	      		
	      		var diskList = self.table.pagedRows();
	      		var newDiskList = [];
	      		var isDiskTrue = true;
	      		for(var i = 0;i < diskList.length; i++){
	      			if($("#"+i).val() == null || $("#"+i).val() == ""){
	      				isDiskTrue = false;
		      		}
	      			if($("#bb"+i).val() == null || $("#bb"+i).val() == ""){
	      				isDiskTrue = false;
		      		}
	      			
	      			var disk = {
	      				serviceUuid	: $("#"+i).val(),
	      				volumeName : diskList[i].name,
	      				volumeSize : diskList[i].size+"",
	      				description : diskList[i].desc,
	      				volumeStatus : diskList[i].state=="MOUNT"?"in-use":"",
	      				vdcUuid : self.selected_vdc(),
	      				azUuid : self.selected_az(),
	      				billCycle : $("#bb"+i).val()
	      			}
	      			newDiskList.push(disk);
	      		}
	      		if(!isDiskTrue){
	      			alert("请检查必填项！");
	      			return;
	      		}
	      		
	      		var state = self.currentVO().state();
	      		if(state == "OK"){
	      			state = "ACTIVE";
	      		}else if(state == "STOPPED"){
	      			state = "SHUTOFF";
	      		}
	      		var detailInfo = {
	      			state : state,
	      			ownerHostName : self.currentVO().ownerHost(),
	      			ownerHostUuid : self.currentVO().ownerHostId()+"",
	      			vcpu : self.currentVO().cpu(),
	      			memory : self.currentVO().memoryMB(),
	      			storage : self.currentVO().storage(),
	      			ip : self.currentVO().ip(),
	      			osVersion : self.currentVO().osVersion(),
	      			name : self.currentVO().name(),
	      			serviceUuid : self.selected_service(),
	      			type : "VM",
	      			azUuid : self.selected_az(),
	      			vdcUuid : self.selected_vdc(),
	      			account : self.selected_user(),
	      			busSysUuid : self.selected_bus(),
	      			virtualHypervisor : self.currentVO().platform(),
	      			cloudPlatform : "CNware",
	      			dataTime : self.currentVO().rangeTime(),
	      			validTimeType : self.currentVO().validTimeType(),
	      			validTimeNum : self.currentVO().validTimeNum(),
	      			billCycle : self.selected_fee(),
	      			originalId : self.currentVO().originalId(),
	      			diskList : newDiskList
	      		}
	      		
	      		csc.rest.post('api/v5.0.0/nanotubes',detailInfo,function(data){
					alert("纳管成功！");
					location.href = "#pages/resources/partitions/business_cutover/index";
		        });
	      	}
		}
		
		var detailModel = new ViewModel(); 
		ko.applyBindings(detailModel, $('#page-content')[0]);
	});
</script>