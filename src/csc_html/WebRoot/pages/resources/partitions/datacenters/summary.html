<div class="bg-light lter b-b wrapper-sm">
	<ol class="breadcrumb">
		<li>当前位置：</li>
		<li>资源</li>
		<li><a href="#pages/resources/partitions/datacenters/index">数据中心</a></li>
		<li class="active">云宏信息数据中心</li>
	</ol>
</div>
<div class='wrapper-md'>
	<div class='bg-white-only b b-blue'>
		<div class="wrapper">
			<a class="btn btn-sm btn-default"
				href="#pages/resources/partitions/datacenters/index"><i
				class="fa fa-arrow-left"></i> 返回</a>
			<button class="btn btn-sm btn-info"
				data-bind="click: editDataCenterInfo">修改</button>
			<button class="btn btn-sm btn-info"
				data-bind="click: deleteDataCenter">删除</button>
		</div>

		<div class="wrapper">
            <h5 class="text-black"><i class="fa fa-minus fa-rotate-90 text-info"></i>基本信息</h5>
            <div class="bg-light b-t b-b wrapper-sm">
              <div class="row m-b">
                <div class="col-xs-1 font-bold text-nowrap">名称：</div>
                <div class="col-xs-3" data-bind="text:dataCenterInfoVO().name"></div>
                <div class="col-xs-1 font-bold text-nowrap">创建时间：</div>
                <div class="col-xs-3" data-bind="text:dataCenterInfoVO().createTime"></div>
                <div class="col-xs-1 font-bold text-nowrap">描述：</div>
                <div class="col-xs-3" data-bind="text:dataCenterInfoVO().description"></div>
              </div>
             </div>		
			<div class="row wrapper">
				<div class="col-xs-6">
					<div class="row text-center">
						<div class="col-xs-6">
							<h5>可用分区数</h5>
							<h2 data-bind="text:summaryVO().azNum"></h2>
							<div id="partitions_chart" style="height: 130px; width: 300px;"></div>
						</div>

						<div class="col-xs-6">
							<h5>虚拟机数</h5>
							<h2 data-bind="text:summaryVO().vmNum"></h2>
							<div id="vm_status_chart" style="height: 130px; width: 280px;"></div>
						</div>
					</div>
				</div>
				<div class="col-xs-6">
						<div class='row wrapper text-center bg-success'>
							<div class='col-xs-4'>
								<div>CPU逻辑单元数</div>
								<div class='h2 m-b-sm' data-bind="text:summaryVO().cpuNum">1</div>
							</div>
							<div class='col-xs-4'>
								<div>内存(GB)</div>
								<div class='h2 m-b-sm' data-bind="text:summaryVO().memorySize">719.58</div>
							</div>
							<div class='col-xs-4'>
								<div>存储(TB)</div>
								<div class='h2 m-b-sm' data-bind="text:summaryVO().storageSize">30.75</div>
							</div>
							<!-- <div class='col-xs-3'>
	              <div>资源池数</div>
	              <div class='h2 m-b-sm' data-bind="text:summaryVO().resourcePoolNum">9</div></div> -->
							<div class='col-xs-4'>
								<div>物理机数</div>
								<div class='h2 m-b-sm' data-bind="text:summaryVO().hostNum">21</div>
							</div>
							<!-- <div class='col-xs-3'>
	              <div>存储数</div>
	              <div class='h2 m-b-sm' data-bind="text:summaryVO().storageNum">83</div></div> -->
							<div class='col-xs-4'>
								<div>网络数</div>
								<div class='h2 m-b-sm' data-bind="text:summaryVO().networkNum">30</div>
							</div>
							<div class='col-xs-4'>
								<div>镜像数</div>
								<div class='h2 m-b-sm' data-bind="text:summaryVO().imageNum">10</div>
							</div>
						</div>

				</div>
				
			</div>
		</div>
		<div class="wrapper">
			<div class="row m-b">
				<div class="col-xs-8">
					<button class="btn btn-sm btn-info" data-bind="click: add">接入</button>
					<!-- <button class="btn btn-sm btn-default">删除</button> -->
				</div>
				<div class="col-xs-3">
					<div class="input-group">
						<span class="input-group-addon">名称</span> <input type="text"
							class="input-sm form-control" placeholder="请输入名称"
							data-bind="value:searchParam().name">
					</div>
				</div>
				<div class="col-xs-1">
					<button class="btn btn-sm btn-default" type="button"
						data-bind="click:search">搜索</button>
				</div>
			</div>
			<div class='table-responsive no-height' data-bind="with:table">
				<table class='table table-striped table-hover'>
					<thead>
						<tr>
							<!-- <th>
	                <div class="checkbox">
	                  <label class="i-checks">
	                    <input type="checkbox" value="" data-bind="checked: isSelectedAll">
	                    <i></i>
	                  </label>
	                </div>                   
	            </th> -->
							<th>名称</th>
							<th>所属数据中心</th>
							<th>云管理平台类型</th>
							<th>IP</th>
							<th>端口</th>
							<th>资源域</th>
							<!-- <th>状态</th> -->
							<th>添加时间</th>
							<th>描述</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody>
						<tr data-bind="visible: showNoData">
							<td colspan=11 class="aligncenter">This table has no data.</td>
						</tr>
						<!-- ko foreach: {data: pagedRows, as: '$row'}  -->
						<tr>
							<!--  <td>
	                <div class="checkbox">
	                  <label class="i-checks">
	                    <input type="checkbox" value="" data-bind="checkedValue: $data, checked: $parent.chosenItems">
	                    <i></i>
	                  </label>
	                </div>                   
	            </td> -->
							<td data-bind="text:name">CNWare</td>
							<td data-bind="text:$root.dataCenterName">xxx</td>
							<td data-bind="text:type">xxx</td>
							<td data-bind="text:ip">192.168.1.100</td>
							<td data-bind="text:port">8080</td>
							<td data-bind="text:domain"></td>
							<!-- <td><span class="label label-success"
								data-bind="if:state == '正常'">正常</span> <span
								class="label label-danger" data-bind="if:state == '异常'">异常</span>
							</td> -->
							<td data-bind="text:createTime"></td>
							<td data-bind="text:description"></td>
							<td><a href="#" data-bind="click:$root.edit">修改</a> | <a
								href="#" data-bind="click:$root.delete">删除</a></td>
						</tr>
						<!-- /ko -->
					</tbody>
				</table>
			</div>
			<footer class="panel-footer"
				data-bind="with: table, visible: table.pages() > 1">
				<ul class="pagination">
					<li data-bind="css: leftPagerClass, click: prevPage"><a
						href="#">&laquo;</a></li>
					<!-- ko foreach: {data: (new Array(pages()))} -->
					<li data-bind="css: $parent.pageClass($index() + 1)"><a
						href="#"
						data-bind="text: $index() + 1, click: $parent.gotoPage($index() + 1)"></a>
					</li>
					<!-- /ko -->
					<li data-bind="css: rightPagerClass, click: nextPage"><a
						href="#">&raquo;</a></li>
				</ul>
			</footer>
		</div>
	</div>
</div>

<div role="dialog" aria-hidden="true" class="modal fade"
	data-bind="modal: { show: isEditDataCenter }">
	<div class='modal-dialog'>
		<div class='modal-content'>
			<div class='modal-header'>
				<button type="button" class="close" data-dismiss="modal">
					<span aria-hidden="true">&times;</span>
				</button>
				<h3 class='modal-title'>修改数据中心</h3>
			</div>
			<div class='modal-body form-horizontal row'
				data-bind="with:dataCenterInfoVO()">
				<div class="form-group">
					<label class="col-xs-3 control-label">名称</label>
					<div class="col-xs-8">
						<input type="email" class="form-control" placeholder="请输入名称"
							data-bind="value:name">
					</div>
					<div class="col-xs-1">
						<span class="text-danger inline m-l-n m-t-sm">*</span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-3 control-label">描述</label>
					<div class="col-xs-8">
						<textarea class="form-control" cols="30" rows="3"
							data-bind="value:description"></textarea>
					</div>
				</div>
			</div>
			<div class='modal-footer' style="text-align: center;">
				<a class="btn btn-default btn-info" data-bind="click:saveDataCenter">确定</a> <a
					class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
			</div>
		</div>
	</div>
</div>

<div role="dialog" aria-hidden="true" class="modal fade"
	data-bind="modal: { show: isEdit }">
	<div class='modal-dialog'>
		<div class='modal-content'>
			<div class='modal-header'>
				<button type="button" class="close" data-dismiss="modal">
					<span aria-hidden="true">&times;</span>
				</button>
				<h3 class='modal-title' data-bind="ifnot: currentVO().id">接入云管理平台</h3>
				<h3 class='modal-title' data-bind="if: currentVO().id">修改</h3>
			</div>
			<div class='modal-body form-horizontal row'
				data-bind="with:currentVO">
				<div class="form-group">
					<label class="col-xs-3 control-label">名称</label>
					<div class="col-xs-8">
						<input type="text" class="form-control" placeholder="请输入名称"
							data-bind="value:name">
					</div>
					<div class="col-xs-1">
						<span class="text-danger inline m-l-n m-t-sm">*</span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-3 control-label">数据中心</label>
					<div class="col-xs-8">
						<input type="text" class="form-control"
							data-bind="value:$root.dataCenterName" value="数据中心1" disabled>
						<!-- <input type="text" class="form-control" data-bind="value:$root.dataCenterUUID" value="1" disabled> -->
					</div>
					<div class="col-xs-1">
						<span class="text-danger inline m-l-n m-t-sm">*</span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-3 control-label">云管理平台类型</label>
					<div class="col-xs-8">
						<select class="form-control"
							data-bind="value:type,attr:{disabled:id}">
							<option value="OpenStack">OpenStack</option>
							<option value="CNware">CNware</option>
						</select>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-3 control-label">IP</label>
					<div class="col-xs-8">
						<input type="text" class="form-control" placeholder="请输入名称"
							data-bind="value:ip,attr:{disabled:id}">
					</div>
					<div class="col-xs-1">
						<span class="text-danger inline m-l-n m-t-sm">*</span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-3 control-label">端口</label>
					<div class="col-xs-8">
						<input type="text" class="form-control" placeholder="请输入名称"
							data-bind="value:port,attr:{disabled:id}">
					</div>
					<div class="col-xs-1">
						<span class="text-danger inline m-l-n m-t-sm">*</span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-3 control-label">用户名</label>
					<div class="col-xs-8">
						<input type="text" class="form-control" placeholder="请输入名称"
							data-bind="value:username">
					</div>
					<div class="col-xs-1">
						<span class="text-danger inline m-l-n m-t-sm">*</span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-3 control-label">密码</label>
					<div class="col-xs-8">
						<input type="password" class="form-control" placeholder="请输入名称"
							data-bind="value:password">
					</div>
					<div class="col-xs-1">
						<span class="text-danger inline m-l-n m-t-sm">*</span>
					</div>
				</div>
				<div class="form-group" data-bind="visible: type() == 'CNware'">
					<label class="col-xs-3 control-label">资源域</label>
					<div class="col-xs-8">
						<div class="panel panel-default table-responsive no-height">
							<table class="table table-striped">
								<thead>
									<tr>
										<th>
											<div class="radio">
												<label class="i-checks"> <input type="radio"
													value=""> <i></i>
												</label>
											</div>
										</th>
										<th>名称</th>
										<th>IP</th>
										<th>端口</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td>
											<div class="radio">
												<label class="i-checks"> <input type="radio"
													value=""> <i></i>
												</label>
											</div>
										</td>
										<td>金阳</td>
										<td>192.168.2.33</td>
										<td>8090</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-3 control-label">描述</label>
					<div class="col-xs-8">
						<textarea class="form-control" cols="30" rows="3"
							data-bind="value:description"></textarea>
					</div>
				</div>
			</div>
			<div class='modal-footer' style="text-align: center;">
				<a class="btn btn-default btn-info" data-bind="click:ok">确定</a> <a
					class="btn btn-default btn btn-default" data-dismiss="modal">取消</a>
			</div>
		</div>
	</div>
</div>

<!-- page specific plugin scripts -->
<script type="text/javascript">
var scripts = [null,"assets/lib/highcharts/highstock.js"];
$('.page-content-area').ace_ajax('loadScripts', scripts, function(args) {
	//console.log(args);


 function ViewModel(){
    this.isEdit = ko.observable(false);
    this.isEditDataCenter = ko.observable(false);
    this.currentVO = ko.validatedObservable({});
    
    //数据中心基础信息VO
    this.dataCenterInfoVO = ko.observable({});
    //数据中心摘要统计信息VO
    this.summaryVO = ko.observable({});

    var self = this;
    
    //从url中拿到参数设置
    self.dataCenterName = args.datacenterName;
    self.dataCenterUUID = args.datacenterId;
    
    //修改数据中心
    this.editDataCenterInfo = function(){
      self.isEditDataCenter(true);  
    }
    
    this.saveDataCenter = function(){
    	csc.rest.put('api/v5.0.0/datacenters/'+self.dataCenterUUID, this.dataCenterInfoVO(), function(data){
            self.isEditDataCenter(false);
    		systemMsg.alert("修改成功");
            //location.href = "#pages/resources/partitions/datacenters/index";
		});
    }
    
    //删除数据中心
    this.deleteDataCenter = function(){
    	var dcName = self.dataCenterInfoVO().name;
		var datacenterUuid = self.dataCenterInfoVO().uuid;
		confirm("确定删除数据中心["+dcName+"]？",function(arg){
			csc.rest.del('api/v5.0.0/datacenters/'+datacenterUuid, function(data){
				systemMsg.alert("删除数据中心：["+dcName+"]成功！");
				location.href = "#pages/resources/partitions/datacenters/index";
		    });
		 });
    }
    
    
    
    this.loadDataCenterInfo = function(){
    	$.ajax("api/v5.0.0/datacenters/"+self.dataCenterUUID).done(function(data){
      	  self.dataCenterInfoVO(data);
      	  //console.log(self.summaryVO().azNum);
  	    });
    }
    
    this.loadSummary = function(){
    	//加载数据中心摘要
    	$.ajax("api/v5.0.0/datacenters/"+self.dataCenterUUID+"/summary").done(function(data){
    	  self.summaryVO(data);
    	  //console.log(self.summaryVO().azNum);
    	  
    	  var azDatas = [];
    	  //color:"#5bd544"
    	  $.each(self.summaryVO().azVirtualHypervisorNum,function(index,data){
    		  var obj = {};
    		  obj.name=data.virTualHypervisor;
    		  obj.y=data.azNum;
    		  if(data.virTualHypervisor == "Kvm"){
    			  obj.color="#5bd544";
    		  }else{
    			  obj.color="#ffd800"
    		  }
    		  azDatas[index] = obj;
   		  });
    	　　//console.log(azDatas);
    	  
    	 //可用分区占比图
    	  $('#partitions_chart').highcharts({
    	      chart: {
    	          marginTop: 0,
    	          plotBackgroundColor: null,
    	          plotBorderWidth: null,
    	          plotShadow: false,
    	          backgroundColor: "none"
    	      },
    	      title: {
    	          text: ''
    	      },
    	      credits:{
    	        enabled: false,
    	        text : ""
    	      }, 
    	      legend:{
    	        layout: 'vertical',
    	        align: 'right',
    	        verticalAlign: 'middle',
    	        borderColor:"none",
    	        labelFormat: '{name}：<b>{y}</b> 个',
    	        itemMarginTop: 10,
    	        itemStyle: {
    	          
    	          fontWeight: 'normal',
    	          fontSize:'12px'
    	        },          
    	      },
    	      plotOptions: {
    	          pie: {
    	              innerSize: '40%',
    	              borderWidth:0,
    	              allowPointSelect: true,
    	              cursor: 'pointer',
    	              dataLabels: {
    	                  enabled: false
    	              },
    	              showInLegend: true
    	          }
    	      },
    	      series: [{
    	          type: 'pie',
    	          name: '云管理平台',
    	          data: azDatas
    	      }]
    	  });
    	  
    	  // 虚拟机状态占比图
    	  $('#vm_status_chart').highcharts({
    	      chart: {
    	          marginTop: 0,
    	          plotBackgroundColor: null,
    	          plotBorderWidth: null,
    	          plotShadow: false,
    	          backgroundColor: "none"
    	      },
    	      title: {
    	          text: ''
    	      },
    	      credits:{
    	        enabled: false,
    	        text : ""
    	      }, 
    	      legend:{
    	        layout: 'vertical',
    	        align: 'right',
    	        verticalAlign: 'middle',
    	        borderColor:"none",
    	        labelFormat: '{name}：<b>{y}</b> 台',
    	        itemMarginTop: 10,
    	        itemStyle: {
    	          
    	          fontWeight: 'normal',
    	          fontSize:'12px'
    	        },          
    	      },
    	      plotOptions: {
    	          pie: {
    	              innerSize: '40%',
    	              borderWidth:0,
    	              allowPointSelect: true,
    	              cursor: 'pointer',
    	              dataLabels: {
    	                  enabled: false
    	              },
    	              showInLegend: true
    	          }
    	      },
    	      series: [{
    	          type: 'pie',
    	          name: '状态',
    	          data: [{
    	                name: '运行中',
    	                y: self.summaryVO().vmNumAlive,
    	                color:"#4791d2"
    	            },
    	            {
    	                name: '已关机',
    	                y: self.summaryVO().vmNumStopped,
    	                color:"#ffd800"
    	            },
    	            {
    	                name: '其他',
    	                y: self.summaryVO().vmNumOther,
    	                color:"#5bd544"
    	            }
    	        ]
    	      }]
    	  });
    	
    	
    	
	    });
    }
    this.loadSummary();
    this.loadDataCenterInfo();

    
    
    //--------------------云管理平台------------------------------------------------
    
	    //点击接入按钮时，初始化数据
	this.add = function(){
	      this.currentVO({
	        id: null,
	        name	:	ko.observable('').extend({ required: true, maxLength: 32 }),
	        dataCenterUUID	:	self.dataCenterUUID,//从上一个页面传过来的 “数据中心uuid”
	        type	:	ko.observable('').extend({ required: true }),
	        ip	:	ko.observable('').extend({ required: true }),
	        port	:	ko.observable().extend({ required: true}),
	        username	:	ko.observable('').extend({ required: true }),
	        password	:	ko.observable('').extend({ required: true }),
	        domain:{},
	        description:''
	      });
	      self.isEdit(true);
	    };

    this.edit = function(object, event){
      self.currentVO({
    	  	id: object.uuid,//这个会加到put的路径
    	  	uuid: object.uuid,//uuid，保存的时候会有这个
	        name	:	ko.observable(object.name).extend({ required: true, maxLength: 32 }),
	        dataCenterUUID	:	self.dataCenterUUID,//从上一个页面传过来的 “数据中心uuid”
	        type	:	ko.observable(object.type).extend({ required: true }),
	        ip	:	ko.observable(object.ip).extend({ required: true }),
	        port	:	ko.observable(object.port).extend({ required: true}),
	        username	:	ko.observable(object.username).extend({ required: true }),
	        password	:	ko.observable(object.password).extend({ required: true }),
	        domain:{},
	        description	:	object.description
      });
      self.isEdit(true);        
    };
    
    this.delete = function(object, event){
        confirm("您确定要删除云管理平台["+object.name+"]吗？",function(){        		
	         api.cloudPlatform.set({"id":object.uuid}).destroy({
		            success: function(){
						alert("删除成功！");
						self.table.refreshData();//刷新列表     
		          	}
		     });
        });//end confirm    	  
      };

    this.ok = function(){ 	  
   		//接入
      	if(this.currentVO().id == null){
        	//验证通过
     	  	if(this.currentVO.errors().length === 0) {
      			//保存
            	api.cloudPlatforms.create(this.currentVO.toJSON(),{
              		success: function(data){
                		self.isEdit(false);//关闭modal
                		if(data.attributes.uuid){
              				alert("接入成功！")               	  
    	            		self.table.refreshData();//刷新列表                	
                		}
             		}
           		});
      	  
	        }else{
	      	  //显示错误提示
	      	  this.currentVO.errors.showAllMessages();
	        }

      //修改
      }else{
        	//验证通过
     	  	if(this.currentVO.errors().length === 0) {     	  		
     	  		api.cloudPlatform.save(this.currentVO.toJSON(),{
     		      	success: function(){
     		        	alert("修改成功")
     		        	self.table.refreshData();//刷新列表    	        	
     	        		self.isEdit(false);//关闭modal
     		      	},
     		      	error: function(){
     		      	}
     	    	});
     	  	}else{
     	  	 //显示错误提示
  	      	  this.currentVO.errors.showAllMessages();    	  		
     	  	}
      }
    };

    this.searchParam = ko.observable({
      name: ""
    });

    this.search = function(){
      this.table.params(this.searchParam());
    };

    //this.table = new DataTable([], {path: 'pages/resources/partitions/datacenters/1.json'});
    this.table = new DataTable([], {path: 'api/v5.0.0/cloudPlatforms?dataCenterUUID='+self.dataCenterUUID});
  };
  
  ko.applyBindings(new ViewModel(), $('#page-content')[0]);


});
</script>